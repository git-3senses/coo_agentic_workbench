import{a as H,c as G,d as Y}from"./chunk-VS5SVXXY.js";import"./chunk-FJNWIHH7.js";import"./chunk-OD4VSVIC.js";import"./chunk-QD3K37AI.js";import{a as F}from"./chunk-E3IMKM74.js";import"./chunk-W2JNMVTT.js";import{c as R,d as V,f as j}from"./chunk-WR7XAGZW.js";import{Wb as L}from"./chunk-FLFKSUZI.js";import{b as N,c as P,f as B,i as z,j as W,k as q,m as $}from"./chunk-SL2VEL43.js";import{Bb as b,Dc as O,Ib as U,Jc as A,Kb as S,La as D,Mb as s,Na as d,Nb as v,Ob as k,Rb as C,Sb as E,Tb as I,Y as x,ab as T,ca as u,da as f,eb as w,pb as m,qb as o,rb as i,sb as p,wc as M,xc as K,yb as y,zb as g}from"./chunk-IVDQKAZB.js";import"./chunk-7RJXRMKA.js";function Q(r,l){if(r&1&&(o(0,"span"),s(1),i()),r&2){let t=b();d(),k("\u2022 ",t.doc.display_date)}}function X(r,l){if(r&1){let t=y();o(0,"button",39),g("click",function(){u(t);let n=b();return f(n.openSource())}),p(1,"lucide-icon",40),s(2," Open Source "),i()}}function Z(r,l){if(r&1&&(o(0,"div",6),s(1),i()),r&2){let t=b();d(),v(t.doc.filename)}}function ee(r,l){r&1&&(o(0,"div",41)(1,"div",42)(2,"div",43),p(3,"lucide-icon",44),i(),o(4,"div",45),s(5,"No PDF uploaded yet"),i(),o(6,"div",46),s(7,"Upload a PDF to view it here and chat against it."),i()()())}function te(r,l){if(r&1&&p(0,"iframe",47),r&2){let t=b();m("src",t.pdfUrl,D)}}function ne(r,l){if(r&1&&(o(0,"div",48),p(1,"markdown",49),i()),r&2){let t=b();d(),m("data",t.markdownText)}}function ie(r,l){r&1&&(o(0,"div",41)(1,"div",42)(2,"div",43),p(3,"lucide-icon",50),i(),o(4,"div",45),s(5,"External official source"),i(),o(6,"div",46),s(7,"Some government sites block embedding. Use \u201COpen Source\u201D."),i()()())}function oe(r,l){if(r&1&&(o(0,"div",51)(1,"div"),s(2),i()()),r&2){let t=l.$implicit;S("ml-auto",t.role==="user")("bg-slate-900",t.role==="user")("text-white",t.role==="user")("bg-slate-50",t.role==="agent")("text-slate-800",t.role==="agent"),d(),S("opacity-80",t.streaming),d(),v(t.content)}}function le(r,l){r&1&&(o(0,"div",52),p(1,"span",53),s(2," Agent is thinking\u2026 "),i())}var J=class r{route=x(V);router=x(j);http=x(A);sanitizer=x(R);dify=x(Y);docId="";doc=null;pdfUrl=null;markdownText=null;objectUrl=null;mermaidInitialized=!1;selectedAgent="KB_SEARCH";messages=[];userInput="";isThinking=!1;ngOnInit(){this.docId=String(this.route.snapshot.paramMap.get("id")||""),this.loadDoc()}ngOnDestroy(){this.revokeObjectUrl()}revokeObjectUrl(){if(this.objectUrl){try{URL.revokeObjectURL(this.objectUrl)}catch{}this.objectUrl=null}}loadDoc(){this.http.get(`/api/kb/${encodeURIComponent(this.docId)}`).subscribe({next:l=>{this.doc=l,this.markdownText=null,l?.file_path?this.loadFileBlob():(this.revokeObjectUrl(),this.pdfUrl=null)},error:()=>{this.doc=null,this.revokeObjectUrl(),this.pdfUrl=null,this.markdownText=null}})}loadFileBlob(){let l=`/api/kb/${encodeURIComponent(this.docId)}/file`;this.http.get(l,{responseType:"blob"}).subscribe({next:t=>{this.revokeObjectUrl();let e=(t.type||"").toLowerCase(),n=e.includes("pdf")||String(this.doc?.mime_type||"").toLowerCase().includes("pdf"),c=e.includes("text/")||String(this.doc?.mime_type||"").toLowerCase().includes("markdown")||String(this.doc?.filename||"").toLowerCase().endsWith(".md")||String(this.doc?.filename||"").toLowerCase().endsWith(".mmd");if(n){this.markdownText=null,this.objectUrl=URL.createObjectURL(t),this.pdfUrl=this.sanitizer.bypassSecurityTrustResourceUrl(this.objectUrl);return}if(c){this.pdfUrl=null,t.text().then(a=>{this.markdownText=a,setTimeout(()=>this.tryRenderMermaid(),0)});return}this.pdfUrl=null,this.markdownText=null},error:t=>{this.revokeObjectUrl(),this.pdfUrl=null,this.markdownText=null;let e=t?.error?.error||t?.message||"Failed to load PDF";this.messages.push({role:"agent",content:`Document viewer error: ${String(e)}

If this is a permissions issue, please log in again and retry.`,ts:Date.now()})}})}async tryRenderMermaid(){if(!this.markdownText)return;let l=document.querySelector("app-knowledge-doc");if(!l)return;let t=Array.from(l.querySelectorAll("pre > code.language-mermaid"));if(t.length===0)return;for(let n of t){let c=n.parentElement;if(!c)continue;let a=document.createElement("div");a.className="mermaid",a.textContent=n.textContent||"",c.replaceWith(a)}let e=(await import("./chunk-QUJDFFYI.js")).default;this.mermaidInitialized||(e.initialize({startOnLoad:!1,securityLevel:"strict"}),this.mermaidInitialized=!0);try{await e.run({querySelector:"div.mermaid"})}catch{}}openSource(){this.doc?.source_url&&window.open(String(this.doc.source_url),"_blank","noopener,noreferrer")}onEnter(l){let t=l;t.shiftKey||(t.preventDefault(),this.send())}send(){let l=this.userInput.trim();if(!l||this.isThinking)return;this.userInput="";let t=this.doc?.title||this.docId,e=`Context (KB doc): ${t} (doc_id: ${this.docId}). Answer strictly based on the document content available in the KB; if not found, say what is missing.`;this.messages.push({role:"user",content:l,ts:Date.now()});let n={role:"agent",content:"",streaming:!0,ts:Date.now()};this.messages.push(n),this.isThinking=!0;let c={kb_doc_id:this.docId,kb_doc_title:t},a=this.dify.sendMessageStreamed(`${e}

User question: ${l}`,c,this.selectedAgent),_;_=a.subscribe({next:h=>{h.type==="chunk"?n.content+=h.text:h.type==="done"&&(n.content=h.response.answer||n.content||"(no answer)",n.streaming=!1,this.isThinking=!1,_?.unsubscribe?.())},error:h=>{n.content=`Error contacting agent: ${h?.message||"unknown error"}`,n.streaming=!1,this.isThinking=!1,_?.unsubscribe?.()}})}onUploadFile(l){let t=l.target,e=t.files?.[0]||null;if(!e)return;let n=new FormData;n.append("file",e),n.append("doc_id",this.docId||""),n.append("title",this.doc?.title||e.name.replace(/\.pdf$/i,"")),n.append("description",this.doc?.description||""),n.append("doc_type",this.doc?.doc_type||"REGULATORY"),n.append("ui_category",this.doc?.ui_category||""),n.append("agent_target",this.doc?.agent_target||""),n.append("icon_name",this.doc?.icon_name||"file-text"),n.append("display_date",this.doc?.display_date||""),n.append("visibility",this.doc?.visibility||"INTERNAL"),this.doc?.source_url&&n.append("source_url",String(this.doc.source_url)),this.http.post("/api/kb/upload",n).subscribe({next:()=>{t.value="",this.loadDoc()},error:()=>{t.value="",alert("Upload failed. Ensure you are logged in and the server has multer installed.")}})}static \u0275fac=function(t){return new(t||r)};static \u0275cmp=T({type:r,selectors:[["app-knowledge-doc"]],decls:57,vars:14,consts:[["fileInput",""],[1,"h-full","w-full","flex","flex-col","bg-slate-50"],[1,"flex-none","bg-white","border-b","border-slate-200","px-6","py-4","flex","items-center","justify-between"],[1,"flex","items-center","gap-3"],[1,"p-2","rounded-lg","hover:bg-slate-100","text-slate-600",3,"click"],["name","arrow-left",1,"w-5","h-5"],[1,"text-xs","text-slate-500"],[1,"text-lg","font-bold","text-slate-900","leading-tight"],[1,"text-xs","text-slate-500","mt-0.5"],[4,"ngIf"],[1,"flex","items-center","gap-2"],["type","file","accept","application/pdf",1,"hidden",3,"change"],[1,"flex","items-center","gap-2","px-3","py-2","rounded-lg","bg-blue-600","hover:bg-blue-700","text-white","text-sm","font-semibold",3,"click"],["name","upload",1,"w-4","h-4"],["class","flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-900 hover:bg-slate-800 text-white text-sm font-semibold",3,"click",4,"ngIf"],[1,"flex-1","min-h-0","flex"],[1,"w-1/2","min-w-0","border-r","border-slate-200","bg-white","flex","flex-col"],[1,"flex-none","px-4","py-3","border-b","border-slate-100","flex","items-center","justify-between"],[1,"text-sm","font-semibold","text-slate-800","flex","items-center","gap-2"],["name","file-text",1,"w-4","h-4","text-slate-500"],["class","text-xs text-slate-500",4,"ngIf"],[1,"flex-1","min-h-0"],["class","h-full flex items-center justify-center text-center p-8",4,"ngIf"],["class","w-full h-full",3,"src",4,"ngIf"],["class","w-full h-full overflow-y-auto p-4 prose prose-slate max-w-none",4,"ngIf"],[1,"w-1/2","min-w-0","bg-white","flex","flex-col"],["name","message-square",1,"w-4","h-4","text-slate-500"],[1,"text-xs","border","border-slate-200","rounded-md","px-2","py-1","bg-white",3,"ngModelChange","ngModel"],["value","KB_SEARCH"],["value","DILIGENCE"],["value","MASTER_COO"],[1,"flex-1","min-h-0","overflow-y-auto","p-4","space-y-3"],["class","max-w-[92%] rounded-xl px-3 py-2 text-sm whitespace-pre-wrap",3,"ml-auto","bg-slate-900","text-white","bg-slate-50","text-slate-800",4,"ngFor","ngForOf"],["class","text-xs text-slate-500 flex items-center gap-2",4,"ngIf"],[1,"flex-none","border-t","border-slate-200","p-3"],[1,"flex","items-end","gap-2"],["rows","2","placeholder","Ask questions about this document\u2026",1,"flex-1","resize-none","border","border-slate-200","rounded-xl","px-3","py-2","text-sm","outline-none","focus:ring-2","focus:ring-blue-100","focus:border-blue-400",3,"ngModelChange","keydown.enter","ngModel"],[1,"px-4","py-2","rounded-xl","bg-blue-600","hover:bg-blue-700","disabled:opacity-40","text-white","text-sm","font-semibold",3,"click","disabled"],[1,"text-[11px]","text-slate-400","mt-2"],[1,"flex","items-center","gap-2","px-3","py-2","rounded-lg","bg-slate-900","hover:bg-slate-800","text-white","text-sm","font-semibold",3,"click"],["name","external-link",1,"w-4","h-4"],[1,"h-full","flex","items-center","justify-center","text-center","p-8"],[1,"max-w-sm"],[1,"w-12","h-12","rounded-xl","bg-slate-100","mx-auto","flex","items-center","justify-center","mb-4"],["name","help-circle",1,"w-6","h-6","text-slate-500"],[1,"text-sm","font-semibold","text-slate-800"],[1,"text-xs","text-slate-500","mt-1"],[1,"w-full","h-full",3,"src"],[1,"w-full","h-full","overflow-y-auto","p-4","prose","prose-slate","max-w-none"],[3,"data"],["name","link2",1,"w-6","h-6","text-slate-500"],[1,"max-w-[92%]","rounded-xl","px-3","py-2","text-sm","whitespace-pre-wrap"],[1,"text-xs","text-slate-500","flex","items-center","gap-2"],[1,"w-2","h-2","rounded-full","bg-blue-500","animate-pulse"]],template:function(t,e){if(t&1){let n=y();o(0,"div",1)(1,"header",2)(2,"div",3)(3,"button",4),g("click",function(){return u(n),f(e.router.navigate(["/knowledge/base"]))}),p(4,"lucide-icon",5),i(),o(5,"div")(6,"div",6),s(7,"Knowledge & Evidence / Knowledge Base"),i(),o(8,"div",7),s(9),i(),o(10,"div",8),s(11),w(12,Q,2,1,"span",9),i()()(),o(13,"div",10)(14,"input",11,0),g("change",function(a){return u(n),f(e.onUploadFile(a))}),i(),o(16,"button",12),g("click",function(){u(n);let a=U(15);return f(a.click())}),p(17,"lucide-icon",13),s(18," Upload PDF "),i(),w(19,X,3,0,"button",14),i()(),o(20,"div",15)(21,"section",16)(22,"div",17)(23,"div",18),p(24,"lucide-icon",19),s(25," Document Viewer "),i(),w(26,Z,2,1,"div",20),i(),o(27,"div",21),w(28,ee,8,0,"div",22)(29,te,1,1,"iframe",23)(30,ne,2,1,"div",24)(31,ie,8,0,"div",22),i()(),o(32,"section",25)(33,"div",17)(34,"div",18),p(35,"lucide-icon",26),s(36," Ask an Agent "),i(),o(37,"div",10)(38,"label",6),s(39,"Agent"),i(),o(40,"select",27),I("ngModelChange",function(a){return u(n),E(e.selectedAgent,a)||(e.selectedAgent=a),f(a)}),o(41,"option",28),s(42,"KB Search"),i(),o(43,"option",29),s(44,"Diligence"),i(),o(45,"option",30),s(46,"Master COO"),i()()()(),o(47,"div",31),w(48,oe,3,13,"div",32)(49,le,3,0,"div",33),i(),o(50,"div",34)(51,"div",35)(52,"textarea",36),I("ngModelChange",function(a){return u(n),E(e.userInput,a)||(e.userInput=a),f(a)}),g("keydown.enter",function(a){return u(n),f(e.onEnter(a))}),i(),o(53,"button",37),g("click",function(){return u(n),f(e.send())}),s(54," Send "),i()(),o(55,"div",38),s(56," Tip: Upload the same PDF into your Dify Dataset for best grounded answers. "),i()()()()()}t&2&&(d(9),v((e.doc==null?null:e.doc.title)||e.docId),d(2),k("",(e.doc==null?null:e.doc.doc_type)||""," "),d(),m("ngIf",e.doc==null?null:e.doc.display_date),d(7),m("ngIf",e.doc==null?null:e.doc.source_url),d(7),m("ngIf",e.doc==null?null:e.doc.filename),d(2),m("ngIf",!e.pdfUrl&&!(e.doc!=null&&e.doc.source_url)),d(),m("ngIf",e.pdfUrl),d(),m("ngIf",e.markdownText),d(),m("ngIf",!e.pdfUrl&&(e.doc==null?null:e.doc.source_url)),d(9),C("ngModel",e.selectedAgent),d(8),m("ngForOf",e.messages),d(),m("ngIf",e.isThinking),d(3),C("ngModel",e.userInput),d(),m("disabled",!e.userInput.trim()||e.isThinking))},dependencies:[O,M,K,$,W,q,N,z,P,B,F,L,G,H],encapsulation:2})};export{J as KnowledgeDocComponent};
