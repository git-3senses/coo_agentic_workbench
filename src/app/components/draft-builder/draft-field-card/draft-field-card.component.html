<!-- Draft Field Card — Reusable field editor with lineage + comments -->
<div class="draft-field-card rounded-lg bg-white border overflow-hidden transition-colors"
  [ngClass]="isUnfilled ? 'border-l-2 border-l-red-400 border-slate-200' : 'border-slate-200 hover:border-slate-300'">

  <!-- ── Label Row ──────────────────────────────────────────── -->
  <div class="px-4 py-2.5 flex items-center justify-between gap-3">
    <div class="flex items-center gap-2 min-w-0 flex-1">
      <span class="text-sm text-slate-800">{{ field.label }}</span>
      <span *ngIf="field.required" class="text-red-400 text-[11px] font-medium">required</span>
    </div>

    <div class="flex items-center gap-2 flex-none">
      <!-- Lineage badge -->
      <span class="inline-flex items-center gap-1 text-[10px] font-medium px-2 py-0.5 rounded-full border"
        [ngClass]="lineageColor">
        <lucide-icon [name]="lineageIcon" class="w-3 h-3"></lucide-icon>
        {{ lineageLabel }}
      </span>

      <!-- Confidence score -->
      <span *ngIf="field.confidence" class="text-[10px] text-slate-400 font-mono tabular-nums">
        {{ (field.confidence * 100) | number:'1.0-0' }}%
      </span>

      <!-- Comments toggle -->
      <button (click)="toggleComments()"
        class="relative p-1 rounded hover:bg-slate-100 text-slate-400 hover:text-slate-600 transition-colors"
        [class.text-blue-500]="showComments">
        <lucide-icon name="message-circle" class="w-3.5 h-3.5"></lucide-icon>
        <span *ngIf="unresolvedCount > 0"
          class="absolute -top-0.5 -right-0.5 w-3.5 h-3.5 flex items-center justify-center rounded-full bg-blue-500 text-white text-[8px] font-bold">
          {{ unresolvedCount }}
        </span>
      </button>
    </div>
  </div>

  <!-- ── Input Area ─────────────────────────────────────────── -->
  <div class="px-4 pb-3">

    <!-- TEXT -->
    <input *ngIf="field.type === 'text'" type="text"
      [(ngModel)]="field.value" (ngModelChange)="onValueChange()"
      [placeholder]="field.placeholder || 'Enter value...'"
      class="w-full px-3 py-2 text-sm rounded-md border border-slate-200 bg-slate-50/50 focus:bg-white focus:border-blue-400 outline-none transition-all" />

    <!-- TEXTAREA -->
    <div *ngIf="field.type === 'textarea'">
      <textarea [(ngModel)]="field.value" (ngModelChange)="onValueChange()"
        [placeholder]="field.placeholder || 'Enter details...'" rows="3"
        class="w-full px-3 py-2 text-sm rounded-md border border-slate-200 bg-slate-50/50 focus:bg-white focus:border-blue-400 outline-none transition-all resize-none"></textarea>
      <p class="text-[10px] text-slate-300 mt-1 text-right">{{ getWordCount(field.value) }} words</p>
    </div>

    <!-- DATE -->
    <input *ngIf="field.type === 'date'" type="date"
      [(ngModel)]="field.value" (ngModelChange)="onValueChange()"
      class="w-full px-3 py-2 text-sm rounded-md border border-slate-200 bg-slate-50/50 focus:bg-white focus:border-blue-400 outline-none transition-all" />

    <!-- CURRENCY -->
    <div *ngIf="field.type === 'currency'" class="relative">
      <span class="absolute left-3 top-2 text-sm text-slate-400">$</span>
      <input type="text" [(ngModel)]="field.value" (ngModelChange)="onValueChange()"
        placeholder="0.00"
        class="w-full pl-7 pr-3 py-2 text-sm rounded-md border border-slate-200 bg-slate-50/50 focus:bg-white focus:border-blue-400 outline-none transition-all" />
    </div>

    <!-- YES/NO -->
    <div *ngIf="field.type === 'yesno'" class="flex items-center gap-2">
      <button (click)="onYesNo(true)"
        class="px-4 py-1.5 text-sm rounded-md border transition-all"
        [ngClass]="field.yesNoValue === true ? 'bg-emerald-50 border-emerald-300 text-emerald-700 font-medium' : 'border-slate-200 text-slate-500 hover:bg-slate-50'">
        Yes
      </button>
      <button (click)="onYesNo(false)"
        class="px-4 py-1.5 text-sm rounded-md border transition-all"
        [ngClass]="field.yesNoValue === false ? 'bg-red-50 border-red-300 text-red-600 font-medium' : 'border-slate-200 text-slate-500 hover:bg-slate-50'">
        No
      </button>
    </div>

    <!-- DROPDOWN -->
    <select *ngIf="field.type === 'dropdown'" [(ngModel)]="field.value" (ngModelChange)="onValueChange()"
      class="w-full px-3 py-2 text-sm rounded-md border border-slate-200 bg-slate-50/50 focus:bg-white focus:border-blue-400 outline-none transition-all">
      <option value="">Select...</option>
      <option *ngFor="let opt of field.options" [value]="opt">{{ opt }}</option>
    </select>

    <!-- BULLET LIST -->
    <div *ngIf="field.type === 'bullet_list'" class="space-y-1.5">
      <div *ngFor="let item of field.bulletItems; let bi = index" class="flex items-center gap-2 group">
        <span class="text-slate-300 text-xs select-none">&bull;</span>
        <input type="text" [(ngModel)]="field.bulletItems![bi]" (ngModelChange)="onValueChange()"
          class="flex-1 px-2 py-1 text-sm rounded border border-transparent hover:border-slate-200 focus:border-blue-400 outline-none bg-transparent focus:bg-white transition-all" />
        <button (click)="onRemoveBullet(bi)"
          class="p-0.5 rounded text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all">
          <lucide-icon name="x" class="w-3 h-3"></lucide-icon>
        </button>
      </div>
      <button (click)="onAddBullet()"
        class="text-xs text-blue-500 hover:text-blue-600 font-medium px-1 py-0.5 transition-colors">
        + Add item
      </button>
    </div>

    <!-- MULTISELECT -->
    <div *ngIf="field.type === 'multiselect'" class="flex flex-wrap gap-1.5">
      <button *ngFor="let opt of field.options"
        class="px-2.5 py-1 text-xs rounded-md border transition-all"
        [ngClass]="field.value.includes(opt) ? 'bg-blue-50 border-blue-300 text-blue-700 font-medium' : 'border-slate-200 text-slate-500 hover:bg-slate-50'"
        (click)="onToggleMultiselect(opt)">
        {{ opt }}
      </button>
    </div>
  </div>

  <!-- ── Comments Section (expandable) ──────────────────────── -->
  <div *ngIf="showComments" class="border-t border-slate-100 bg-slate-50/50">
    <!-- Existing comments -->
    <div *ngIf="fieldComments.length > 0" class="px-4 pt-3 space-y-2">
      <div *ngFor="let c of fieldComments"
        class="flex items-start gap-2 text-xs"
        [class.opacity-50]="c.resolved">
        <div class="w-5 h-5 rounded-full bg-slate-200 flex items-center justify-center text-[9px] font-bold text-slate-600 flex-none mt-0.5">
          {{ c.author.charAt(0) }}
        </div>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2">
            <span class="font-medium text-slate-700">{{ c.author }}</span>
            <span class="text-[10px] text-slate-400">{{ c.timestamp }}</span>
            <span *ngIf="c.resolved" class="text-[9px] text-emerald-600 font-medium">Resolved</span>
          </div>
          <p class="text-slate-600 mt-0.5">{{ c.text }}</p>
          <button *ngIf="!c.resolved" (click)="onResolveComment(c.id)"
            class="text-[10px] text-blue-500 hover:text-blue-600 font-medium mt-1 transition-colors">
            Resolve
          </button>
        </div>
      </div>
    </div>

    <!-- Add comment -->
    <div class="px-4 py-3">
      <div class="flex items-center gap-2">
        <input type="text" [(ngModel)]="newCommentText" (keyup.enter)="submitComment()"
          placeholder="Add a comment..."
          class="flex-1 px-2.5 py-1.5 text-xs rounded-md border border-slate-200 bg-white focus:border-blue-400 outline-none transition-colors" />
        <button (click)="submitComment()" [disabled]="!newCommentText.trim()"
          class="px-2.5 py-1.5 text-xs font-medium text-blue-600 hover:bg-blue-50 rounded-md transition-colors disabled:opacity-30">
          Post
        </button>
      </div>
    </div>
  </div>
</div>
