<!-- ═══════════════════════════════════════════════════════════════
     NPA DETAIL V2 — Decomposed container component
     Header + Tab Bar stay here; each tab delegates to its own child.
     ═══════════════════════════════════════════════════════════════ -->

<div class="fixed inset-0 z-50 flex flex-col h-screen w-screen bg-slate-50 font-sans">

  <!-- ─── HEADER ──────────────────────────────────────────────── -->
  <header class="flex-none bg-white border-b border-slate-200 px-6 py-3 flex items-center justify-between shadow-sm z-20">
    <!-- Left: breadcrumb + title -->
    <div class="flex items-center gap-4 min-w-0">
      <button class="group p-2 rounded-full hover:bg-slate-100 text-slate-500 hover:text-slate-900 transition-all">
        <lucide-icon name="arrow-left" class="w-5 h-5 group-hover:-translate-x-0.5 transition-transform"></lucide-icon>
      </button>

      <div class="min-w-0">
        <!-- Breadcrumb row -->
        <div class="flex items-center gap-2 text-xs text-slate-500 mb-1">
          <span class="text-slate-400 font-medium">NPA Pipeline</span>
          <lucide-icon name="chevron-right" class="w-3 h-3 text-slate-300"></lucide-icon>
          <span class="font-mono text-slate-600 bg-slate-100 px-1.5 py-0.5 rounded text-[11px]">{{ project.displayId || project.id }}</span>
          <span class="text-slate-300 hidden sm:inline">|</span>
          <span class="hidden sm:flex items-center gap-1">
            <lucide-icon name="user" class="w-3 h-3"></lucide-icon>
            <span class="font-medium text-slate-700">{{ project.submittedBy }}</span>
          </span>
          <span class="text-slate-300 hidden sm:inline">|</span>
          <span class="hidden sm:inline text-slate-400">{{ project.submittedDate }}</span>
        </div>
        <!-- Title row -->
        <div class="flex items-center gap-2 flex-wrap">
          <h1 class="text-base font-bold text-slate-900 truncate max-w-[420px]">{{ project.title }}</h1>
          <span class="inline-flex items-center px-2 py-0.5 rounded text-[11px] font-semibold bg-blue-100 text-blue-700 border border-blue-200 whitespace-nowrap">
            {{ project.approvalTrack }}
          </span>
          <span *ngIf="project.crossBorder" class="inline-flex items-center px-2 py-0.5 rounded text-[11px] font-medium bg-purple-50 text-purple-700 border border-purple-200 whitespace-nowrap">
            <lucide-icon name="globe" class="w-3 h-3 mr-1"></lucide-icon>Cross-Border
          </span>
          <span *ngIf="project.ntg" class="inline-flex items-center px-2 py-0.5 rounded text-[11px] font-semibold border whitespace-nowrap"
            [ngClass]="{
              'bg-amber-50 text-amber-700 border-amber-200': project.pacStatus === 'Pending',
              'bg-green-50 text-green-700 border-green-200': project.pacStatus === 'Approved',
              'bg-red-50 text-red-700 border-red-200': project.pacStatus === 'Rejected'
            }">
            <lucide-icon name="shield-check" class="w-3 h-3 mr-1"></lucide-icon>PAC: {{ project.pacStatus }}
          </span>
        </div>
      </div>
    </div>

    <!-- Right: actions -->
    <div class="flex items-center gap-2">
      <button class="px-3 py-1.5 text-sm font-medium text-indigo-600 hover:bg-indigo-50 rounded-lg border border-indigo-200 hover:border-indigo-300 flex items-center gap-1.5 transition-colors">
        <lucide-icon name="refresh-cw" class="w-3.5 h-3.5"></lucide-icon>Refresh
      </button>
      <button class="px-3 py-1.5 text-sm font-medium text-slate-600 hover:bg-slate-50 rounded-lg border border-slate-200 hover:border-slate-300 flex items-center gap-1.5 transition-colors">
        <lucide-icon name="save" class="w-3.5 h-3.5"></lucide-icon>Save
      </button>
      <div class="h-5 w-px bg-slate-200 mx-1"></div>
      <button class="px-3 py-1.5 text-sm font-medium text-red-600 hover:bg-red-50 rounded-lg transition-colors">Reject</button>
      <button class="px-4 py-1.5 text-sm font-semibold text-white bg-dbs-primary hover:bg-dbs-primary-hover rounded-lg shadow-sm transition-colors">
        Approve
      </button>
    </div>
  </header>

  <!-- ─── TAB BAR ────────────────────────────────────────────── -->
  <nav class="flex-none bg-white border-b border-slate-200 px-6">
    <div class="flex items-center gap-0.5 -mb-px">
      <button *ngFor="let tab of tabs" (click)="setTab(tab.id)"
        class="relative px-4 py-2.5 text-sm font-medium transition-colors flex items-center gap-2"
        [class.tab-active]="activeTab === tab.id"
        [class.text-slate-900]="activeTab === tab.id"
        [class.text-slate-500]="activeTab !== tab.id"
        [class.hover:text-slate-700]="activeTab !== tab.id">
        <lucide-icon [name]="tab.icon" class="w-4 h-4"></lucide-icon>
        {{ tab.label }}
        <!-- Badge -->
        <span *ngIf="tab.badge"
          class="ml-0.5 text-[10px] font-bold px-1.5 py-0.5 rounded-full leading-none"
          [ngClass]="{
            'bg-red-100 text-red-700': tab.badgeColor === 'red',
            'bg-amber-100 text-amber-700': tab.badgeColor === 'amber',
            'bg-slate-100 text-slate-600': !tab.badgeColor
          }">
          {{ tab.badge }}
        </span>
      </button>
    </div>
  </nav>

  <!-- ─── CONTENT AREA — Delegates to child tab components ──── -->
  <main class="flex-1 overflow-y-auto scroll-region p-6">

    <!-- TAB 1: PROPOSAL -->
    <app-proposal-tab *ngIf="activeTab === 'PROPOSAL'"
      [project]="project"
      [draftProgress]="getDraftProgress()"
      (openDraft)="openDraftBuilder()">
    </app-proposal-tab>

    <!-- TAB 2: DOCUMENTS -->
    <app-documents-tab *ngIf="activeTab === 'DOCUMENTS'"
      [docCompleteness]="docCompleteness"
      [documents]="documents"
      [missingDocItems]="missingDocItems">
    </app-documents-tab>

    <!-- TAB 3: ANALYSIS -->
    <app-analysis-tab *ngIf="activeTab === 'ANALYSIS'"
      [classification]="classification"
      [risk]="risk"
      [mlPrediction]="mlPrediction">
    </app-analysis-tab>

    <!-- TAB 4: SIGN-OFF -->
    <app-signoff-tab *ngIf="activeTab === 'SIGNOFF'"
      [governance]="governance">
    </app-signoff-tab>

    <!-- TAB 5: WORKFLOW -->
    <app-workflow-tab *ngIf="activeTab === 'WORKFLOW'"
      [stages]="workflowStages">
    </app-workflow-tab>

    <!-- TAB 6: MONITOR -->
    <app-monitor-tab *ngIf="activeTab === 'MONITOR'"
      [monitoring]="monitoring">
    </app-monitor-tab>

    <!-- TAB 7: CHAT -->
    <app-chat-tab *ngIf="activeTab === 'CHAT'"
      [messages]="chatMessages"
      (messageSent)="onChatMessageSent($event)">
    </app-chat-tab>

  </main>
</div>

<!-- ═══════════════════════════════════════════════════════════════
     DRAFT BUILDER OVERLAY — Full-screen 3-column editor
     ═══════════════════════════════════════════════════════════════ -->
<app-draft-builder-overlay *ngIf="showDraftBuilder"
  [projectId]="project.id"
  [sections]="draftSections"
  [comments]="draftComments"
  [agentMessages]="draftAgentMessages"
  [referenceNPAs]="referenceNPAs"
  [selectedRefNPA]="selectedRefNPA"
  (closed)="closeDraftBuilder()"
  (commentAdded)="onCommentAdded($event)"
  (commentResolved)="onCommentResolved($event)"
  (agentMessageSent)="onAgentMessageSent($event)">
</app-draft-builder-overlay>
