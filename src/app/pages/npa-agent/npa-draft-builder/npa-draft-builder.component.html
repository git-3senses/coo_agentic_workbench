<!-- NPA DRAFT BUILDER — 3-Column Layout -->
<div class="fixed inset-0 z-[110] flex flex-col h-screen w-screen bg-slate-50 overscroll-none font-sans">

   <!-- ═══════════════════════════════════════════════════════════ -->
   <!-- HEADER                                                     -->
   <!-- ═══════════════════════════════════════════════════════════ -->
   <div
      class="flex-none bg-white border-b border-slate-200 px-5 py-2.5 flex items-center justify-between shadow-sm z-20">
      <div class="flex items-center gap-3">
         <button (click)="close.emit()"
            class="group flex items-center justify-center p-1.5 rounded-full hover:bg-slate-100 text-slate-500 hover:text-slate-900 transition-all">
            <lucide-icon name="arrow-left"
               class="w-5 h-5 stroke-[1.5] group-hover:-translate-x-0.5 transition-transform"></lucide-icon>
         </button>
         <div class="h-5 w-px bg-slate-200"></div>
         <div class="flex items-center gap-2">
            <div class="p-1.5 bg-blue-50 border border-blue-100 rounded-lg">
               <lucide-icon name="file-edit" class="w-4 h-4 text-blue-600"></lucide-icon>
            </div>
            <div>
               <h1 class="text-sm font-bold text-slate-900 leading-tight">NPA Draft Builder</h1>
               <p class="text-[10px] text-slate-400 font-medium">{{ inputData?.title || 'New Product Approval' }}</p>
            </div>
         </div>
      </div>

      <!-- Progress + Actions -->
      <div class="flex items-center gap-4">
         <!-- Overall Progress -->
         <div class="flex items-center gap-2.5">
            <div class="flex items-center gap-1.5">
               <div class="w-28 h-1.5 bg-slate-200 rounded-full overflow-hidden">
                  <div class="h-full rounded-full transition-all duration-500"
                     [class]="overallProgress >= 80 ? 'bg-emerald-500' : overallProgress >= 40 ? 'bg-amber-500' : 'bg-blue-500'"
                     [style.width.%]="overallProgress"></div>
               </div>
               <span class="text-xs font-bold tabular-nums"
                  [class]="overallProgress >= 80 ? 'text-emerald-600' : overallProgress >= 40 ? 'text-amber-600' : 'text-blue-600'">
                  {{ overallProgress }}%
               </span>
            </div>
            <span class="text-[10px] text-slate-400 font-mono">{{ filledFields }}/{{ totalFields }}</span>
         </div>

         <div class="h-5 w-px bg-slate-200"></div>


         <button (click)="saveDraft()"
            class="px-3.5 py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-50 rounded-lg transition-colors border border-slate-200 hover:border-slate-300 flex items-center gap-1.5">
            <lucide-icon name="save" class="w-3.5 h-3.5"></lucide-icon>
            Save Draft
         </button>
      </div>
   </div>

   <!-- ═══════════════════════════════════════════════════════════ -->
   <!-- MAIN 3-COLUMN LAYOUT                                       -->
   <!-- ═══════════════════════════════════════════════════════════ -->
   <div class="flex-1 overflow-hidden flex">

      <!-- ─────────────────────────────────────────────────────── -->
      <!-- LEFT COLUMN: Section Stepper (w-60)                     -->
      <!-- ─────────────────────────────────────────────────────── -->
      <div class="w-60 flex-none bg-white border-r border-slate-200 flex flex-col overflow-hidden">
         <app-npa-section-stepper [sections]="stepperSections" [activeSectionId]="activeSectionId"
            [filledFields]="filledFields" [totalFields]="totalFields" [overallProgress]="overallProgress"
            (sectionSelected)="selectSection($event)">
         </app-npa-section-stepper>
      </div>

      <!-- ─────────────────────────────────────────────────────── -->
      <!-- CENTER COLUMN: Section Form Renderer (flex-1)           -->
      <!-- ─────────────────────────────────────────────────────── -->
      <div class="flex-1 flex flex-col overflow-hidden bg-slate-50/50">

         <!-- Section Header -->
         <div *ngIf="getActiveSection() as section"
            class="flex-none px-6 py-4 bg-white border-b border-slate-200 flex items-center justify-between">
            <div class="flex items-center gap-3">
               <div class="p-2 rounded-lg"
                  [class]="getGroupForSection(section.id).bgClass + ' border ' + getGroupForSection(section.id).borderClass">
                  <lucide-icon [name]="section.icon" class="w-5 h-5"
                     [class]="getGroupForSection(section.id).textClass"></lucide-icon>
               </div>
               <div>
                  <div class="flex items-center gap-2">
                     <span class="text-xs font-bold text-slate-400 font-mono">Section {{ section.numbering }}</span>
                     <span
                        class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-[9px] font-semibold uppercase tracking-wider"
                        [class]="getGroupForSection(section.id).bgClass + ' ' + getGroupForSection(section.id).textClass">
                        <lucide-icon [name]="getGroupForSection(section.id).icon" class="w-2.5 h-2.5"></lucide-icon>
                        {{ getGroupForSection(section.id).label }}
                     </span>
                  </div>
                  <h2 class="text-base font-bold text-slate-900 mt-0.5">{{ section.label }}</h2>
               </div>
            </div>

            <!-- Section Nav -->
            <div class="flex items-center gap-2">
               <span class="text-xs text-slate-400 font-mono mr-2">
                  {{ section.filledCount }}/{{ section.fieldCount }} fields
               </span>
               <button (click)="navigatePrev()"
                  class="p-1.5 rounded-lg hover:bg-slate-100 text-slate-400 hover:text-slate-700 transition-colors disabled:opacity-30"
                  [disabled]="stepperSections[0]?.id === activeSectionId">
                  <lucide-icon name="chevron-left" class="w-4 h-4"></lucide-icon>
               </button>
               <button (click)="navigateNext()"
                  class="p-1.5 rounded-lg hover:bg-slate-100 text-slate-400 hover:text-slate-700 transition-colors disabled:opacity-30"
                  [disabled]="stepperSections[stepperSections.length - 1]?.id === activeSectionId">
                  <lucide-icon name="chevron-right" class="w-4 h-4"></lucide-icon>
               </button>
            </div>
         </div>

         <!-- Fields Content -->
         <div class="flex-1 overflow-y-auto px-6 py-5 npa-scrollbar">
            <div class="max-w-3xl mx-auto space-y-6">

               <!-- No groups fallback -->
               <div *ngIf="getActiveSectionGroups().length === 0" class="text-center py-16">
                  <div class="w-14 h-14 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-4">
                     <lucide-icon name="inbox" class="w-7 h-7 text-slate-300"></lucide-icon>
                  </div>
                  <p class="text-sm font-medium text-slate-500">No fields in this section</p>
                  <p class="text-xs text-slate-400 mt-1">This section may not require field input</p>
               </div>

               <!-- Field Groups (Topics) -->
               <div *ngFor="let group of getActiveSectionGroups(); trackBy: trackByGroupTopic"
                  class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">

                  <!-- Topic Header -->
                  <div class="px-5 py-3.5 bg-slate-50/70 border-b border-slate-100 flex items-center justify-between">
                     <div class="flex items-center gap-2">
                        <span class="text-xs font-bold text-slate-400 font-mono w-5">{{ group.numbering }}</span>
                        <h3 class="text-sm font-semibold text-slate-800">{{ group.topic }}</h3>
                     </div>
                     <span class="text-[10px] font-mono text-slate-400">
                        {{ group.fields.length }} field{{ group.fields.length !== 1 ? 's' : '' }}
                     </span>
                  </div>

                  <!-- Guidance -->
                  <div *ngIf="group.guidance" class="px-5 py-2.5 bg-blue-50/50 border-b border-blue-100/50">
                     <p class="text-[11px] text-blue-700/80 italic leading-relaxed flex items-start gap-1.5">
                        <lucide-icon name="info" class="w-3 h-3 mt-0.5 flex-none text-blue-500/60"></lucide-icon>
                        {{ group.guidance }}
                     </p>
                  </div>

                  <!-- Fields — delegated to NpaFieldRendererComponent -->
                  <div class="divide-y divide-slate-100">
                     <ng-container *ngFor="let field of group.fields; trackBy: trackByFieldKey">
                        <div *ngIf="shouldShowField(field)"
                           class="px-5 py-4 hover:bg-slate-50/50 transition-colors group/field">
                           <app-npa-field-renderer [field]="field" (fieldEdited)="onFieldEdited($event)"
                              (fieldCleared)="onFieldCleared($event)" (askAgent)="askAgentAboutField($event)">
                           </app-npa-field-renderer>
                        </div>
                     </ng-container>
                  </div>
               </div>

               <!-- Navigation Buttons -->
               <div class="flex items-center justify-between pt-4 pb-8">
                  <button (click)="navigatePrev()"
                     class="px-4 py-2 text-xs font-semibold text-slate-500 hover:text-slate-700 hover:bg-white rounded-lg border border-slate-200 transition-colors flex items-center gap-1.5 disabled:opacity-30"
                     [disabled]="stepperSections[0]?.id === activeSectionId">
                     <lucide-icon name="arrow-left" class="w-3.5 h-3.5"></lucide-icon>
                     Previous Section
                  </button>
                  <button (click)="navigateNext()"
                     class="px-4 py-2 text-xs font-semibold text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow-sm transition-colors flex items-center gap-1.5 disabled:opacity-30"
                     [disabled]="stepperSections[stepperSections.length - 1]?.id === activeSectionId">
                     Next Section
                     <lucide-icon name="arrow-right" class="w-3.5 h-3.5"></lucide-icon>
                  </button>
               </div>
            </div>
         </div>
      </div>

      <!-- ─────────────────────────────────────────────────────── -->
      <!-- RIGHT COLUMN: Agent Chat Panel (w-80)                   -->
      <!-- ─────────────────────────────────────────────────────── -->
      <div class="w-80 flex-none bg-white border-l border-slate-200 flex flex-col overflow-hidden">
         <app-npa-agent-chat [signOffGroups]="signOffGroups" [activeAgentId]="activeAgentId" [agentChats]="agentChats"
            [sectionFieldGroups]="sectionFieldGroups" (agentSelected)="selectAgent($event)"
            (validateRequested)="validateDraft()" (applySuggestion)="onApplyFieldSuggestion($event)">
         </app-npa-agent-chat>
      </div>
   </div>
</div>