import{a as p}from"./chunk-W2JNMVTT.js";import{Jc as c,T as m,Y as o,fc as a,la as s}from"./chunk-IVDQKAZB.js";import{a as R,b as d}from"./chunk-7RJXRMKA.js";var P={"RMG-Credit":"APPROVER_RISK","RMG-Market":"APPROVER_MARKET",Finance:"APPROVER_FINANCE","Group Tax":"APPROVER_TAX","Legal & Compliance":"APPROVER_LEGAL","Legal, Compliance & Secretariat":"APPROVER_LEGAL",Operations:"APPROVER_OPS",Technology:"APPROVER_TECH",MLR:"APPROVER_LEGAL","Product Control":"CHECKER","COO Office":"COO"},A=class n{http=o(c);authService=o(p);_currentUser=s(this.buildFromAuth());_allUsers=s([]);_loaded=s(!1);currentUser=this._currentUser.asReadonly();allUsers=this._allUsers.asReadonly();loaded=this._loaded.asReadonly();isMaker=a(()=>this.currentUser().role==="MAKER");isApprover=a(()=>this.currentUser().role.startsWith("APPROVER_"));isAdmin=a(()=>this.currentUser().role==="ADMIN");constructor(){this.loadUsers(),this.authService.user$.subscribe(e=>{e&&this._currentUser.set({id:e.id,name:e.display_name||e.full_name.split(" ")[0],email:e.email,role:this.mapDbRole(e.role,e.department),department:e.department,jobTitle:e.job_title})})}switchRole(e){let i=this._allUsers().find(r=>r.role===e);i?this._currentUser.set(i):this._currentUser.set(d(R({},this._currentUser()),{role:e}))}loadUsers(){this.http.get("/api/users").subscribe({next:e=>{let t=e.map(r=>({id:r.id,name:r.display_name||r.full_name,email:r.email,role:this.mapDbRole(r.role,r.department),department:r.department,jobTitle:r.job_title}));this._allUsers.set(t),this._loaded.set(!0);let i=this.authService.currentUser;if(i){let r=t.find(l=>l.id===i.id||l.email===i.email);r&&this._currentUser.set(r)}},error:e=>{console.warn("[UserService] Failed to load users from API, using auth user as fallback",e)}})}mapDbRole(e,t){return e==="MAKER"?"MAKER":e==="CHECKER"?"CHECKER":e==="COO"?"COO":e==="ADMIN"?"ADMIN":e==="APPROVER"?P[t]||"APPROVER_RISK":"MAKER"}buildFromAuth(){let e=this.authService.currentUser;return e?{id:e.id,name:e.display_name||e.full_name.split(" ")[0],email:e.email,role:this.mapDbRole(e.role,e.department),department:e.department,jobTitle:e.job_title}:{id:"",name:"Guest",role:"MAKER",email:""}}static \u0275fac=function(t){return new(t||n)};static \u0275prov=m({token:n,factory:n.\u0275fac,providedIn:"root"})};export{A as a};
