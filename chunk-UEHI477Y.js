import{a as Bt}from"./chunk-EH6T6EZV.js";import{a as Rt,b as Be,c as Ge,d as Ue,e as je,f as qe,g as Ke,h as Vt}from"./chunk-VC56KDBY.js";import{a as Ot,c as Ft,d as ce}from"./chunk-VS5SVXXY.js";import{a as Q}from"./chunk-J3WGSLJR.js";import"./chunk-FJNWIHH7.js";import"./chunk-OD4VSVIC.js";import{a as $e}from"./chunk-E4BST6GI.js";import{a as Gt}from"./chunk-ZRP56TWH.js";import{a as Ve}from"./chunk-SAMWE3XV.js";import"./chunk-QD3K37AI.js";import{a as be}from"./chunk-IUB5JG3Z.js";import{a as ae}from"./chunk-E3IMKM74.js";import{a as Fe}from"./chunk-W2JNMVTT.js";import{d as Me,f as Le,j as Oe}from"./chunk-WR7XAGZW.js";import{Wb as L,Xb as U}from"./chunk-FLFKSUZI.js";import{b as oe,c as se,f as le,h as Nt,i as Dt,j as Mt,k as Lt,m as de}from"./chunk-SL2VEL43.js";import{$b as Ee,Ac as De,Bb as p,Cc as Et,D as gt,Dc as N,F as xt,Fb as ge,Gb as fe,Hb as _e,Ib as Pe,Jb as H,Jc as re,Ka as Ce,Kb as M,Lb as O,Mb as l,Na as s,Nb as v,Ob as x,P as ht,Pb as Y,Rb as j,Sa as R,Sb as q,T as we,Tb as K,Vb as Z,Wb as wt,Xa as ye,Y as T,Yb as At,Zb as Tt,_b as ie,ab as E,ac as Ie,bc as ft,ca as _,cc as Re,da as b,ea as vt,eb as f,fa as Ct,h as ut,j as te,jc as Ne,kb as St,o as ke,oa as It,pb as c,qb as r,rb as a,sb as m,tb as Ae,u as yt,ub as Te,vb as kt,vc as G,wb as me,wc as V,xb as ue,xc as F,y as ne,yb as I,z as ve,zb as y,zc as Pt}from"./chunk-IVDQKAZB.js";import{a as B,b as pe}from"./chunk-7RJXRMKA.js";var We=class n{onBack=new R;onComplete=new R;workspaceConfig={context:"NPA_AGENT",showLanding:!1,showSidebar:!0,showTemplateForm:!0,templateFilter:["STRATEGY","RISK","LEGAL","OPS","MARKETING"],title:"NPA Agent",subtitle:"Product Approval Assistant"};goBack(){this.onBack.emit()}handleAgentComplete(t){this.onComplete.emit(t)}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=E({type:n,selectors:[["app-chat-interface"]],outputs:{onBack:"onBack",onComplete:"onComplete"},decls:1,vars:1,consts:[[3,"onBack","onComplete","config"]],template:function(e,i){e&1&&(r(0,"app-agent-workspace",0),y("onBack",function(){return i.goBack()})("onComplete",function(d){return i.handleAgentComplete(d)}),a()),e&2&&c("config",i.workspaceConfig)},dependencies:[Vt],styles:["[_nghost-%COMP%]{display:block;height:100%}"]})};var qt={MASTER_COO:"violet",NPA_ORCHESTRATOR:"orange",IDEATION:"indigo",CLASSIFIER:"purple",ML_PREDICT:"amber",RISK:"red",GOVERNANCE:"slate",DILIGENCE:"cyan",DOC_LIFECYCLE:"teal",MONITORING:"emerald",KB_SEARCH:"fuchsia",NOTIFICATION:"pink"},Kt={MASTER_COO:{label:"Sessions",value:"2,456",actionLabel:"Chat"},NPA_ORCHESTRATOR:{label:"Orchestrations",value:"1,892",actionLabel:"Status"},IDEATION:{label:"Creates",value:"1,248",actionLabel:"Start"},CLASSIFIER:{label:"Confidence",value:"88%",actionLabel:"Classify"},ML_PREDICT:{label:"Accuracy",value:"92%",actionLabel:"Predict"},RISK:{label:"Catch Rate",value:"96%",actionLabel:"Scan"},GOVERNANCE:{label:"SLA Met",value:"94%",actionLabel:"Route"},DILIGENCE:{label:"Docs",value:"200+",actionLabel:"Ask"},DOC_LIFECYCLE:{label:"Validated",value:"3,412",actionLabel:"Check"},MONITORING:{label:"Products",value:"156",actionLabel:"Monitor"},KB_SEARCH:{label:"Hit Rate",value:"94%",actionLabel:"Search"},NOTIFICATION:{label:"Sent",value:"8,923",actionLabel:"View"}},xe=class n{difyBase=T(ce);http=T(re);getCapabilities(){return te(Q.map(t=>{let e=Kt[t.id]||{label:"Tasks",value:"0",actionLabel:"Run"};return{id:t.id,name:t.name,description:t.description,icon:t.icon,stats:{label:e.label,value:e.value},actionLabel:e.actionLabel,color:qt[t.id]||"blue",status:"active",tier:t.tier,difyType:t.difyType}})).pipe(gt(300))}getAgentStatuses(){return this.http.get("/api/dify/agents/status").pipe(ke(t=>t.agents),ne(()=>te(Q.map(t=>({id:t.id,name:t.name,tier:t.tier,type:t.difyType,icon:t.icon,color:t.color,status:"ready"})))))}getActiveWorkItems(){return te([{id:"JOB-991",agentName:"Classification",operation:"Classifying TSG2025-041",status:"completed",duration:"450ms",color:"purple"},{id:"JOB-990",agentName:"Governance",operation:"Creating sign-off requests",status:"waiting",duration:"12m",color:"slate"},{id:"JOB-989",agentName:"KB Search",operation:'Searching "MAS_Guidelines.pdf"',status:"completed",duration:"890ms",color:"fuchsia"},{id:"JOB-988",agentName:"Risk Agent",operation:"4-layer risk cascade",status:"running",duration:"2.1s",color:"red"}]).pipe(gt(300))}getAgentHealth(){return this.http.get("/api/dify/agents/health").pipe(ke(t=>{let e=t.summary||{},i=t.metrics||{},o="healthy";e.unhealthy>0?o="down":e.degraded>0&&(o="degraded");let u=(t.agents||[]).filter(h=>h.status==="HEALTHY"||h.status==="DEGRADED"),g=u.reduce((h,S)=>h+(S.latency_ms||0),0),C=u.length>0?Math.round(g/u.length):0;return{status:o,latency:C,uptime:99.9,activeAgents:e.healthy||0,totalAgents:e.total||13,totalDecisions:i.totalDecisions||0,confidenceScore:i.confidenceScore||87,toolsUsed:i.toolsUsed||54,kbsConnected:i.kbsConnected||0,kbRecords:i.kbRecords||0}}),ne(()=>te({status:"down",latency:0,uptime:0,activeAgents:0,totalAgents:13,totalDecisions:0,confidenceScore:0,toolsUsed:0,kbsConnected:0,kbRecords:0})))}getConnectedKnowledgeBases(){return this.http.get("/api/dify/datasets").pipe(ke(t=>t.data||[]),ne(()=>te([])))}getAgentActivityStream(){return this.difyBase.getAgentActivity()}getAgentsByTier(){return[{tier:1,label:"Strategic Command",agents:Q.filter(t=>t.tier===1)},{tier:2,label:"Domain Orchestration",agents:Q.filter(t=>t.tier===2)},{tier:3,label:"Specialist Workers",agents:Q.filter(t=>t.tier===3)},{tier:4,label:"Shared Utilities",agents:Q.filter(t=>t.tier===4)}]}static \u0275fac=function(e){return new(e||n)};static \u0275prov=we({token:n,factory:n.\u0275fac,providedIn:"root"})};function Wt(n,t){n&1&&(r(0,"div",14)(1,"div",15)(2,"p")(3,"span",16),l(4,"How it works:"),a(),l(5," This agent uses Dify workflows to orchestrate the process."),a(),r(6,"div",17)(7,"span",18),l(8,"Model: GPT-4o"),a(),r(9,"span",18),l(10,"Tools: 3"),a()(),r(11,"button",19),l(12," Launch Full Mode "),a()()())}var Ye=class n{capability;isExpanded=!1;action=new R;expand=new R;onActionClick(t){t.stopPropagation(),this.action.emit()}toggleExpand(){this.expand.emit()}getHoverClass(t){return{blue:"hover:border-blue-200",purple:"hover:border-purple-200",amber:"hover:border-amber-200",green:"hover:border-green-200",indigo:"hover:border-indigo-200",red:"hover:border-red-200"}[t]||"hover:border-slate-200"}getIconBgClass(t){return{blue:"bg-blue-50 text-blue-600",purple:"bg-purple-50 text-purple-600",amber:"bg-amber-50 text-amber-600",green:"bg-green-50 text-green-600",indigo:"bg-indigo-50 text-indigo-600",red:"bg-red-50 text-red-600"}[t]||"bg-slate-50 text-slate-600"}getTextClass(t){return{blue:"text-blue-600",purple:"text-purple-600",amber:"text-amber-600",green:"text-green-600",indigo:"text-indigo-600",red:"text-red-600"}[t]||"text-slate-600"}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=E({type:n,selectors:[["app-capability-card"]],inputs:{capability:"capability",isExpanded:"isExpanded"},outputs:{action:"action",expand:"expand"},decls:19,vars:13,consts:[[1,"group","bg-white","rounded-xl","p-5","border","border-slate-200","shadow-sm","hover:shadow-md","transition-all","cursor-pointer","relative","overflow-hidden",3,"click","ngClass"],[1,"flex","justify-between","items-start","mb-4"],[1,"w-10","h-10","rounded-lg","flex","items-center","justify-center","transition-transform","group-hover:scale-110",3,"ngClass"],[1,"w-5","h-5",3,"name"],[1,"text-slate-300","group-hover:text-slate-500","transition-colors"],[1,"w-4","h-4",3,"name"],[1,"font-bold","text-slate-900","mb-1"],[1,"text-sm","text-slate-500","mb-4","transition-all","duration-300"],[1,"flex","items-center","justify-between","text-xs","mt-auto"],[1,"font-mono","text-slate-400"],[1,"font-semibold","text-slate-600"],[1,"font-semibold","transition-transform","group-hover:translate-x-1","flex","items-center","gap-1",3,"click","ngClass"],["name","arrow-right",1,"w-3","h-3"],["class","mt-4 pt-4 border-t border-slate-100 animate-in fade-in slide-in-from-top-2 duration-200",4,"ngIf"],[1,"mt-4","pt-4","border-t","border-slate-100","animate-in","fade-in","slide-in-from-top-2","duration-200"],[1,"text-xs","text-slate-500","space-y-2"],[1,"font-semibold","text-slate-700"],[1,"flex","items-center","gap-2"],[1,"px-1.5","py-0.5","rounded","bg-slate-100","border","border-slate-200","text-[10px]","font-mono"],[1,"w-full","mt-3","py-1.5","rounded-lg","bg-dbs-primary","text-white","font-semibold","hover:bg-dbs-primary-hover","transition-colors"]],template:function(e,i){e&1&&(r(0,"div",0),y("click",function(){return i.toggleExpand()}),r(1,"div",1)(2,"div",2),m(3,"lucide-icon",3),a(),r(4,"div",4),m(5,"lucide-icon",5),a()(),r(6,"h3",6),l(7),a(),r(8,"p",7),l(9),a(),r(10,"div",8)(11,"span",9)(12,"span",10),l(13),a(),l(14),a(),r(15,"button",11),y("click",function(d){return i.onActionClick(d)}),l(16),m(17,"lucide-icon",12),a()(),f(18,Wt,13,0,"div",13),a()),e&2&&(c("ngClass",i.getHoverClass(i.capability.color)),s(2),c("ngClass",i.getIconBgClass(i.capability.color)),s(),c("name",i.capability.icon),s(2),c("name",i.isExpanded?"chevron-up":"chevron-down"),s(2),v(i.capability.name),s(),M("line-clamp-2",!i.isExpanded),s(),x(" ",i.capability.description," "),s(4),v(i.capability.stats.value),s(),x(" ",i.capability.stats.label," "),s(),c("ngClass",i.getTextClass(i.capability.color)),s(),x(" ",i.capability.actionLabel," "),s(2),c("ngIf",i.isExpanded))},dependencies:[N,G,F,U,L],encapsulation:2})};function Yt(n,t){n&1&&(r(0,"span",22),m(1,"span",23),l(2," Running "),a())}function Ht(n,t){n&1&&(r(0,"span",24),m(1,"lucide-icon",25),l(2," Done "),a())}function zt(n,t){n&1&&(r(0,"span",26),m(1,"lucide-icon",27),l(2," Wait "),a())}function Jt(n,t){if(n&1&&(r(0,"div",11)(1,"div",12)(2,"span",13),l(3),a(),r(4,"span",14),l(5),a(),r(6,"span",15),l(7),a()(),r(8,"div",16)(9,"div",17),f(10,Yt,3,0,"span",18)(11,Ht,3,0,"span",19)(12,zt,3,0,"span",20),a(),r(13,"span",21),l(14),a()()()),n&2){let e=t.$implicit,i=p();s(3),v(e.id),s(),c("ngClass",i.getColorClass(e.color)),s(),v(e.agentName),s(2),v(e.operation),s(3),c("ngIf",e.status==="running"),s(),c("ngIf",e.status==="completed"),s(),c("ngIf",e.status==="waiting"),s(2),v(e.duration)}}function Qt(n,t){n&1&&(r(0,"div",28),l(1," No active agent jobs running. "),a())}var He=class n{items=[];getColorClass(t){return{blue:"text-blue-400",purple:"text-purple-400",amber:"text-amber-400",green:"text-green-400",red:"text-red-400",fuchsia:"text-fuchsia-400"}[t]||"text-slate-400"}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=E({type:n,selectors:[["app-work-item-list"]],inputs:{items:"items"},decls:17,vars:2,consts:[[1,"bg-slate-900","rounded-xl","overflow-hidden","shadow-lg","border","border-slate-800","font-mono","text-sm"],[1,"bg-slate-950","px-4","py-2","border-b","border-slate-800","flex","items-center","justify-between","text-xs","text-slate-400"],[1,"flex","gap-4"],[1,"w-20"],[1,"w-32"],[1,"flex","gap-4","mr-8"],[1,"w-24","text-right"],[1,"w-16","text-right"],[1,"divide-y","divide-slate-800/50"],["class","px-4 py-3 flex items-center justify-between hover:bg-white/5 transition-colors group cursor-default",4,"ngFor","ngForOf"],["class","px-4 py-8 text-center text-slate-600 italic",4,"ngIf"],[1,"px-4","py-3","flex","items-center","justify-between","hover:bg-white/5","transition-colors","group","cursor-default"],[1,"flex","gap-4","items-center"],[1,"text-slate-500","w-20"],[1,"font-medium","w-32","truncate",3,"ngClass"],[1,"text-slate-300","truncate","max-w-[200px]","md:max-w-md"],[1,"flex","gap-4","justify-end","items-center"],[1,"w-24","flex","justify-end"],["class","text-green-400 flex items-center gap-1.5",4,"ngIf"],["class","text-slate-500 flex items-center gap-1.5",4,"ngIf"],["class","text-amber-400 flex items-center gap-1.5",4,"ngIf"],[1,"text-slate-600","w-16","text-right","font-mono","text-xs"],[1,"text-green-400","flex","items-center","gap-1.5"],[1,"w-1.5","h-1.5","bg-green-400","rounded-full","animate-pulse"],[1,"text-slate-500","flex","items-center","gap-1.5"],["name","check",1,"w-3","h-3"],[1,"text-amber-400","flex","items-center","gap-1.5"],["name","clock",1,"w-3","h-3"],[1,"px-4","py-8","text-center","text-slate-600","italic"]],template:function(e,i){e&1&&(r(0,"div",0)(1,"div",1)(2,"div",2)(3,"span",3),l(4,"JOB ID"),a(),r(5,"span",4),l(6,"AGENT"),a(),r(7,"span"),l(8,"OPERATION"),a()(),r(9,"div",5)(10,"span",6),l(11,"STATUS"),a(),r(12,"span",7),l(13,"TIME"),a()()(),r(14,"div",8),f(15,Jt,15,8,"div",9)(16,Qt,2,0,"div",10),a()()),e&2&&(s(15),c("ngForOf",i.items),s(),c("ngIf",i.items.length===0))},dependencies:[N,G,V,F,U,L],encapsulation:2})};var ze=class n{constructor(t){this.difyService=t}metrics={status:"down",latency:0,uptime:0,activeAgents:0,totalAgents:13,totalDecisions:0,confidenceScore:0,toolsUsed:0,kbsConnected:0,kbRecords:0};kbs=[];totalKbRecords=0;ngOnInit(){this.difyService.getConnectedKnowledgeBases().subscribe(t=>{this.kbs=t,this.totalKbRecords=t.reduce((e,i)=>e+(i.document_count||i.total_documents||0),0)})}formatNumber(t){return t?t>=1e3?(t/1e3).toFixed(1)+"k":t.toString():"0"}static \u0275fac=function(e){return new(e||n)(ye(xe))};static \u0275cmp=E({type:n,selectors:[["app-agent-health-panel"]],inputs:{metrics:"metrics"},decls:60,vars:15,consts:[[1,"bg-white","rounded-xl","border","border-slate-200","overflow-hidden","shadow-sm","mt-8"],[1,"bg-slate-50","px-6","py-3","border-b","border-slate-200","flex","items-center","justify-between"],[1,"flex","items-center","gap-2"],["name","activity",1,"w-4","h-4","text-slate-500"],[1,"text-xs","font-bold","uppercase","tracking-widest","text-slate-600"],[1,"flex","items-center","gap-2","text-xs"],[1,"flex","items-center","gap-1.5","px-2","py-0.5","rounded-full","bg-green-100","text-green-700","font-medium"],[1,"w-1.5","h-1.5","bg-green-500","rounded-full","animate-pulse"],[1,"text-slate-400"],[1,"grid","grid-cols-2","md:grid-cols-4","divide-x","divide-slate-100"],[1,"p-4","flex","items-center","gap-4"],[1,"w-10","h-10","rounded-full","bg-green-50","text-green-600","flex","items-center","justify-center"],["name","heart-pulse",1,"w-5","h-5"],[1,"text-2xl","font-mono","font-bold","text-slate-900"],[1,"text-sm","font-sans","text-slate-500","font-normal","ml-1"],[1,"text-xs","text-slate-500","font-medium","uppercase"],[1,"flex","items-center","gap-1","mt-1"],[1,"h-1.5","flex-1","bg-green-500","rounded-full"],[1,"h-1.5","bg-slate-200","rounded-full"],[1,"w-10","h-10","rounded-full","bg-indigo-50","text-indigo-600","flex","items-center","justify-center"],["name","gauge",1,"w-5","h-5"],[1,"h-1.5","rounded-full",3,"ngClass"],[1,"w-10","h-10","rounded-full","bg-purple-50","text-purple-600","flex","items-center","justify-center"],["name","wrench",1,"w-5","h-5"],[1,"text-[10px]","text-slate-400","mt-0.5"],[1,"p-4","flex","items-center","gap-4","hover:bg-slate-50"],[1,"w-10","h-10","rounded-full","bg-amber-50","text-amber-600","flex","items-center","justify-center"],["name","book-open",1,"w-5","h-5"],[1,"flex-1","flex","items-center","justify-between"]],template:function(e,i){e&1&&(r(0,"div",0)(1,"div",1)(2,"div",2),m(3,"lucide-icon",3),r(4,"h3",4),l(5,"System Health & Performance"),a()(),r(6,"div",5)(7,"span",6),m(8,"span",7),l(9," Systems Operational "),a(),r(10,"span",8),l(11,"Last updated: Just now"),a()()(),r(12,"div",9)(13,"div",10)(14,"div",11),m(15,"lucide-icon",12),a(),r(16,"div")(17,"p",13),l(18),r(19,"span",14),l(20),a()(),r(21,"p",15),l(22,"Agents Healthy"),a(),r(23,"div",16),m(24,"div",17)(25,"div",18),a()()(),r(26,"div",10)(27,"div",19),m(28,"lucide-icon",20),a(),r(29,"div")(30,"p",13),l(31),r(32,"span",14),l(33,"%"),a()(),r(34,"p",15),l(35,"Confidence Score"),a(),r(36,"div",16),m(37,"div",21)(38,"div",18),a()()(),r(39,"div",10)(40,"div",22),m(41,"lucide-icon",23),a(),r(42,"div")(43,"p",13),l(44),a(),r(45,"p",15),l(46,"Tools Connected"),a(),r(47,"p",24),l(48,"MCP, APIs, Workflows"),a()()(),r(49,"div",25)(50,"div",26),m(51,"lucide-icon",27),a(),r(52,"div",28)(53,"div")(54,"p",13),l(55),a(),r(56,"p",15),l(57,"KBs Connected"),a(),r(58,"p",24),l(59),a()()()()()()),e&2&&(s(18),v(i.metrics.activeAgents),s(2),x("/ ",i.metrics.totalAgents||13),s(4),H("width",i.metrics.activeAgents/(i.metrics.totalAgents||13)*100,"%"),s(),H("width",100-i.metrics.activeAgents/(i.metrics.totalAgents||13)*100,"%"),s(6),v(i.metrics.confidenceScore||0),s(6),H("width",i.metrics.confidenceScore||0,"%"),c("ngClass",(i.metrics.confidenceScore||0)>=80?"bg-green-500":(i.metrics.confidenceScore||0)>=60?"bg-amber-500":"bg-rose-500"),s(),H("width",100-(i.metrics.confidenceScore||0),"%"),s(6),v(i.metrics.toolsUsed||0),s(11),v(i.kbs.length||i.metrics.kbsConnected||0),s(4),x("",i.formatNumber(i.totalKbRecords||i.metrics.kbRecords||0)," records indexed"))},dependencies:[N,G,U,L],encapsulation:2})};function Xt(n,t){if(n&1){let e=I();r(0,"tr",15)(1,"td",16)(2,"a",17),y("click",function(){let o=_(e).$implicit,d=p();return b(d.onViewDetail.emit(o.id))}),l(3),a()(),r(4,"td",18),l(5),a(),r(6,"td",18)(7,"span",19),l(8),a()(),r(9,"td",18)(10,"span",20),l(11),a()(),r(12,"td",18)(13,"div",21),l(14),a()(),r(15,"td",18)(16,"div",22),m(17,"lucide-icon",23),l(18),a()(),r(19,"td",18)(20,"span",24),l(21),a()(),r(22,"td",18)(23,"span",25),l(24),a()(),r(25,"td",18)(26,"button",26),y("click",function(){let o=_(e).$implicit,d=p();return b(d.onViewDetail.emit(o.id))}),m(27,"lucide-icon",27),a()()()}if(n&2){let e=t.$implicit,i=p();s(3),x(" ",e.id," "),s(2),v(e.name),s(3),v(e.productType),s(3),v(e.businessUnit),s(3),x(" ",e.currentStage," "),s(2),c("ngClass",i.getStatusClasses(e.status)),s(),c("name",i.getStatusIcon(e.status)),s(),x(" ",i.getStatusLabel(e.status)," "),s(2),c("ngClass",i.getDaysClasses(e.daysInStage)),s(),x(" ",e.daysInStage,"d "),s(3),v(e.owner)}}var Je=class n{onViewDetail=new R;pipelineData=[];npaService=T(be);constructor(){}ngOnInit(){this.npaService.getAll().subscribe({next:t=>{this.pipelineData=t.map(e=>({id:e.id,name:e.title||"Untitled",productType:e.npa_type||"New Product",businessUnit:e.pm_team||"Global Fin. Markets",currentStage:this.mapStage(e.current_stage),status:this.mapStatus(e.status),daysInStage:Math.floor((Date.now()-new Date(e.created_at).getTime())/(1e3*3600*24)),owner:e.submitted_by||"Unknown",lastUpdated:new Date(e.updated_at||e.created_at).toLocaleDateString()}))},error:t=>console.error("Failed to load NPA pipeline from API",t)})}mapStatus(t){switch(t){case"On Track":return"on-track";case"At Risk":return"at-risk";case"Blocked":return"blocked";case"Completed":return"completed";case"Warning":return"at-risk";default:return"on-track"}}mapStage(t){return{IDEATION:"Prospect (Ideation)",INITIATION:"Initiation",DISCOVERY:"Discovery",REVIEW:"Review",DCE_REVIEW:"Review",RETURNED_TO_MAKER:"Review",RISK_ASSESSMENT:"Sign-Off",GOVERNANCE:"Pre Launch",SIGN_OFF:"Sign-Off",PENDING_SIGN_OFFS:"Sign-Off",PENDING_FINAL_APPROVAL:"Pre Launch",APPROVED:"Pre Launch",LAUNCH_PREP:"Pre Launch",UAT:"Pre Launch",LAUNCH:"Launch",LAUNCHED:"Launch",PIR:"PIR / Monitoring",MONITORING:"PIR / Monitoring"}[t]||t||"Discovery"}getStatusClasses(t){return{"on-track":"bg-[hsl(var(--status-completed-bg))] text-[hsl(var(--status-completed))]","at-risk":"bg-amber-500/10 text-amber-600",blocked:"bg-[hsl(var(--status-exception-bg))] text-[hsl(var(--status-exception))]",completed:"bg-[hsl(var(--status-completed-bg))] text-[hsl(var(--status-completed))]"}[t]||""}getStatusIcon(t){return{"on-track":"check-circle-2","at-risk":"alert-triangle",blocked:"alert-triangle",completed:"check-circle-2"}[t]||"circle"}getStatusLabel(t){return{"on-track":"On Track","at-risk":"At Risk",blocked:"Blocked",completed:"Completed"}[t]||t}getDaysClasses(t){return t>7?"text-[hsl(var(--status-exception))] font-medium":t>5?"text-amber-600 font-medium":"text-sm"}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=E({type:n,selectors:[["app-npa-pipeline-table"]],outputs:{onViewDetail:"onViewDetail"},decls:32,vars:1,consts:[[1,"rounded-xl","border","border-border/50","bg-card","text-card-foreground","shadow-sm"],[1,"p-6","pb-3"],[1,"flex","items-center","justify-between"],[1,"text-lg","font-semibold","flex","items-center","gap-2"],["name","file-text",1,"w-5","h-5","text-muted-foreground"],[1,"inline-flex","items-center","justify-center","rounded-md","text-sm","font-medium","transition-colors","border","border-input","bg-transparent","shadow-sm","hover:bg-accent","hover:text-accent-foreground","h-9","px-3"],[1,"p-6","pt-0"],[1,"w-full","overflow-auto"],[1,"w-full","caption-bottom","text-sm"],[1,"[&_tr]:border-b"],[1,"border-b","transition-colors","hover:bg-muted/50","data-[state=selected]:bg-muted"],[1,"h-10","px-2","text-left","align-middle","font-medium","text-muted-foreground"],[1,"h-10","px-2","text-left","align-middle","font-medium","text-muted-foreground","w-[50px]"],[1,"[&_tr:last-child]:border-0"],["class","border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted group",4,"ngFor","ngForOf"],[1,"border-b","transition-colors","hover:bg-muted/50","data-[state=selected]:bg-muted","group"],[1,"p-2","align-middle","font-medium"],[1,"text-primary","hover:underline","cursor-pointer",3,"click"],[1,"p-2","align-middle"],[1,"text-xs","text-muted-foreground"],[1,"text-xs"],[1,"inline-flex","items-center","rounded-md","border","px-2.5","py-0.5","text-xs","font-semibold","transition-colors","focus:outline-none","focus:ring-2","focus:ring-ring","focus:ring-offset-2","text-foreground","border-border/50"],[1,"inline-flex","items-center","rounded-md","border","px-2.5","py-0.5","text-xs","font-semibold","transition-colors","focus:outline-none","focus:ring-2","focus:ring-ring","focus:ring-offset-2","gap-1","border-transparent",3,"ngClass"],[1,"w-3","h-3",3,"name"],[3,"ngClass"],[1,"text-sm","text-muted-foreground"],[1,"inline-flex","items-center","justify-center","rounded-md","text-sm","font-medium","transition-colors","hover:bg-accent","hover:text-accent-foreground","h-8","w-8","opacity-0","group-hover:opacity-100",3,"click"],["name","arrow-right",1,"w-4","h-4"]],template:function(e,i){e&1&&(r(0,"div",0)(1,"div",1)(2,"div",2)(3,"h3",3),m(4,"lucide-icon",4),l(5," NPA Pipeline "),a(),r(6,"button",5),l(7," View All NPAs "),a()()(),r(8,"div",6)(9,"div",7)(10,"table",8)(11,"thead",9)(12,"tr",10)(13,"th",11),l(14,"NPA ID"),a(),r(15,"th",11),l(16,"Product Name"),a(),r(17,"th",11),l(18,"Type"),a(),r(19,"th",11),l(20,"Business Unit"),a(),r(21,"th",11),l(22,"Current Stage"),a(),r(23,"th",11),l(24,"Status"),a(),r(25,"th",11),l(26,"Days in Stage"),a(),r(27,"th",11),l(28,"Owner"),a(),m(29,"th",12),a()(),r(30,"tbody",13),f(31,Xt,28,11,"tr",14),a()()()()()),e&2&&(s(31),c("ngForOf",i.pipelineData))},dependencies:[N,G,V,U,L,Oe],encapsulation:2})};var Zt=()=>[];function ei(n,t){if(n&1){let e=I();r(0,"button",30),y("click",function(){_(e);let o=p();return b(o.onContinueDraft())}),m(1,"lucide-icon",80),l(2," Continue Draft "),a()}}function ti(n,t){if(n&1){let e=I();r(0,"button",30),y("click",function(){_(e);let o=p();return b(o.onOpenWorkspaceInbox())}),m(1,"lucide-icon",81),l(2," My Inbox "),a()}}function ii(n,t){if(n&1){let e=I();r(0,"app-capability-card",82),y("expand",function(){let o=_(e).$implicit,d=p();return b(d.onCardExpand(o.id))})("action",function(){let o=_(e).$implicit,d=p();return b(d.onCapabilityAction(o.id))}),a()}if(n&2){let e=t.$implicit,i=p();c("capability",e)("isExpanded",i.expandedCardId===e.id)}}function ni(n,t){if(n&1&&(r(0,"div",88)(1,"div",89),m(2,"lucide-icon",90),a(),r(3,"div",91)(4,"h4",92),l(5),a(),r(6,"p",93),l(7,"Ready"),a()()()),n&2){let e=t.$implicit;s(),c("ngClass",e.color),s(),c("name",e.icon),s(3),v(e.name)}}function ri(n,t){if(n&1&&(r(0,"section")(1,"div",34)(2,"div",83),m(3,"lucide-icon",84),a(),r(4,"h2",37),l(5," Tier 3 \u2014 Specialist Workers "),a(),r(6,"span",85),l(7),a()(),r(8,"div",86),f(9,ni,8,3,"div",87),a()()),n&2){let e=p();s(7),x("",e.tier3Agents.length," Agents"),s(2),c("ngForOf",e.tier3Agents)}}function ai(n,t){if(n&1&&(r(0,"div",101)(1,"div",102),m(2,"lucide-icon",103),a(),r(3,"div",104)(4,"h4",105),l(5),a(),r(6,"p",106),l(7),a()(),r(8,"div",107)(9,"span",108),l(10),a(),r(11,"span",109),l(12,"Chatflow"),a()()()),n&2){let e=t.$implicit;s(),c("ngClass",e.color),s(),c("name",e.icon),s(3),v(e.name),s(2),v(e.description),s(3),x("Tier ",e.tier)}}function oi(n,t){if(n&1&&(r(0,"div",101)(1,"div",102),m(2,"lucide-icon",103),a(),r(3,"div",104)(4,"h4",105),l(5),a(),r(6,"p",106),l(7),a()(),r(8,"span",109),l(9,"Ready"),a()()),n&2){let e=t.$implicit;s(),c("ngClass",e.color),s(),c("name",e.icon),s(3),v(e.name),s(2),v(e.description)}}function si(n,t){if(n&1&&(r(0,"section")(1,"div",94)(2,"div")(3,"div",95)(4,"div",96),m(5,"lucide-icon",97),a(),r(6,"h2",37),l(7," Tier 1-2 \u2014 Orchestrators "),a()(),r(8,"div",10),f(9,ai,13,5,"div",98),a()(),r(10,"div")(11,"div",95)(12,"div",99),m(13,"lucide-icon",100),a(),r(14,"h2",37),l(15," Tier 4 \u2014 Shared Utilities "),a()(),r(16,"div",10),f(17,oi,10,4,"div",98),a()()()()),n&2){let e=p();s(9),c("ngForOf",e.orchestratorAgents),s(8),c("ngForOf",e.tier4Agents)}}function li(n,t){n&1&&(r(0,"section")(1,"div",43)(2,"div",44)(3,"div",99),m(4,"lucide-icon",100),a(),r(5,"h2",37),l(6," Infrastructure & Tooling "),a()()(),r(7,"div",110)(8,"div",111)(9,"div",112)(10,"span",113),m(11,"lucide-icon",114),a(),m(12,"div",115),a(),r(13,"h4",116),l(14,"Dify LLM Platform"),a(),r(15,"div",117)(16,"div",118)(17,"span"),l(18,"Agents"),a(),r(19,"span",119),l(20,"13"),a()(),r(21,"div",118)(22,"span"),l(23,"Status"),a(),r(24,"span",119),l(25,"Online"),a()()()(),r(26,"div",111)(27,"div",112)(28,"span",120),m(29,"lucide-icon",121),a(),m(30,"div",115),a(),r(31,"h4",116),l(32,"MCP Tools"),a(),r(33,"div",117)(34,"div",118)(35,"span"),l(36,"Tools"),a(),r(37,"span",119),l(38,"50+"),a()(),r(39,"div",118)(40,"span"),l(41,"Port"),a(),r(42,"span",119),l(43,"3002"),a()()()(),r(44,"div",111)(45,"div",112)(46,"span",122),m(47,"lucide-icon",123),a(),m(48,"div",115),a(),r(49,"h4",116),l(50,"MariaDB"),a(),r(51,"div",117)(52,"div",118)(53,"span"),l(54,"Tables"),a(),r(55,"span",119),l(56,"42"),a()(),r(57,"div",118)(58,"span"),l(59,"Records"),a(),r(60,"span",119),l(61,"14.5k"),a()()()(),r(62,"div",111)(63,"div",112)(64,"span",124),m(65,"lucide-icon",125),a(),m(66,"div",115),a(),r(67,"h4",116),l(68,"Audit Logger"),a(),r(69,"div",117)(70,"div",118)(71,"span"),l(72,"Logs"),a(),r(73,"span",119),l(74,"3.4k"),a()(),r(75,"div",118)(76,"span"),l(77,"Coverage"),a(),r(78,"span",119),l(79,"100%"),a()()()(),r(80,"div",111)(81,"div",112)(82,"span",126),m(83,"lucide-icon",127),a(),m(84,"div",115),a(),r(85,"h4",116),l(86,"Express Proxy"),a(),r(87,"div",117)(88,"div",118)(89,"span"),l(90,"Routes"),a(),r(91,"span",119),l(92,"15"),a()(),r(93,"div",118)(94,"span"),l(95,"Port"),a(),r(96,"span",119),l(97,"3000"),a()()()()()())}function di(n,t){n&1&&(r(0,"div",128),m(1,"lucide-icon",129),l(2," Loading Knowledge Bases... "),a())}function ci(n,t){if(n&1&&(r(0,"div",130)(1,"div",131)(2,"div",132),m(3,"lucide-icon",57),a(),r(4,"div")(5,"h4",133),l(6),ie(7,"slice"),a(),r(8,"p",134),l(9),a()()(),r(10,"div",44)(11,"span",135),l(12,"SYNCED"),a(),m(13,"lucide-icon",136),a()()),n&2){let e=t.$implicit;s(5),c("title",e.name),s(),Y("",ft(7,5,e.name,0,30),"",e.name.length>30?"...":""),s(3),Y("",e.document_count||e.total_documents||0," records \u2022 ",e.provider||"Dify")}}var Qe=class n{navigateToCreate=new R;navigateToDraft=new R;navigateToDetail=new R;difyService=T(xe);userService=T(Ve);dashboardService=T(Bt);npaService=T(be);router=T(Le);userRole=()=>this.userService.currentUser().role;capabilities$=this.difyService.getCapabilities();workItems$=this.difyService.getActiveWorkItems();healthMetrics$=this.difyService.getAgentHealth();expandedCardId=null;seedingDemo=!1;emptyMetrics={status:"down",latency:0,uptime:0,activeAgents:0,totalAgents:13,totalDecisions:0};heroActiveNpas=0;heroApprovalRate=0;heroAvgCycle=0;tier3Agents=Q.filter(t=>t.tier===3);tier4Agents=Q.filter(t=>t.tier===4);orchestratorAgents=Q.filter(t=>t.tier===1||t.tier===2);difyKbs=[];constructor(){}ngOnInit(){this.loadHeroStats(),this.loadDifyKbs()}loadHeroStats(){this.dashboardService.getKpis().subscribe({next:t=>{let e=u=>t.find(g=>g.label.includes(u)),i=e("Pipeline"),o=e("Approval"),d=e("Cycle");if(i?.subValue){let u=i.subValue.match(/(\d+)/);u&&(this.heroActiveNpas=parseInt(u[1],10))}else this.heroActiveNpas=Math.round(i?.value||0);this.heroApprovalRate=Math.round(o?.value||0),this.heroAvgCycle=Math.round(d?.value||0)},error:t=>console.warn("[NpaDashboard] Failed to load hero KPIs",t)})}loadDifyKbs(){this.difyService.getConnectedKnowledgeBases().subscribe({next:t=>{this.difyKbs=t||[]},error:t=>console.warn("[NpaDashboard] Failed to load Dify KBs",t)})}onCreateNew(){this.navigateToCreate.emit()}onContinueDraft(){this.navigateToDraft.emit()}onSearchKb(){this.router.navigate(["/knowledge/base"])}onOpenWorkspaceDrafts(){this.router.navigate(["/workspace/drafts"])}onOpenWorkspaceInbox(){this.router.navigate(["/workspace/inbox"])}onSeedDemo(){console.log("Seed demo clicked")}onCardExpand(t){this.expandedCardId===t?this.expandedCardId=null:this.expandedCardId=t}onCapabilityAction(t){console.log("[DifyAgentService] Triggering capability:",t),t==="create_npa"&&this.onCreateNew()}onViewDetail(t){this.navigateToDetail.emit(t)}onViewAll(t){console.log("Viewing all for section:",t)}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=E({type:n,selectors:[["app-npa-dashboard"]],outputs:{navigateToCreate:"navigateToCreate",navigateToDraft:"navigateToDraft",navigateToDetail:"navigateToDetail"},decls:153,vars:24,consts:[[1,"min-h-screen","bg-slate-50/50","pb-20","font-sans"],[1,"bg-white","border-b","border-slate-200","pt-8","pb-10","px-6","sm:px-10","shadow-sm","relative","overflow-hidden"],[1,"absolute","top-0","right-0","w-96","h-96","bg-blue-50","rounded-full","blur-3xl","opacity-50","-translate-y-1/2","translate-x-1/3","pointer-events-none"],[1,"max-w-7xl","mx-auto","flex","flex-col","md:flex-row","items-center","justify-between","gap-8","relative","z-10"],[1,"flex","items-start","gap-6"],[1,"relative","group","cursor-pointer"],[1,"w-20","h-20","rounded-2xl","bg-gradient-to-br","from-indigo-600","to-blue-600","flex","items-center","justify-center","shadow-lg","shadow-blue-200","ring-4","ring-white"],["name","bot",1,"w-10","h-10","text-white"],[1,"absolute","-bottom-1","-right-1","w-6","h-6","bg-white","rounded-full","flex","items-center","justify-center"],[1,"w-4","h-4","bg-green-500","rounded-full","ring-2","ring-white","animate-pulse"],[1,"space-y-3"],[1,"text-3xl","font-bold","text-slate-900","tracking-tight","flex","items-center","gap-3"],[1,"px-2.5","py-0.5","rounded-full","bg-blue-50","text-blue-700","text-xs","font-bold","border","border-blue-100","uppercase","tracking-wide"],[1,"text-lg","text-slate-500","max-w-2xl","leading-relaxed","mt-1"],[1,"flex","items-center","gap-6","text-sm","font-medium","text-slate-600","bg-slate-50","inline-flex","px-4","py-2","rounded-lg","border","border-slate-200/60"],[1,"flex","items-center","gap-1.5","hover:text-indigo-600","transition-colors","cursor-help"],["name","database",1,"w-4","h-4","text-indigo-500"],[1,"w-px","h-4","bg-slate-300"],[1,"flex","items-center","gap-1.5","hover:text-green-600","transition-colors","cursor-help"],["name","zap",1,"w-4","h-4","text-amber-500"],[1,"flex","items-center","gap-1.5","hover:text-purple-600","transition-colors","cursor-help"],["name","brain-circuit",1,"w-4","h-4","text-purple-500"],[1,"flex","flex-col","gap-3","w-full","md:w-[420px]"],[1,"group","relative","inline-flex","items-center","justify-center","gap-3","px-8","py-4","bg-dbs-primary","hover:bg-dbs-primary-hover","text-white","rounded-xl","font-bold","text-lg","shadow-xl","transition-all","transform","hover:-translate-y-0.5","active:translate-y-0","focus:ring-4","focus:ring-blue-100",3,"click"],["name","message-square",1,"w-6","h-6"],[1,"absolute","right-0","top-0","-mt-1","-mr-1","flex","h-3","w-3"],[1,"animate-ping","absolute","inline-flex","h-full","w-full","rounded-full","bg-sky-400","opacity-75"],[1,"relative","inline-flex","rounded-full","h-3","w-3","bg-sky-500"],[1,"grid","grid-cols-2","gap-2"],["class","px-4 py-2 bg-white border border-dbs-border text-slate-700 rounded-lg text-sm font-semibold hover:bg-slate-50 hover:text-slate-900 transition-colors flex items-center justify-center gap-2 whitespace-nowrap",3,"click",4,"ngIf"],[1,"px-4","py-2","bg-white","border","border-dbs-border","text-slate-700","rounded-lg","text-sm","font-semibold","hover:bg-slate-50","hover:text-slate-900","transition-colors","flex","items-center","justify-center","gap-2","whitespace-nowrap",3,"click"],["name","search",1,"w-3.5","h-3.5"],[1,"max-w-7xl","mx-auto","px-6","sm:px-10","space-y-12","mt-12"],[3,"metrics"],[1,"flex","items-center","gap-3","mb-6"],[1,"p-2","bg-blue-100","text-blue-700","rounded-lg"],["name","target",1,"w-5","h-5"],[1,"text-sm","font-bold","text-slate-700","uppercase","tracking-widest"],[1,"grid","grid-cols-1","md:grid-cols-2","lg:grid-cols-4","gap-5"],[3,"capability","isExpanded","expand","action",4,"ngFor","ngForOf"],[4,"ngIf"],[1,"grid","grid-cols-1","lg:grid-cols-2","gap-8","items-stretch"],[1,"h-full","flex","flex-col"],[1,"flex","items-center","justify-between","mb-6"],[1,"flex","items-center","gap-3"],[1,"p-2","bg-purple-100","text-purple-700","rounded-lg"],["name","book-open",1,"w-5","h-5"],[1,"text-xs","font-bold","text-purple-600","bg-purple-50","border","border-purple-100","px-3","py-1.5","rounded-lg","hover:bg-purple-100","transition-colors","flex","items-center","gap-1.5",3,"click"],["name","plus",1,"w-3","h-3"],[1,"bg-white","border","border-slate-200","rounded-xl","overflow-hidden","shadow-sm","flex-1","flex","flex-col"],[1,"divide-y","divide-slate-100","min-h-[160px]"],["class","p-6 text-center text-slate-500 text-sm flex flex-col items-center gap-2",4,"ngIf"],["class","p-4 flex items-center justify-between hover:bg-slate-50 transition-colors cursor-pointer group",4,"ngFor","ngForOf"],[1,"bg-slate-50","px-4","py-2","border-t","border-slate-200","text-center","mt-auto"],[1,"text-xs","font-semibold","text-slate-500","hover:text-slate-800","flex","items-center","justify-center","gap-1","w-full",3,"click"],["name","arrow-right",1,"w-3","h-3"],[1,"p-2","bg-amber-100","text-amber-700","rounded-lg"],["name","database",1,"w-5","h-5"],[1,"text-xs","font-bold","text-amber-600","bg-amber-50","border","border-amber-100","px-3","py-1.5","rounded-lg","hover:bg-amber-100","transition-colors","flex","items-center","gap-1.5",3,"click"],[1,"p-4","space-y-4","flex-1"],[1,"flex","items-center","justify-between"],[1,"w-8","h-8","rounded","bg-slate-100","flex","items-center","justify-center","text-slate-600"],["name","activity",1,"w-4","h-4"],[1,"text-sm","font-bold","text-slate-900"],[1,"text-[10px]","text-slate-500"],[1,"w-2.5","h-2.5","rounded-full","bg-green-500","animate-pulse"],[1,"w-full","h-px","bg-slate-100"],["name","shield",1,"w-4","h-4"],[1,"w-2.5","h-2.5","rounded-full","bg-green-500"],["name","share-2",1,"w-4","h-4"],[1,"w-2.5","h-2.5","rounded-full","bg-yellow-400","animate-pulse"],[1,"flex","items-center","justify-between","opacity-60"],["name","send",1,"w-4","h-4"],[1,"w-2.5","h-2.5","rounded-full","bg-slate-300"],[1,"p-2","bg-sky-100","text-sky-700","rounded-lg"],["name","cpu",1,"w-5","h-5"],[3,"items"],[1,"p-2","bg-emerald-100","text-emerald-700","rounded-lg"],["name","file-text",1,"w-5","h-5"],[3,"onViewDetail"],["name","file-edit",1,"w-3.5","h-3.5"],["name","inbox",1,"w-3.5","h-3.5"],[3,"expand","action","capability","isExpanded"],[1,"p-2","bg-indigo-100","text-indigo-700","rounded-lg"],["name","bot",1,"w-5","h-5"],[1,"px-2","py-0.5","rounded-full","bg-indigo-50","text-indigo-600","text-xs","font-bold","border","border-indigo-100"],[1,"grid","grid-cols-2","md:grid-cols-3","lg:grid-cols-5","gap-4"],["class","bg-white rounded-lg p-4 border border-slate-200 shadow-sm flex items-center gap-3 hover:shadow-md hover:border-slate-300 transition-all cursor-default group",4,"ngFor","ngForOf"],[1,"bg-white","rounded-lg","p-4","border","border-slate-200","shadow-sm","flex","items-center","gap-3","hover:shadow-md","hover:border-slate-300","transition-all","cursor-default","group"],[1,"w-10","h-10","rounded-full","flex","items-center","justify-center","border",3,"ngClass"],[1,"w-5","h-5",3,"name"],[1,"min-w-0"],[1,"font-bold","text-sm","text-slate-700","truncate"],[1,"text-[10px]","uppercase","tracking-wide","font-semibold","text-green-600"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-6"],[1,"flex","items-center","gap-3","mb-4"],[1,"p-2","bg-violet-100","text-violet-700","rounded-lg"],["name","brain-circuit",1,"w-5","h-5"],["class","bg-white rounded-lg p-4 border border-slate-200 shadow-sm flex items-center gap-4 hover:shadow-md transition-all",4,"ngFor","ngForOf"],[1,"p-2","bg-slate-200","text-slate-700","rounded-lg"],["name","layers",1,"w-5","h-5"],[1,"bg-white","rounded-lg","p-4","border","border-slate-200","shadow-sm","flex","items-center","gap-4","hover:shadow-md","transition-all"],[1,"w-12","h-12","rounded-xl","flex","items-center","justify-center","border",3,"ngClass"],[1,"w-6","h-6",3,"name"],[1,"flex-1","min-w-0"],[1,"font-bold","text-sm","text-slate-900"],[1,"text-xs","text-slate-500","truncate"],[1,"flex","items-center","gap-2"],[1,"px-2","py-0.5","rounded-full","text-[10px]","font-bold","bg-violet-50","text-violet-600","border","border-violet-100"],[1,"px-2","py-0.5","rounded-full","text-[10px]","font-bold","bg-green-50","text-green-600","border","border-green-100"],[1,"grid","grid-cols-2","md:grid-cols-3","lg:grid-cols-5","gap-3"],[1,"bg-slate-50","border","border-slate-200","rounded-lg","p-3","hover:bg-white","hover:border-slate-300","transition-colors","group"],[1,"flex","items-center","justify-between","mb-2"],[1,"p-1","rounded","bg-white","border","border-slate-200","shadow-sm","text-indigo-600"],["name","brain-circuit",1,"w-3.5","h-3.5"],[1,"w-2","h-2","rounded-full","bg-green-500","shadow-sm","shadow-green-200"],[1,"font-bold","text-xs","text-slate-700"],[1,"mt-2","space-y-1"],[1,"flex","justify-between","text-[10px]","text-slate-500"],[1,"font-mono","text-slate-900"],[1,"p-1","rounded","bg-white","border","border-slate-200","shadow-sm","text-blue-600"],["name","server",1,"w-3.5","h-3.5"],[1,"p-1","rounded","bg-white","border","border-slate-200","shadow-sm","text-emerald-600"],["name","database",1,"w-3.5","h-3.5"],[1,"p-1","rounded","bg-white","border","border-slate-200","shadow-sm","text-red-600"],["name","shield-check",1,"w-3.5","h-3.5"],[1,"p-1","rounded","bg-white","border","border-slate-200","shadow-sm","text-amber-600"],["name","link-2",1,"w-3.5","h-3.5"],[1,"p-6","text-center","text-slate-500","text-sm","flex","flex-col","items-center","gap-2"],["name","loader-2",1,"w-6","h-6","animate-spin","text-slate-300"],[1,"p-4","flex","items-center","justify-between","hover:bg-slate-50","transition-colors","cursor-pointer","group"],[1,"flex","items-center","gap-4"],[1,"w-10","h-10","rounded-lg","bg-indigo-50","text-indigo-600","flex","items-center","justify-center","border","border-indigo-100"],[1,"text-sm","font-bold","text-slate-900","group-hover:text-indigo-600",3,"title"],[1,"text-xs","text-slate-500"],[1,"px-2","py-0.5","rounded","text-[10px]","font-bold","bg-green-100","text-green-700"],["name","chevron-right",1,"w-4","h-4","text-slate-300","group-hover:text-indigo-400"]],template:function(e,i){e&1&&(r(0,"div",0)(1,"div",1),m(2,"div",2),r(3,"div",3)(4,"div",4)(5,"div",5)(6,"div",6),m(7,"lucide-icon",7),a(),r(8,"div",8),m(9,"div",9),a()(),r(10,"div",10)(11,"div")(12,"h1",11),l(13," NPA Agent "),r(14,"span",12),l(15,"v2.1 Online"),a()(),r(16,"p",13),l(17," Your AI-powered NPA workbench with 13 specialist agents across 4 tiers. Create NPAs, predict outcomes, validate docs, and orchestrate approvals via Dify. "),a()(),r(18,"div",14)(19,"span",15),m(20,"lucide-icon",16),l(21),a(),m(22,"div",17),r(23,"span",18),m(24,"lucide-icon",19),l(25),a(),m(26,"div",17),r(27,"span",20),m(28,"lucide-icon",21),l(29),a()()()(),r(30,"div",22)(31,"button",23),y("click",function(){return i.onCreateNew()}),m(32,"lucide-icon",24),l(33," Chat with Agent "),r(34,"span",25),m(35,"span",26)(36,"span",27),a()(),r(37,"div",28),f(38,ei,3,0,"button",29)(39,ti,3,0,"button",29),r(40,"button",30),y("click",function(){return i.onSearchKb()}),m(41,"lucide-icon",31),l(42," Search KB "),a()()()()(),r(43,"div",32)(44,"section"),m(45,"app-agent-health-panel",33),ie(46,"async"),a(),r(47,"section")(48,"div",34)(49,"div",35),m(50,"lucide-icon",36),a(),r(51,"h2",37),l(52," Agent Capabilities "),a()(),r(53,"div",38),f(54,ii,1,2,"app-capability-card",39),ie(55,"async"),a()(),f(56,ri,10,2,"section",40)(57,si,18,2,"section",40)(58,li,98,0,"section",40),r(59,"div",41)(60,"section",42)(61,"div",43)(62,"div",44)(63,"div",45),m(64,"lucide-icon",46),a(),r(65,"h2",37),l(66," Linked Knowledge Bases "),a()(),r(67,"button",47),y("click",function(){return i.onCreateNew()}),m(68,"lucide-icon",48),l(69," Add KB "),a()(),r(70,"div",49)(71,"div",50),f(72,di,3,0,"div",51)(73,ci,14,9,"div",52),ie(74,"slice"),a(),r(75,"div",53)(76,"button",54),y("click",function(){return i.onViewAll("kb")}),l(77," View All Knowledge Sources "),m(78,"lucide-icon",55),a()()()(),r(79,"section",42)(80,"div",43)(81,"div",44)(82,"div",56),m(83,"lucide-icon",57),a(),r(84,"h2",37),l(85," Connected Services "),a()(),r(86,"button",58),y("click",function(){return i.onCreateNew()}),m(87,"lucide-icon",48),l(88," Add Service "),a()(),r(89,"div",49)(90,"div",59)(91,"div",60)(92,"div",44)(93,"div",61),m(94,"lucide-icon",62),a(),r(95,"div")(96,"p",63),l(97,"Bloomberg API"),a(),r(98,"p",64),l(99,"Market Data \u2022 14ms"),a()()(),m(100,"div",65),a(),m(101,"div",66),r(102,"div",60)(103,"div",44)(104,"div",61),m(105,"lucide-icon",67),a(),r(106,"div")(107,"p",63),l(108,"Policy Engine"),a(),r(109,"p",64),l(110,"Regulatory \u2022 Online"),a()()(),m(111,"div",68),a(),m(112,"div",66),r(113,"div",60)(114,"div",44)(115,"div",61),m(116,"lucide-icon",69),a(),r(117,"div")(118,"p",63),l(119,"SharePoint"),a(),r(120,"p",64),l(121,"Docs \u2022 Syncing..."),a()()(),m(122,"div",70),a(),m(123,"div",66),r(124,"div",71)(125,"div",44)(126,"div",61),m(127,"lucide-icon",72),a(),r(128,"div")(129,"p",63),l(130,"SendGrid"),a(),r(131,"p",64),l(132,"Email \u2022 Idle"),a()()(),m(133,"div",73),a()(),r(134,"div",53)(135,"button",54),y("click",function(){return i.onViewAll("services")}),l(136," View All Connected Services "),m(137,"lucide-icon",55),a()()()()(),r(138,"section")(139,"div",34)(140,"div",74),m(141,"lucide-icon",75),a(),r(142,"h2",37),l(143," Active Agent Work Items "),a()(),m(144,"app-work-item-list",76),ie(145,"async"),a(),r(146,"section")(147,"div",34)(148,"div",77),m(149,"lucide-icon",78),a(),r(150,"h2",37),l(151," NPA Pipeline "),a()(),r(152,"app-npa-pipeline-table",79),y("onViewDetail",function(d){return i.onViewDetail(d)}),a()()()()),e&2&&(s(21),x(" ",i.heroActiveNpas," Active NPAs "),s(4),x(" ",i.heroApprovalRate,"% Approval Rate "),s(4),x(" ",i.heroAvgCycle,"d Avg Cycle "),s(9),c("ngIf",i.userRole()==="MAKER"),s(),c("ngIf",i.userRole()!=="MAKER"),s(6),c("metrics",Ee(46,13,i.healthMetrics$)||i.emptyMetrics),s(9),c("ngForOf",Ee(55,15,i.capabilities$)),s(2),c("ngIf",!1),s(),c("ngIf",!1),s(),c("ngIf",!1),s(14),c("ngIf",i.difyKbs.length===0),s(),c("ngForOf",ft(74,17,i.difyKbs,0,4)),s(71),c("items",Ee(145,21,i.workItems$)||Z(23,Zt)))},dependencies:[N,G,V,F,U,L,Oe,Ye,He,ze,Je,Pt,Et],styles:["[_nghost-%COMP%]{display:block}"]})};var Xe={id:"PART_C",type:"part",label:"Part C: Product Information to be Completed by Proposing Unit",numbering:"",children:[{id:"PC.I",type:"section",label:"Product Specifications (Basic Information)",numbering:"I",children:[{id:"PC.I.1",type:"topic",label:"Description",numbering:"1",children:[{id:"PC.I.1.a",type:"sub_question",label:"Purpose or Rationale for Proposal",numbering:"a)",guidance:"Describe the purpose or rationale for the proposal \u2014 what are the benefits to customers or BU/SU? Set out what problem it aims to solve. The summary should address the problem statement or articulate the value proposition.",fieldKeys:["business_rationale","problem_statement","value_proposition","customer_benefit","bu_benefit","competitive_landscape","market_opportunity"]},{id:"PC.I.1.b",type:"sub_question",label:"Scope and Parameters of Product/Service",numbering:"b)",guidance:"Describe the scope and parameters including: Role of PU (manufacturer, distributor, principal, agent); Product Features (currency denomination, funded vs unfunded, tenor, repricing info); Product Life Cycle.",fieldKeys:["product_name","product_type","underlying_asset","currency_denomination","tenor","funding_type","repricing_info","product_role","product_maturity","product_lifecycle","product_features","product_currency_pair","product_benchmark"]},{id:"PC.I.1.c",type:"sub_question",label:"Expected Transaction Volume and Revenue per Annum",numbering:"c)",guidance:"Provide revenue estimate by year, gross and net of transfer pricing.",fieldKeys:["notional_amount","expected_volume","revenue_year1","revenue_year1_net","revenue_year2","revenue_year2_net","revenue_year3","revenue_year3_net","product_notional_ccy","transfer_pricing"]},{id:"PC.I.1.d",type:"sub_question",label:"Business Model",numbering:"d)",guidance:"Highlight how the product/service (including SPV/SPE if applicable) sources revenue for DBS. Include revenue streams, gross margin split, and target ROI.",fieldKeys:["target_roi","revenue_streams","gross_margin_split","cost_allocation","break_even_timeline"]},{id:"PC.I.1.e",type:"sub_question",label:"Special Purpose Vehicles (SPV)",numbering:"e)",guidance:"Highlight any SPVs involved including the Arranger, country of incorporation, and responsibility for booking/monitoring.",fieldKeys:["spv_involved","spv_details","spv_arranger","spv_country"]}]},{id:"PC.I.2",type:"topic",label:"Target Customer",numbering:"2",children:[{id:"PC.I.2.a",type:"sub_question",label:"Target Customer Segment",numbering:"a)",guidance:"Identify the target customer segments for this product.",fieldKeys:["customer_segments"]},{id:"PC.I.2.b",type:"sub_question",label:"Regulatory Restrictions",numbering:"b)",guidance:"Describe any regulatory-driven restrictions on customer eligibility.",fieldKeys:["customer_restrictions"]},{id:"PC.I.2.c",type:"sub_question",label:"Customer Suitability & Domicile",numbering:"c)",guidance:"Describe suitability criteria and domicile requirements for target customers.",fieldKeys:["customer_suitability","customer_accreditation"]},{id:"PC.I.2.d",type:"sub_question",label:"Target Customer Profile",numbering:"d)",guidance:"Describe the target customer profile including minimum turnover and risk-based criteria.",fieldKeys:["customer_min_turnover"]},{id:"PC.I.2.e",type:"sub_question",label:"Customer Objectives & Risk Profile",numbering:"e)",guidance:"Describe the target customers' investment objectives and risk appetite.",fieldKeys:["customer_objectives"]},{id:"PC.I.2.f",type:"sub_question",label:"Target Markets / Locations",numbering:"f)",guidance:"Specify the geographic markets and locations where the product will be offered.",fieldKeys:["customer_geographic"]},{id:"PC.I.2.g",type:"sub_question",label:"Key Risks Faced by Target Customers",numbering:"g)",guidance:"Describe the key risks that target customers face with this product.",fieldKeys:["customer_key_risks"]}]},{id:"PC.I.3",type:"topic",label:"Commercialization Approach",numbering:"3",children:[{id:"PC.I.3.a",type:"sub_question",label:"Channel Availability",numbering:"a)",guidance:"Specify which channels will sell this product (e.g. DBS Bank, DBSV, etc.) and, if more than one entity/location, include the rationale.",fieldKeys:["distribution_channels","channel_rationale"]},{id:"PC.I.3.b",type:"sub_question",label:"Sales Suitability",numbering:"b)",guidance:"Document the customer onboarding process and suitability assessment. Describe how qualified customers have access to the product/service.",fieldKeys:["sales_suitability","onboarding_process","kyc_requirements","complaints_handling"]},{id:"PC.I.3.c",type:"sub_question",label:"Marketing & Communication",numbering:"c)",guidance:"Describe the marketing and communication plan for the product/service.",fieldKeys:["marketing_plan"]},{id:"PC.I.3.d",type:"sub_question",label:"Sales Surveillance",numbering:"d)",guidance:"Describe the sales surveillance process to monitor sales practices and customer outcomes.",fieldKeys:["sales_surveillance"]},{id:"PC.I.3.e",type:"sub_question",label:"Staff Training",numbering:"e)",guidance:"Describe staff training requirements for product knowledge, sales practices, and regulatory compliance.",fieldKeys:["staff_training"]}]},{id:"PC.I.4",type:"topic",label:"Conditions Imposed by Product Approval Committee (PAC)",numbering:"4",guidance:"For New-to-Group product/service, list any conditions imposed by the PAC.",fieldKeys:["pac_reference","pac_conditions","pac_date"]},{id:"PC.I.5",type:"topic",label:"Involvement of External Parties in the Initiative",numbering:"5",guidance:'Provide details of all external parties involved in the end-to-end process. Include Risk Profiling ID reference as per the Risk Data Assessment Sourcing Principles (RASP) baseline. Is any commercially related data (e.g. "green", "bond", "sustainable", "ESG") being utilized?',fieldKeys:["external_parties_involved","ip_considerations","external_party_names","rasp_reference","esg_data_used"]}]},{id:"PC.II",type:"section",label:"Operational & Technology Information",numbering:"II",children:[{id:"PC.II.1",type:"topic",label:"Operational Information",numbering:"1",children:[{id:"PC.II.1.a",type:"sub_question",label:"Operating Model",numbering:"a)",guidance:"Provide details on how trading parties are involved in the end-to-end process. Describe functional responsibilities between Front Office, Middle Office, Back Office, Operations, and any third parties, including additional requirements (e.g. collateral management).",fieldKeys:["front_office_model","middle_office_model","back_office_model","third_party_ops","collateral_mgmt_ops"]},{id:"PC.II.1.b",type:"sub_question",label:"Booking Process in Operations",numbering:"b)",guidance:"Provide details of end-to-end transaction flow \u2014 front-to-back settlement, accounting, valuation, including exception and manual handling.",fieldKeys:["booking_legal_form","booking_family","booking_typology","portfolio_allocation","confirmation_process","reconciliation","exception_handling","accounting_treatment","settlement_flow","stp_rate","nostro_accounts"]},{id:"PC.II.1.c",type:"sub_question",label:"Operational Adequacy",numbering:"c)",guidance:"Confirm operational adequacy by checking each applicable item: staffing, process documentation, system readiness, controls, monitoring, escalation procedures, and audit trails.",fieldKeys:["ops_adequacy_checklist"]},{id:"PC.II.1.d",type:"sub_question",label:"Operating Account Controls",numbering:"d)",guidance:"Describe the controls in place for operating accounts (GL alignment, deposit accounts, reconciliation controls).",fieldKeys:["operating_account_controls"]},{id:"PC.II.1.e",type:"sub_question",label:"Limit Structure & Monitoring",numbering:"e)",guidance:"Describe the limit structure, limit monitoring process, and breach escalation procedures.",fieldKeys:["limit_structure","limit_monitoring"]},{id:"PC.II.1.f",type:"sub_question",label:"Manual Process Fallback",numbering:"f)",guidance:"Are there any manual process fallbacks? If yes, describe the manual processes and planned automation timeline.",fieldKeys:["manual_fallback","manual_fallback_details"]},{id:"PC.II.1.g",type:"sub_question",label:"Collateral Management",numbering:"g)",guidance:"Describe the collateral management framework: eligible collateral, haircuts, margining frequency, and dispute resolution.",fieldKeys:["collateral_eligibility","collateral_haircuts","margin_frequency","collateral_disputes"]},{id:"PC.II.1.h",type:"sub_question",label:"Custody Account",numbering:"h)",guidance:"Is a custody account required? If yes, describe the custody arrangement and controls.",fieldKeys:["custody_required","custody_details"]},{id:"PC.II.1.i",type:"sub_question",label:"Trade Repository / ESFR Reporting",numbering:"i)",guidance:"Describe trade repository obligations, ESFR reporting requirements, and data submission processes.",fieldKeys:["trade_repository_reporting"]},{id:"PC.II.1.j",type:"sub_question",label:"SFEMC / Code of Conduct",numbering:"j)",guidance:"Describe relevant SFEMC references, code of conduct obligations, and industry best practices.",fieldKeys:["sfemc_references"]}]},{id:"PC.II.2",type:"topic",label:"Technical Platform",numbering:"2",children:[{id:"PC.II.2.a",type:"sub_question",label:"System Requirements",numbering:"a)",guidance:"Does the proposal involve new changes to application systems, technology solutions, and/or IT infrastructure? If yes, describe the scope and integration.",fieldKeys:["new_system_changes","booking_system","tech_requirements","system_integration","trade_capture_system","risk_system","reporting_system"]},{id:"PC.II.2.b",type:"sub_question",label:"Front Office / Internet Facing System",numbering:"b)",guidance:"Describe the front office or internet-facing system for impact analysis. Include details of system changes.",fieldKeys:["valuation_model","fo_system_changes","mktdata_requirements"]},{id:"PC.II.2.c",type:"sub_question",label:"Back End / Supporting Systems",numbering:"c)",guidance:"Describe back-end and supporting systems for impact analysis. Include details of systems and any manual work-around.",fieldKeys:["settlement_method","be_system_changes","manual_workarounds"]}]},{id:"PC.II.3",type:"topic",label:"Information Security",numbering:"3",guidance:"Does the proposal involve any system or major system enhancements? Describe any requirements related to information security. Are there any deviations from ISS policies?",fieldKeys:["system_enhancements","iss_deviations","pentest_status","security_assessment"]},{id:"PC.II.4",type:"topic",label:"Technology Resiliency",numbering:"4",guidance:"Describe external party risk management (include GRC ID), system design and recovery details (RTO/RPO), and DR testing plan.",fieldKeys:["grc_id","hsm_required","rto_target","rpo_target","dr_testing_plan"]},{id:"PC.II.5",type:"topic",label:"Business Continuity Management",numbering:"5",guidance:"Describe BIA considerations, updated BCP requirements, and any additional continuity measures.",fieldKeys:["bia_considerations","bcp_requirements","continuity_measures","bcm_critical_processes","bcm_recovery_strategy","bcm_alternate_site","bcm_communication_plan","bcm_testing_frequency","bcm_vendor_dependencies","bcm_staff_awareness","bcm_regulatory_compliance","bcm_incident_response"]}]},{id:"PC.III",type:"section",label:"Pricing Model Details",numbering:"III",children:[{id:"PC.III.1",type:"topic",label:"Pricing Model Validation / Assurance",numbering:"1",guidance:"Is there a requirement for pricing model validation? If yes, has pricing model assurance been done?",fieldKeys:["pricing_model_required","pricing_methodology","roae_analysis","pricing_assumptions","bespoke_adjustments","fva_adjustment","xva_treatment","day_count_convention"]},{id:"PC.III.2",type:"topic",label:"Model Name and Validation Date",numbering:"2",guidance:"State the model name, validation date, and any model restrictions approved by risk team. Refer to the Risk Data Assessment tool.",fieldKeys:["pricing_model_name","model_validation_date","model_restrictions","risk_data_assessment_ref"]},{id:"PC.III.3",type:"topic",label:"Standardised Initial Margin Model (SIMM) Treatment",numbering:"3",guidance:"Describe the SIMM sensitivities and margin treatment for this product.",fieldKeys:["simm_treatment","simm_sensitivities","simm_backtesting"]}]},{id:"PC.IV",type:"section",label:"Risk Analysis",numbering:"IV",children:[{id:"PC.IV.A",type:"topic",label:"Operational Risk",numbering:"A",children:[{id:"PC.IV.A.1",type:"sub_question",label:"Legal & Compliance Considerations",numbering:"1",guidance:"Address regulatory compliance, licensing requirements, cross-border regulations, legal documentation requirements, and any sanctions or AML considerations.",fieldKeys:["legal_opinion","licensing_requirements","primary_regulation","secondary_regulations","regulatory_reporting","cross_border_regulations","legal_docs_required","sanctions_check","aml_considerations"]},{id:"PC.IV.A.2",type:"sub_question",label:"Finance and Tax",numbering:"2",guidance:"Describe the accounting treatment (Trading Book vs Banking Book, Fair Value, On/Off Balance Sheet) and tax considerations across jurisdictions.",fieldKeys:["tax_impact","accounting_book","fair_value_treatment","on_off_balance","tax_jurisdictions","service_output_fees","service_fee_structure","service_fee_allocation","reg_matching_ifrs","reg_matching_mas","reg_matching_gst","reg_matching_wht"]},{id:"PC.IV.A.3",type:"sub_question",label:"Financial Crimes & Financial Security",numbering:"3",guidance:"Address conduct considerations, market abuse regulation (MAR) assessment with MAS references, and MRA boundary tests.",fieldKeys:["fc_conduct_considerations","fc_mar_assessment","fc_mar_sub_items","fc_mra_boundary_test","fc_mra_details"]},{id:"PC.IV.A.D",type:"sub_question",label:"Funding Liquidity Risk",numbering:"D",guidance:"Describe LCR/NSFR/EAFL metrics, liquidity coverage ratio, HQLA qualification, cashflow modeling, liquidity facilities, and limit implementation.",fieldKeys:["flr_lcr_nsfr_metrics","flr_hqla_qualification","flr_cashflow_modeling","flr_liquidity_facility","flr_limit_implementation"]}]},{id:"PC.IV.B",type:"topic",label:"Market & Liquidity",numbering:"B",children:[{id:"PC.IV.B.1",type:"sub_question",label:"Market Risk",numbering:"1",guidance:"If applicable, complete the market risk factor table. Indicate the relevant pricing parameters, sensitivity reports, VaR capture, and stress capture for each risk factor.",fieldKeys:["market_risk","risk_classification","pricing_parameters","model_risk"]},{id:"PC.IV.B.1.table",type:"table",label:"Market Risk Factor Matrix",numbering:"",tableColumns:["Risk Factor","Applicable?","Sensitivity Reports?","Captured in VaR?","Captured in Stress?"],tableFieldMapping:[{rowLabel:"IR Delta",fieldKey:"mrf_ir_delta"},{rowLabel:"IR Vega",fieldKey:"mrf_ir_vega"},{rowLabel:"IR Gamma",fieldKey:"mrf_ir_gamma"},{rowLabel:"FX Delta",fieldKey:"mrf_fx_delta"},{rowLabel:"FX Vega",fieldKey:"mrf_fx_vega"},{rowLabel:"Equity Delta",fieldKey:"mrf_eq_delta"},{rowLabel:"Equity Vega",fieldKey:"mrf_eq_vega"},{rowLabel:"Commodity",fieldKey:"mrf_commodity"},{rowLabel:"Credit",fieldKey:"mrf_credit"},{rowLabel:"Correlation",fieldKey:"mrf_correlation"}]},{id:"PC.IV.B.2",type:"sub_question",label:"Funding / Liquidity Risk",numbering:"2",guidance:"Describe how the product will be captured in the existing liquidity risk metrics. Indicate what the corporate risk liquidity cost is. Identify if there is any contingent cash flow driven by market events.",fieldKeys:["liquidity_risk","liquidity_cost","contingent_cashflow","contingent_cashflow_desc"]},{id:"PC.IV.B.3",type:"sub_question",label:"Market Risk Regulatory Capital",numbering:"3",guidance:"Confirm trading book assignment. Describe capital requirements and model validation procedures.",fieldKeys:["trading_book_assignment","regulatory_capital","var_capture","model_validation_proc"]}]},{id:"PC.IV.C",type:"topic",label:"Credit Risk",numbering:"C",children:[{id:"PC.IV.C.1",type:"sub_question",label:"Potential Risks",numbering:"1",guidance:"Identify the primary sources of credit risk. Do they require new credit limit types or credit support?",fieldKeys:["credit_risk","new_limit_types","credit_support_required"]},{id:"PC.IV.C.2",type:"sub_question",label:"Risk Mitigation",numbering:"2",guidance:"Describe the risk mitigation measures, collateral frameworks, and how they have been stress-tested.",fieldKeys:["counterparty_default","collateral_framework","stress_test_results","wrong_way_risk","netting_agreements","isda_master"]},{id:"PC.IV.C.3",type:"sub_question",label:"Limits to Cover Exposure",numbering:"3",guidance:"Describe limits to cover exposure and the party responsible for monitoring. Are there appropriate models for verification, monitoring, and measurement?",fieldKeys:["stress_scenarios","exposure_limits","monitoring_party"]},{id:"PC.IV.C.4",type:"sub_question",label:"Collateral Requirements",numbering:"4",guidance:"If the transaction is to be collateralized, describe the collateral management and monitoring process. Is the acceptable collateral risk-rated based on Core Credit Risk Policy?",fieldKeys:["custody_risk","collateral_risk_rated","csa_in_place"]},{id:"PC.IV.C.5",type:"sub_question",label:"Credit Risk Capital Calculation",numbering:"5",guidance:"For portfolios under Standardized Approach, state PFE Standards. For portfolios under Internal Model Approach, describe EAD and regulatory capital.",fieldKeys:["counterparty_rating","pfe_standards","ead_calculation","cva_dva_impact"]},{id:"PC.IV.C.6",type:"sub_question",label:"Regulatory Considerations",numbering:"6",guidance:"Describe any regulatory considerations for credit risk including large exposure rules and concentration limits.",fieldKeys:["large_exposure_rules","concentration_limits"]},{id:"PC.IV.C.7",type:"sub_question",label:"Counterparty Credit Risk",numbering:"7",guidance:"Describe the counterparty credit risk assessment framework.",fieldKeys:["ccr_framework"]}]},{id:"PC.IV.D",type:"topic",label:"Reputational Risk",numbering:"D",guidance:"Evaluate and provide an assessment of the reputational risk exposure. Does the new product involve changes that could negatively impact the Bank's reputation? Include ESG assessment.",fieldKeys:["reputational_risk","negative_impact","esg_assessment","esg_classification","country_risk"]}]},{id:"PC.V",type:"section",label:"Data Management",numbering:"V",children:[{id:"PC.V.1",type:"topic",label:"Design for Data (D4D) and Data Management Requirements",numbering:"1",guidance:"Describe D4D requirements including data governance, ownership, stewardship, quality monitoring, and GDPR/privacy compliance.",fieldKeys:["data_governance","data_ownership","data_stewardship","data_quality_monitoring","data_privacy","data_retention","gdpr_compliance","data_lineage","data_classification"]},{id:"PC.V.2",type:"topic",label:"PURE (Purposeful, Unsurprising, Respectful, Explainable) Principles",numbering:"2",guidance:"Provide the PURE assessment ID and describe compliance with each principle.",fieldKeys:["pure_assessment_id","pure_purposeful","pure_unsurprising","pure_respectful","pure_explainable"]},{id:"PC.V.3",type:"topic",label:"Risk Data Aggregation and Reporting Requirements",numbering:"3",guidance:"Describe risk data aggregation capabilities and automated regulatory reporting.",fieldKeys:["reporting_requirements","automated_reporting","rda_reporting_frequency"]}]},{id:"PC.VI",type:"section",label:"Other Risk Identification and Mitigation",numbering:"VI",guidance:"Are there other risk identifications and mitigations which have not been described in sections I\u2013V? If so, describe them here.",fieldKeys:["other_risks_exist","operational_risk","additional_risk_mitigants"]},{id:"PC.VII",type:"section",label:"Additional Information for Trading Products / Instruments",numbering:"VII",guidance:"If the new product involves a trading product/instrument, please complete the additional risk assessment in Appendix 5.",fieldKeys:["trading_product","appendix5_required"]}]},Se=[{id:"APP.1",type:"appendix",label:"Entity/Location Information",numbering:"Appendix 1",children:[{id:"APP.1.table",type:"table",label:"Entity/Location Matrix",numbering:"",tableColumns:["Function","Legal Entity","Location"],tableFieldMapping:[{rowLabel:"Sales / Origination",fieldKey:"sales_entity"},{rowLabel:"Booking",fieldKey:"booking_entity"},{rowLabel:"Risk Taking",fieldKey:"risk_taking_entity"},{rowLabel:"Processing",fieldKey:"processing_entity"}]},{id:"APP.1.additional",type:"topic",label:"Additional Entity Information",numbering:"",guidance:"Specify additional entities involved in hedging and clearing.",fieldKeys:["hedge_entity","hedge_location","clearing_entity"]}]},{id:"APP.2",type:"appendix",label:'Intellectual Property ("IP")',numbering:"Appendix 2",children:[{id:"APP.2.A",type:"topic",label:"Part A \u2014 DBS IP",numbering:"A",guidance:"Does the new product/service create or incorporate the use of any IP that is owned or to be owned by DBS (whether newly created or existing)?",fieldKeys:["dbs_ip_exists","dbs_ip_details"]},{id:"APP.2.B",type:"topic",label:"Part B \u2014 Third Party IP",numbering:"B",guidance:"Does the new product/service create or incorporate the use of any IP that is owned or to be owned by a third party (whether newly created or existing)?",fieldKeys:["third_party_ip_exists","third_party_ip_details","ip_licensing"]}]},{id:"APP.3",type:"appendix",label:"Financial Crime Risk Areas",numbering:"Appendix 3",guidance:"Please complete both Parts A and B of this section. Identify relevant financial crime risk areas (money laundering, terrorism financing, sanctions, fraud, bribery & corruption).",children:[{id:"APP.3.1",type:"topic",label:"Risk Assessment",numbering:"1",guidance:"Assess each financial crime risk area applicable to this product.",fieldKeys:["aml_assessment","terrorism_financing","sanctions_assessment","fraud_risk","bribery_corruption","fc_risk_rating","fc_mitigation_measures"]},{id:"APP.3.2",type:"topic",label:"Policies & Controls",numbering:"2",guidance:"Describe the policies, procedures, and controls in place to mitigate financial crime risks.",fieldKeys:["fc_policy_framework","fc_screening_controls","fc_transaction_monitoring","fc_suspicious_reporting","fc_record_keeping","fc_staff_training","fc_independent_testing"]},{id:"APP.3.3",type:"topic",label:"Validation & Surveillance",numbering:"3",guidance:"Describe the validation, surveillance, and reporting procedures.",fieldKeys:["fc_validation_process","fc_surveillance_tools","fc_regulatory_reporting"]},{id:"APP.3.4",type:"topic",label:"Data Privacy",numbering:"4",guidance:"Describe data privacy considerations relating to financial crime prevention.",fieldKeys:["fc_data_privacy_compliance","fc_data_sharing_agreements"]}]},{id:"APP.4",type:"appendix",label:"Risk Data Aggregation and Reporting Requirements",numbering:"Appendix 4",guidance:"Describe risk data aggregation compliance with regulatory requirements relating to Risk Data Aggregation and Reporting.",fieldKeys:["rda_compliance","rda_data_sources","rda_aggregation_method","rda_data_quality"]},{id:"APP.5",type:"appendix",label:"Additional Information for Trading Products / Instruments",numbering:"Appendix 5",children:[{id:"APP.5.1",type:"topic",label:"Customers",numbering:"1",guidance:"Describe revenue sharing, cost allocation, and capital allocation.",fieldKeys:["app5_revenue_sharing","app5_capital_allocation"]},{id:"APP.5.2",type:"topic",label:"Product Information",numbering:"2",guidance:"Is the product to be hedge-fund purposes? Clarify what is being hedged and provide a brief description of any underlying transactions.",fieldKeys:["app5_hedge_purpose","app5_hedge_description"]},{id:"APP.5.3",type:"topic",label:"Collateral and Pledged Assets",numbering:"3",guidance:"Describe collateral types, custody systems, and risk mitigation.",fieldKeys:["collateral_types","custody_arrangements"]},{id:"APP.5.4",type:"topic",label:"Valuation and Funding",numbering:"4",guidance:"Describe valuation models and funding sources.",fieldKeys:["app5_valuation_model","valuation_method","funding_source"]},{id:"APP.5.5",type:"topic",label:"Additional Finance Considerations",numbering:"5",guidance:"Describe booking schema, lifecycle management, and cross-product integration.",fieldKeys:["booking_schema","lifecycle_management","cross_product_integration","margin_methodology","close_out_netting"]},{id:"APP.5.6",type:"topic",label:"Technology Considerations",numbering:"6",guidance:"Describe architecture, security, and scalability requirements.",fieldKeys:["app5_tech_architecture","app5_security_req","app5_scalability"]},{id:"APP.5.7",type:"topic",label:"Regulatory Considerations",numbering:"7",guidance:"Describe the compliance framework, regulatory reporting, and monitoring.",fieldKeys:["app5_compliance_framework","app5_reg_monitoring","trade_reporting","clearing_obligation"]}]},{id:"APP.6",type:"appendix",label:"Use of Third-Party Hosted Communication or Media Channels/Platforms \u2014 Risk Assessment",numbering:"Appendix 6",guidance:"This appendix is only applicable if the PU intends to use a third-party hosted communication or media channel/platform. Complete the preliminary risk assessment and information security assessment.",children:[{id:"APP.6.A",type:"topic",label:"Description of Use Case",numbering:"Part A",guidance:"Describe the intended use case for the third-party platform.",fieldKeys:["third_party_platform","platform_name","tp_use_case_description","tp_business_justification"]},{id:"APP.6.B",type:"topic",label:"Preliminary Risk Assessment",numbering:"Part B",guidance:"Conduct a preliminary risk assessment covering operational, regulatory, and reputational risks.",fieldKeys:["platform_risk_assessment","tp_risk_rating","tp_risk_mitigants"]},{id:"APP.6.C1",type:"topic",label:"Context Questions",numbering:"Part C.1",guidance:"Answer context questions about the platform usage, data flows, and integration.",fieldKeys:["tp_data_classification","tp_user_population","tp_integration_scope","tp_data_flow","tp_exit_strategy"]},{id:"APP.6.C2",type:"topic",label:"Information Security Assessment",numbering:"Part C.2",guidance:"Assess information security posture of the third-party platform.",fieldKeys:["info_security_assessment","tp_encryption_standards","tp_access_controls","tp_audit_logging","tp_vulnerability_mgmt","tp_incident_response","tp_certifications"]},{id:"APP.6.C3",type:"topic",label:"Cybersecurity & Communication Archives",numbering:"Part C.3",guidance:"Describe cybersecurity measures and communication archival requirements.",fieldKeys:["tp_cyber_assessment","tp_communication_archival","tp_retention_policy","tp_ediscovery"]},{id:"APP.6.C4",type:"topic",label:"IP, Data Ownership & Privacy",numbering:"Part C.4",guidance:"Address intellectual property, data ownership, and data privacy requirements.",fieldKeys:["data_residency","tp_data_ownership","tp_ip_rights","tp_pdpa_compliance","tp_cross_border_transfer","tp_data_deletion","tp_consent_management","tp_breach_notification","tp_dpo_contact","tp_privacy_impact"]}]}],_t=[{key:"approving_authority",label:"Approving Authority",nodeId:"PC.I",fieldType:"text",strategy:"RULE"},{key:"bia_completed",label:"BIA Completed",nodeId:"PC.I",fieldType:"yesno",strategy:"RULE"},{key:"business_case_status",label:"Business Case Status",nodeId:"PC.I",fieldType:"text",strategy:"RULE"},{key:"business_unit",label:"Business Unit",nodeId:"PC.I",fieldType:"dropdown",strategy:"RULE",options:["Treasury & Markets","Wealth Management","Corporate Banking","Institutional Banking","Consumer Banking","Digital Assets"]},{key:"customer_profile",label:"Customer Profile",nodeId:"PC.I",fieldType:"textarea",strategy:"RULE"},{key:"desk",label:"Trading Desk",nodeId:"PC.I",fieldType:"text",strategy:"RULE"},{key:"dr_test_frequency",label:"DR Test Frequency",nodeId:"PC.I",fieldType:"text",strategy:"RULE"},{key:"geographic_scope",label:"Geographic Scope",nodeId:"PC.I",fieldType:"multiselect",strategy:"RULE"},{key:"group_product_head",label:"Group Product Head",nodeId:"PC.I",fieldType:"text",strategy:"RULE"},{key:"hedging_purpose",label:"Hedging Purpose",nodeId:"PC.I",fieldType:"textarea",strategy:"RULE"},{key:"isda_agreement",label:"ISDA Agreement",nodeId:"PC.IV",fieldType:"textarea",strategy:"RULE"},{key:"kickoff_date",label:"Kickoff Date",nodeId:"PC.I",fieldType:"date",strategy:"RULE"},{key:"mtj_journey",label:"MTJ Journey",nodeId:"PC.I",fieldType:"text",strategy:"RULE"},{key:"npa_process_type",label:"NPA Process Type",nodeId:"PC.I",fieldType:"text",strategy:"RULE"},{key:"pac_approval_date",label:"PAC Approval Date",nodeId:"PC.I",fieldType:"date",strategy:"RULE"},{key:"product_manager_name",label:"Product Manager",nodeId:"PC.I",fieldType:"text",strategy:"RULE"},{key:"proposal_preparer",label:"Proposal Preparer",nodeId:"PC.I",fieldType:"text",strategy:"RULE"},{key:"required_signoffs",label:"Required Sign-offs",nodeId:"APP.1",fieldType:"textarea",strategy:"RULE"},{key:"rpo_minutes",label:"RPO (Minutes)",nodeId:"PC.II",fieldType:"text",strategy:"RULE"},{key:"rto_hours",label:"RTO (Hours)",nodeId:"PC.II",fieldType:"text",strategy:"RULE"},{key:"signoff_order",label:"Sign-off Order",nodeId:"APP.1",fieldType:"dropdown",strategy:"RULE",options:["Parallel","Sequential"]},{key:"strike_price",label:"Strike Price",nodeId:"PC.III",fieldType:"currency",strategy:"RULE"},{key:"supporting_documents",label:"Supporting Documents",nodeId:"APP.6",fieldType:"file_upload",strategy:"RULE"},{key:"term_sheet",label:"Term Sheet",nodeId:"APP.6",fieldType:"file_upload",strategy:"RULE"},{key:"trade_date",label:"Expected Trade Date",nodeId:"PC.I",fieldType:"date",strategy:"RULE"},{key:"business_rationale",label:"Business Rationale",strategy:"LLM",llmCategory:"product_description",nodeId:"PC.I.1.a",fieldType:"textarea",required:!0},{key:"problem_statement",label:"Problem Statement",strategy:"LLM",llmCategory:"product_description",nodeId:"PC.I.1.a",fieldType:"textarea"},{key:"value_proposition",label:"Value Proposition",strategy:"LLM",llmCategory:"product_description",nodeId:"PC.I.1.a",fieldType:"textarea"},{key:"customer_benefit",label:"Benefits to Customers",strategy:"LLM",llmCategory:"product_description",nodeId:"PC.I.1.a",fieldType:"textarea"},{key:"bu_benefit",label:"Benefits to BU/SU",strategy:"LLM",llmCategory:"product_description",nodeId:"PC.I.1.a",fieldType:"textarea"},{key:"product_name",label:"Product Name",strategy:"RULE",ruleSource:"npa_record",nodeId:"PC.I.1.b",fieldType:"text",required:!0},{key:"product_type",label:"Product Type",strategy:"RULE",ruleSource:"npa_record",nodeId:"PC.I.1.b",fieldType:"dropdown",options:["Derivative","Structured Product","Loan","Bond","Fund","Insurance","Digital Asset","Other"]},{key:"underlying_asset",label:"Underlying Asset",strategy:"RULE",ruleSource:"npa_record",nodeId:"PC.I.1.b",fieldType:"text"},{key:"currency_denomination",label:"Currency Denomination",strategy:"RULE",ruleSource:"npa_record",nodeId:"PC.I.1.b",fieldType:"dropdown",options:["SGD","USD","EUR","GBP","JPY","CNY","HKD","AUD","INR","IDR","TWD","Multi-currency"]},{key:"tenor",label:"Tenor",strategy:"RULE",ruleSource:"npa_record",nodeId:"PC.I.1.b",fieldType:"text"},{key:"funding_type",label:"Funded vs Unfunded",strategy:"RULE",ruleSource:"npa_record",nodeId:"PC.I.1.b",fieldType:"dropdown",options:["Funded","Unfunded","Partially Funded"]},{key:"repricing_info",label:"Repricing Information",strategy:"COPY",copySection:"product_specs",nodeId:"PC.I.1.b",fieldType:"textarea"},{key:"product_role",label:"Role of Proposing Unit",strategy:"COPY",copySection:"product_specs",nodeId:"PC.I.1.b",fieldType:"dropdown",options:["Manufacturer","Distributor","Principal","Agent","Arranger"]},{key:"product_maturity",label:"Product Maturity",strategy:"COPY",copySection:"product_specs",nodeId:"PC.I.1.b",fieldType:"dropdown",options:["Established","Mature","Growing","Emerging","New"]},{key:"product_lifecycle",label:"Product Life Cycle",strategy:"COPY",copySection:"product_specs",nodeId:"PC.I.1.b",fieldType:"textarea"},{key:"product_features",label:"Product Features Summary",strategy:"LLM",llmCategory:"product_description",nodeId:"PC.I.1.b",fieldType:"textarea"},{key:"notional_amount",label:"Transaction Volume (Notional)",strategy:"RULE",ruleSource:"npa_record",nodeId:"PC.I.1.c",fieldType:"currency",required:!0},{key:"revenue_year1",label:"Revenue Year 1 (Gross)",strategy:"LLM",llmCategory:"financial_projection",nodeId:"PC.I.1.c",fieldType:"currency"},{key:"revenue_year1_net",label:"Revenue Year 1 (Net of TP)",strategy:"LLM",llmCategory:"financial_projection",nodeId:"PC.I.1.c",fieldType:"currency"},{key:"revenue_year2",label:"Revenue Year 2 (Gross)",strategy:"LLM",llmCategory:"financial_projection",nodeId:"PC.I.1.c",fieldType:"currency"},{key:"revenue_year2_net",label:"Revenue Year 2 (Net of TP)",strategy:"LLM",llmCategory:"financial_projection",nodeId:"PC.I.1.c",fieldType:"currency"},{key:"revenue_year3",label:"Revenue Year 3 (Gross)",strategy:"LLM",llmCategory:"financial_projection",nodeId:"PC.I.1.c",fieldType:"currency"},{key:"revenue_year3_net",label:"Revenue Year 3 (Net of TP)",strategy:"LLM",llmCategory:"financial_projection",nodeId:"PC.I.1.c",fieldType:"currency"},{key:"expected_volume",label:"Expected Annual Volume",strategy:"LLM",llmCategory:"financial_projection",nodeId:"PC.I.1.c",fieldType:"text"},{key:"target_roi",label:"Target ROI",strategy:"LLM",llmCategory:"financial_projection",nodeId:"PC.I.1.d",fieldType:"text"},{key:"revenue_streams",label:"Revenue Streams",strategy:"LLM",llmCategory:"financial_projection",nodeId:"PC.I.1.d",fieldType:"bullet_list"},{key:"gross_margin_split",label:"Gross Margin Split",strategy:"LLM",llmCategory:"financial_projection",nodeId:"PC.I.1.d",fieldType:"textarea"},{key:"cost_allocation",label:"Cost Allocation",strategy:"LLM",llmCategory:"financial_projection",nodeId:"PC.I.1.d",fieldType:"textarea"},{key:"spv_involved",label:"Is SPV/SPE Involved?",strategy:"MANUAL",nodeId:"PC.I.1.e",fieldType:"yesno"},{key:"spv_details",label:"SPV Details",strategy:"MANUAL",nodeId:"PC.I.1.e",fieldType:"textarea",dependsOn:{field:"spv_involved",value:"Yes"}},{key:"spv_arranger",label:"SPV Arranger",strategy:"MANUAL",nodeId:"PC.I.1.e",fieldType:"text",dependsOn:{field:"spv_involved",value:"Yes"}},{key:"spv_country",label:"SPV Country of Incorporation",strategy:"MANUAL",nodeId:"PC.I.1.e",fieldType:"text",dependsOn:{field:"spv_involved",value:"Yes"}},{key:"customer_segments",label:"Target Customer Segments",strategy:"MANUAL",nodeId:"PC.I.2",fieldType:"multiselect",options:["Institutional","Corporate","SME","Retail - Mass","Retail - Affluent","Retail - Private Banking","Government","Financial Institutions"]},{key:"customer_restrictions",label:"Regulatory Restrictions on Customers",strategy:"LLM",llmCategory:"compliance",nodeId:"PC.I.2",fieldType:"textarea"},{key:"customer_suitability",label:"Customer Suitability Criteria",strategy:"COPY",copySection:"product_specs",nodeId:"PC.I.2",fieldType:"textarea"},{key:"customer_min_turnover",label:"Minimum Annual Turnover",strategy:"MANUAL",nodeId:"PC.I.2",fieldType:"currency"},{key:"customer_geographic",label:"Geographic Scope",strategy:"RULE",ruleSource:"npa_record",nodeId:"PC.I.2",fieldType:"multiselect",options:["Singapore","Hong Kong","China","India","Indonesia","Taiwan","Rest of APAC","Global"]},{key:"distribution_channels",label:"Distribution Channels",strategy:"COPY",copySection:"product_specs",nodeId:"PC.I.3.a",fieldType:"multiselect",options:["DBS Bank","DBSV","DBS Treasures","DBS Private Bank","digibank","Third Party Distributors","Direct Sales"]},{key:"channel_rationale",label:"Multi-Entity/Location Rationale",strategy:"LLM",llmCategory:"product_description",nodeId:"PC.I.3.a",fieldType:"textarea"},{key:"sales_suitability",label:"Sales Suitability",strategy:"COPY",copySection:"product_specs",nodeId:"PC.I.3.b",fieldType:"textarea"},{key:"onboarding_process",label:"Customer Onboarding Process",strategy:"COPY",copySection:"product_specs",nodeId:"PC.I.3.b",fieldType:"textarea"},{key:"marketing_plan",label:"Marketing & Communication Plan",strategy:"LLM",llmCategory:"product_description",nodeId:"PC.I.3.c",fieldType:"textarea"},{key:"pac_reference",label:"PAC Reference Number",strategy:"MANUAL",nodeId:"PC.I.4",fieldType:"text"},{key:"pac_conditions",label:"PAC Conditions List",strategy:"MANUAL",nodeId:"PC.I.4",fieldType:"bullet_list"},{key:"pac_date",label:"PAC Approval Date",strategy:"MANUAL",nodeId:"PC.I.4",fieldType:"date"},{key:"external_parties_involved",label:"External Parties Involved?",strategy:"MANUAL",nodeId:"PC.I.5",fieldType:"yesno"},{key:"ip_considerations",label:"IP Considerations",strategy:"MANUAL",nodeId:"PC.I.5",fieldType:"textarea",dependsOn:{field:"external_parties_involved",value:"Yes"}},{key:"external_party_names",label:"External Party Names",strategy:"MANUAL",nodeId:"PC.I.5",fieldType:"bullet_list",dependsOn:{field:"external_parties_involved",value:"Yes"}},{key:"rasp_reference",label:"RASP Baseline Reference",strategy:"MANUAL",nodeId:"PC.I.5",fieldType:"text",dependsOn:{field:"external_parties_involved",value:"Yes"}},{key:"esg_data_used",label:"ESG/Sustainable Data Used?",strategy:"MANUAL",nodeId:"PC.I.5",fieldType:"yesno"},{key:"front_office_model",label:"Front Office Operating Model",strategy:"COPY",copySection:"operational",nodeId:"PC.II.1.a",fieldType:"textarea"},{key:"middle_office_model",label:"Middle Office Operating Model",strategy:"COPY",copySection:"operational",nodeId:"PC.II.1.a",fieldType:"textarea"},{key:"back_office_model",label:"Back Office Operating Model",strategy:"COPY",copySection:"operational",nodeId:"PC.II.1.a",fieldType:"textarea"},{key:"third_party_ops",label:"Third Party Operations",strategy:"COPY",copySection:"operational",nodeId:"PC.II.1.a",fieldType:"textarea"},{key:"collateral_mgmt_ops",label:"Collateral Management Requirements",strategy:"LLM",llmCategory:"operational",nodeId:"PC.II.1.a",fieldType:"textarea"},{key:"booking_legal_form",label:"Booking Legal Form",strategy:"RULE",ruleSource:"product_config",nodeId:"PC.II.1.b",fieldType:"text"},{key:"booking_family",label:"Booking Family",strategy:"RULE",ruleSource:"product_config",nodeId:"PC.II.1.b",fieldType:"text"},{key:"booking_typology",label:"Booking Typology",strategy:"RULE",ruleSource:"product_config",nodeId:"PC.II.1.b",fieldType:"text"},{key:"portfolio_allocation",label:"Portfolio Allocation",strategy:"RULE",ruleSource:"product_config",nodeId:"PC.II.1.b",fieldType:"text"},{key:"confirmation_process",label:"Confirmation Process",strategy:"COPY",copySection:"operational",nodeId:"PC.II.1.b",fieldType:"textarea"},{key:"reconciliation",label:"Reconciliation",strategy:"COPY",copySection:"operational",nodeId:"PC.II.1.b",fieldType:"textarea"},{key:"exception_handling",label:"Exception & Manual Handling",strategy:"COPY",copySection:"operational",nodeId:"PC.II.1.b",fieldType:"textarea"},{key:"accounting_treatment",label:"Accounting Treatment",strategy:"LLM",llmCategory:"financial_projection",nodeId:"PC.II.1.b",fieldType:"textarea"},{key:"settlement_flow",label:"Settlement Flow Description",strategy:"COPY",copySection:"operational",nodeId:"PC.II.1.b",fieldType:"textarea"},{key:"new_system_changes",label:"New System Changes Required?",strategy:"MANUAL",nodeId:"PC.II.2.a",fieldType:"yesno"},{key:"booking_system",label:"Booking System",strategy:"RULE",ruleSource:"system_config",nodeId:"PC.II.2.a",fieldType:"dropdown",options:["Murex","Calypso","Summit","Opics","Kondor+","SAP","Other"]},{key:"tech_requirements",label:"Technology Requirements",strategy:"LLM",llmCategory:"operational",nodeId:"PC.II.2.a",fieldType:"textarea"},{key:"system_integration",label:"System Integration Scope",strategy:"LLM",llmCategory:"operational",nodeId:"PC.II.2.a",fieldType:"textarea",dependsOn:{field:"new_system_changes",value:"Yes"}},{key:"valuation_model",label:"Valuation Model",strategy:"LLM",llmCategory:"pricing",nodeId:"PC.II.2.b",fieldType:"textarea"},{key:"fo_system_changes",label:"Front Office System Changes",strategy:"LLM",llmCategory:"operational",nodeId:"PC.II.2.b",fieldType:"textarea"},{key:"settlement_method",label:"Settlement Method",strategy:"RULE",ruleSource:"product_config",nodeId:"PC.II.2.c",fieldType:"dropdown",options:["SWIFT","MEPS+","CLS","DvP","FoP","Manual"]},{key:"be_system_changes",label:"Back End System Changes",strategy:"LLM",llmCategory:"operational",nodeId:"PC.II.2.c",fieldType:"textarea"},{key:"manual_workarounds",label:"Manual Work-Arounds",strategy:"MANUAL",nodeId:"PC.II.2.c",fieldType:"textarea"},{key:"system_enhancements",label:"System Enhancements Involved?",strategy:"MANUAL",nodeId:"PC.II.3",fieldType:"yesno"},{key:"iss_deviations",label:"ISS Policy Deviations",strategy:"MANUAL",nodeId:"PC.II.3",fieldType:"textarea",dependsOn:{field:"system_enhancements",value:"Yes"}},{key:"pentest_status",label:"Penetration Test Status",strategy:"MANUAL",nodeId:"PC.II.3",fieldType:"dropdown",options:["Not Required","Planned","In Progress","Completed - Pass","Completed - Remediation Required"],dependsOn:{field:"system_enhancements",value:"Yes"}},{key:"security_assessment",label:"Security Assessment Details",strategy:"MANUAL",nodeId:"PC.II.3",fieldType:"textarea",dependsOn:{field:"system_enhancements",value:"Yes"}},{key:"grc_id",label:"GRC ID (External Party Risk)",strategy:"MANUAL",nodeId:"PC.II.4",fieldType:"text"},{key:"hsm_required",label:"HSM Required?",strategy:"MANUAL",nodeId:"PC.II.4",fieldType:"yesno"},{key:"rto_target",label:"Recovery Time Objective (RTO)",strategy:"RULE",ruleSource:"system_config",nodeId:"PC.II.4",fieldType:"text"},{key:"rpo_target",label:"Recovery Point Objective (RPO)",strategy:"RULE",ruleSource:"system_config",nodeId:"PC.II.4",fieldType:"text"},{key:"dr_testing_plan",label:"DR Testing Plan",strategy:"COPY",copySection:"operational",nodeId:"PC.II.4",fieldType:"textarea"},{key:"bia_considerations",label:"BIA Considerations",strategy:"COPY",copySection:"operational",nodeId:"PC.II.5",fieldType:"textarea"},{key:"bcp_requirements",label:"Updated BCP Requirements",strategy:"COPY",copySection:"operational",nodeId:"PC.II.5",fieldType:"textarea"},{key:"continuity_measures",label:"Additional Continuity Measures",strategy:"MANUAL",nodeId:"PC.II.5",fieldType:"textarea"},{key:"pricing_model_required",label:"Pricing Model Validation Required?",strategy:"MANUAL",nodeId:"PC.III.1",fieldType:"yesno"},{key:"pricing_methodology",label:"Pricing Methodology",strategy:"LLM",llmCategory:"pricing",nodeId:"PC.III.1",fieldType:"textarea",dependsOn:{field:"pricing_model_required",value:"Yes"}},{key:"roae_analysis",label:"ROAE Analysis",strategy:"LLM",llmCategory:"pricing",nodeId:"PC.III.1",fieldType:"textarea"},{key:"pricing_assumptions",label:"Pricing Assumptions",strategy:"LLM",llmCategory:"pricing",nodeId:"PC.III.1",fieldType:"textarea"},{key:"bespoke_adjustments",label:"Bespoke Adjustments",strategy:"LLM",llmCategory:"pricing",nodeId:"PC.III.1",fieldType:"textarea"},{key:"pricing_model_name",label:"Pricing Model Name",strategy:"RULE",ruleSource:"product_config",nodeId:"PC.III.2",fieldType:"text"},{key:"model_validation_date",label:"Model Validation Date",strategy:"RULE",ruleSource:"product_config",nodeId:"PC.III.2",fieldType:"date"},{key:"model_restrictions",label:"Model Restrictions",strategy:"LLM",llmCategory:"pricing",nodeId:"PC.III.2",fieldType:"textarea"},{key:"risk_data_assessment_ref",label:"Risk Data Assessment Tool Reference",strategy:"MANUAL",nodeId:"PC.III.2",fieldType:"text"},{key:"simm_treatment",label:"SIMM Treatment",strategy:"LLM",llmCategory:"pricing",nodeId:"PC.III.3",fieldType:"textarea"},{key:"simm_sensitivities",label:"SIMM Sensitivities",strategy:"LLM",llmCategory:"pricing",nodeId:"PC.III.3",fieldType:"textarea"},{key:"legal_opinion",label:"Legal Opinion",strategy:"COPY",copySection:"legal",nodeId:"PC.IV.A.1",fieldType:"textarea"},{key:"licensing_requirements",label:"Licensing Requirements",strategy:"LLM",llmCategory:"compliance",nodeId:"PC.IV.A.1",fieldType:"textarea"},{key:"primary_regulation",label:"Primary Regulation",strategy:"RULE",ruleSource:"jurisdiction_table",nodeId:"PC.IV.A.1",fieldType:"text"},{key:"secondary_regulations",label:"Secondary Regulations",strategy:"RULE",ruleSource:"jurisdiction_table",nodeId:"PC.IV.A.1",fieldType:"bullet_list"},{key:"regulatory_reporting",label:"Regulatory Reporting",strategy:"RULE",ruleSource:"jurisdiction_table",nodeId:"PC.IV.A.1",fieldType:"textarea"},{key:"cross_border_regulations",label:"Cross-Border Regulatory Considerations",strategy:"LLM",llmCategory:"compliance",nodeId:"PC.IV.A.1",fieldType:"textarea"},{key:"legal_docs_required",label:"Legal Documentation Required",strategy:"LLM",llmCategory:"compliance",nodeId:"PC.IV.A.1",fieldType:"bullet_list"},{key:"sanctions_check",label:"Sanctions Check",strategy:"RULE",ruleSource:"jurisdiction_table",nodeId:"PC.IV.A.1",fieldType:"yesno"},{key:"aml_considerations",label:"AML Considerations",strategy:"LLM",llmCategory:"compliance",nodeId:"PC.IV.A.1",fieldType:"textarea"},{key:"tax_impact",label:"Tax Impact",strategy:"COPY",copySection:"legal",nodeId:"PC.IV.A.2",fieldType:"textarea"},{key:"accounting_book",label:"Trading Book vs Banking Book",strategy:"RULE",ruleSource:"product_config",nodeId:"PC.IV.A.2",fieldType:"dropdown",options:["Trading Book","Banking Book"]},{key:"fair_value_treatment",label:"Fair Value Treatment",strategy:"LLM",llmCategory:"financial_projection",nodeId:"PC.IV.A.2",fieldType:"textarea"},{key:"on_off_balance",label:"On/Off Balance Sheet",strategy:"RULE",ruleSource:"product_config",nodeId:"PC.IV.A.2",fieldType:"dropdown",options:["On Balance Sheet","Off Balance Sheet","Both"]},{key:"tax_jurisdictions",label:"Tax Jurisdictions Analysis",strategy:"LLM",llmCategory:"financial_projection",nodeId:"PC.IV.A.2",fieldType:"textarea"},{key:"market_risk",label:"Market Risk Assessment",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.B.1",fieldType:"textarea",required:!0},{key:"risk_classification",label:"Risk Classification",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.B.1",fieldType:"dropdown",options:["Level 1","Level 2","Level 3"]},{key:"pricing_parameters",label:"Relevant Pricing Parameters",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.B.1",fieldType:"textarea"},{key:"mrf_ir_delta",label:"MRF: IR Delta",strategy:"RULE",ruleSource:"product_config",nodeId:"PC.IV.B.1",fieldType:"yesno"},{key:"mrf_ir_vega",label:"MRF: IR Vega",strategy:"RULE",ruleSource:"product_config",nodeId:"PC.IV.B.1",fieldType:"yesno"},{key:"mrf_ir_gamma",label:"MRF: IR Gamma",strategy:"RULE",ruleSource:"product_config",nodeId:"PC.IV.B.1",fieldType:"yesno"},{key:"mrf_fx_delta",label:"MRF: FX Delta",strategy:"RULE",ruleSource:"product_config",nodeId:"PC.IV.B.1",fieldType:"yesno"},{key:"mrf_fx_vega",label:"MRF: FX Vega",strategy:"RULE",ruleSource:"product_config",nodeId:"PC.IV.B.1",fieldType:"yesno"},{key:"mrf_eq_delta",label:"MRF: Equity Delta",strategy:"RULE",ruleSource:"product_config",nodeId:"PC.IV.B.1",fieldType:"yesno"},{key:"mrf_eq_vega",label:"MRF: Equity Vega",strategy:"RULE",ruleSource:"product_config",nodeId:"PC.IV.B.1",fieldType:"yesno"},{key:"mrf_commodity",label:"MRF: Commodity",strategy:"RULE",ruleSource:"product_config",nodeId:"PC.IV.B.1",fieldType:"yesno"},{key:"mrf_credit",label:"MRF: Credit",strategy:"RULE",ruleSource:"product_config",nodeId:"PC.IV.B.1",fieldType:"yesno"},{key:"mrf_correlation",label:"MRF: Correlation",strategy:"RULE",ruleSource:"product_config",nodeId:"PC.IV.B.1",fieldType:"yesno"},{key:"liquidity_risk",label:"Funding/Liquidity Risk",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.B.2",fieldType:"textarea"},{key:"liquidity_cost",label:"Corporate Risk Liquidity Cost",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.B.2",fieldType:"textarea"},{key:"contingent_cashflow",label:"Contingent Cash Flow Risk",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.B.2",fieldType:"yesno"},{key:"contingent_cashflow_desc",label:"Contingent Cash Flow Description",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.B.2",fieldType:"textarea",dependsOn:{field:"contingent_cashflow",value:"Yes"}},{key:"trading_book_assignment",label:"Trading Book Assignment Confirmed?",strategy:"MANUAL",nodeId:"PC.IV.B.3",fieldType:"yesno"},{key:"regulatory_capital",label:"Regulatory Capital Requirements",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.B.3",fieldType:"textarea"},{key:"var_capture",label:"VaR Capture",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.B.3",fieldType:"textarea"},{key:"model_validation_proc",label:"Model Validation Procedures",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.B.3",fieldType:"textarea"},{key:"credit_risk",label:"Credit Risk Assessment",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.C.1",fieldType:"textarea",required:!0},{key:"new_limit_types",label:"New Credit Limit Types Required?",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.C.1",fieldType:"yesno"},{key:"credit_support_required",label:"Credit Support Required?",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.C.1",fieldType:"yesno"},{key:"counterparty_default",label:"Risk Mitigation Measures",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.C.2",fieldType:"textarea"},{key:"collateral_framework",label:"Collateral Framework",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.C.2",fieldType:"textarea"},{key:"stress_test_results",label:"Stress Test Results",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.C.2",fieldType:"textarea"},{key:"stress_scenarios",label:"Stress Scenarios",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.C.3",fieldType:"textarea"},{key:"exposure_limits",label:"Limits to Cover Exposure",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.C.3",fieldType:"textarea"},{key:"monitoring_party",label:"Monitoring Party",strategy:"MANUAL",nodeId:"PC.IV.C.3",fieldType:"text"},{key:"custody_risk",label:"Custody Risk",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.C.4",fieldType:"textarea"},{key:"collateral_risk_rated",label:"Collateral Risk-Rated per Core Policy?",strategy:"MANUAL",nodeId:"PC.IV.C.4",fieldType:"yesno"},{key:"counterparty_rating",label:"Counterparty Rating",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.C.5",fieldType:"text"},{key:"pfe_standards",label:"PFE Standards (Standardized Approach)",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.C.5",fieldType:"textarea"},{key:"ead_calculation",label:"EAD & Capital (Internal Model)",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.C.5",fieldType:"textarea"},{key:"large_exposure_rules",label:"Large Exposure Rules",strategy:"LLM",llmCategory:"compliance",nodeId:"PC.IV.C.6",fieldType:"textarea"},{key:"concentration_limits",label:"Concentration Limits",strategy:"LLM",llmCategory:"compliance",nodeId:"PC.IV.C.6",fieldType:"textarea"},{key:"ccr_framework",label:"Counterparty Credit Risk Framework",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.C.7",fieldType:"textarea"},{key:"reputational_risk",label:"Reputational Risk Assessment",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.D",fieldType:"textarea"},{key:"negative_impact",label:"Potential Negative Impact?",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.D",fieldType:"yesno"},{key:"esg_assessment",label:"ESG Assessment",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.D",fieldType:"textarea"},{key:"esg_classification",label:"ESG Classification",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.D",fieldType:"dropdown",options:["Green","Social","Sustainable","Transition","Not Applicable"]},{key:"data_governance",label:"Data Governance Framework",strategy:"COPY",copySection:"data_mgmt",nodeId:"PC.V.1",fieldType:"textarea"},{key:"data_ownership",label:"Data Ownership",strategy:"COPY",copySection:"data_mgmt",nodeId:"PC.V.1",fieldType:"text"},{key:"data_stewardship",label:"Data Stewardship",strategy:"COPY",copySection:"data_mgmt",nodeId:"PC.V.1",fieldType:"text"},{key:"data_quality_monitoring",label:"Data Quality Monitoring",strategy:"COPY",copySection:"data_mgmt",nodeId:"PC.V.1",fieldType:"textarea"},{key:"data_privacy",label:"Data Privacy Assessment",strategy:"COPY",copySection:"data_mgmt",nodeId:"PC.V.1",fieldType:"textarea"},{key:"data_retention",label:"Data Retention Policy",strategy:"COPY",copySection:"data_mgmt",nodeId:"PC.V.1",fieldType:"textarea"},{key:"gdpr_compliance",label:"GDPR/Privacy Compliance",strategy:"COPY",copySection:"data_mgmt",nodeId:"PC.V.1",fieldType:"yesno"},{key:"pure_assessment_id",label:"PURE Assessment ID",strategy:"MANUAL",nodeId:"PC.V.2",fieldType:"text"},{key:"pure_purposeful",label:"PURE: Purposeful",strategy:"LLM",llmCategory:"compliance",nodeId:"PC.V.2",fieldType:"textarea"},{key:"pure_unsurprising",label:"PURE: Unsurprising",strategy:"LLM",llmCategory:"compliance",nodeId:"PC.V.2",fieldType:"textarea"},{key:"pure_respectful",label:"PURE: Respectful",strategy:"LLM",llmCategory:"compliance",nodeId:"PC.V.2",fieldType:"textarea"},{key:"pure_explainable",label:"PURE: Explainable",strategy:"LLM",llmCategory:"compliance",nodeId:"PC.V.2",fieldType:"textarea"},{key:"reporting_requirements",label:"Risk Data Aggregation & Reporting",strategy:"LLM",llmCategory:"compliance",nodeId:"PC.V.3",fieldType:"textarea"},{key:"automated_reporting",label:"Automated Regulatory Reporting",strategy:"LLM",llmCategory:"compliance",nodeId:"PC.V.3",fieldType:"textarea"},{key:"other_risks_exist",label:"Other Risks Not Described in I-V?",strategy:"MANUAL",nodeId:"PC.VI",fieldType:"yesno"},{key:"operational_risk",label:"Operational Risk Assessment",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.VI",fieldType:"textarea",dependsOn:{field:"other_risks_exist",value:"Yes"}},{key:"additional_risk_mitigants",label:"Additional Risk Mitigants",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.VI",fieldType:"bullet_list",dependsOn:{field:"other_risks_exist",value:"Yes"}},{key:"trading_product",label:"Involves Trading Product?",strategy:"RULE",ruleSource:"npa_record",nodeId:"PC.VII",fieldType:"yesno"},{key:"appendix5_required",label:"Appendix 5 Assessment Required?",strategy:"RULE",ruleSource:"npa_record",nodeId:"PC.VII",fieldType:"yesno",dependsOn:{field:"trading_product",value:"Yes"}},{key:"booking_entity",label:"Booking Entity",strategy:"RULE",ruleSource:"org_chart",nodeId:"APP.1",fieldType:"text",required:!0},{key:"sales_entity",label:"Sales / Origination Entity",strategy:"RULE",ruleSource:"org_chart",nodeId:"APP.1",fieldType:"text"},{key:"sales_location",label:"Sales / Origination Location",strategy:"RULE",ruleSource:"org_chart",nodeId:"APP.1",fieldType:"text"},{key:"booking_location",label:"Booking Location",strategy:"RULE",ruleSource:"org_chart",nodeId:"APP.1",fieldType:"text"},{key:"risk_taking_entity",label:"Risk Taking Entity",strategy:"RULE",ruleSource:"org_chart",nodeId:"APP.1",fieldType:"text"},{key:"risk_taking_location",label:"Risk Taking Location",strategy:"RULE",ruleSource:"org_chart",nodeId:"APP.1",fieldType:"text"},{key:"processing_entity",label:"Processing Entity",strategy:"RULE",ruleSource:"org_chart",nodeId:"APP.1",fieldType:"text"},{key:"processing_location",label:"Processing Location",strategy:"RULE",ruleSource:"org_chart",nodeId:"APP.1",fieldType:"text"},{key:"counterparty",label:"Counterparty",strategy:"RULE",ruleSource:"org_chart",nodeId:"APP.1",fieldType:"text"},{key:"dbs_ip_exists",label:"DBS IP Created/Used?",strategy:"MANUAL",nodeId:"APP.2",fieldType:"yesno"},{key:"dbs_ip_details",label:"DBS IP Details",strategy:"MANUAL",nodeId:"APP.2",fieldType:"textarea",dependsOn:{field:"dbs_ip_exists",value:"Yes"}},{key:"third_party_ip_exists",label:"Third Party IP Used?",strategy:"MANUAL",nodeId:"APP.2",fieldType:"yesno"},{key:"third_party_ip_details",label:"Third Party IP Details",strategy:"MANUAL",nodeId:"APP.2",fieldType:"textarea",dependsOn:{field:"third_party_ip_exists",value:"Yes"}},{key:"ip_licensing",label:"IP Licensing Arrangements",strategy:"MANUAL",nodeId:"APP.2",fieldType:"textarea"},{key:"aml_assessment",label:"AML Assessment",strategy:"LLM",llmCategory:"compliance",nodeId:"APP.3",fieldType:"textarea",required:!0},{key:"terrorism_financing",label:"Terrorism Financing Risk",strategy:"LLM",llmCategory:"compliance",nodeId:"APP.3",fieldType:"textarea"},{key:"sanctions_assessment",label:"Sanctions Assessment",strategy:"LLM",llmCategory:"compliance",nodeId:"APP.3",fieldType:"textarea"},{key:"fraud_risk",label:"Fraud Risk Assessment",strategy:"LLM",llmCategory:"compliance",nodeId:"APP.3",fieldType:"textarea"},{key:"bribery_corruption",label:"Bribery & Corruption Risk",strategy:"LLM",llmCategory:"compliance",nodeId:"APP.3",fieldType:"textarea"},{key:"fc_risk_rating",label:"Overall Financial Crime Risk Rating",strategy:"LLM",llmCategory:"compliance",nodeId:"APP.3",fieldType:"dropdown",options:["Low","Medium","High","Very High"]},{key:"fc_mitigation_measures",label:"FC Mitigation Measures",strategy:"LLM",llmCategory:"compliance",nodeId:"APP.3",fieldType:"bullet_list"},{key:"rda_compliance",label:"RDA Regulatory Compliance",strategy:"LLM",llmCategory:"compliance",nodeId:"APP.4",fieldType:"textarea"},{key:"rda_data_sources",label:"Risk Data Sources",strategy:"COPY",copySection:"data_mgmt",nodeId:"APP.4",fieldType:"bullet_list"},{key:"rda_aggregation_method",label:"Data Aggregation Methodology",strategy:"COPY",copySection:"data_mgmt",nodeId:"APP.4",fieldType:"textarea"},{key:"app5_revenue_sharing",label:"Revenue Sharing Model",strategy:"LLM",llmCategory:"financial_projection",nodeId:"APP.5",fieldType:"textarea"},{key:"app5_capital_allocation",label:"Capital Allocation",strategy:"LLM",llmCategory:"financial_projection",nodeId:"APP.5",fieldType:"textarea"},{key:"app5_hedge_purpose",label:"Hedge Purpose?",strategy:"MANUAL",nodeId:"APP.5",fieldType:"yesno"},{key:"app5_hedge_description",label:"Hedge Description",strategy:"LLM",llmCategory:"product_description",nodeId:"APP.5",fieldType:"textarea",dependsOn:{field:"app5_hedge_purpose",value:"Yes"}},{key:"collateral_types",label:"Collateral Types",strategy:"COPY",copySection:"trading",nodeId:"APP.5",fieldType:"multiselect",options:["Cash","Government Bonds","Corporate Bonds","Equities","Real Estate","Commodities","Other"]},{key:"custody_arrangements",label:"Custody Arrangements",strategy:"COPY",copySection:"trading",nodeId:"APP.5",fieldType:"textarea"},{key:"valuation_method",label:"Valuation Method",strategy:"COPY",copySection:"trading",nodeId:"APP.5",fieldType:"textarea"},{key:"funding_source",label:"Funding Source",strategy:"COPY",copySection:"trading",nodeId:"APP.5",fieldType:"textarea"},{key:"booking_schema",label:"Booking Schema",strategy:"RULE",ruleSource:"product_config",nodeId:"APP.5",fieldType:"textarea"},{key:"lifecycle_management",label:"Lifecycle Management",strategy:"COPY",copySection:"trading",nodeId:"APP.5",fieldType:"textarea"},{key:"cross_product_integration",label:"Cross-Product Integration",strategy:"LLM",llmCategory:"operational",nodeId:"APP.5",fieldType:"textarea"},{key:"app5_tech_architecture",label:"Technology Architecture",strategy:"LLM",llmCategory:"operational",nodeId:"APP.5",fieldType:"textarea"},{key:"app5_security_req",label:"Security Requirements",strategy:"MANUAL",nodeId:"APP.5",fieldType:"textarea"},{key:"app5_scalability",label:"Scalability Requirements",strategy:"LLM",llmCategory:"operational",nodeId:"APP.5",fieldType:"textarea"},{key:"app5_compliance_framework",label:"Compliance Framework",strategy:"LLM",llmCategory:"compliance",nodeId:"APP.5",fieldType:"textarea"},{key:"app5_reg_monitoring",label:"Regulatory Monitoring",strategy:"LLM",llmCategory:"compliance",nodeId:"APP.5",fieldType:"textarea"},{key:"third_party_platform",label:"Third-Party Platform Used?",strategy:"MANUAL",nodeId:"APP.6",fieldType:"yesno"},{key:"platform_name",label:"Platform Name",strategy:"MANUAL",nodeId:"APP.6",fieldType:"text",dependsOn:{field:"third_party_platform",value:"Yes"}},{key:"platform_risk_assessment",label:"Platform Risk Assessment",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"APP.6",fieldType:"textarea",dependsOn:{field:"third_party_platform",value:"Yes"}},{key:"info_security_assessment",label:"Information Security Assessment",strategy:"MANUAL",nodeId:"APP.6",fieldType:"textarea",dependsOn:{field:"third_party_platform",value:"Yes"}},{key:"data_residency",label:"Data Residency Consideration",strategy:"LLM",llmCategory:"compliance",nodeId:"APP.6",fieldType:"textarea",dependsOn:{field:"third_party_platform",value:"Yes"}},{key:"product_currency_pair",label:"Currency Pair (if FX)",strategy:"RULE",ruleSource:"npa_record",nodeId:"PC.I.1.b",fieldType:"text"},{key:"product_benchmark",label:"Benchmark / Reference Rate",strategy:"RULE",ruleSource:"npa_record",nodeId:"PC.I.1.b",fieldType:"text"},{key:"product_notional_ccy",label:"Notional Currency",strategy:"RULE",ruleSource:"npa_record",nodeId:"PC.I.1.c",fieldType:"dropdown",options:["SGD","USD","EUR","GBP","JPY","CNY","HKD","AUD","Multi-currency"]},{key:"transfer_pricing",label:"Transfer Pricing Methodology",strategy:"LLM",llmCategory:"financial_projection",nodeId:"PC.I.1.c",fieldType:"textarea"},{key:"break_even_timeline",label:"Break-Even Timeline",strategy:"LLM",llmCategory:"financial_projection",nodeId:"PC.I.1.d",fieldType:"text"},{key:"competitive_landscape",label:"Competitive Landscape",strategy:"LLM",llmCategory:"product_description",nodeId:"PC.I.1.a",fieldType:"textarea"},{key:"market_opportunity",label:"Market Opportunity Assessment",strategy:"LLM",llmCategory:"product_description",nodeId:"PC.I.1.a",fieldType:"textarea"},{key:"customer_accreditation",label:"Customer Accreditation Requirements",strategy:"MANUAL",nodeId:"PC.I.2.c",fieldType:"textarea"},{key:"kyc_requirements",label:"KYC/CDD Requirements",strategy:"COPY",copySection:"product_specs",nodeId:"PC.I.3.b",fieldType:"textarea"},{key:"complaints_handling",label:"Complaints Handling Process",strategy:"COPY",copySection:"product_specs",nodeId:"PC.I.3.b",fieldType:"textarea"},{key:"trade_capture_system",label:"Trade Capture System",strategy:"RULE",ruleSource:"system_config",nodeId:"PC.II.2.a",fieldType:"text"},{key:"risk_system",label:"Risk Management System",strategy:"RULE",ruleSource:"system_config",nodeId:"PC.II.2.a",fieldType:"text"},{key:"reporting_system",label:"Reporting System",strategy:"RULE",ruleSource:"system_config",nodeId:"PC.II.2.a",fieldType:"text"},{key:"stp_rate",label:"Expected STP Rate",strategy:"LLM",llmCategory:"operational",nodeId:"PC.II.1.b",fieldType:"text"},{key:"nostro_accounts",label:"Nostro Account Requirements",strategy:"RULE",ruleSource:"product_config",nodeId:"PC.II.1.b",fieldType:"textarea"},{key:"mktdata_requirements",label:"Market Data Requirements",strategy:"LLM",llmCategory:"operational",nodeId:"PC.II.2.b",fieldType:"textarea"},{key:"fva_adjustment",label:"FVA Adjustment",strategy:"LLM",llmCategory:"pricing",nodeId:"PC.III.1",fieldType:"textarea"},{key:"xva_treatment",label:"XVA Treatment",strategy:"LLM",llmCategory:"pricing",nodeId:"PC.III.1",fieldType:"textarea"},{key:"day_count_convention",label:"Day Count Convention",strategy:"RULE",ruleSource:"product_config",nodeId:"PC.III.1",fieldType:"dropdown",options:["ACT/360","ACT/365","30/360","ACT/ACT"]},{key:"wrong_way_risk",label:"Wrong-Way Risk",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.C.2",fieldType:"textarea"},{key:"cva_dva_impact",label:"CVA/DVA Impact",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.C.5",fieldType:"textarea"},{key:"netting_agreements",label:"Netting Agreements",strategy:"COPY",copySection:"legal",nodeId:"PC.IV.C.2",fieldType:"textarea"},{key:"isda_master",label:"ISDA Master Agreement",strategy:"MANUAL",nodeId:"PC.IV.C.2",fieldType:"yesno"},{key:"csa_in_place",label:"CSA in Place",strategy:"MANUAL",nodeId:"PC.IV.C.4",fieldType:"yesno"},{key:"country_risk",label:"Country Risk Assessment",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.D",fieldType:"textarea"},{key:"model_risk",label:"Model Risk",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.B.1",fieldType:"textarea"},{key:"data_lineage",label:"Data Lineage Documentation",strategy:"COPY",copySection:"data_mgmt",nodeId:"PC.V.1",fieldType:"textarea"},{key:"data_classification",label:"Data Classification Level",strategy:"RULE",ruleSource:"system_config",nodeId:"PC.V.1",fieldType:"dropdown",options:["Public","Internal","Confidential","Restricted"]},{key:"hedge_entity",label:"Hedge Entity",strategy:"RULE",ruleSource:"org_chart",nodeId:"APP.1",fieldType:"text"},{key:"hedge_location",label:"Hedge Location",strategy:"RULE",ruleSource:"org_chart",nodeId:"APP.1",fieldType:"text"},{key:"clearing_entity",label:"Clearing Entity",strategy:"RULE",ruleSource:"org_chart",nodeId:"APP.1",fieldType:"text"},{key:"margin_methodology",label:"Margin Methodology",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"APP.5",fieldType:"textarea"},{key:"close_out_netting",label:"Close-Out Netting",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"APP.5",fieldType:"textarea"},{key:"trade_reporting",label:"Trade Reporting Requirements",strategy:"RULE",ruleSource:"jurisdiction_table",nodeId:"APP.5",fieldType:"textarea"},{key:"clearing_obligation",label:"Clearing Obligation",strategy:"RULE",ruleSource:"jurisdiction_table",nodeId:"APP.5",fieldType:"yesno"},{key:"customer_objectives",label:"Customer Objectives & Risk Profile",strategy:"LLM",llmCategory:"product_description",nodeId:"PC.I.2.e",fieldType:"textarea"},{key:"customer_key_risks",label:"Key Risks Faced by Target Customers",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.I.2.g",fieldType:"textarea"},{key:"sales_surveillance",label:"Sales Surveillance Process",strategy:"COPY",copySection:"product_specs",nodeId:"PC.I.3.d",fieldType:"textarea"},{key:"staff_training",label:"Staff Training Requirements",strategy:"COPY",copySection:"product_specs",nodeId:"PC.I.3.e",fieldType:"textarea"},{key:"ops_adequacy_checklist",label:"Operational Adequacy Checklist",strategy:"MANUAL",nodeId:"PC.II.1.c",fieldType:"checkbox_group",options:["Adequate staffing confirmed","Process documentation complete","Systems ready for go-live","Controls tested and effective","Monitoring dashboards configured","Escalation procedures documented","Audit trail requirements met"]},{key:"operating_account_controls",label:"Operating Account Controls",strategy:"COPY",copySection:"operational",nodeId:"PC.II.1.d",fieldType:"textarea"},{key:"limit_structure",label:"Limit Structure",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.II.1.e",fieldType:"textarea"},{key:"limit_monitoring",label:"Limit Monitoring Process",strategy:"COPY",copySection:"operational",nodeId:"PC.II.1.e",fieldType:"textarea"},{key:"manual_fallback",label:"Manual Process Fallback Required?",strategy:"MANUAL",nodeId:"PC.II.1.f",fieldType:"yesno"},{key:"manual_fallback_details",label:"Manual Fallback Details",strategy:"MANUAL",nodeId:"PC.II.1.f",fieldType:"textarea",dependsOn:{field:"manual_fallback",value:"Yes"}},{key:"collateral_eligibility",label:"Eligible Collateral Types",strategy:"COPY",copySection:"operational",nodeId:"PC.II.1.g",fieldType:"textarea"},{key:"collateral_haircuts",label:"Collateral Haircuts",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.II.1.g",fieldType:"textarea"},{key:"margin_frequency",label:"Margining Frequency",strategy:"RULE",ruleSource:"product_config",nodeId:"PC.II.1.g",fieldType:"dropdown",options:["Daily","Weekly","Monthly","Ad-hoc","N/A"]},{key:"collateral_disputes",label:"Collateral Dispute Resolution",strategy:"COPY",copySection:"operational",nodeId:"PC.II.1.g",fieldType:"textarea"},{key:"custody_required",label:"Custody Account Required?",strategy:"MANUAL",nodeId:"PC.II.1.h",fieldType:"yesno"},{key:"custody_details",label:"Custody Arrangement Details",strategy:"COPY",copySection:"operational",nodeId:"PC.II.1.h",fieldType:"textarea",dependsOn:{field:"custody_required",value:"Yes"}},{key:"trade_repository_reporting",label:"Trade Repository / ESFR Reporting",strategy:"LLM",llmCategory:"compliance",nodeId:"PC.II.1.i",fieldType:"textarea"},{key:"sfemc_references",label:"SFEMC / Code of Conduct References",strategy:"LLM",llmCategory:"compliance",nodeId:"PC.II.1.j",fieldType:"textarea"},{key:"bcm_critical_processes",label:"Critical Business Processes",strategy:"LLM",llmCategory:"operational",nodeId:"PC.II.5",fieldType:"textarea"},{key:"bcm_recovery_strategy",label:"Recovery Strategy",strategy:"COPY",copySection:"operational",nodeId:"PC.II.5",fieldType:"textarea"},{key:"bcm_alternate_site",label:"Alternate Site Arrangements",strategy:"COPY",copySection:"operational",nodeId:"PC.II.5",fieldType:"textarea"},{key:"bcm_communication_plan",label:"Crisis Communication Plan",strategy:"COPY",copySection:"operational",nodeId:"PC.II.5",fieldType:"textarea"},{key:"bcm_testing_frequency",label:"BCM Testing Frequency",strategy:"RULE",ruleSource:"system_config",nodeId:"PC.II.5",fieldType:"dropdown",options:["Quarterly","Semi-annually","Annually","As Required"]},{key:"bcm_vendor_dependencies",label:"Vendor/Third-Party Dependencies",strategy:"LLM",llmCategory:"operational",nodeId:"PC.II.5",fieldType:"textarea"},{key:"bcm_staff_awareness",label:"Staff Awareness & Training",strategy:"COPY",copySection:"operational",nodeId:"PC.II.5",fieldType:"textarea"},{key:"bcm_regulatory_compliance",label:"BCM Regulatory Compliance",strategy:"LLM",llmCategory:"compliance",nodeId:"PC.II.5",fieldType:"textarea"},{key:"bcm_incident_response",label:"Incident Response Plan",strategy:"COPY",copySection:"operational",nodeId:"PC.II.5",fieldType:"textarea"},{key:"simm_backtesting",label:"SIMM Backtesting Results",strategy:"LLM",llmCategory:"pricing",nodeId:"PC.III.3",fieldType:"textarea"},{key:"service_output_fees",label:"Service Output Fees",strategy:"LLM",llmCategory:"financial_projection",nodeId:"PC.IV.A.2",fieldType:"textarea"},{key:"service_fee_structure",label:"Fee Structure Details",strategy:"LLM",llmCategory:"financial_projection",nodeId:"PC.IV.A.2",fieldType:"textarea"},{key:"service_fee_allocation",label:"Fee Allocation Methodology",strategy:"LLM",llmCategory:"financial_projection",nodeId:"PC.IV.A.2",fieldType:"textarea"},{key:"reg_matching_ifrs",label:"IFRS Regulatory Matching",strategy:"LLM",llmCategory:"compliance",nodeId:"PC.IV.A.2",fieldType:"textarea"},{key:"reg_matching_mas",label:"MAS Notice Regulatory Matching",strategy:"LLM",llmCategory:"compliance",nodeId:"PC.IV.A.2",fieldType:"textarea"},{key:"reg_matching_gst",label:"GST Treatment",strategy:"LLM",llmCategory:"financial_projection",nodeId:"PC.IV.A.2",fieldType:"textarea"},{key:"reg_matching_wht",label:"Withholding Tax Treatment",strategy:"LLM",llmCategory:"financial_projection",nodeId:"PC.IV.A.2",fieldType:"textarea"},{key:"fc_conduct_considerations",label:"Conduct Considerations",strategy:"LLM",llmCategory:"compliance",nodeId:"PC.IV.A.3",fieldType:"textarea"},{key:"fc_mar_assessment",label:"MAR Assessment",strategy:"LLM",llmCategory:"compliance",nodeId:"PC.IV.A.3",fieldType:"textarea"},{key:"fc_mar_sub_items",label:"MAR Sub-Items (MAS References)",strategy:"LLM",llmCategory:"compliance",nodeId:"PC.IV.A.3",fieldType:"bullet_list"},{key:"fc_mra_boundary_test",label:"MRA Boundary Test Required?",strategy:"MANUAL",nodeId:"PC.IV.A.3",fieldType:"yesno"},{key:"fc_mra_details",label:"MRA Boundary Test Details",strategy:"LLM",llmCategory:"compliance",nodeId:"PC.IV.A.3",fieldType:"textarea",dependsOn:{field:"fc_mra_boundary_test",value:"Yes"}},{key:"flr_lcr_nsfr_metrics",label:"LCR/NSFR/EAFL Metrics",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.A.D",fieldType:"textarea"},{key:"flr_hqla_qualification",label:"HQLA Qualification",strategy:"MANUAL",nodeId:"PC.IV.A.D",fieldType:"yesno"},{key:"flr_cashflow_modeling",label:"Cashflow Modeling",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.A.D",fieldType:"textarea"},{key:"flr_liquidity_facility",label:"Liquidity Facility Required?",strategy:"MANUAL",nodeId:"PC.IV.A.D",fieldType:"yesno"},{key:"flr_limit_implementation",label:"Limit Implementation Plan",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"PC.IV.A.D",fieldType:"textarea"},{key:"app5_valuation_model",label:"Valuation Model (Trading)",strategy:"LLM",llmCategory:"pricing",nodeId:"APP.5.4",fieldType:"textarea"},{key:"rda_reporting_frequency",label:"RDAR Reporting Frequency",strategy:"RULE",ruleSource:"system_config",nodeId:"PC.V.3",fieldType:"dropdown",options:["Daily","Weekly","Monthly","Quarterly","Ad-hoc"]},{key:"rda_data_quality",label:"Data Quality Assessment",strategy:"LLM",llmCategory:"data_mgmt",nodeId:"APP.4",fieldType:"textarea"},{key:"fc_policy_framework",label:"Financial Crime Policy Framework",strategy:"COPY",copySection:"legal",nodeId:"APP.3.2",fieldType:"textarea"},{key:"fc_screening_controls",label:"Screening Controls",strategy:"COPY",copySection:"legal",nodeId:"APP.3.2",fieldType:"textarea"},{key:"fc_transaction_monitoring",label:"Transaction Monitoring",strategy:"COPY",copySection:"legal",nodeId:"APP.3.2",fieldType:"textarea"},{key:"fc_suspicious_reporting",label:"Suspicious Transaction Reporting",strategy:"MANUAL",nodeId:"APP.3.2",fieldType:"textarea"},{key:"fc_record_keeping",label:"Record Keeping Requirements",strategy:"COPY",copySection:"legal",nodeId:"APP.3.2",fieldType:"textarea"},{key:"fc_staff_training",label:"Financial Crime Staff Training",strategy:"COPY",copySection:"legal",nodeId:"APP.3.2",fieldType:"textarea"},{key:"fc_independent_testing",label:"Independent Testing Program",strategy:"MANUAL",nodeId:"APP.3.2",fieldType:"textarea"},{key:"fc_validation_process",label:"Validation Process",strategy:"COPY",copySection:"legal",nodeId:"APP.3.3",fieldType:"textarea"},{key:"fc_surveillance_tools",label:"Surveillance Tools",strategy:"LLM",llmCategory:"compliance",nodeId:"APP.3.3",fieldType:"textarea"},{key:"fc_regulatory_reporting",label:"Regulatory Reporting Obligations",strategy:"LLM",llmCategory:"compliance",nodeId:"APP.3.3",fieldType:"textarea"},{key:"fc_data_privacy_compliance",label:"Data Privacy Compliance",strategy:"LLM",llmCategory:"compliance",nodeId:"APP.3.4",fieldType:"textarea"},{key:"fc_data_sharing_agreements",label:"Data Sharing Agreements",strategy:"COPY",copySection:"legal",nodeId:"APP.3.4",fieldType:"textarea"},{key:"tp_use_case_description",label:"Use Case Description",strategy:"LLM",llmCategory:"operational",nodeId:"APP.6.A",fieldType:"textarea"},{key:"tp_business_justification",label:"Business Justification",strategy:"LLM",llmCategory:"product_description",nodeId:"APP.6.A",fieldType:"textarea"},{key:"tp_risk_rating",label:"Risk Rating",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"APP.6.B",fieldType:"dropdown",options:["Low","Medium","High","Critical"]},{key:"tp_risk_mitigants",label:"Risk Mitigants",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"APP.6.B",fieldType:"textarea"},{key:"tp_data_classification",label:"Data Classification",strategy:"MANUAL",nodeId:"APP.6.C1",fieldType:"dropdown",options:["Public","Internal","Confidential","Restricted"]},{key:"tp_user_population",label:"User Population",strategy:"MANUAL",nodeId:"APP.6.C1",fieldType:"textarea"},{key:"tp_integration_scope",label:"Integration Scope",strategy:"LLM",llmCategory:"operational",nodeId:"APP.6.C1",fieldType:"textarea"},{key:"tp_data_flow",label:"Data Flow Description",strategy:"LLM",llmCategory:"operational",nodeId:"APP.6.C1",fieldType:"textarea"},{key:"tp_exit_strategy",label:"Exit Strategy",strategy:"LLM",llmCategory:"operational",nodeId:"APP.6.C1",fieldType:"textarea"},{key:"tp_encryption_standards",label:"Encryption Standards",strategy:"MANUAL",nodeId:"APP.6.C2",fieldType:"textarea"},{key:"tp_access_controls",label:"Access Controls",strategy:"MANUAL",nodeId:"APP.6.C2",fieldType:"textarea"},{key:"tp_audit_logging",label:"Audit Logging",strategy:"MANUAL",nodeId:"APP.6.C2",fieldType:"yesno"},{key:"tp_vulnerability_mgmt",label:"Vulnerability Management",strategy:"MANUAL",nodeId:"APP.6.C2",fieldType:"textarea"},{key:"tp_incident_response",label:"Incident Response Plan",strategy:"COPY",copySection:"operational",nodeId:"APP.6.C2",fieldType:"textarea"},{key:"tp_certifications",label:"Security Certifications",strategy:"MANUAL",nodeId:"APP.6.C2",fieldType:"checkbox_group",options:["SOC 2 Type II","ISO 27001","PCI DSS","CSA STAR","Other"]},{key:"tp_cyber_assessment",label:"Cybersecurity Assessment",strategy:"LLM",llmCategory:"risk_analysis",nodeId:"APP.6.C3",fieldType:"textarea"},{key:"tp_communication_archival",label:"Communication Archival",strategy:"MANUAL",nodeId:"APP.6.C3",fieldType:"yesno"},{key:"tp_retention_policy",label:"Data Retention Policy",strategy:"MANUAL",nodeId:"APP.6.C3",fieldType:"textarea"},{key:"tp_ediscovery",label:"e-Discovery Capability",strategy:"MANUAL",nodeId:"APP.6.C3",fieldType:"yesno"},{key:"tp_data_ownership",label:"Data Ownership",strategy:"MANUAL",nodeId:"APP.6.C4",fieldType:"textarea"},{key:"tp_ip_rights",label:"IP Rights",strategy:"MANUAL",nodeId:"APP.6.C4",fieldType:"textarea"},{key:"tp_pdpa_compliance",label:"PDPA Compliance",strategy:"LLM",llmCategory:"compliance",nodeId:"APP.6.C4",fieldType:"textarea"},{key:"tp_cross_border_transfer",label:"Cross-Border Data Transfer",strategy:"LLM",llmCategory:"compliance",nodeId:"APP.6.C4",fieldType:"textarea"},{key:"tp_data_deletion",label:"Data Deletion Process",strategy:"MANUAL",nodeId:"APP.6.C4",fieldType:"textarea"},{key:"tp_consent_management",label:"Consent Management",strategy:"MANUAL",nodeId:"APP.6.C4",fieldType:"textarea"},{key:"tp_breach_notification",label:"Breach Notification Process",strategy:"COPY",copySection:"legal",nodeId:"APP.6.C4",fieldType:"textarea"},{key:"tp_dpo_contact",label:"Data Protection Officer Contact",strategy:"MANUAL",nodeId:"APP.6.C4",fieldType:"text"},{key:"tp_privacy_impact",label:"Privacy Impact Assessment",strategy:"LLM",llmCategory:"compliance",nodeId:"APP.6.C4",fieldType:"textarea"}],Ze=new Map(_t.map(n=>[n.key,n]));function bt(n){let t=[...n.fieldKeys||[]];for(let e of n.children||[])t=t.concat(bt(e));return[...new Set(t)]}function Ut(){let n=[];for(let t of Xe.children||[])t.type==="section"&&n.push({id:t.id,label:t.label,numbering:t.numbering});for(let t=0;t<Se.length;t++){let e=Se[t];n.push({id:e.id,label:e.label,numbering:`A${t+1}`})}return n}var pi={AUTO:{label:"Auto",bgClass:"bg-emerald-50",textClass:"text-emerald-700",dotClass:"bg-emerald-400"},ADAPTED:{label:"Adapted",bgClass:"bg-amber-50",textClass:"text-amber-700",dotClass:"bg-amber-400"},MANUAL:{label:"Manual",bgClass:"bg-blue-50",textClass:"text-blue-700",dotClass:"bg-blue-400"}},mi={label:"Unknown",bgClass:"bg-slate-50",textClass:"text-slate-600",dotClass:"bg-slate-400"},et=class n{lineage="MANUAL";get badge(){return pi[this.lineage]||mi}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=E({type:n,selectors:[["app-npa-lineage-badge"]],inputs:{lineage:"lineage"},decls:3,vars:5,consts:[[1,"flex","items-center","gap-1","px-1.5","py-0.5","rounded","text-[9px]","font-semibold"],[1,"w-1.5","h-1.5","rounded-full"]],template:function(e,i){e&1&&(Ae(0,"span",0),kt(1,"span",1),l(2),Te()),e&2&&(O(i.badge.bgClass+" "+i.badge.textClass),s(),O(i.badge.dotClass),s(),x(" ",i.badge.label,`
`))},dependencies:[N],encapsulation:2})};var ui={RULE:{label:"Rule",bgClass:"bg-slate-100",textClass:"text-slate-600"},COPY:{label:"Copy",bgClass:"bg-violet-50",textClass:"text-violet-600"},LLM:{label:"AI",bgClass:"bg-sky-50",textClass:"text-sky-600"},MANUAL:{label:"Manual",bgClass:"bg-orange-50",textClass:"text-orange-600"}},gi={label:"Unknown",bgClass:"bg-slate-50",textClass:"text-slate-500"},tt=class n{strategy="";get badge(){return ui[this.strategy]||pe(B({},gi),{label:this.strategy})}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=E({type:n,selectors:[["app-npa-strategy-badge"]],inputs:{strategy:"strategy"},decls:2,vars:3,consts:[[1,"px-1.5","py-0.5","rounded","text-[9px]","font-semibold"]],template:function(e,i){e&1&&(Ae(0,"span",0),l(1),Te()),e&2&&(O(i.badge.bgClass+" "+i.badge.textClass),s(),x(" ",i.badge.label,`
`))},dependencies:[N],encapsulation:2})};var fi=["autosize"],_i=()=>["Yes","No","N/A"],he=()=>[];function bi(n,t){n&1&&(r(0,"span",21),l(1,"*"),a())}function yi(n,t){if(n&1&&(r(0,"p",26),l(1),a()),n&2){let e=p(2);s(),x(" ",e.field.tooltip," ")}}function xi(n,t){if(n&1&&(r(0,"span",37),l(1),a()),n&2){let e=p().$implicit;s(),x(' "',e.snippet,'" ')}}function hi(n,t){if(n&1){let e=I();r(0,"button",32),y("click",function(){let o=_(e).$implicit,d=p(3);return b(d.onCitationClick(o))}),m(1,"lucide-icon",33),r(2,"div",34)(3,"span",35),l(4),a(),f(5,xi,2,1,"span",36),a()()}if(n&2){let e=t.$implicit;s(4),x(" ",e.sourceName," "),s(),c("ngIf",e.snippet)}}function vi(n,t){if(n&1&&(r(0,"div")(1,"div",27),m(2,"lucide-icon",28),r(3,"span",29),l(4,"Sources & Evidence"),a()(),r(5,"div",30),f(6,hi,6,2,"button",31),a()()),n&2){let e=p(2);s(6),c("ngForOf",e.field.lineageMetadata.citations)}}function Ci(n,t){if(n&1&&(r(0,"span",22),m(1,"lucide-icon",23),r(2,"div",24),f(3,yi,2,1,"p",25)(4,vi,7,1,"div",17),a()()),n&2){let e=p();s(3),c("ngIf",e.field.tooltip),s(),c("ngIf",e.field.lineageMetadata==null||e.field.lineageMetadata.citations==null?null:e.field.lineageMetadata.citations.length)}}function Ii(n,t){if(n&1&&m(0,"app-npa-lineage-badge",38),n&2){let e=p();c("lineage",e.field.lineage)}}function Si(n,t){if(n&1&&(r(0,"span",39),l(1),a()),n&2){let e=p();s(),x(" ",(e.field.confidence*100).toFixed(0),"% ")}}function ki(n,t){if(n&1&&(r(0,"p",42),l(1),a()),n&2){let e=p(2);s(),v(e.field.placeholder)}}function wi(n,t){if(n&1&&(r(0,"div",40),f(1,ki,2,1,"p",41),a()),n&2){let e=p();s(),c("ngIf",e.field.placeholder)}}function Ai(n,t){if(n&1&&(r(0,"a",49),l(1),a()),n&2){let e=p(3);c("href",e.field.referenceUrl,Ce),s(),x(" ",e.field.placeholder||e.field.referenceUrl||"Reference document"," ")}}function Ti(n,t){if(n&1&&(r(0,"span",50),l(1),a()),n&2){let e=p(3);s(),v(e.field.placeholder||"Reference document")}}function Pi(n,t){if(n&1&&(r(0,"div",45),m(1,"lucide-icon",46),f(2,Ai,2,2,"a",47)(3,Ti,2,1,"ng-template",null,0,Re),r(5,"span",48),l(6,"Read-only reference"),a()()),n&2){let e=Pe(4),i=p(2);s(2),c("ngIf",i.field.referenceUrl)("ngIfElse",e)}}function Ei(n,t){if(n&1&&(r(0,"p",56),l(1),a()),n&2){let e=p(3);s(),x(" ",e.field.value," ")}}function Ri(n,t){n&1&&(r(0,"p",57),l(1,"No value provided."),a())}function Ni(n,t){if(n&1&&(r(0,"div",58),m(1,"lucide-icon",59),r(2,"p",60),l(3),a()()),n&2){let e=p(3);s(3),v(e.field.source)}}function Di(n,t){if(n&1&&(r(0,"div",51),f(1,Ei,2,1,"p",52)(2,Ri,2,0,"ng-template",null,1,Re)(4,Ni,4,1,"div",53),r(5,"div",54),m(6,"lucide-icon",55),l(7," Versions: placeholder (diff/restore later) "),a()()),n&2){let e=Pe(3),i=p(2);s(),c("ngIf",i.field.value&&i.field.value.trim())("ngIfElse",e),s(3),c("ngIf",i.field.source)}}function Mi(n,t){if(n&1&&(me(0),f(1,Pi,7,2,"div",43)(2,Di,8,3,"div",44),ue()),n&2){let e=p();s(),c("ngIf",e.field.type==="reference_link"),s(),c("ngIf",e.field.type!=="header"&&e.field.type!=="reference_link")}}function Li(n,t){if(n&1){let e=I();r(0,"input",72),K("ngModelChange",function(o){_(e);let d=p(2);return q(d.field.value,o)||(d.field.value=o),b(o)}),y("ngModelChange",function(){_(e);let o=p(2);return b(o.fieldEdited.emit(o.field))})("focus",function(){_(e);let o=p(2);return b(o.startEditing())})("blur",function(){_(e);let o=p(2);return b(o.finishEditing())}),a()}if(n&2){let e=p(2);M("border-slate-200",!e.field.isEditing&&!e.field.value&&!e.field.required)("border-red-300",!e.field.value&&e.field.required&&!e.field.isEditing)("border-blue-300",e.field.isEditing)("ring-2",e.field.isEditing)("ring-blue-500/20",e.field.isEditing)("bg-slate-50",!e.field.value&&!e.field.isEditing)("bg-white",e.field.value||e.field.isEditing)("border-emerald-200",e.field.value&&e.field.lineage==="AUTO")("border-amber-200",e.field.value&&e.field.lineage==="ADAPTED")("text-slate-900",e.field.value)("text-slate-400",!e.field.value),j("ngModel",e.field.value),c("placeholder",e.field.placeholder||"")}}function Oi(n,t){if(n&1){let e=I();r(0,"textarea",73,2),K("ngModelChange",function(o){_(e);let d=p(2);return q(d.field.value,o)||(d.field.value=o),b(o)}),y("ngModelChange",function(){_(e);let o=p(2);return b(o.fieldEdited.emit(o.field))})("focus",function(){_(e);let o=p(2);return b(o.startEditing())})("blur",function(){_(e);let o=p(2);return b(o.finishEditing())})("input",function(o){_(e);let d=p(2);return b(d.autoResize(o))}),l(2,"   "),a()}if(n&2){let e=p(2);M("border-slate-200",!e.field.isEditing&&!e.field.value)("border-blue-300",e.field.isEditing)("ring-2",e.field.isEditing)("ring-blue-500/20",e.field.isEditing)("bg-slate-50",!e.field.value&&!e.field.isEditing)("bg-white",e.field.value||e.field.isEditing)("border-emerald-200",e.field.value&&e.field.lineage==="AUTO")("border-amber-200",e.field.value&&e.field.lineage==="ADAPTED")("text-slate-900",e.field.value)("text-slate-400",!e.field.value),j("ngModel",e.field.value),c("placeholder",e.field.placeholder||"")}}function Fi(n,t){if(n&1){let e=I();r(0,"input",74),K("ngModelChange",function(o){_(e);let d=p(2);return q(d.field.value,o)||(d.field.value=o),b(o)}),y("ngModelChange",function(){_(e);let o=p(2);return b(o.fieldEdited.emit(o.field))})("change",function(){_(e);let o=p(2);return b(o.finishEditing())}),a()}if(n&2){let e=p(2);M("text-slate-900",e.field.value)("text-slate-400",!e.field.value),j("ngModel",e.field.value)}}function Vi(n,t){if(n&1){let e=I();r(0,"div",16)(1,"span",75),l(2),a(),r(3,"input",76),K("ngModelChange",function(o){_(e);let d=p(2);return q(d.field.value,o)||(d.field.value=o),b(o)}),y("ngModelChange",function(){_(e);let o=p(2);return b(o.fieldEdited.emit(o.field))})("focus",function(){_(e);let o=p(2);return b(o.startEditing())})("blur",function(){_(e);let o=p(2);return b(o.finishEditing())}),a()()}if(n&2){let e=p(2);s(2),v(e.field.currencyCode||"SGD"),s(),M("text-slate-900",e.field.value)("text-slate-400",!e.field.value),j("ngModel",e.field.value),c("placeholder",e.field.placeholder||"0.00")}}function Bi(n,t){if(n&1&&(r(0,"option",80),l(1),a()),n&2){let e=t.$implicit;c("value",e),s(),v(e)}}function Gi(n,t){if(n&1){let e=I();r(0,"select",77),K("ngModelChange",function(o){_(e);let d=p(2);return q(d.field.value,o)||(d.field.value=o),b(o)}),y("change",function(){_(e);let o=p(2);return b(o.finishEditing())}),r(1,"option",78),l(2,"Select..."),a(),f(3,Bi,2,2,"option",79),a()}if(n&2){let e=p(2);M("text-slate-900",e.field.value)("text-slate-400",!e.field.value),j("ngModel",e.field.value),s(3),c("ngForOf",e.field.options||Z(6,_i))}}function Ui(n,t){if(n&1){let e=I();r(0,"span",87),l(1),r(2,"button",88),y("click",function(){let o=_(e).$implicit,d=p(3);return b(d.toggleMultiSelectOption(o))}),m(3,"lucide-icon",89),a()()}if(n&2){let e=t.$implicit;s(),x(" ",e," ")}}function ji(n,t){n&1&&(r(0,"span",90),l(1,"Click options below..."),a())}function qi(n,t){if(n&1){let e=I();r(0,"button",91),y("click",function(){let o=_(e).$implicit,d=p(3);return b(d.toggleMultiSelectOption(o))}),l(1),a()}if(n&2){let e=t.$implicit,i=p(3);M("bg-blue-100",i.isOptionSelected(e))("border-blue-300",i.isOptionSelected(e))("text-blue-700",i.isOptionSelected(e))("bg-slate-50",!i.isOptionSelected(e))("border-slate-200",!i.isOptionSelected(e))("text-slate-600",!i.isOptionSelected(e))("hover:bg-blue-50",!i.isOptionSelected(e)),s(),x(" ",e," ")}}function Ki(n,t){if(n&1&&(r(0,"div",81)(1,"div",82),f(2,Ui,4,1,"span",83)(3,ji,2,0,"span",84),a(),r(4,"div",85),f(5,qi,2,15,"button",86),a()()),n&2){let e=p(2);s(2),c("ngForOf",e.field.selectedOptions||Z(3,he)),s(),c("ngIf",!(e.field.selectedOptions!=null&&e.field.selectedOptions.length)),s(2),c("ngForOf",e.field.options||Z(4,he))}}function $i(n,t){n&1&&m(0,"div",98)}function Wi(n,t){n&1&&m(0,"div",99)}function Yi(n,t){if(n&1){let e=I();r(0,"textarea",100,2),K("ngModelChange",function(o){_(e);let d=p(3);return q(d.field.conditionalText,o)||(d.field.conditionalText=o),b(o)}),y("blur",function(){_(e);let o=p(3);return b(o.updateConditionalText(o.field.conditionalText||""))})("input",function(o){_(e);let d=p(3);return b(d.autoResize(o))}),l(2,"	      "),a()}if(n&2){let e=p(3);j("ngModel",e.field.conditionalText)}}function Hi(n,t){if(n&1){let e=I();r(0,"div",81)(1,"div",92)(2,"button",93),y("click",function(){_(e);let o=p(2);return b(o.setYesNo(!0))}),r(3,"div",94),f(4,$i,1,0,"div",95),a(),l(5," Yes "),a(),r(6,"button",93),y("click",function(){_(e);let o=p(2);return b(o.setYesNo(!1))}),r(7,"div",94),f(8,Wi,1,0,"div",96),a(),l(9," No "),a()(),f(10,Yi,3,1,"textarea",97),a()}if(n&2){let e=p(2);s(2),M("bg-emerald-50",e.field.yesNoValue===!0)("border-emerald-300",e.field.yesNoValue===!0)("text-emerald-700",e.field.yesNoValue===!0)("bg-white",e.field.yesNoValue!==!0)("border-slate-200",e.field.yesNoValue!==!0)("text-slate-600",e.field.yesNoValue!==!0)("hover:bg-emerald-50",e.field.yesNoValue!==!0),s(),M("border-emerald-500",e.field.yesNoValue===!0)("border-slate-300",e.field.yesNoValue!==!0),s(),c("ngIf",e.field.yesNoValue===!0),s(2),M("bg-red-50",e.field.yesNoValue===!1)("border-red-300",e.field.yesNoValue===!1)("text-red-700",e.field.yesNoValue===!1)("bg-white",e.field.yesNoValue!==!1)("border-slate-200",e.field.yesNoValue!==!1)("text-slate-600",e.field.yesNoValue!==!1)("hover:bg-red-50",e.field.yesNoValue!==!1),s(),M("border-red-500",e.field.yesNoValue===!1)("border-slate-300",e.field.yesNoValue!==!1),s(),c("ngIf",e.field.yesNoValue===!1),s(2),c("ngIf",e.field.yesNoValue===!0)}}function zi(n,t){if(n&1){let e=I();r(0,"label",103)(1,"input",104),y("change",function(){let o=_(e).$implicit,d=p(3);return b(d.toggleCheckboxOption(o))}),a(),r(2,"span",105),l(3),a()()}if(n&2){let e=t.$implicit,i=p(3);s(),c("checked",i.isOptionSelected(e)),s(2),v(e)}}function Ji(n,t){if(n&1&&(r(0,"div",101),f(1,zi,4,2,"label",102),a()),n&2){let e=p(2);s(),c("ngForOf",e.field.options||Z(1,he))}}function Qi(n,t){if(n&1){let e=I();r(0,"div",109)(1,"span",110),l(2),a(),r(3,"input",111),y("ngModelChange",function(o){let d=_(e).index,u=p(3);return b(u.updateBulletItem(d,o))}),a(),r(4,"button",112),y("click",function(){let o=_(e).index,d=p(3);return b(d.removeBulletItem(o))}),m(5,"lucide-icon",113),a()()}if(n&2){let e=t.$implicit,i=t.index;s(2),x("",i+1,"."),s(),c("ngModel",e)}}function Xi(n,t){if(n&1){let e=I();r(0,"div",81),f(1,Qi,6,2,"div",106),r(2,"button",107),y("click",function(){_(e);let o=p(2);return b(o.addBulletItem())}),m(3,"lucide-icon",108),l(4," Add Item "),a()()}if(n&2){let e=p(2);s(),c("ngForOf",e.field.bulletItems||Z(2,he))("ngForTrackBy",e.trackByIndex)}}function Zi(n,t){if(n&1){let e=I();r(0,"div",120)(1,"div",109),m(2,"lucide-icon",121),r(3,"span",122),l(4),a()(),r(5,"button",123),y("click",function(){let o=_(e).index,d=p(3);return b(d.removeFile(o))}),m(6,"lucide-icon",124),a()()}if(n&2){let e=t.$implicit;s(4),v(e)}}function en(n,t){if(n&1){let e=I();r(0,"div",81),f(1,Zi,7,1,"div",114),r(2,"label",115),m(3,"lucide-icon",116),r(4,"span",117),l(5,"Click to upload or drag & drop"),a(),r(6,"span",118),l(7,"PDF, DOC, XLS up to 10MB"),a(),r(8,"input",119),y("change",function(o){_(e);let d=p(2);return b(d.onFileSelect(o))}),a()()()}if(n&2){let e=p(2);s(),c("ngForOf",e.field.attachedFiles||Z(1,he))}}function tn(n,t){if(n&1&&(r(0,"th",133),l(1),a()),n&2){let e=t.$implicit;s(),x(" ",e," ")}}function nn(n,t){if(n&1){let e=I();r(0,"td",138)(1,"input",139),y("ngModelChange",function(o){let d=_(e).index,u=p().index,g=p(4);return b(g.updateTableCell(u,d,o))}),a()()}if(n&2){let e=t.$implicit;s(),c("ngModel",e)}}function rn(n,t){if(n&1){let e=I();r(0,"tr"),f(1,nn,2,1,"td",134),r(2,"td",135)(3,"button",136),y("click",function(){let o=_(e).index,d=p(4);return b(d.removeTableRow(o))}),m(4,"lucide-icon",137),a()()()}if(n&2){let e=t.$implicit,i=p(4);s(),c("ngForOf",e),s(2),c("disabled",i.tableRows.length<=1)}}function an(n,t){if(n&1&&(r(0,"table",129)(1,"thead")(2,"tr"),f(3,tn,2,1,"th",130),m(4,"th",131),a()(),r(5,"tbody"),f(6,rn,5,2,"tr",132),a()()),n&2){let e=p(3);s(3),c("ngForOf",e.field.tableColumns),s(3),c("ngForOf",e.tableRows)}}function on(n,t){if(n&1){let e=I();r(0,"textarea",140,2),K("ngModelChange",function(o){_(e);let d=p(3);return q(d.field.value,o)||(d.field.value=o),b(o)}),y("ngModelChange",function(){_(e);let o=p(3);return b(o.fieldEdited.emit(o.field))})("focus",function(){_(e);let o=p(3);return b(o.startEditing())})("blur",function(){_(e);let o=p(3);return b(o.finishEditing())})("input",function(o){_(e);let d=p(3);return b(d.autoResize(o))}),l(2,"	      "),a()}if(n&2){let e=p(3);j("ngModel",e.field.value)}}function sn(n,t){if(n&1){let e=I();r(0,"div",125),f(1,an,7,2,"table",126),r(2,"button",127),y("click",function(){_(e);let o=p(2);return b(o.addTableRow())}),m(3,"lucide-icon",108),l(4," Add Row "),a(),f(5,on,3,1,"textarea",128),a()}if(n&2){let e=p(2);s(),c("ngIf",e.field.tableColumns&&e.field.tableColumns.length>0),s(4),c("ngIf",!e.field.tableColumns||e.field.tableColumns.length===0)}}function ln(n,t){if(n&1&&(r(0,"a",49),l(1),a()),n&2){let e=p(3);c("href",e.field.referenceUrl,Ce),s(),x(" ",e.field.placeholder||e.field.referenceUrl||"Reference document"," ")}}function dn(n,t){if(n&1&&(r(0,"span",50),l(1),a()),n&2){let e=p(3);s(),v(e.field.placeholder||"Reference document")}}function cn(n,t){if(n&1&&(r(0,"div",45),m(1,"lucide-icon",46),f(2,ln,2,2,"a",47)(3,dn,2,1,"ng-template",null,3,Re),r(5,"span",48),l(6,"Read-only reference"),a()()),n&2){let e=Pe(4),i=p(2);s(2),c("ngIf",i.field.referenceUrl)("ngIfElse",e)}}function pn(n,t){if(n&1){let e=I();r(0,"div",81)(1,"textarea",141,2),K("ngModelChange",function(o){_(e);let d=p(2);return q(d.field.value,o)||(d.field.value=o),b(o)}),y("ngModelChange",function(){_(e);let o=p(2);return b(o.fieldEdited.emit(o.field))})("focus",function(){_(e);let o=p(2);return b(o.startEditing())})("blur",function(){_(e);let o=p(2);return b(o.finishEditing())})("input",function(o){_(e);let d=p(2);return b(d.autoResize(o))}),l(3,"	      "),a(),r(4,"div",142),m(5,"lucide-icon",143),l(6," Repeatable section \u2014 add multiple entries separated by lines "),a()()}if(n&2){let e=p(2);s(),j("ngModel",e.field.value),c("placeholder",e.field.placeholder||"Enter details for each item...")}}function mn(n,t){if(n&1){let e=I();r(0,"textarea",144,2),K("ngModelChange",function(o){_(e);let d=p(2);return q(d.field.value,o)||(d.field.value=o),b(o)}),y("ngModelChange",function(){_(e);let o=p(2);return b(o.fieldEdited.emit(o.field))})("focus",function(){_(e);let o=p(2);return b(o.startEditing())})("blur",function(){_(e);let o=p(2);return b(o.finishEditing())})("input",function(o){_(e);let d=p(2);return b(d.autoResize(o))}),l(2,"	   "),a()}if(n&2){let e=p(2);j("ngModel",e.field.value),c("placeholder",e.field.placeholder||"Provide details...")}}function un(n,t){n&1&&(r(0,"div",145)(1,"div",146),m(2,"lucide-icon",147),r(3,"span",148),l(4,"Generating..."),a()()())}function gn(n,t){if(n&1){let e=I();r(0,"button",153),y("click",function(){_(e);let o=p(3);return b(o.clearField())}),m(1,"lucide-icon",124),a()}}function fn(n,t){if(n&1){let e=I();r(0,"div",149),f(1,gn,2,0,"button",150),r(2,"button",151),y("click",function(){_(e);let o=p(2);return b(o.onAskAgent())}),m(3,"lucide-icon",152),a()()}if(n&2){let e=p(2);s(),c("ngIf",e.field.value)}}function _n(n,t){if(n&1&&(me(0),f(1,Li,1,24,"input",61)(2,Oi,3,22,"textarea",62)(3,Fi,1,5,"input",63)(4,Vi,4,7,"div",64)(5,Gi,4,7,"select",65)(6,Ki,6,5,"div",66)(7,Hi,11,39,"div",66)(8,Ji,2,2,"div",67)(9,Xi,5,3,"div",66)(10,en,9,2,"div",66)(11,sn,6,2,"div",68)(12,cn,7,2,"div",43)(13,pn,7,2,"div",66)(14,mn,3,2,"textarea",69)(15,un,5,0,"div",70)(16,fn,4,1,"div",71),ue()),n&2){let e=p();s(),c("ngIf",e.field.type==="text"),s(),c("ngIf",e.field.type==="textarea"||e.field.type==="flowchart"),s(),c("ngIf",e.field.type==="date"),s(),c("ngIf",e.field.type==="currency"),s(),c("ngIf",e.field.type==="dropdown"),s(),c("ngIf",e.field.type==="multiselect"),s(),c("ngIf",e.field.type==="yesno"),s(),c("ngIf",e.field.type==="checkbox_group"),s(),c("ngIf",e.field.type==="bullet_list"),s(),c("ngIf",e.field.type==="file_upload"),s(),c("ngIf",e.field.type==="table_grid"),s(),c("ngIf",e.field.type==="reference_link"),s(),c("ngIf",e.field.type==="repeatable"),s(),c("ngIf",e.field.type==="conditional"),s(),c("ngIf",e.field.isStreaming),s(),c("ngIf",e.field.type!=="reference_link"&&e.field.type!=="file_upload")}}function bn(n,t){if(n&1&&(r(0,"span",159),m(1,"lucide-icon",160),l(2),a()),n&2){let e=t.$implicit;s(2),x(" ",e," ")}}function yn(n,t){if(n&1){let e=I();r(0,"div",154)(1,"label",155),m(2,"lucide-icon",156),l(3," Attach file "),r(4,"input",157),y("change",function(o){_(e);let d=p();return b(d.onFileSelect(o))}),a()(),f(5,bn,3,1,"span",158),a()}if(n&2){let e=p();s(5),c("ngForOf",e.field.attachedFiles||Z(1,he))}}function xn(n,t){if(n&1&&(r(0,"div",161),m(1,"lucide-icon",162),r(2,"p",163),l(3),a()()),n&2){let e=p();s(3),v(e.field.validationError)}}function hn(n,t){if(n&1&&(r(0,"div",164),m(1,"lucide-icon",59),r(2,"p",60),l(3),a()()),n&2){let e=p();s(3),v(e.field.source)}}var it=class n{field;readOnly=!1;fieldEdited=new R;fieldCleared=new R;askAgent=new R;commentClicked=new R;fileSelected=new R;citationClick=new R;autosizeTextareas;lastObservedValue="";resizeScheduled=!1;onCitationClick(t){this.citationClick.emit(t)}startEditing(){this.field.isEditing=!0}finishEditing(){this.field.isEditing=!1,this.field.value&&this.field.lineage!=="MANUAL"&&(this.field.lineage="ADAPTED"),this.fieldEdited.emit(this.field)}clearField(){this.field.value="",this.field.lineage="MANUAL",this.field.confidence=void 0,this.field.source=void 0,this.fieldCleared.emit(this.field),this.scheduleAutosize()}onAskAgent(){this.askAgent.emit(this.field)}onCommentClick(){this.commentClicked.emit(this.field)}addBulletItem(){this.field.bulletItems||(this.field.bulletItems=[]),this.field.bulletItems.push(""),this.syncBulletToValue()}removeBulletItem(t){this.field.bulletItems&&(this.field.bulletItems.splice(t,1),this.syncBulletToValue())}updateBulletItem(t,e){this.field.bulletItems&&(this.field.bulletItems[t]=e,this.syncBulletToValue())}syncBulletToValue(){this.field.value=(this.field.bulletItems||[]).filter(t=>t.trim()).join(`
\u2022 `),this.field.value&&(this.field.value="\u2022 "+this.field.value),this.fieldEdited.emit(this.field)}toggleMultiSelectOption(t){this.field.selectedOptions||(this.field.selectedOptions=[]);let e=this.field.selectedOptions.indexOf(t);e>=0?this.field.selectedOptions.splice(e,1):this.field.selectedOptions.push(t),this.field.value=this.field.selectedOptions.join(", "),this.fieldEdited.emit(this.field)}setYesNo(t){this.field.yesNoValue=t,this.field.value=t?"Yes":"No",t||(this.field.conditionalText=""),this.fieldEdited.emit(this.field)}updateConditionalText(t){this.field.conditionalText=t,this.field.value=`${this.field.yesNoValue?"Yes":"No"} \u2014 ${t}`,this.fieldEdited.emit(this.field)}toggleCheckboxOption(t){this.field.selectedOptions||(this.field.selectedOptions=[]);let e=this.field.selectedOptions.indexOf(t);e>=0?this.field.selectedOptions.splice(e,1):this.field.selectedOptions.push(t),this.field.value=this.field.selectedOptions.join("; "),this.fieldEdited.emit(this.field)}onFileSelect(t){let e=t.target;if(e.files){this.field.attachedFiles||(this.field.attachedFiles=[]);for(let i=0;i<e.files.length;i++)this.field.attachedFiles.push(e.files[i].name);this.field.value=this.field.attachedFiles.join(", "),this.fieldEdited.emit(this.field)}}removeFile(t){this.field.attachedFiles&&(this.field.attachedFiles.splice(t,1),this.field.value=this.field.attachedFiles.join(", "),this.fieldEdited.emit(this.field))}autoResize(t){let e=t.target;e.style.height="auto",e.style.height=e.scrollHeight+"px"}ngDoCheck(){let t=String(this.field?.value||"");t!==this.lastObservedValue&&(this.lastObservedValue=t,this.scheduleAutosize())}scheduleAutosize(){this.resizeScheduled||(this.resizeScheduled=!0,setTimeout(()=>{this.resizeScheduled=!1,this.resizeAllTextareas()},0))}resizeAllTextareas(){if(this.autosizeTextareas)for(let t of this.autosizeTextareas.toArray()){let e=t?.nativeElement;e&&(e.style.height="auto",e.style.height=e.scrollHeight+"px")}}get tableRows(){return(!this.field.tableData||this.field.tableData.length===0)&&this.field.tableColumns&&this.field.tableColumns.length>0&&(this.field.tableData=[this.field.tableColumns.map(()=>""),this.field.tableColumns.map(()=>""),this.field.tableColumns.map(()=>"")]),this.field.tableData||[]}addTableRow(){this.field.tableData||(this.field.tableData=[]);let t=this.field.tableColumns?.length||3;this.field.tableData.push(new Array(t).fill("")),this.syncTableToValue()}removeTableRow(t){this.field.tableData&&this.field.tableData.length>1&&(this.field.tableData.splice(t,1),this.syncTableToValue())}updateTableCell(t,e,i){this.field.tableData&&(this.field.tableData[t][e]=i,this.syncTableToValue())}syncTableToValue(){this.field.value=JSON.stringify(this.field.tableData),this.fieldEdited.emit(this.field)}isOptionSelected(t){return(this.field.selectedOptions||[]).includes(t)}trackByIndex(t){return t}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=E({type:n,selectors:[["app-npa-field-renderer"]],viewQuery:function(e,i){if(e&1&&ge(fi,5),e&2){let o;fe(o=_e())&&(i.autosizeTextareas=o)}},inputs:{field:"field",readOnly:"readOnly"},outputs:{fieldEdited:"fieldEdited",fieldCleared:"fieldCleared",askAgent:"askAgent",commentClicked:"commentClicked",fileSelected:"fileSelected",citationClick:"citationClick"},decls:19,vars:12,consts:[["refNoLinkRO",""],["emptyValueRO",""],["autosize",""],["refNoLink",""],[1,"flex","items-center","justify-between","mb-2"],[1,"flex","items-center","gap-2","flex-1","min-w-0"],[1,"text-xs","font-semibold","text-slate-700"],["class","text-red-400 text-[10px] font-bold",4,"ngIf"],["class","group/tip relative mt-0.5",4,"ngIf"],[1,"flex","items-center","gap-1.5","flex-none"],[3,"strategy"],[3,"lineage",4,"ngIf"],["class","text-[9px] font-mono text-slate-400",4,"ngIf"],["type","button","title","Comments",1,"ml-1","inline-flex","items-center","justify-center","w-7","h-7","rounded-md","border","border-slate-200","bg-white","hover:bg-slate-50","text-slate-500","hover:text-slate-700","transition-colors",3,"click"],["name","message-square",1,"w-3.5","h-3.5"],["class","py-1 border-b border-slate-200",4,"ngIf"],[1,"relative"],[4,"ngIf"],["class","mt-2",4,"ngIf"],["class","mt-1.5 flex items-center gap-1.5 px-2 py-1 bg-red-50 border border-red-200 rounded-md",4,"ngIf"],["class","mt-1.5 flex items-center gap-1",4,"ngIf"],[1,"text-red-400","text-[10px]","font-bold"],[1,"group/tip","relative","mt-0.5"],["name","info",1,"w-3","h-3","text-slate-300","hover:text-blue-400","cursor-help"],[1,"absolute","z-50","bottom-full","left-1/2","-translate-x-1/2","mb-1.5","w-64","p-3","bg-slate-800","text-white","rounded-lg","shadow-xl","opacity-0","group-hover/tip:opacity-100","transition-opacity","pointer-events-auto","cursor-default","pointer-events-none","group-hover/tip:pointer-events-auto"],["class","text-[11px] leading-relaxed mb-2 pb-2 border-b border-slate-700/50",4,"ngIf"],[1,"text-[11px]","leading-relaxed","mb-2","pb-2","border-b","border-slate-700/50"],[1,"flex","items-center","gap-1.5","mb-1.5","text-blue-300"],["name","book-open",1,"w-3.5","h-3.5"],[1,"text-[10px]","font-bold","uppercase","tracking-wider"],[1,"flex","flex-col","gap-1.5"],["class","flex items-start text-left gap-2 p-1.5 -mx-1.5 rounded bg-slate-700/30 hover:bg-slate-700/80 transition-colors group/cit",3,"click",4,"ngFor","ngForOf"],[1,"flex","items-start","text-left","gap-2","p-1.5","-mx-1.5","rounded","bg-slate-700/30","hover:bg-slate-700/80","transition-colors","group/cit",3,"click"],["name","file-text",1,"w-3","h-3","text-slate-400","mt-0.5","group-hover/cit:text-blue-300","flex-none"],[1,"flex","flex-col","min-w-0"],[1,"text-[10px]","font-medium","text-slate-200","truncate","group-hover/cit:text-blue-200"],["class","text-[9px] text-slate-400 line-clamp-2 leading-tight mt-0.5 italic",4,"ngIf"],[1,"text-[9px]","text-slate-400","line-clamp-2","leading-tight","mt-0.5","italic"],[3,"lineage"],[1,"text-[9px]","font-mono","text-slate-400"],[1,"py-1","border-b","border-slate-200"],["class","text-[11px] text-slate-500 italic",4,"ngIf"],[1,"text-[11px]","text-slate-500","italic"],["class","flex items-center gap-2 px-3 py-2 bg-blue-50/50 rounded-lg border border-blue-100",4,"ngIf"],["class","py-0.5",4,"ngIf"],[1,"flex","items-center","gap-2","px-3","py-2","bg-blue-50/50","rounded-lg","border","border-blue-100"],["name","external-link",1,"w-3.5","h-3.5","text-blue-500"],["target","_blank","rel","noopener noreferrer","class","text-xs text-blue-700 font-medium hover:underline cursor-pointer",3,"href",4,"ngIf","ngIfElse"],[1,"text-[9px]","text-blue-500","italic","ml-auto"],["target","_blank","rel","noopener noreferrer",1,"text-xs","text-blue-700","font-medium","hover:underline","cursor-pointer",3,"href"],[1,"text-xs","text-blue-700","font-medium"],[1,"py-0.5"],["class","text-[13px] leading-relaxed text-slate-900 whitespace-pre-wrap",4,"ngIf","ngIfElse"],["class","mt-2 flex items-center gap-1",4,"ngIf"],[1,"mt-2","text-[10px]","text-slate-400","font-medium","flex","items-center","gap-1.5"],["name","history",1,"w-3","h-3"],[1,"text-[13px]","leading-relaxed","text-slate-900","whitespace-pre-wrap"],[1,"text-[12px]","text-slate-400","italic"],[1,"mt-2","flex","items-center","gap-1"],["name","quote",1,"w-2.5","h-2.5","text-slate-300"],[1,"text-[10px]","text-slate-400","italic","truncate"],["type","text","class","w-full px-3 py-2 text-sm rounded-lg border transition-all outline-none",3,"ngModel","placeholder","border-slate-200","border-red-300","border-blue-300","ring-2","ring-blue-500/20","bg-slate-50","bg-white","border-emerald-200","border-amber-200","text-slate-900","text-slate-400","ngModelChange","focus","blur",4,"ngIf"],["rows","4","class","w-full min-h-[104px] px-3 py-2 text-sm rounded-lg border transition-all outline-none resize-none overflow-hidden",3,"ngModel","placeholder","border-slate-200","border-blue-300","ring-2","ring-blue-500/20","bg-slate-50","bg-white","border-emerald-200","border-amber-200","text-slate-900","text-slate-400","ngModelChange","focus","blur","input",4,"ngIf"],["type","date","class","w-full px-3 py-2 text-sm rounded-lg border border-slate-200 bg-white outline-none focus:border-blue-300 focus:ring-2 focus:ring-blue-500/20",3,"ngModel","text-slate-900","text-slate-400","ngModelChange","change",4,"ngIf"],["class","relative",4,"ngIf"],["class","w-full px-3 py-2 text-sm rounded-lg border border-slate-200 bg-white outline-none focus:border-blue-300 focus:ring-2 focus:ring-blue-500/20 cursor-pointer",3,"ngModel","text-slate-900","text-slate-400","ngModelChange","change",4,"ngIf"],["class","space-y-2",4,"ngIf"],["class","space-y-1.5",4,"ngIf"],["class","overflow-x-auto",4,"ngIf"],["rows","4","class","w-full min-h-[104px] px-3 py-2 text-sm rounded-lg border border-amber-200 bg-amber-50/20 outline-none focus:border-amber-300 focus:ring-2 focus:ring-amber-500/20 resize-none",3,"ngModel","placeholder","ngModelChange","focus","blur","input",4,"ngIf"],["class","absolute inset-0 flex items-center justify-center bg-white/80 rounded-lg",4,"ngIf"],["class","absolute right-1.5 top-1.5 flex items-center gap-0.5 opacity-0 group-hover/field:opacity-100 transition-opacity",4,"ngIf"],["type","text",1,"w-full","px-3","py-2","text-sm","rounded-lg","border","transition-all","outline-none",3,"ngModelChange","focus","blur","ngModel","placeholder"],["rows","4",1,"w-full","min-h-[104px]","px-3","py-2","text-sm","rounded-lg","border","transition-all","outline-none","resize-none","overflow-hidden",3,"ngModelChange","focus","blur","input","ngModel","placeholder"],["type","date",1,"w-full","px-3","py-2","text-sm","rounded-lg","border","border-slate-200","bg-white","outline-none","focus:border-blue-300","focus:ring-2","focus:ring-blue-500/20",3,"ngModelChange","change","ngModel"],[1,"absolute","left-3","top-1/2","-translate-y-1/2","text-[10px]","font-bold","text-slate-400","uppercase"],["type","number",1,"w-full","pl-10","pr-3","py-2","text-sm","rounded-lg","border","border-slate-200","bg-white","outline-none","focus:border-blue-300","focus:ring-2","focus:ring-blue-500/20",3,"ngModelChange","focus","blur","ngModel","placeholder"],[1,"w-full","px-3","py-2","text-sm","rounded-lg","border","border-slate-200","bg-white","outline-none","focus:border-blue-300","focus:ring-2","focus:ring-blue-500/20","cursor-pointer",3,"ngModelChange","change","ngModel"],["value",""],[3,"value",4,"ngFor","ngForOf"],[3,"value"],[1,"space-y-2"],[1,"flex","flex-wrap","gap-1.5","min-h-[36px]","px-3","py-2","rounded-lg","border","border-slate-200","bg-white"],["class","inline-flex items-center gap-1 px-2 py-0.5 bg-blue-50 border border-blue-200 rounded-full text-[10px] font-semibold text-blue-700",4,"ngFor","ngForOf"],["class","text-xs text-slate-400",4,"ngIf"],[1,"flex","flex-wrap","gap-1"],["class","px-2 py-1 rounded text-[10px] font-medium transition-colors border",3,"bg-blue-100","border-blue-300","text-blue-700","bg-slate-50","border-slate-200","text-slate-600","hover:bg-blue-50","click",4,"ngFor","ngForOf"],[1,"inline-flex","items-center","gap-1","px-2","py-0.5","bg-blue-50","border","border-blue-200","rounded-full","text-[10px]","font-semibold","text-blue-700"],[1,"hover:text-red-500",3,"click"],["name","x",1,"w-2.5","h-2.5"],[1,"text-xs","text-slate-400"],[1,"px-2","py-1","rounded","text-[10px]","font-medium","transition-colors","border",3,"click"],[1,"flex","items-center","gap-3"],[1,"flex","items-center","gap-1.5","px-3","py-1.5","rounded-lg","text-xs","font-semibold","transition-all","border",3,"click"],[1,"w-3.5","h-3.5","rounded-full","border-2","flex","items-center","justify-center"],["class","w-2 h-2 rounded-full bg-emerald-500",4,"ngIf"],["class","w-2 h-2 rounded-full bg-red-500",4,"ngIf"],["placeholder","If Yes, please provide details...","rows","4","class","w-full min-h-[104px] px-3 py-2 text-sm rounded-lg border border-amber-200 bg-amber-50/30 outline-none focus:border-amber-300 focus:ring-2 focus:ring-amber-500/20 resize-none",3,"ngModel","ngModelChange","blur","input",4,"ngIf"],[1,"w-2","h-2","rounded-full","bg-emerald-500"],[1,"w-2","h-2","rounded-full","bg-red-500"],["placeholder","If Yes, please provide details...","rows","4",1,"w-full","min-h-[104px]","px-3","py-2","text-sm","rounded-lg","border","border-amber-200","bg-amber-50/30","outline-none","focus:border-amber-300","focus:ring-2","focus:ring-amber-500/20","resize-none",3,"ngModelChange","blur","input","ngModel"],[1,"space-y-1.5"],["class","flex items-start gap-2 px-3 py-2 rounded-lg hover:bg-slate-50 cursor-pointer transition-colors",4,"ngFor","ngForOf"],[1,"flex","items-start","gap-2","px-3","py-2","rounded-lg","hover:bg-slate-50","cursor-pointer","transition-colors"],["type","checkbox",1,"mt-0.5","w-3.5","h-3.5","rounded","border-slate-300","text-blue-600","focus:ring-blue-500/20",3,"change","checked"],[1,"text-xs","text-slate-700"],["class","flex items-center gap-2",4,"ngFor","ngForOf","ngForTrackBy"],[1,"flex","items-center","gap-1.5","px-3","py-1.5","text-[11px]","font-semibold","text-blue-600","hover:bg-blue-50","rounded-lg","transition-colors","border","border-dashed","border-blue-200",3,"click"],["name","plus-circle",1,"w-3.5","h-3.5"],[1,"flex","items-center","gap-2"],[1,"text-slate-400","text-xs","font-mono","w-5","text-right"],["type","text","placeholder","Enter item...",1,"flex-1","px-3","py-1.5","text-sm","rounded-lg","border","border-slate-200","bg-white","outline-none","focus:border-blue-300","focus:ring-2","focus:ring-blue-500/20",3,"ngModelChange","ngModel"],[1,"p-1","rounded","hover:bg-red-50","text-slate-300","hover:text-red-500","transition-colors",3,"click"],["name","minus-circle",1,"w-3.5","h-3.5"],["class","flex items-center justify-between px-3 py-2 bg-slate-50 rounded-lg border border-slate-200",4,"ngFor","ngForOf"],[1,"flex","flex-col","items-center","justify-center","px-4","py-4","border-2","border-dashed","border-slate-200","rounded-lg","hover:border-blue-300","hover:bg-blue-50/30","cursor-pointer","transition-all"],["name","upload-cloud",1,"w-6","h-6","text-slate-300","mb-1"],[1,"text-[11px]","font-medium","text-slate-500"],[1,"text-[9px]","text-slate-400","mt-0.5"],["type","file","multiple","",1,"hidden",3,"change"],[1,"flex","items-center","justify-between","px-3","py-2","bg-slate-50","rounded-lg","border","border-slate-200"],["name","file",1,"w-3.5","h-3.5","text-slate-400"],[1,"text-xs","text-slate-700","truncate"],[1,"p-1","rounded","hover:bg-red-50","text-slate-300","hover:text-red-500",3,"click"],["name","x",1,"w-3","h-3"],[1,"overflow-x-auto"],["class","w-full border-collapse text-sm table-grid",4,"ngIf"],[1,"mt-1.5","flex","items-center","gap-1.5","px-3","py-1.5","text-[11px]","font-semibold","text-blue-600","hover:bg-blue-50","rounded-lg","transition-colors","border","border-dashed","border-blue-200",3,"click"],["placeholder","Enter table data...","rows","4","class","w-full min-h-[104px] px-3 py-2 text-sm rounded-lg border border-slate-200 bg-white outline-none focus:border-blue-300 focus:ring-2 focus:ring-blue-500/20 resize-y font-mono",3,"ngModel","ngModelChange","focus","blur","input",4,"ngIf"],[1,"w-full","border-collapse","text-sm","table-grid"],["class","px-2 py-1.5 bg-slate-50 border border-slate-200 text-left text-[10px] font-semibold uppercase tracking-wider text-slate-500",4,"ngFor","ngForOf"],[1,"w-8","border","border-slate-200","bg-slate-50"],[4,"ngFor","ngForOf"],[1,"px-2","py-1.5","bg-slate-50","border","border-slate-200","text-left","text-[10px]","font-semibold","uppercase","tracking-wider","text-slate-500"],["class","border border-slate-200 p-0",4,"ngFor","ngForOf"],[1,"border","border-slate-200","text-center"],[1,"p-0.5","rounded","hover:bg-red-50","text-slate-300","hover:text-red-500","transition-colors",3,"click","disabled"],["name","minus-circle",1,"w-3","h-3"],[1,"border","border-slate-200","p-0"],["type","text","placeholder","\u2014",1,"w-full","px-2","py-1.5","text-xs","border-0","outline-none","bg-transparent","focus:bg-blue-50/30",3,"ngModelChange","ngModel"],["placeholder","Enter table data...","rows","4",1,"w-full","min-h-[104px]","px-3","py-2","text-sm","rounded-lg","border","border-slate-200","bg-white","outline-none","focus:border-blue-300","focus:ring-2","focus:ring-blue-500/20","resize-y","font-mono",3,"ngModelChange","focus","blur","input","ngModel"],["rows","4",1,"w-full","min-h-[104px]","px-3","py-2","text-sm","rounded-lg","border","border-slate-200","bg-white","outline-none","focus:border-blue-300","focus:ring-2","focus:ring-blue-500/20","resize-y",3,"ngModelChange","focus","blur","input","ngModel","placeholder"],[1,"flex","items-center","gap-1.5","text-[10px]","text-slate-400"],["name","copy-plus",1,"w-3","h-3"],["rows","4",1,"w-full","min-h-[104px]","px-3","py-2","text-sm","rounded-lg","border","border-amber-200","bg-amber-50/20","outline-none","focus:border-amber-300","focus:ring-2","focus:ring-amber-500/20","resize-none",3,"ngModelChange","focus","blur","input","ngModel","placeholder"],[1,"absolute","inset-0","flex","items-center","justify-center","bg-white/80","rounded-lg"],[1,"flex","items-center","gap-1.5","text-blue-600"],["name","loader-2",1,"w-3.5","h-3.5","animate-spin"],[1,"text-[10px]","font-semibold"],[1,"absolute","right-1.5","top-1.5","flex","items-center","gap-0.5","opacity-0","group-hover/field:opacity-100","transition-opacity"],["class","p-1 rounded hover:bg-red-50 text-slate-300 hover:text-red-500 transition-colors","title","Clear field",3,"click",4,"ngIf"],["title","Ask agent about this field",1,"p-1","rounded","hover:bg-blue-50","text-slate-300","hover:text-blue-500","transition-colors",3,"click"],["name","sparkles",1,"w-3","h-3"],["title","Clear field",1,"p-1","rounded","hover:bg-red-50","text-slate-300","hover:text-red-500","transition-colors",3,"click"],[1,"mt-2"],[1,"inline-flex","items-center","gap-1.5","px-2","py-1","text-[10px]","font-medium","text-slate-400","hover:text-blue-600","hover:bg-blue-50","rounded","cursor-pointer","transition-colors"],["name","paperclip",1,"w-3","h-3"],["type","file",1,"hidden",3,"change"],["class","inline-flex items-center gap-1 ml-2 text-[10px] text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded",4,"ngFor","ngForOf"],[1,"inline-flex","items-center","gap-1","ml-2","text-[10px]","text-blue-600","bg-blue-50","px-1.5","py-0.5","rounded"],["name","file",1,"w-2.5","h-2.5"],[1,"mt-1.5","flex","items-center","gap-1.5","px-2","py-1","bg-red-50","border","border-red-200","rounded-md"],["name","alert-circle",1,"w-3","h-3","text-red-500","flex-none"],[1,"text-[10px]","text-red-600","font-medium"],[1,"mt-1.5","flex","items-center","gap-1"]],template:function(e,i){e&1&&(r(0,"div",4)(1,"div",5)(2,"label",6),l(3),a(),f(4,bi,2,0,"span",7)(5,Ci,5,2,"span",8),a(),r(6,"div",9),m(7,"app-npa-strategy-badge",10),f(8,Ii,1,1,"app-npa-lineage-badge",11)(9,Si,2,1,"span",12),r(10,"button",13),y("click",function(){return i.onCommentClick()}),m(11,"lucide-icon",14),a()()(),f(12,wi,2,1,"div",15),r(13,"div",16),f(14,Mi,3,2,"ng-container",17)(15,_n,17,16,"ng-container",17),a(),f(16,yn,6,2,"div",18)(17,xn,4,1,"div",19)(18,hn,4,1,"div",20)),e&2&&(s(3),v(i.field.label),s(),c("ngIf",i.field.required),s(),c("ngIf",i.field.tooltip||(i.field.lineageMetadata==null||i.field.lineageMetadata.citations==null?null:i.field.lineageMetadata.citations.length)),s(2),c("strategy",i.field.strategy),s(),c("ngIf",i.field.value),s(),c("ngIf",i.field.confidence),s(3),c("ngIf",i.field.type==="header"),s(2),c("ngIf",i.readOnly),s(),c("ngIf",!i.readOnly),s(),c("ngIf",!i.readOnly&&i.field.attachable&&i.field.type!=="file_upload"),s(),c("ngIf",!i.readOnly&&i.field.validationError),s(),c("ngIf",!i.readOnly&&i.field.source))},dependencies:[N,V,F,de,Mt,Lt,oe,Nt,Dt,se,le,ae,L,et,tt],styles:["textarea.resize-y[_ngcontent-%COMP%]{min-height:60px;max-height:300px}.file-drop-active[_ngcontent-%COMP%]{border-color:#3b82f6!important;background-color:#eff6ff!important}.tag-enter[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_fadeSlideIn .2s ease-out forwards}.bullet-item-enter[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_fadeSlideIn .15s ease-out forwards}@keyframes _ngcontent-%COMP%_fadeSlideIn{0%{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}@keyframes _ngcontent-%COMP%_radioSelect{0%{transform:scale(0)}50%{transform:scale(1.2)}to{transform:scale(1)}}.yesno-dot[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_radioSelect .2s ease-out}@keyframes _ngcontent-%COMP%_slideDown{0%{opacity:0;max-height:0;transform:translateY(-8px)}to{opacity:1;max-height:200px;transform:translateY(0)}}.conditional-field-enter[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_slideDown .3s ease-out forwards;overflow:hidden}"]})};function vn(n,t){n&1&&m(0,"lucide-icon",24)}function Cn(n,t){if(n&1&&(r(0,"span"),l(1),a()),n&2){let e=p().$implicit;s(),v(e.numbering)}}function In(n,t){if(n&1&&(r(0,"span",25),l(1),a()),n&2){let e=p().$implicit,i=p();s(),x(" ",i.missingRequired(e.id)," req ")}}function Sn(n,t){if(n&1){let e=I();r(0,"div",11)(1,"button",12),y("click",function(){let o=_(e).$implicit,d=p();return b(d.selectSection(o.id))}),r(2,"div",13),f(3,vn,1,0,"lucide-icon",14)(4,Cn,2,1,"span",15),a(),r(5,"div",16)(6,"div",17)(7,"p",18),l(8),a(),f(9,In,2,1,"span",19),a(),r(10,"div",20)(11,"div",21),m(12,"div",22),a(),r(13,"span",23),l(14),a()()()()()}if(n&2){let e=t.$implicit,i=p();s(),M("border-blue-600",i.activeSectionId===e.id)("bg-blue-50/50",i.activeSectionId===e.id)("border-transparent",i.activeSectionId!==e.id)("hover:bg-slate-50",i.activeSectionId!==e.id),s(),M("bg-emerald-100",e.status==="complete")("text-emerald-700",e.status==="complete")("bg-amber-100",e.status==="partial")("text-amber-700",e.status==="partial")("bg-slate-100",e.status==="empty")("text-slate-400",e.status==="empty")("bg-blue-100",e.status==="streaming")("text-blue-600",e.status==="streaming"),s(),c("ngIf",e.status==="complete"),s(),c("ngIf",e.status!=="complete"),s(3),M("text-blue-700",i.activeSectionId===e.id)("text-slate-700",i.activeSectionId!==e.id),s(),x(" ",e.label," "),s(),c("ngIf",i.missingRequired(e.id)>0),s(3),O(i.getSectionProgressColor(e)),H("width",e.fieldCount>0?e.filledCount/e.fieldCount*100:0,"%"),s(2),Y("",e.filledCount,"/",e.fieldCount)}}var rt=class n{sections=[];activeSectionId="";filledFields=0;totalFields=0;overallProgress=0;requiredMissingBySection={};sectionSelected=new R;selectSection(t){this.sectionSelected.emit(t)}getGroupForSection(t){for(let e of ee)if(e.sections.includes(t))return e;return t.startsWith("APP")?ee.find(e=>e.id==="LCS")||ee[0]:ee[0]}getSectionProgressColor(t){return t.status==="complete"?"bg-emerald-500":t.status==="partial"?"bg-amber-500":t.status==="streaming"?"bg-blue-500":"bg-slate-300"}trackBySectionId(t,e){return e.id}missingRequired(t){return Number(this.requiredMissingBySection?.[t]||0)}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=E({type:n,selectors:[["app-npa-section-stepper"]],inputs:{sections:"sections",activeSectionId:"activeSectionId",filledFields:"filledFields",totalFields:"totalFields",overallProgress:"overallProgress",requiredMissingBySection:"requiredMissingBySection"},outputs:{sectionSelected:"sectionSelected"},decls:23,vars:5,consts:[[1,"flex-none","px-4","py-3","border-b","border-slate-100","bg-slate-50/50"],[1,"text-[10px]","font-bold","uppercase","tracking-widest","text-slate-400","flex","items-center","gap-1.5"],["name","list-ordered",1,"w-3","h-3"],[1,"flex-1","overflow-y-auto","py-1","npa-scrollbar"],["class","group",4,"ngFor","ngForOf","ngForTrackBy"],[1,"flex-none","px-4","py-3","border-t","border-slate-200","bg-slate-50/50"],[1,"grid","grid-cols-3","gap-1","text-center"],[1,"text-sm","font-bold","text-emerald-600"],[1,"text-[8px]","font-bold","text-slate-400","uppercase"],[1,"text-sm","font-bold","text-amber-600"],[1,"text-sm","font-bold","text-blue-600"],[1,"group"],[1,"w-full","flex","items-start","gap-2","px-3","py-2.5","text-left","transition-all","border-l-2",3,"click"],[1,"flex-none","w-5","h-5","rounded-full","flex","items-center","justify-center","mt-0.5","text-[9px]","font-bold"],["name","check","class","w-3 h-3",4,"ngIf"],[4,"ngIf"],[1,"flex-1","min-w-0"],[1,"flex","items-start","justify-between","gap-2"],[1,"text-[13px]","font-semibold","leading-tight","truncate"],["class","flex-none inline-flex items-center gap-1 px-1.5 py-0.5 rounded-full bg-red-50 text-red-700 border border-red-200 text-[9px] font-bold",4,"ngIf"],[1,"flex","items-center","gap-1.5","mt-1"],[1,"flex-1","h-1","bg-slate-100","rounded-full","overflow-hidden"],[1,"h-full","rounded-full","transition-all","duration-300"],[1,"text-[10px]","font-mono","text-slate-400"],["name","check",1,"w-3","h-3"],[1,"flex-none","inline-flex","items-center","gap-1","px-1.5","py-0.5","rounded-full","bg-red-50","text-red-700","border","border-red-200","text-[9px]","font-bold"]],template:function(e,i){e&1&&(r(0,"div",0)(1,"h3",1),m(2,"lucide-icon",2),l(3," Sections "),a()(),r(4,"div",3),f(5,Sn,15,38,"div",4),a(),r(6,"div",5)(7,"div",6)(8,"div")(9,"p",7),l(10),a(),r(11,"p",8),l(12,"Filled"),a()(),r(13,"div")(14,"p",9),l(15),a(),r(16,"p",8),l(17,"Empty"),a()(),r(18,"div")(19,"p",10),l(20),a(),r(21,"p",8),l(22,"Done"),a()()()()),e&2&&(s(5),c("ngForOf",i.sections)("ngForTrackBy",i.trackBySectionId),s(5),v(i.filledFields),s(5),v(i.totalFields-i.filledFields),s(5),x("",i.overallProgress,"%"))},dependencies:[N,V,F,ae,L],styles:[".npa-scrollbar[_ngcontent-%COMP%]{scrollbar-width:thin;scrollbar-color:#cbd5e1 transparent}.npa-scrollbar[_ngcontent-%COMP%]::-webkit-scrollbar{width:4px}.npa-scrollbar[_ngcontent-%COMP%]::-webkit-scrollbar-track{background:transparent}.npa-scrollbar[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background-color:#cbd5e1;border-radius:4px}.npa-scrollbar[_ngcontent-%COMP%]::-webkit-scrollbar-thumb:hover{background-color:#94a3b8}"]})};var kn=["chatContainer"];function wn(n,t){if(n&1){let e=I();r(0,"button",23),y("click",function(){let o=_(e).$implicit,d=p();return b(d.selectAgent(o.id))}),m(1,"lucide-icon",24),l(2),a()}if(n&2){let e=t.$implicit,i=p();O(i.activeAgentId===e.id?e.textClass:"text-slate-500 hover:text-slate-700 hover:bg-slate-100"),M("bg-white",i.activeAgentId===e.id)("shadow-sm",i.activeAgentId===e.id)("border",i.activeAgentId===e.id)("border-slate-200",i.activeAgentId===e.id),s(),c("name",e.icon),s(),x(" ",e.shortLabel," ")}}function An(n,t){if(n&1&&(r(0,"div",31),m(1,"lucide-icon",24),a()),n&2){let e=p().$implicit,i=p(2);O(e.role==="system"?"bg-slate-100 text-slate-500":i.getActiveGroup().bgClass+" "+i.getActiveGroup().textClass),s(),c("name",e.role==="system"?"info":i.getActiveGroup().icon)}}function Tn(n,t){if(n&1&&(r(0,"div",28),f(1,An,2,3,"div",29),r(2,"div",30),l(3),a()()),n&2){let e=t.$implicit;M("justify-end",e.role==="user"),s(),c("ngIf",e.role!=="user"),s(),M("bg-blue-600",e.role==="user")("text-white",e.role==="user")("bg-slate-100",e.role==="agent")("text-slate-700",e.role==="agent")("bg-slate-50",e.role==="system")("text-slate-500",e.role==="system")("italic",e.role==="system")("border",e.role==="system")("border-slate-200",e.role==="system"),s(),x(" ",e.content," ")}}function Pn(n,t){if(n&1&&(r(0,"span"),l(1),a()),n&2){let e=p(2).ngIf;s(),v(e.streamText)}}function En(n,t){n&1&&(r(0,"span",37),m(1,"span",38)(2,"span",39)(3,"span",40),a())}function Rn(n,t){if(n&1&&(r(0,"div",28)(1,"div",32),m(2,"lucide-icon",33),a(),r(3,"div",34),f(4,Pn,2,1,"span",15)(5,En,4,0,"span",35),m(6,"span",36),a()()),n&2){let e=p().ngIf,i=p();s(),O(i.getActiveGroup().bgClass+" "+i.getActiveGroup().textClass),s(3),c("ngIf",e.streamText),s(),c("ngIf",!e.streamText)}}function Nn(n,t){if(n&1){let e=I();r(0,"button",52),y("click",function(){_(e);let o=p().$implicit,d=p(3);return b(d.onApplySuggestionAsBullets(o))}),m(1,"lucide-icon",56),l(2," Bullets "),a()}}function Dn(n,t){if(n&1&&(r(0,"p",57),l(1),a()),n&2){let e=p().$implicit;s(),x(" Confidence: ",(e.confidence*100).toFixed(0),"% ")}}function Mn(n,t){if(n&1){let e=I();r(0,"div",47)(1,"div",48)(2,"span",49),l(3),a(),r(4,"div",50),f(5,Nn,3,0,"button",51),r(6,"button",52),y("click",function(){let o=_(e).$implicit,d=p(3);return b(d.onApplySuggestion(o))}),m(7,"lucide-icon",53),l(8," Apply "),a()()(),r(9,"p",54),l(10),a(),f(11,Dn,2,1,"p",55),a()}if(n&2){let e=t.$implicit,i=p(3);s(3),v(e.label||e.fieldKey),s(2),c("ngIf",i.isBulletField(e.fieldKey)),s(5),Y("",e.value.substring(0,200),"",e.value.length>200?"...":""),s(),c("ngIf",e.confidence)}}function Ln(n,t){if(n&1){let e=I();r(0,"div",41)(1,"div",42)(2,"p",43),m(3,"lucide-icon",44),l(4),a(),r(5,"button",45),y("click",function(){_(e);let o=p(2);return b(o.applyAllSuggestions())}),l(6," Apply All "),a()(),f(7,Mn,12,5,"div",46),a()}if(n&2){let e=p(2);s(4),x(" Field Suggestions (",e.pendingSuggestions.length,") "),s(3),c("ngForOf",e.pendingSuggestions)}}function On(n,t){if(n&1&&(me(0),f(1,Tn,4,22,"div",25)(2,Rn,7,4,"div",26)(3,Ln,8,2,"div",27),ue()),n&2){let e=t.ngIf,i=p();s(),c("ngForOf",e.messages)("ngForTrackBy",i.trackByMsgIndex),s(),c("ngIf",e.isStreaming),s(),c("ngIf",i.pendingSuggestions.length>0)}}var at=class n{signOffGroups=ee;activeAgentId="BIZ";agentChats=new Map;sectionFieldGroups=new Map;inputData=null;agentSelected=new R;messageSent=new R;validateRequested=new R;applySuggestion=new R;chatContainer;cdr=T(Ne);difyService=T(ce);chatSessionService=T(Be);http=T(re);shouldScrollToBottom=!1;chatInput="";pendingSuggestions=[];pendingFieldHelp=null;agentConfigured=new Map;isTestingAgent=!1;agentIdMap={BIZ:"AG_NPA_BIZ",TECH_OPS:"AG_NPA_TECH_OPS",FINANCE:"AG_NPA_FINANCE",RMG:"AG_NPA_RMG",LCS:"AG_NPA_LCS"};ngOnInit(){this.refreshAgentStatus()}ngAfterViewChecked(){this.shouldScrollToBottom&&(this.scrollToBottom(),this.shouldScrollToBottom=!1)}selectAgent(t){this.activeAgentId=t,this.pendingSuggestions=[],this.agentSelected.emit(t)}getActiveGroup(){return this.signOffGroups.find(t=>t.id===this.activeAgentId)||this.signOffGroups[0]}getActiveAgentChat(){return this.agentChats.get(this.activeAgentId)}isActiveAgentConfigured(){let t=this.agentIdMap[this.activeAgentId];return this.agentConfigured.get(t)===!0}refreshAgentStatus(){this.http.get("/api/dify/agents/status").subscribe({next:t=>{let e=Array.isArray(t?.agents)?t.agents:Array.isArray(t)?t:[],i=new Map;for(let o of e)o?.id&&i.set(String(o.id),!!o.configured);this.agentConfigured=i,this.cdr.detectChanges()},error:()=>{}})}testActiveAgent(){let t=this.agentChats.get(this.activeAgentId);if(!t||this.isTestingAgent)return;let e=this.agentIdMap[this.activeAgentId];t.messages.push({role:"system",content:`Testing connection for ${this.getActiveGroup().shortLabel} agent...`,timestamp:new Date}),this.shouldScrollToBottom=!0,this.isTestingAgent=!0;let i=this.inputData?.npaId||this.inputData?.projectId||this.inputData?.id||"",o=this.inputData?.title||"",d={current_project_id:i?String(i):"",npa_data:o?`NPA title: ${o}`:""};this.difyService.sendMessage("Connection test: reply with OK and your agent name.",d,e).subscribe({next:u=>{t.messages.push({role:"agent",content:u.answer||"OK",timestamp:new Date}),t.isConnected=!0,this.agentConfigured.set(e,!0),this.autoSaveSession(t),this.shouldScrollToBottom=!0,this.isTestingAgent=!1,this.cdr.detectChanges()},error:u=>{let g=u?.error?.error||u?.message||"Connection test failed";t.messages.push({role:"system",content:`Connection test failed. ${String(g)}`,timestamp:new Date}),this.autoSaveSession(t),this.shouldScrollToBottom=!0,this.isTestingAgent=!1,this.cdr.detectChanges()}})}sendChatMessage(){if(!this.chatInput.trim())return;let t=this.agentChats.get(this.activeAgentId);if(!t)return;let e=this.chatInput.trim();t.messages.push({role:"user",content:e,timestamp:new Date}),this.autoSaveSession(t),this.chatInput="",this.pendingSuggestions=[],this.shouldScrollToBottom=!0;let i=this.agentIdMap[this.activeAgentId],o=this.signOffGroups.find(h=>h.id===this.activeAgentId),d=this.buildAgentContext(o),u=d?`[Context: Reviewing NPA sections ${o?.sections.join(", ")}]

${d}

User question: ${e}`:e;t.isStreaming=!0,t.streamText="";let g=this.inputData?.npaId||this.inputData?.projectId||this.inputData?.id||"",C={current_project_id:g?String(g):"",current_stage:"draft_builder",user_message:e};this.difyService.sendMessage(u,C,i).subscribe({next:h=>{let S=String(h.answer||"").trim();t.messages.push({role:"agent",content:S,timestamp:new Date});let P=h?.metadata?.payload?.field_suggestions;Array.isArray(P)&&P.length?this.pendingSuggestions=P.map(k=>({fieldKey:String(k.field_key||k.fieldKey||""),label:k.label?String(k.label):void 0,value:String(k.suggested_value??k.value??""),confidence:typeof k.confidence=="number"?k.confidence:void 0})).filter(k=>!!k.fieldKey):this.pendingFieldHelp?.fieldKey&&S?this.pendingSuggestions=[{fieldKey:this.pendingFieldHelp.fieldKey,label:this.pendingFieldHelp.label,value:S,format:"text"}]:this.pendingSuggestions=[],this.pendingFieldHelp=null,t.isStreaming=!1,t.streamText="",t.isConnected=!0,this.shouldScrollToBottom=!0,this.autoSaveSession(t),this.cdr.detectChanges()},error:h=>{let S=h?.error?.metadata?.trace?.error_detail||h?.error?.metadata?.trace?.detail||h?.error?.detail||h?.error?.error||h?.message||"Unknown error";console.warn(`[AgentChat] Agent ${i} error:`,S),t.messages.push({role:"system",content:`Agent request failed (HTTP ${h?.status||"N/A"}). ${String(S)}`,timestamp:new Date}),t.isStreaming=!1,t.streamText="",this.shouldScrollToBottom=!0,this.autoSaveSession(t),this.cdr.detectChanges()}})}askAboutField(t){this.pendingFieldHelp={fieldKey:t.key,label:t.label},this.chatInput=`Help me fill the "${t.label}" field. What should the value be based on the product context?`,this.sendChatMessage()}onApplySuggestion(t){this.applySuggestion.emit(t),this.pendingSuggestions=this.pendingSuggestions.filter(i=>i.fieldKey!==t.fieldKey);let e=this.agentChats.get(this.activeAgentId);e&&(e.messages.push({role:"system",content:`Applied suggestion for "${t.label||t.fieldKey}".`,timestamp:new Date}),this.shouldScrollToBottom=!0,this.autoSaveSession(e),this.cdr.detectChanges())}onApplySuggestionAsBullets(t){this.onApplySuggestion(pe(B({},t),{format:"bullets"}))}applyAllSuggestions(){for(let i of this.pendingSuggestions)this.applySuggestion.emit(i);let t=this.pendingSuggestions.length;this.pendingSuggestions=[];let e=this.agentChats.get(this.activeAgentId);e&&(e.messages.push({role:"system",content:`Applied ${t} field suggestion${t>1?"s":""}.`,timestamp:new Date}),this.shouldScrollToBottom=!0,this.autoSaveSession(e),this.cdr.detectChanges())}isBulletField(t){if(!t)return!1;for(let e of this.sectionFieldGroups.values())for(let i of e){let o=i.fields?.find(d=>d.key===t);if(o)return o.type==="bullet_list"}return!1}autoSaveSession(t){if(!t.messages.length)return;let e=this.agentIdMap[this.activeAgentId]||this.activeAgentId,i=this.difyService.getConversationId(e),o={activeAgentId:e,delegationStack:[],conversations:i?{[e]:i}:{}};t.sessionId=this.chatSessionService.saveSessionFor(t.sessionId||null,t.messages.map(d=>({role:d.role==="system"?"agent":d.role,content:d.content,timestamp:d.timestamp})),e,null,{makeActive:!1,conversationState:o})}parseNpaMeta(t){let e=/@@NPA_META@@(\{[\s\S]*?\})(?:@@END_META@@)?/g,i=[],o=t,d;for(;(d=e.exec(t))!==null;){try{let u=JSON.parse(d[1]),g=u.fields||(u.field_key?[u]:[]);for(let C of g)C.field_key&&C.value!==void 0&&i.push({fieldKey:C.field_key,label:C.label||C.field_key,value:String(C.value),confidence:C.confidence})}catch(u){console.warn("[AgentChat] Failed to parse @@NPA_META@@:",u),this.tryExtractFieldsFromBrokenJson(d[1],i)}o=o.replace(d[0],"").trim()}return{cleanText:o,suggestions:i}}tryExtractFieldsFromBrokenJson(t,e){let i=/\{\s*"field_key"\s*:\s*"([^"]+)"\s*,\s*"label"\s*:\s*"([^"]*)"\s*,\s*"value"\s*:\s*"((?:[^"\\]|\\.)*)"\s*(?:,\s*"confidence"\s*:\s*([\d.]+))?\s*\}/g,o,d=0;for(;(o=i.exec(t))!==null;)e.push({fieldKey:o[1],label:o[2]||o[1],value:o[3].replace(/\\"/g,'"').replace(/\\n/g,`
`),confidence:o[4]?parseFloat(o[4]):void 0}),d++;d>0&&console.log(`[AgentChat] Fallback parser recovered ${d} fields from malformed JSON`)}getAgentDifyAppName(){return{BIZ:"CF_NPA_BIZ",TECH_OPS:"CF_NPA_TECH_OPS",FINANCE:"CF_NPA_FINANCE",RMG:"CF_NPA_RMG",LCS:"CF_NPA_LCS"}[this.activeAgentId]}buildAgentContext(t){if(!t)return"";let e=[],i=this.inputData?.npaId||this.inputData?.projectId||this.inputData?.id||"",o=this.inputData?.title||this.inputData?.product_name||"",d=this.inputData?.description||"",u=this.inputData?.npaType||this.inputData?.npa_type||"",g=[];i&&g.push(`NPA ID: ${i}`),o&&g.push(`Title: ${o}`),u&&g.push(`Classification: ${u}`),d&&g.push(`Description: ${String(d).substring(0,240)}${String(d).length>240?"...":""}`),g.length&&e.push(`NPA summary:
- ${g.join(`
- `)}`);let C=[];for(let h of t.sections){let S=this.sectionFieldGroups.get(h)||[];for(let P of S){let k=P.fields.filter(w=>w.value&&w.value.trim());if(k.length>0){e.push(`### ${P.topic}`);for(let w of k)e.push(`- **${w.label}**: ${w.value.substring(0,200)}${w.value.length>200?"...":""}`)}for(let w of P.fields)(!w.value||!String(w.value).trim())&&w.required&&C.push({key:w.key,label:w.label,section:h})}}if(C.length>0){let h=C.slice(0,30);e.push(""),e.push("Missing required fields (please propose values; if unknown, ask 1 clarification question first):");for(let S of h)e.push(`- ${S.key} \u2014 ${S.label} (${S.section})`);C.length>h.length&&e.push(`- ...and ${C.length-h.length} more required fields`)}return e.length>0?`Current field values:
${e.join(`
`)}`:""}scrollToBottom(){try{this.chatContainer&&(this.chatContainer.nativeElement.scrollTop=this.chatContainer.nativeElement.scrollHeight)}catch{}}trackByMsgIndex(t,e){return t}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=E({type:n,selectors:[["app-npa-agent-chat"]],viewQuery:function(e,i){if(e&1&&ge(kn,5),e&2){let o;fe(o=_e())&&(i.chatContainer=o.first)}},inputs:{signOffGroups:"signOffGroups",activeAgentId:"activeAgentId",agentChats:"agentChats",sectionFieldGroups:"sectionFieldGroups",inputData:"inputData"},outputs:{agentSelected:"agentSelected",messageSent:"messageSent",validateRequested:"validateRequested",applySuggestion:"applySuggestion"},decls:29,vars:32,consts:[["chatContainer",""],[1,"flex-none","border-b","border-slate-200","bg-slate-50/50"],[1,"flex","items-center","gap-0.5","px-2","py-2","overflow-x-auto","npa-scrollbar-x"],["class","flex-none flex items-center gap-1 px-2 py-1.5 rounded-lg text-[10px] font-semibold transition-all whitespace-nowrap",3,"bg-white","shadow-sm","border","border-slate-200","class","click",4,"ngFor","ngForOf"],[1,"flex-none","px-4","py-2.5","border-b","border-slate-100","flex","items-center","justify-between"],[1,"flex","items-center","gap-2"],[1,"w-4","h-4",3,"name"],[1,"text-[11px]","font-bold"],[1,"text-[9px]","text-slate-500"],[1,"w-1.5","h-1.5","rounded-full",3,"title"],["title","Test",1,"p-1.5","rounded-md","border","border-slate-200","bg-white/70","hover:bg-white","transition-colors","disabled:opacity-50",3,"click","disabled"],["name","activity",1,"w-3.5","h-3.5"],["title","Refresh status",1,"p-1.5","rounded-md","border","border-slate-200","bg-white/70","hover:bg-white","transition-colors",3,"click"],["name","refresh-cw",1,"w-3.5","h-3.5"],[1,"flex-1","overflow-y-auto","px-3","py-3","space-y-3","npa-scrollbar"],[4,"ngIf"],[1,"flex-none","px-3","py-3","border-t","border-slate-200","bg-white"],["type","text",1,"flex-1","px-3","py-2","text-xs","rounded-lg","border","border-slate-200","bg-slate-50","focus:bg-white","focus:border-blue-300","focus:ring-2","focus:ring-blue-500/20","outline-none","transition-all","disabled:opacity-50",3,"ngModelChange","keydown.enter","ngModel","placeholder"],[1,"flex-none","p-2","rounded-lg","transition-colors",3,"click","disabled"],["name","send",1,"w-3.5","h-3.5"],[1,"flex","items-center","gap-2","mt-2"],[1,"text-[9px]","font-medium","text-slate-400","hover:text-blue-600","hover:bg-blue-50","px-2","py-1","rounded","transition-colors",3,"click"],["name","check-circle-2",1,"w-2.5","h-2.5","inline","mr-0.5"],[1,"flex-none","flex","items-center","gap-1","px-2","py-1.5","rounded-lg","text-[10px]","font-semibold","transition-all","whitespace-nowrap",3,"click"],[1,"w-3","h-3",3,"name"],["class","flex gap-2",3,"justify-end",4,"ngFor","ngForOf","ngForTrackBy"],["class","flex gap-2",4,"ngIf"],["class","space-y-2 mt-2",4,"ngIf"],[1,"flex","gap-2"],["class","flex-none w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold",3,"class",4,"ngIf"],[1,"max-w-[85%]","px-3","py-2","rounded-xl","text-xs","leading-relaxed","whitespace-pre-wrap"],[1,"flex-none","w-6","h-6","rounded-full","flex","items-center","justify-center","text-[10px]","font-bold"],[1,"flex-none","w-6","h-6","rounded-full","flex","items-center","justify-center"],["name","loader-2",1,"w-3","h-3","animate-spin"],[1,"max-w-[85%]","bg-slate-100","px-3","py-2","rounded-xl","text-xs","text-slate-700","leading-relaxed","whitespace-pre-wrap"],["class","flex items-center gap-1.5",4,"ngIf"],[1,"inline-block","w-0.5","h-3.5","bg-slate-400","ml-0.5","animate-pulse"],[1,"flex","items-center","gap-1.5"],[1,"w-1","h-1","bg-slate-400","rounded-full","animate-bounce",2,"animation-delay","0ms"],[1,"w-1","h-1","bg-slate-400","rounded-full","animate-bounce",2,"animation-delay","150ms"],[1,"w-1","h-1","bg-slate-400","rounded-full","animate-bounce",2,"animation-delay","300ms"],[1,"space-y-2","mt-2"],[1,"flex","items-center","justify-between","px-2"],[1,"text-[10px]","font-bold","uppercase","tracking-wider","text-emerald-600"],["name","lightbulb",1,"w-3","h-3","inline","mr-1"],[1,"text-[9px]","font-semibold","text-emerald-600","hover:bg-emerald-50","px-2","py-0.5","rounded","transition-colors",3,"click"],["class","bg-emerald-50 border border-emerald-200 rounded-lg px-3 py-2 space-y-1",4,"ngFor","ngForOf"],[1,"bg-emerald-50","border","border-emerald-200","rounded-lg","px-3","py-2","space-y-1"],[1,"flex","items-center","justify-between"],[1,"text-[11px]","font-semibold","text-slate-700"],[1,"flex","items-center","gap-1"],["class","text-[9px] font-bold text-emerald-700 hover:bg-emerald-100 px-2 py-0.5 rounded transition-colors flex items-center gap-1",3,"click",4,"ngIf"],[1,"text-[9px]","font-bold","text-emerald-700","hover:bg-emerald-100","px-2","py-0.5","rounded","transition-colors","flex","items-center","gap-1",3,"click"],["name","check",1,"w-2.5","h-2.5"],[1,"text-[11px]","text-slate-600","leading-relaxed"],["class","text-[9px] text-slate-400 font-mono",4,"ngIf"],["name","list",1,"w-2.5","h-2.5"],[1,"text-[9px]","text-slate-400","font-mono"]],template:function(e,i){if(e&1){let o=I();r(0,"div",1)(1,"div",2),f(2,wn,3,12,"button",3),a()(),r(3,"div",4)(4,"div",5),m(5,"lucide-icon",6),r(6,"div")(7,"p",7),l(8),a(),r(9,"p",8),l(10),a()()(),r(11,"div",5),m(12,"div",9),r(13,"button",10),y("click",function(){return _(o),b(i.testActiveAgent())}),m(14,"lucide-icon",11),a(),r(15,"button",12),y("click",function(){return _(o),b(i.refreshAgentStatus())}),m(16,"lucide-icon",13),a()()(),r(17,"div",14,0),f(19,On,4,4,"ng-container",15),a(),r(20,"div",16)(21,"div",5)(22,"input",17),K("ngModelChange",function(u){return _(o),q(i.chatInput,u)||(i.chatInput=u),b(u)}),y("keydown.enter",function(){return _(o),b(i.sendChatMessage())}),a(),r(23,"button",18),y("click",function(){return _(o),b(i.sendChatMessage())}),m(24,"lucide-icon",19),a()(),r(25,"div",20)(26,"button",21),y("click",function(){return _(o),b(i.validateRequested.emit())}),m(27,"lucide-icon",22),l(28," Validate "),a()()()}if(e&2){let o,d;s(2),c("ngForOf",i.signOffGroups),s(),O(i.getActiveGroup().bgClass),s(2),O(i.getActiveGroup().textClass),c("name",i.getActiveGroup().icon),s(2),O(i.getActiveGroup().textClass),s(),v(i.getActiveGroup().label),s(2),x("Sections: ",i.getActiveGroup().sections.join(", ")),s(2),M("bg-emerald-400",i.isActiveAgentConfigured())("bg-amber-400",!i.isActiveAgentConfigured()&&((o=i.getActiveAgentChat())==null?null:o.isConnected))("bg-slate-300",!i.isActiveAgentConfigured()&&!((d=i.getActiveAgentChat())!=null&&d.isConnected)),c("title",i.isActiveAgentConfigured()?"Configured":"Unconfigured"),s(),c("disabled",i.isTestingAgent),s(6),c("ngIf",i.getActiveAgentChat()),s(3),j("ngModel",i.chatInput),c("placeholder","Ask "+i.getActiveGroup().shortLabel+" agent..."),s(),M("bg-blue-600",i.chatInput.trim())("text-white",i.chatInput.trim())("hover:bg-blue-700",i.chatInput.trim())("bg-slate-100",!i.chatInput.trim())("text-slate-400",!i.chatInput.trim()),c("disabled",!i.chatInput.trim())}},dependencies:[N,V,F,de,oe,se,le,ae,L],styles:[".npa-scrollbar[_ngcontent-%COMP%]{scrollbar-width:thin;scrollbar-color:#cbd5e1 transparent}.npa-scrollbar[_ngcontent-%COMP%]::-webkit-scrollbar{width:4px}.npa-scrollbar[_ngcontent-%COMP%]::-webkit-scrollbar-track{background:transparent}.npa-scrollbar[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background-color:#cbd5e1;border-radius:4px}.npa-scrollbar[_ngcontent-%COMP%]::-webkit-scrollbar-thumb:hover{background-color:#94a3b8}.npa-scrollbar-x[_ngcontent-%COMP%]{scrollbar-width:thin;scrollbar-color:#cbd5e1 transparent}.npa-scrollbar-x[_ngcontent-%COMP%]::-webkit-scrollbar{height:3px}.npa-scrollbar-x[_ngcontent-%COMP%]::-webkit-scrollbar-track{background:transparent}.npa-scrollbar-x[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background-color:#e2e8f0;border-radius:3px}@keyframes _ngcontent-%COMP%_typingBounce{0%,to{transform:translateY(0)}50%{transform:translateY(-3px)}}.typing-dot[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_typingBounce .6s ease-in-out infinite}"]})};var Fn=["agentChat"],Vn=()=>[];function Bn(n,t){if(n&1&&(r(0,"span",49),l(1),a()),n&2){let e=p();s(),x(" ",e.draftCommentCount()," ")}}function Gn(n,t){if(n&1&&(r(0,"div",50),m(1,"lucide-icon",51),r(2,"span",52),l(3),a()()),n&2){let e=p();s(3),v(e.draftSaveError)}}function Un(n,t){if(n&1&&(r(0,"span",70),l(1),a()),n&2){let e=p().ngIf,i=p();s(),x(" ",i.requiredMissingBySection[e.id]," required missing ")}}function jn(n,t){if(n&1&&(r(0,"span",71),l(1),a()),n&2){let e=p(2);s(),x(" ",e.requiredMissing," ")}}function qn(n,t){if(n&1){let e=I();r(0,"div",53)(1,"div",54)(2,"div",55),m(3,"lucide-icon",56),a(),r(4,"div")(5,"div",7)(6,"span",57),l(7),a(),r(8,"span",58),m(9,"lucide-icon",59),l(10),a(),f(11,Un,2,1,"span",60),a(),r(12,"h2",61),l(13),a(),r(14,"p",62),l(15,"Agents propose values; you decide + save."),a()()(),r(16,"div",7)(17,"button",63),y("click",function(){_(e);let o=p();return b(o.goToNextMissingRequired())}),l(18," Next missing required "),a(),r(19,"button",64),y("click",function(){_(e);let o=p();return b(o.openIssuesPanel())}),l(20," Show Issues "),f(21,jn,2,1,"span",65),a(),r(22,"span",66),l(23),a(),r(24,"button",67),y("click",function(){_(e);let o=p();return b(o.navigatePrev())}),m(25,"lucide-icon",68),a(),r(26,"button",67),y("click",function(){_(e);let o=p();return b(o.navigateNext())}),m(27,"lucide-icon",69),a()()()}if(n&2){let e=t.ngIf,i=p();s(2),O(i.getGroupForSection(e.id).bgClass+" border "+i.getGroupForSection(e.id).borderClass),s(),O(i.getGroupForSection(e.id).textClass),c("name",e.icon),s(4),x("Section ",e.numbering),s(),O(i.getGroupForSection(e.id).bgClass+" "+i.getGroupForSection(e.id).textClass),s(),c("name",i.getGroupForSection(e.id).icon),s(),x(" ",i.getGroupForSection(e.id).label," "),s(),c("ngIf",i.requiredMissingBySection[e.id]),s(2),v(e.label),s(4),c("disabled",i.validationErrors.length===0),s(4),c("ngIf",i.requiredMissing>0),s(2),Y(" ",e.filledCount,"/",e.fieldCount," fields "),s(),c("disabled",(i.stepperSections[0]==null?null:i.stepperSections[0].id)===i.activeSectionId),s(2),c("disabled",(i.stepperSections[i.stepperSections.length-1]==null?null:i.stepperSections[i.stepperSections.length-1].id)===i.activeSectionId)}}function Kn(n,t){n&1&&(r(0,"div",72)(1,"div",73),m(2,"lucide-icon",74),a(),r(3,"p",75),l(4,"No fields in this section"),a(),r(5,"p",76),l(6,"This section may not require field input"),a()())}function $n(n,t){if(n&1&&(r(0,"div",85)(1,"p",86),m(2,"lucide-icon",87),l(3),a()()),n&2){let e=p().$implicit;s(3),x(" ",e.guidance," ")}}function Wn(n,t){if(n&1){let e=I();r(0,"div",89)(1,"app-npa-field-renderer",90),y("fieldEdited",function(o){_(e);let d=p(3);return b(d.onFieldEdited(o))})("fieldCleared",function(o){_(e);let d=p(3);return b(d.onFieldCleared(o))})("askAgent",function(o){_(e);let d=p(3);return b(d.askAgentAboutField(o))})("citationClick",function(o){_(e);let d=p(3);return b(d.onCitationClick(o))})("commentClicked",function(o){_(e);let d=p(3);return b(d.openCommentsForField(o))}),a()()}if(n&2){let e=p().$implicit,i=p(2);c("id","field_"+e.key),s(),c("field",e)("readOnly",i.isReadOnly)}}function Yn(n,t){if(n&1&&(me(0),f(1,Wn,2,3,"div",88),ue()),n&2){let e=t.$implicit,i=p(2);s(),c("ngIf",i.shouldShowField(e))}}function Hn(n,t){if(n&1&&(r(0,"div",77)(1,"div",78)(2,"div",7)(3,"span",79),l(4),a(),r(5,"h3",80),l(6),a()(),r(7,"span",81),l(8),a()(),f(9,$n,4,1,"div",82),r(10,"div",83),f(11,Yn,2,1,"ng-container",84),a()()),n&2){let e=t.$implicit,i=p();s(4),v(e.numbering),s(2),v(e.topic),s(2),Y(" ",e.fields.length," field",e.fields.length!==1?"s":""," "),s(),c("ngIf",e.guidance),s(2),c("ngForOf",e.fields)("ngForTrackBy",i.trackByFieldKey)}}function zn(n,t){n&1&&(r(0,"div",91),l(1,"Assistant Panel"),a())}function Jn(n,t){n&1&&m(0,"div",92)}function Qn(n,t){if(n&1&&(r(0,"span",98),l(1),a()),n&2){let e=p(2);s(),x(" ",e.requiredMissing," ")}}function Xn(n,t){if(n&1){let e=I();r(0,"div",93)(1,"button",94),y("click",function(){_(e);let o=p();return b(o.agentPanelTab="CHAT")}),m(2,"lucide-icon",20),l(3," Chat "),a(),r(4,"button",94),y("click",function(){_(e);let o=p();return b(o.agentPanelTab="KNOWLEDGE")}),m(5,"lucide-icon",95),l(6," Knowledge "),a(),r(7,"button",94),y("click",function(){_(e);let o=p();return b(o.agentPanelTab="ISSUES")}),m(8,"lucide-icon",96),l(9," Issues "),f(10,Qn,2,1,"span",97),a()()}if(n&2){let e=p();s(),M("bg-white",e.agentPanelTab==="CHAT")("shadow-sm",e.agentPanelTab==="CHAT")("text-slate-800",e.agentPanelTab==="CHAT")("text-slate-400",e.agentPanelTab!=="CHAT")("hover:text-slate-600",e.agentPanelTab!=="CHAT"),s(3),M("bg-white",e.agentPanelTab==="KNOWLEDGE")("shadow-sm",e.agentPanelTab==="KNOWLEDGE")("text-blue-700",e.agentPanelTab==="KNOWLEDGE")("border",e.agentPanelTab==="KNOWLEDGE")("border-blue-100",e.agentPanelTab==="KNOWLEDGE")("text-slate-400",e.agentPanelTab!=="KNOWLEDGE")("hover:text-slate-600",e.agentPanelTab!=="KNOWLEDGE"),s(3),M("bg-white",e.agentPanelTab==="ISSUES")("shadow-sm",e.agentPanelTab==="ISSUES")("text-rose-700",e.agentPanelTab==="ISSUES")("border",e.agentPanelTab==="ISSUES")("border-rose-100",e.agentPanelTab==="ISSUES")("text-slate-400",e.agentPanelTab!=="ISSUES")("hover:text-slate-600",e.agentPanelTab!=="ISSUES"),s(3),c("ngIf",e.requiredMissing>0)}}function Zn(n,t){if(n&1){let e=I();r(0,"app-npa-agent-chat",99,0),y("agentSelected",function(o){_(e);let d=p();return b(d.selectAgent(o))})("validateRequested",function(){_(e);let o=p();return b(o.validateDraft())})("applySuggestion",function(o){_(e);let d=p();return b(d.onApplyFieldSuggestion(o))}),a()}if(n&2){let e=p();c("signOffGroups",e.signOffGroups)("activeAgentId",e.activeAgentId)("agentChats",e.agentChats)("sectionFieldGroups",e.sectionFieldGroups)("inputData",e.inputData)}}function er(n,t){if(n&1&&(r(0,"div",115)(1,"span",116),l(2,"Full Origin Document"),a(),r(3,"a",117),l(4," Open "),m(5,"lucide-icon",118),a()()),n&2){let e=p(3);s(3),c("href",e.selectedCitation.url,Ce)}}function tr(n,t){if(n&1&&(r(0,"div",103)(1,"div",104)(2,"div",105),m(3,"lucide-icon",106),a(),r(4,"div")(5,"h3",107),l(6),a(),r(7,"span",108),l(8),a()()(),r(9,"div",109)(10,"div",110)(11,"div",111),m(12,"lucide-icon",112),l(13," Cited Passage "),a(),r(14,"blockquote",113),l(15),a()(),f(16,er,6,1,"div",114),a()()),n&2){let e=p(2);s(6),x("",e.selectedCitation.sourceName," "),s(2),x(" ",e.selectedCitation.sourceId," "),s(7),x(" ",e.selectedCitation.snippet," "),s(),c("ngIf",e.selectedCitation.url)}}function ir(n,t){n&1&&(r(0,"div",119)(1,"div",120),m(2,"lucide-icon",121),a(),r(3,"h4",122),l(4,"No Evidence Selected"),a(),r(5,"p",123),l(6,'Click on the "Sources & Evidence" links in the field tooltips to view the exact policy or historical document used by the agent.'),a()())}function nr(n,t){if(n&1&&(r(0,"div",100),f(1,tr,17,4,"div",101)(2,ir,7,0,"div",102),a()),n&2){let e=p();s(),c("ngIf",e.selectedCitation),s(),c("ngIf",!e.selectedCitation)}}function rr(n,t){n&1&&(r(0,"div",136),l(1," No blocking issues detected. "),a())}function ar(n,t){if(n&1){let e=I();r(0,"div",137)(1,"div",138)(2,"div",6)(3,"div",139),l(4),a(),r(5,"div",140),l(6),a()(),r(7,"button",141),y("click",function(){let o=_(e).$implicit,d=p(2);return b(d.jumpToField(o.field,o.section))}),l(8," Jump "),a()()()}if(n&2){let e=t.$implicit;s(4),x("Missing required: ",e.label),s(2),v(e.field)}}function or(n,t){if(n&1&&(r(0,"div",124)(1,"div",125)(2,"div",126),l(3,"Issues"),a(),r(4,"div",127),l(5," Missing required fields and validation blockers. "),a()(),r(6,"div",128)(7,"div",129)(8,"div",130)(9,"div",131),l(10,"Required missing"),a(),r(11,"div",132),l(12),a()(),r(13,"div",130)(14,"div",131),l(15,"Required total"),a(),r(16,"div",133),l(17),a()()(),f(18,rr,2,0,"div",134)(19,ar,9,2,"div",135),a()()),n&2){let e=p();s(12),v(e.requiredMissing),s(5),v(e.requiredTotal),s(),c("ngIf",e.validationErrors.length===0),s(),c("ngForOf",e.validationErrors)}}function sr(n,t){if(n&1&&(r(0,"div",162),l(1),a()),n&2){let e=p(2);s(),x(" ",e.commentsDrawerRef," ")}}function lr(n,t){n&1&&(r(0,"div",163),l(1," Loading comments\u2026 "),a())}function dr(n,t){if(n&1&&(r(0,"div",164),l(1),a()),n&2){let e=p(2);s(),x(" ",e.commentsError," ")}}function cr(n,t){if(n&1&&(r(0,"div",174)(1,"div",166)(2,"div",175),l(3),a(),r(4,"div",16),l(5),a()(),r(6,"div",176),l(7),a()()),n&2){let e=t.$implicit;s(3),v(e.author),s(2),v(e.when),s(2),x(" ",e.text," ")}}function pr(n,t){if(n&1&&(r(0,"div",172),f(1,cr,8,3,"div",173),a()),n&2){let e=p().$implicit,i=p(2);s(),c("ngForOf",e.replies)("ngForTrackBy",i.trackByReplyId)}}function mr(n,t){if(n&1){let e=I();r(0,"div",177)(1,"textarea",178),K("ngModelChange",function(o){_(e);let d=p(3);return q(d.replyDraft,o)||(d.replyDraft=o),b(o)}),a(),r(2,"div",179)(3,"button",180),y("click",function(){_(e);let o=p(3);return b(o.cancelReply())}),l(4," Cancel "),a(),r(5,"button",181),y("click",function(){_(e);let o=p(3);return b(o.postReply())}),l(6," Post Reply "),a()()()}if(n&2){let e=p(3);s(),j("ngModel",e.replyDraft),s(4),c("disabled",e.commentsLoading)}}function ur(n,t){if(n&1){let e=I();r(0,"div",165)(1,"div",166)(2,"div",167),l(3),a(),r(4,"div",16),l(5),a()(),r(6,"div",168),l(7),a(),f(8,pr,2,2,"div",169),r(9,"div",159)(10,"button",170),y("click",function(){let o=_(e).$implicit,d=p(2);return b(d.startReply(o.id))}),l(11," Reply "),a()(),f(12,mr,7,2,"div",171),a()}if(n&2){let e=t.$implicit,i=p(2);s(3),v(e.author),s(2),v(e.when),s(2),x(" ",e.text," "),s(),c("ngIf",e.replies==null?null:e.replies.length),s(4),c("ngIf",i.replyToCommentId===e.id)}}function gr(n,t){if(n&1){let e=I();r(0,"div",142)(1,"div",143),y("click",function(){_(e);let o=p();return b(o.closeCommentsDrawer())}),a(),r(2,"div",144)(3,"div",145)(4,"div",6)(5,"div",146),l(6,"Comments"),a(),r(7,"div",147),l(8),a(),f(9,sr,2,1,"div",148),a(),r(10,"button",149),y("click",function(){_(e);let o=p();return b(o.closeCommentsDrawer())}),m(11,"lucide-icon",150),a()(),r(12,"div",151),f(13,lr,2,0,"div",152)(14,dr,2,1,"div",153)(15,ur,13,5,"div",154),r(16,"div",155),l(17," Versions placeholder: each field change will create a version entry (diff/restore) later. "),a()(),r(18,"div",156)(19,"label",157),l(20,"Add a comment"),a(),r(21,"textarea",158),K("ngModelChange",function(o){_(e);let d=p();return q(d.commentDraft,o)||(d.commentDraft=o),b(o)}),a(),r(22,"div",159)(23,"button",160),y("click",function(){_(e);let o=p();return b(o.postComment())}),m(24,"lucide-icon",161),l(25," Post "),a()()()()()}if(n&2){let e=p();s(8),x(" ",e.commentsDrawerTitle," "),s(),c("ngIf",e.commentsDrawerRef),s(4),c("ngIf",e.commentsLoading),s(),c("ngIf",e.commentsError),s(),c("ngForOf",(e.activeThread==null?null:e.activeThread.comments)||Z(8,Vn))("ngForTrackBy",e.trackByCommentId),s(6),j("ngModel",e.commentDraft),s(2),c("disabled",e.commentsLoading)}}var ee=[{id:"BIZ",label:"Proposing Unit (Business)",shortLabel:"Business",icon:"briefcase",color:"blue",bgClass:"bg-blue-50",textClass:"text-blue-700",borderClass:"border-blue-200",sections:["PC.I","PC.VII"]},{id:"TECH_OPS",label:"T&O + ISS",shortLabel:"T&O",icon:"settings",color:"indigo",bgClass:"bg-indigo-50",textClass:"text-indigo-700",borderClass:"border-indigo-200",sections:["PC.II"]},{id:"FINANCE",label:"Group Finance",shortLabel:"Finance",icon:"calculator",color:"emerald",bgClass:"bg-emerald-50",textClass:"text-emerald-700",borderClass:"border-emerald-200",sections:["PC.III","PC.V"]},{id:"RMG",label:"RMG (Market & Credit)",shortLabel:"RMG",icon:"shield-alert",color:"rose",bgClass:"bg-rose-50",textClass:"text-rose-700",borderClass:"border-rose-200",sections:["PC.IV","PC.VI"]},{id:"LCS",label:"Legal, Compliance & Secretariat",shortLabel:"Legal",icon:"scale",color:"amber",bgClass:"bg-amber-50",textClass:"text-amber-700",borderClass:"border-amber-200",sections:["APP.1","APP.2","APP.3","APP.4","APP.5","APP.6"]}],ot=class n{close=new R;onSave=new R;inputData=null;http=T(re);cdr=T(Ne);authService=T(Fe);agentChatComponent;isReadOnly=!1;rightPanelCollapsed=!1;draftSaveError=null;requiredMissingBySection={};requiredTotal=0;requiredFilled=0;requiredMissing=0;focusedFieldKey=null;commentsDrawerOpen=!1;commentsDrawerTitle="";commentsDrawerRef="";commentDraft="";replyToCommentId=null;replyDraft="";activeThread=null;threads=new Map;commentsLoading=!1;commentsError="";activeCommentScope="DRAFT";activeCommentFieldKey=null;draftCommentsCountValue=0;stepperSections=[];activeSectionId="PC.I";expandedSections=new Set(["PC.I"]);fieldMap=new Map;sectionFieldGroups=new Map;signOffGroups=ee;activeAgentId="BIZ";agentChats=new Map;isStreaming=!1;streamingAgent=null;autoSaveTimer=null;lastSavedAt=null;isDirty=!1;isSavingDraft=!1;overallProgress=0;totalFields=0;filledFields=0;statsRecomputeScheduled=!1;npaClassification="New-to-Group";npaLiteExcludedSections=new Set(["PC.III","PC.V","PC.VII","APP.4","APP.5","APP.6"]);validationErrors=[];showValidation=!1;agentPanelTab="CHAT";selectedCitation=null;dirtyFieldKeys=new Set;referenceNpaIds=[];referenceNpaDetails=[];npaSearchResults=[];showRefSearch=!1;refSearchQuery="";Math=Math;ngOnInit(){let t=String(this.authService.currentUser?.role||"").toUpperCase();this.isReadOnly=!(t==="MAKER"||t==="CHECKER")||!this.authService.token,this.inputData?.npaType&&(this.npaClassification=this.inputData.npaType);let e=this.inputData?.referenceNpaIds||[];e.length>0&&(this.referenceNpaIds=[...e],this.loadReferenceNpaDetails()),this.initializeSections(),this.initializeFieldMap(),this.initializeAgentChats(),this.loadExistingFormData(),this.startAutoSave()}ngOnDestroy(){this.autoSaveTimer&&clearInterval(this.autoSaveTimer)}startAutoSave(){this.autoSaveTimer=setInterval(()=>{this.isDirty&&this.autoSaveDraft()},3e4)}autoSaveDraft(){let t=this.inputData?.npaId||this.inputData?.projectId||"draft",e={};this.fieldMap.forEach((o,d)=>{o.value&&o.value.trim()&&(e[d]={value:o.value,lineage:o.lineage})});try{sessionStorage.setItem(`_draft_builder_autosave_${t}`,JSON.stringify(e)),this.lastSavedAt=new Date,console.log(`[DraftBuilder] Auto-saved ${Object.keys(e).length} fields`)}catch{}(this.inputData?.npaId||this.inputData?.projectId||this.inputData?.id||"")&&this.persistFormDataToDb("autosave")}initializeSections(){let t=Ut();this.stepperSections=t.map(e=>{let i=this.getSectionOwner(e.id),o=this.getSectionIcon(e.id),d=this.getTemplateNode(e.id),u=d?bt(d):[];return{id:e.id,numbering:e.numbering,label:e.label,icon:o,fieldCount:u.length,filledCount:0,owner:i,status:"empty",children:d?.children||[]}})}initializeFieldMap(){for(let t of _t){let e={key:t.key,label:t.label,value:"",lineage:"MANUAL",strategy:t.strategy,nodeId:t.nodeId,isStreaming:!1,isEditing:!1,type:this.inferFieldType(t),placeholder:t.placeholder||this.getFieldPlaceholder(t),tooltip:t.ruleSource||t.copySection||t.llmCategory||"",required:t.required??t.strategy!=="MANUAL",options:t.options,dependsOn:t.dependsOn,bulletItems:t.fieldType==="bullet_list"?[""]:void 0,selectedOptions:t.fieldType==="multiselect"||t.fieldType==="checkbox_group"?[]:void 0,yesNoValue:t.fieldType==="yesno"?null:void 0,currencyCode:t.fieldType==="currency"?"SGD":void 0};this.fieldMap.set(t.key,e)}this.totalFields=this.fieldMap.size,this.buildSectionFieldGroups()}buildSectionFieldGroups(){let t=[...Xe.children||[],...Se];for(let e of t){let i=e.id,o=[];if(e.children&&e.children.length>0)for(let d of e.children){let u=this.collectFieldStatesFromNode(d);if(u.length>0||d.children&&d.children.length>0){let g=[...u];if(d.children){for(let C of d.children)if(g.push(...this.collectFieldStatesFromNode(C)),C.children)for(let h of C.children)g.push(...this.collectFieldStatesFromNode(h))}g.length>0&&o.push({topic:d.label,numbering:d.numbering,guidance:d.guidance,fields:g})}}else if(e.fieldKeys&&e.fieldKeys.length>0){let d=e.fieldKeys.map(u=>this.fieldMap.get(u)).filter(u=>!!u);d.length>0&&o.push({topic:e.label,numbering:e.numbering,guidance:e.guidance,fields:d})}this.sectionFieldGroups.set(i,o)}}collectFieldStatesFromNode(t){let e=[];if(t.fieldKeys)for(let i of t.fieldKeys){let o=this.fieldMap.get(i);o&&e.push(o)}if(t.tableFieldMapping)for(let i of t.tableFieldMapping){let o=this.fieldMap.get(i.fieldKey);o&&e.push(o)}return e}initializeAgentChats(){for(let t of ee)this.agentChats.set(t.id,{id:t.id,messages:[{role:"system",content:`${t.label} agent ready. I can help auto-fill and review fields in sections: ${t.sections.join(", ")}.`,timestamp:new Date}],isConnected:!1,isStreaming:!1,streamText:""})}loadExistingFormData(){if(!this.inputData?.npaId&&!this.inputData?.projectId)return;let t=this.inputData.npaId||this.inputData.projectId;this.http.get(`/api/npas/${t}/form-data`).subscribe({next:e=>{e?.length?(this.applyFormDataToFieldMap(e),console.log("[DraftBuilder] Loaded",e.length,"fields from DB")):(console.log("[DraftBuilder] No existing form data \u2014 triggering auto-prefill for",t),this.triggerPrefill(t))},error:e=>console.warn("[DraftBuilder] Could not load form data:",e.message)})}applyFormDataToFieldMap(t){let e=0;for(let i of t){let o=i.field_key,d=i.field_value??i.value??"",u=this.fieldMap.get(o);if(u&&d){u.value=d,u.lineage=i.lineage||"AUTO";let g=i.confidence_score??i.confidence??null,C=g==null||g===""?null:Number(g);u.confidence=Number.isFinite(C)?C:null,u.source=i.metadata?.sourceSnippet||i.source||null,e++}}this.updateProgress(),this.recomputeRequiredStats(),this.cdr.detectChanges()}triggerPrefill(t){this.http.get(`/api/npas/${t}/prefill`).subscribe({next:e=>{let i=e?.filled_fields;if(!i?.length){console.log("[DraftBuilder] Prefill returned 0 fields");return}console.log(`[DraftBuilder] Prefill returned ${i.length} fields`,`(${e.summary?.rule_count||0} RULE, ${e.summary?.copy_count||0} COPY)`,e.similar_npa_id?`from reference NPA: ${e.similar_npa_id}`:""),this.applyFormDataToFieldMap(i),this.http.post(`/api/npas/${t}/prefill/persist`,{filled_fields:i}).subscribe({next:o=>console.log(`[DraftBuilder] Prefill persisted: ${o?.fields_saved||0} fields`),error:o=>console.warn("[DraftBuilder] Prefill persist failed (fields still applied to UI):",o.message)})},error:e=>console.warn("[DraftBuilder] Prefill failed:",e.message)})}loadReferenceNpaDetails(){this.referenceNpaDetails=this.referenceNpaIds.map(t=>({id:t,title:"Loading..."}));for(let t of this.referenceNpaIds)this.http.get(`/api/npas/${t}`).subscribe({next:e=>{let i=this.referenceNpaDetails.findIndex(o=>o.id===t);i>=0&&(this.referenceNpaDetails[i]={id:t,title:e.title||t},this.cdr.detectChanges())},error:()=>{}})}searchNpas(t){if(this.refSearchQuery=t,!t||t.length<2){this.npaSearchResults=[];return}this.http.get("/api/npas").subscribe({next:e=>{let i=t.toLowerCase();this.npaSearchResults=e.filter(o=>!this.referenceNpaIds.includes(o.id)).filter(o=>o.id.toLowerCase().includes(i)||o.title.toLowerCase().includes(i)).slice(0,5).map(o=>({id:o.id,title:o.title,npa_type:o.npa_type})),this.cdr.detectChanges()}})}addReferenceNpa(t){this.referenceNpaIds.includes(t.id)||(this.referenceNpaIds.push(t.id),this.referenceNpaDetails.push({id:t.id,title:t.title}),this.npaSearchResults=[],this.refSearchQuery="",this.showRefSearch=!1,this.persistReferenceNpaIds(),this.retriggerPrefillWithRefs())}removeReferenceNpa(t){this.referenceNpaIds=this.referenceNpaIds.filter(e=>e!==t),this.referenceNpaDetails=this.referenceNpaDetails.filter(e=>e.id!==t),this.persistReferenceNpaIds()}persistReferenceNpaIds(){let t=this.inputData?.npaId||this.inputData?.projectId||"";t&&this.http.put(`/api/npas/${t}`,{reference_npa_ids:this.referenceNpaIds}).subscribe({next:()=>console.log("[DraftBuilder] Reference NPAs saved:",this.referenceNpaIds),error:e=>console.warn("[DraftBuilder] Failed to save reference NPAs:",e.message)})}retriggerPrefillWithRefs(){let t=this.inputData?.npaId||this.inputData?.projectId||"";if(!t||this.referenceNpaIds.length===0)return;let e=`?similar_npa_ids=${encodeURIComponent(this.referenceNpaIds.join(","))}`;this.http.get(`/api/npas/${t}/prefill${e}`).subscribe({next:i=>{let o=i?.filled_fields?.filter(d=>d.strategy==="COPY");o?.length&&(console.log(`[DraftBuilder] Re-prefill ${o.length} COPY fields from ${this.referenceNpaIds.length} refs`),this.applyFormDataToFieldMap(o),this.http.post(`/api/npas/${t}/prefill/persist`,{filled_fields:o}).subscribe({next:()=>console.log("[DraftBuilder] Updated COPY fields persisted"),error:()=>{}}))}})}onFieldEdited(t){this.isDirty=!0,this.focusedFieldKey=t.key,this.dirtyFieldKeys.add(t.key),t.value&&t.value.trim()!==""&&(t.validationError=void 0),this.scheduleStatsRecompute()}onFieldCleared(t){this.isDirty=!0,this.dirtyFieldKeys.add(t.key),this.scheduleStatsRecompute()}askAgentAboutField(t){this.focusedFieldKey=t.key;let e=t.nodeId?.split(".").slice(0,2).join(".")||"",i=this.getSectionOwner(e);this.activeAgentId=i,this.agentPanelTab="CHAT",this.cdr.detectChanges(),setTimeout(()=>this.agentChatComponent?.askAboutField(t),0)}onApplyFieldSuggestion(t){let e=this.fieldMap.get(t.fieldKey);if(e){if(this.focusedFieldKey=e.key,(t?.format||"text")==="bullets"&&e.type==="bullet_list"){let o=this.parseBulletItems(t.value);e.bulletItems=o.length?o:[""];let d=(e.bulletItems||[]).filter(u=>String(u||"").trim()).join(`
\u2022 `);e.value=d?`\u2022 ${d}`:""}else if(e.value=t.value,e.type==="bullet_list"){let o=this.parseBulletItems(t.value);if(o.length){e.bulletItems=o;let d=o.filter(u=>String(u||"").trim()).join(`
\u2022 `);e.value=d?`\u2022 ${d}`:e.value}}e.lineage="ADAPTED",e.confidence=t.confidence,e.validationError=void 0,this.isDirty=!0,this.dirtyFieldKeys.add(e.key),this.scheduleStatsRecompute(),this.persistFormDataToDb("autosave"),console.log(`[DraftBuilder] Applied suggestion for ${t.fieldKey}`)}else console.warn(`[DraftBuilder] Unknown field key in suggestion: ${t.fieldKey}`)}scheduleStatsRecompute(){this.statsRecomputeScheduled||(this.statsRecomputeScheduled=!0,setTimeout(()=>{this.statsRecomputeScheduled=!1,this.updateProgress(),this.recomputeRequiredStats(),this.cdr.detectChanges()},100))}parseBulletItems(t){let e=String(t||"").trim();if(!e)return[];let i=e.split(/\r?\n/).map(d=>d.trim()).filter(Boolean),o=[];for(let d of i){let u=d.replace(/^([*-]|\d+[\.\)])\s+/,"").replace(/^\u2022\s+/,"").trim();if(u&&(o.push(u),o.length>=60))break}if(o.length<=1&&e.length>120&&e.includes(";")){let d=e.split(";").map(u=>u.trim()).filter(Boolean);if(d.length>1)return d.slice(0,60)}return o}onCitationClick(t){this.selectedCitation=t,this.agentPanelTab="KNOWLEDGE",console.log(`[DraftBuilder] Viewing citation: ${t.sourceName}`)}selectSection(t){this.activeSectionId=t,this.expandedSections.has(t)||this.expandedSections.add(t);let e=this.getSectionOwner(t);e!==this.activeAgentId&&(this.activeAgentId=e)}selectAgent(t){this.activeAgentId=t}navigateNext(){let t=this.stepperSections.findIndex(e=>e.id===this.activeSectionId);t<this.stepperSections.length-1&&this.selectSection(this.stepperSections[t+1].id)}navigatePrev(){let t=this.stepperSections.findIndex(e=>e.id===this.activeSectionId);t>0&&this.selectSection(this.stepperSections[t-1].id)}nowLabel(){return new Date().toLocaleString()}ensureThread(t,e,i){let o=this.threads.get(t);if(o)return o;let d={key:t,title:e,ref:i,comments:[]};return this.threads.set(t,d),d}draftCommentCount(){return this.draftCommentsCountValue}openCommentsForDraft(){let t=this.inputData?.npaId||this.inputData?.projectId||this.inputData?.id||"",e="Draft Comments",i=t?`Draft: ${t}`:"Draft",o=`draft:${String(t||"unknown")}`;this.activeCommentScope="DRAFT",this.activeCommentFieldKey=null,this.activeThread=this.ensureThread(o,e,i),this.commentsDrawerTitle=e,this.commentsDrawerRef=i,this.commentDraft="",this.replyToCommentId=null,this.replyDraft="",this.commentsDrawerOpen=!0,this.loadCommentsFromDb("DRAFT",null,o,e,i)}openCommentsForField(t){let e=t.key||t.nodeId||t.label||"field",i=`${t.label||"Field"} \u2014 Comments`,o=`Field: ${t.label||""} \xB7 ${e}`,d=`field:${String(e)}`;this.activeCommentScope="FIELD",this.activeCommentFieldKey=t.key||null,this.activeThread=this.ensureThread(d,i,o),this.commentsDrawerTitle=i,this.commentsDrawerRef=o,this.commentDraft="",this.replyToCommentId=null,this.replyDraft="",this.commentsDrawerOpen=!0,this.loadCommentsFromDb("FIELD",this.activeCommentFieldKey,d,i,o)}closeCommentsDrawer(){this.commentsDrawerOpen=!1,this.commentDraft="",this.replyToCommentId=null,this.replyDraft="",this.activeThread=null,this.commentsLoading=!1,this.commentsError=""}postComment(){if(!this.activeThread)return;let t=String(this.commentDraft||"").trim();if(!t)return;let e=this.inputData?.npaId||this.inputData?.projectId||this.inputData?.id||"";if(!e){let i=this.authService.currentUser?.display_name||this.authService.currentUser?.full_name||"User";this.activeThread.comments.push({id:Date.now(),author:i,when:this.nowLabel(),text:t,replies:[]}),this.commentDraft="";return}this.commentsError="",this.commentsLoading=!0,this.http.post(`/api/npas/${encodeURIComponent(e)}/comments`,{scope:this.activeCommentScope,field_key:this.activeCommentScope==="FIELD"?this.activeCommentFieldKey:null,text:t}).subscribe({next:()=>{this.commentDraft="";let i=this.activeThread?.key||`draft:${e}`;this.loadCommentsFromDb(this.activeCommentScope,this.activeCommentFieldKey,i,this.commentsDrawerTitle,this.commentsDrawerRef)},error:i=>{this.commentsLoading=!1,this.commentsError=i?.error?.error||i?.message||"Failed to post comment"}})}startReply(t){this.replyToCommentId=t,this.replyDraft=""}cancelReply(){this.replyToCommentId=null,this.replyDraft=""}postReply(){if(!this.activeThread||!this.replyToCommentId)return;let t=String(this.replyDraft||"").trim();if(!t)return;let e=this.inputData?.npaId||this.inputData?.projectId||this.inputData?.id||"";if(!e){let i=this.activeThread.comments.find(d=>d.id===this.replyToCommentId);if(!i)return;let o=this.authService.currentUser?.display_name||this.authService.currentUser?.full_name||"User";i.replies.push({id:Date.now(),author:o,when:this.nowLabel(),text:t}),this.replyToCommentId=null,this.replyDraft="";return}this.commentsError="",this.commentsLoading=!0,this.http.post(`/api/npas/${encodeURIComponent(e)}/comments`,{scope:this.activeCommentScope,field_key:this.activeCommentScope==="FIELD"?this.activeCommentFieldKey:null,text:t,parent_id:this.replyToCommentId}).subscribe({next:()=>{this.replyToCommentId=null,this.replyDraft="";let i=this.activeThread?.key||`draft:${e}`;this.loadCommentsFromDb(this.activeCommentScope,this.activeCommentFieldKey,i,this.commentsDrawerTitle,this.commentsDrawerRef)},error:i=>{this.commentsLoading=!1,this.commentsError=i?.error?.error||i?.message||"Failed to post reply"}})}trackByCommentId(t,e){return String(e.id)}trackByReplyId(t,e){return String(e.id)}loadCommentsFromDb(t,e,i,o,d){let u=this.inputData?.npaId||this.inputData?.projectId||this.inputData?.id||"";if(!u)return;this.commentsLoading=!0,this.commentsError="";let g={scope:t};e&&(g.field_key=e),this.http.get(`/api/npas/${encodeURIComponent(u)}/comments`,{params:g}).subscribe({next:C=>{let h=this.buildThreadFromRows(C||[],i,o,d);this.threads.set(i,h),this.activeThread=h,t==="DRAFT"&&(this.draftCommentsCountValue=h.comments.length),this.commentsLoading=!1,this.cdr.detectChanges()},error:C=>{this.commentsLoading=!1,this.commentsError=C?.error?.error||C?.message||"Failed to load comments"}})}buildThreadFromRows(t,e,i,o){let d={key:e,title:i,ref:o,comments:[]},u=new Map;for(let g of t)if((g.parent_comment_id===void 0?null:g.parent_comment_id)===null){let h={id:Number(g.id),author:g.author_name||"User",when:g.created_at?new Date(g.created_at).toLocaleString():this.nowLabel(),text:g.comment_text||"",replies:[]};u.set(h.id,h),d.comments.push(h)}for(let g of t){let C=g.parent_comment_id===void 0?null:g.parent_comment_id;if(C===null)continue;let h=u.get(Number(C));h&&h.replies.push({id:Number(g.id),author:g.author_name||"User",when:g.created_at?new Date(g.created_at).toLocaleString():this.nowLabel(),text:g.comment_text||""})}return d}updateProgress(){let t=0,e=0;this.fieldMap.forEach(i=>{let o=i.nodeId?.split(".").slice(0,2).join(".")||"";this.isSectionApplicable(o)&&(e++,i.value&&i.value.trim()!==""&&t++)}),this.totalFields=e,this.filledFields=t,this.overallProgress=e>0?Math.round(t/e*100):0;for(let i of this.stepperSections){let d=(this.sectionFieldGroups.get(i.id)||[]).flatMap(u=>u.fields);i.fieldCount=d.length,i.filledCount=d.filter(u=>u.value&&u.value.trim()!=="").length,i.status=this.isSectionApplicable(i.id)?i.filledCount===0?"empty":i.filledCount>=i.fieldCount?"complete":"partial":"complete"}}updateSectionProgress(t){let e=Ze.get(t);if(!e?.nodeId)return;let i=e.nodeId.split(".").slice(0,2).join("."),o=this.stepperSections.find(d=>d.id===i);if(o){let u=(this.sectionFieldGroups.get(o.id)||[]).flatMap(g=>g.fields);o.filledCount=u.filter(g=>g.value&&g.value.trim()!=="").length,o.status=o.filledCount===0?"empty":o.filledCount>=o.fieldCount?"complete":"partial"}this.updateProgress()}getActiveSection(){return this.stepperSections.find(t=>t.id===this.activeSectionId)}getActiveSectionGroups(){return this.sectionFieldGroups.get(this.activeSectionId)||[]}getGroupForSection(t){let e=this.getSectionOwner(t);return ee.find(i=>i.id===e)||ee[0]}getSectionOwner(t){for(let e of ee)if(e.sections.includes(t))return e.id;return t.startsWith("APP")?"LCS":"BIZ"}shouldShowField(t){if(!t.dependsOn)return!0;let e=this.fieldMap.get(t.dependsOn.field);return e?e.value===t.dependsOn.value:!0}isSectionApplicable(t){return this.npaClassification!=="NPA Lite"?!0:!this.npaLiteExcludedSections.has(t)}setClassification(t){this.npaClassification=t,this.updateProgress()}validateDraft(){return this.validationErrors=[],this.fieldMap.forEach(t=>{t.validationError=void 0}),this.fieldMap.forEach((t,e)=>{if(t.required&&this.isSectionApplicable(t.nodeId?.split(".").slice(0,2).join(".")||"")&&(!t.value||t.value.trim()==="")){let i=t.nodeId?.split(".").slice(0,2).join(".")||"Unknown";t.validationError="This field is required",this.validationErrors.push({field:e,label:t.label,section:i})}}),this.showValidation=this.validationErrors.length>0,this.recomputeRequiredStats(),this.validationErrors.length===0}goToValidationError(t){this.selectSection(t.section),this.showValidation=!1}dismissValidation(){this.showValidation=!1}openIssuesPanel(){this.agentPanelTab="ISSUES",this.recomputeRequiredStats(),this.rightPanelCollapsed&&(this.rightPanelCollapsed=!1)}goToNextMissingRequired(){let t=this.validationErrors?.[0];t&&this.jumpToField(t.field,t.section)}jumpToField(t,e){e&&this.selectSection(e),this.focusedFieldKey=t,setTimeout(()=>{let i=document.getElementById(`field_${t}`);i&&i.scrollIntoView({behavior:"smooth",block:"center"})},0)}recomputeRequiredStats(){let t={},e=0,i=0,o=0;if(this.fieldMap.forEach(d=>{if(!d.required)return;let u=d.nodeId?.split(".").slice(0,2).join(".")||"";if(!this.isSectionApplicable(u))return;i++;let g=!!(d.value&&String(d.value).trim());g&&o++,g||(e++,t[u]=(t[u]||0)+1)}),this.validationErrors?.length){let d={};for(let u of this.validationErrors)d[u.section]=(d[u.section]||0)+1;this.requiredMissingBySection=d}else this.requiredMissingBySection=t;this.requiredTotal=i,this.requiredFilled=o,this.requiredMissing=e}requiredProgressPercent(){return this.requiredTotal?Math.round(this.requiredFilled/this.requiredTotal*100):0}saveDraft(t=!1){t||this.validateDraft(),!this.isReadOnly&&this.persistFormDataToDb("manual",()=>{let e=[];this.fieldMap.forEach((i,o)=>{this.isSectionApplicable(i.nodeId?.split(".").slice(0,2).join(".")||"")&&e.push({field_key:o,field_value:i.value||"",lineage:i.lineage,confidence_score:i.confidence??null,metadata:{sourceSnippet:i.source,strategy:i.strategy,fieldType:i.type}})}),this.onSave.emit({fields:e,classification:this.npaClassification,validationErrors:this.validationErrors.length,progress:this.overallProgress})})}persistFormDataToDb(t,e){let i=this.inputData?.npaId||this.inputData?.projectId||this.inputData?.id||"";if(!i)return;if(!this.authService.token){this.draftSaveError="Not authenticated. Please re-login to save changes.",this.isDirty=!0;return}let o=[],d=Array.from(this.dirtyFieldKeys);for(let g of d){let C=this.fieldMap.get(g);if(!C||!this.isSectionApplicable(C.nodeId?.split(".").slice(0,2).join(".")||""))continue;let h=C.confidence,S=h==null||h===""?null:Number(h);o.push({field_key:g,value:C.value??"",lineage:C.lineage||"MANUAL",confidence:Number.isFinite(S)?S:null,source:C.source||null,strategy:C.strategy||"MANUAL"})}if(o.length===0||this.isSavingDraft)return;this.isSavingDraft=!0,this.draftSaveError=null;let u=new Set(o.map(g=>String(g.field_key)));this.http.post(`/api/npas/${encodeURIComponent(i)}/form-data`,{filled_fields:o}).subscribe({next:()=>{this.lastSavedAt=new Date;for(let g of u)this.dirtyFieldKeys.delete(g);this.isDirty=this.dirtyFieldKeys.size>0,this.isSavingDraft=!1,this.draftSaveError=null,t==="manual"&&console.log("[DraftBuilder] Saved to DB:",i),e?.(),this.cdr.detectChanges()},error:g=>{if(this.isSavingDraft=!1,Number(g?.status||0)===401)this.draftSaveError="Session expired. Please log in again to save.";else{let h=g?.error?.error||g?.message||"Failed to save draft to DB",S=Array.isArray(g?.error?.details)?g.error.details:null;if(S?.length){let P=S[0];this.draftSaveError=`${h}: ${String(P.path||"field")} \u2014 ${String(P.message||"")}`}else this.draftSaveError=h}this.isDirty=!0,console.warn("[DraftBuilder] Failed to persist form data:",this.draftSaveError,g?.error?.details||""),this.cdr.detectChanges()}})}getSectionIcon(t){return{"PC.I":"package","PC.II":"settings","PC.III":"calculator","PC.IV":"shield-alert","PC.V":"database","PC.VI":"alert-triangle","PC.VII":"bar-chart-2","APP.1":"building","APP.2":"key","APP.3":"shield","APP.4":"pie-chart","APP.5":"trending-up","APP.6":"globe"}[t]||"file-text"}getTemplateNode(t){return t.startsWith("PC.")?Xe.children?.find(e=>e.id===t):Se.find(e=>e.id===t)}inferFieldType(t){return t.fieldType?t.fieldType:t.key.includes("date")||t.key.includes("_at")?"date":t.key.includes("amount")||t.key.includes("revenue")||t.key.includes("roi")?"currency":t.strategy==="LLM"?"textarea":t.key.startsWith("mrf_")?"dropdown":"text"}getFieldPlaceholder(t){return t.strategy==="RULE"?"Auto-populated from system":t.strategy==="COPY"?"Copied from similar NPA":t.strategy==="LLM"?"AI-generated content":"Enter value manually"}trackByFieldKey(t,e){return e.key}trackByGroupTopic(t,e){return e.topic}trackBySectionId(t,e){return e.id}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=E({type:n,selectors:[["app-npa-draft-builder"]],viewQuery:function(e,i){if(e&1&&ge(Fn,5),e&2){let o;fe(o=_e())&&(i.agentChatComponent=o.first)}},inputs:{inputData:"inputData"},outputs:{close:"close",onSave:"onSave"},decls:62,vars:45,consts:[["agentChat",""],[1,"fixed","inset-0","z-[110]","flex","flex-col","h-screen","w-screen","bg-slate-50","overscroll-none","font-sans"],[1,"flex-none","bg-white","border-b","border-slate-200","px-4","py-2","flex","items-center","justify-between","z-20"],[1,"flex","items-center","gap-3","min-w-0"],[1,"flex","items-center","justify-center","w-9","h-9","rounded-full","border","border-slate-200","bg-white","hover:bg-slate-50","text-slate-500","hover:text-slate-900","transition-all",3,"click"],["name","arrow-left",1,"w-5","h-5","stroke-[1.5]"],[1,"min-w-0"],[1,"flex","items-center","gap-2"],[1,"text-sm","font-bold","text-slate-900","leading-tight","truncate"],[1,"px-2","py-0.5","rounded-full","text-[10px]","font-bold","border"],[1,"text-[11px]","text-slate-400","font-medium","truncate"],[1,"flex","items-center","gap-4","flex-none"],[1,"hidden","md:flex","items-center","gap-2"],[1,"w-44","h-2","bg-slate-100","rounded-full","overflow-hidden"],[1,"h-full","bg-emerald-500","rounded-full","transition-all"],[1,"text-xs","font-bold","tabular-nums","text-slate-700"],[1,"text-[10px]","text-slate-400","font-mono"],[1,"w-40","h-2","bg-slate-100","rounded-full","overflow-hidden"],[1,"h-full","rounded-full","transition-all"],[1,"px-3","py-2","text-xs","font-semibold","text-slate-700","hover:bg-slate-50","rounded-lg","transition-colors","border","border-slate-200","flex","items-center","gap-1.5",3,"click"],["name","message-square",1,"w-3.5","h-3.5"],["class","ml-1 px-1.5 py-0.5 rounded-full text-[10px] font-bold bg-slate-100 text-slate-600",4,"ngIf"],["class","hidden md:flex items-center gap-2 px-3 py-2 rounded-lg border border-rose-200 bg-rose-50 text-rose-700 text-xs font-semibold max-w-[320px]",4,"ngIf"],[1,"px-3.5","py-2","text-xs","font-bold","text-white","bg-blue-600","hover:bg-blue-700","rounded-lg","shadow-sm","transition-colors","disabled:opacity-50","disabled:hover:bg-blue-600","disabled:cursor-not-allowed",3,"click","disabled"],[1,"flex-1","overflow-hidden","flex","gap-4","p-4"],[1,"w-72","flex-none","bg-white","border","border-slate-200","rounded-xl","flex","flex-col","overflow-hidden"],[3,"sectionSelected","sections","activeSectionId","filledFields","totalFields","overallProgress","requiredMissingBySection"],[1,"flex-1","flex","flex-col","overflow-hidden","bg-white","border","border-slate-200","rounded-xl"],["class","flex-none px-6 py-4 bg-white border-b border-slate-200 flex items-center justify-between rounded-t-xl",4,"ngIf"],[1,"flex-1","overflow-y-auto","px-6","py-5","npa-scrollbar"],[1,"max-w-4xl","2xl:max-w-5xl","mx-auto","space-y-6"],["class","text-center py-16",4,"ngIf"],["class","bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden",4,"ngFor","ngForOf","ngForTrackBy"],[1,"flex","items-center","justify-between","pt-4","pb-8"],[1,"px-4","py-2","text-xs","font-semibold","text-slate-500","hover:text-slate-700","hover:bg-white","rounded-lg","border","border-slate-200","transition-colors","flex","items-center","gap-1.5","disabled:opacity-30",3,"click","disabled"],["name","arrow-left",1,"w-3.5","h-3.5"],[1,"px-4","py-2","text-xs","font-semibold","text-white","bg-blue-600","hover:bg-blue-700","rounded-lg","shadow-sm","transition-colors","flex","items-center","gap-1.5","disabled:opacity-30",3,"click","disabled"],["name","arrow-right",1,"w-3.5","h-3.5"],[1,"flex-none","bg-white","border","border-slate-200","rounded-xl","flex","flex-col","overflow-hidden","transition-[width]","duration-200"],[1,"flex-none","flex","items-center","justify-between","px-2","py-2","border-b","border-slate-200","bg-slate-50/50"],[1,"p-2","rounded-lg","hover:bg-slate-100","text-slate-600","transition-colors",3,"click","title"],["name","menu",1,"w-4","h-4"],["class","text-[11px] font-bold text-slate-700",4,"ngIf"],["class","w-8",4,"ngIf"],["class","flex-none flex items-center p-1.5 bg-slate-50 border-b border-slate-200",4,"ngIf"],["class","flex-1 flex flex-col min-h-0",3,"signOffGroups","activeAgentId","agentChats","sectionFieldGroups","inputData","agentSelected","validateRequested","applySuggestion",4,"ngIf"],["class","flex-1 flex flex-col min-h-0 bg-slate-50/30 relative",4,"ngIf"],["class","flex-1 flex flex-col min-h-0 bg-white",4,"ngIf"],["class","fixed inset-0 z-[220]",4,"ngIf"],[1,"ml-1","px-1.5","py-0.5","rounded-full","text-[10px]","font-bold","bg-slate-100","text-slate-600"],[1,"hidden","md:flex","items-center","gap-2","px-3","py-2","rounded-lg","border","border-rose-200","bg-rose-50","text-rose-700","text-xs","font-semibold","max-w-[320px]"],["name","alert-circle",1,"w-4","h-4","flex-none"],[1,"truncate"],[1,"flex-none","px-6","py-4","bg-white","border-b","border-slate-200","flex","items-center","justify-between","rounded-t-xl"],[1,"flex","items-center","gap-3"],[1,"p-2","rounded-lg","border"],[1,"w-5","h-5",3,"name"],[1,"text-xs","font-bold","text-slate-400","font-mono"],[1,"inline-flex","items-center","gap-1","px-1.5","py-0.5","rounded","text-[9px]","font-semibold","uppercase","tracking-wider"],[1,"w-2.5","h-2.5",3,"name"],["class","inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-red-50 text-red-700 border border-red-200 text-[10px] font-bold",4,"ngIf"],[1,"text-base","font-bold","text-slate-900","mt-0.5"],[1,"text-[11px]","text-slate-500","mt-0.5"],[1,"hidden","md:inline-flex","items-center","gap-1.5","px-3","py-2","rounded-lg","border","border-slate-200","bg-white","hover:bg-slate-50","text-xs","font-semibold","text-slate-700","transition-colors","disabled:opacity-40",3,"click","disabled"],[1,"hidden","md:inline-flex","items-center","gap-1.5","px-3","py-2","rounded-lg","border","border-slate-200","bg-white","hover:bg-slate-50","text-xs","font-semibold","text-slate-700","transition-colors",3,"click"],["class","ml-1 px-1.5 py-0.5 rounded-full bg-red-50 text-red-700 border border-red-200 text-[10px] font-bold",4,"ngIf"],[1,"text-xs","text-slate-400","font-mono","ml-2"],[1,"p-1.5","rounded-lg","hover:bg-slate-100","text-slate-400","hover:text-slate-700","transition-colors","disabled:opacity-30",3,"click","disabled"],["name","chevron-left",1,"w-4","h-4"],["name","chevron-right",1,"w-4","h-4"],[1,"inline-flex","items-center","gap-1","px-2","py-0.5","rounded-full","bg-red-50","text-red-700","border","border-red-200","text-[10px]","font-bold"],[1,"ml-1","px-1.5","py-0.5","rounded-full","bg-red-50","text-red-700","border","border-red-200","text-[10px]","font-bold"],[1,"text-center","py-16"],[1,"w-14","h-14","rounded-full","bg-slate-100","flex","items-center","justify-center","mx-auto","mb-4"],["name","inbox",1,"w-7","h-7","text-slate-300"],[1,"text-sm","font-medium","text-slate-500"],[1,"text-xs","text-slate-400","mt-1"],[1,"bg-white","rounded-lg","border","border-slate-200","shadow-sm","overflow-hidden"],[1,"px-5","py-3","bg-slate-50/70","border-b","border-slate-100","flex","items-center","justify-between"],[1,"text-xs","font-bold","text-slate-400","font-mono","w-5"],[1,"text-sm","font-semibold","text-slate-800"],[1,"text-[10px]","font-mono","text-slate-400"],["class","px-5 py-2.5 bg-blue-50/50 border-b border-blue-100/50",4,"ngIf"],[1,"divide-y","divide-slate-100"],[4,"ngFor","ngForOf","ngForTrackBy"],[1,"px-5","py-2.5","bg-blue-50/50","border-b","border-blue-100/50"],[1,"text-[11px]","text-blue-700/80","italic","leading-relaxed","flex","items-start","gap-1.5"],["name","info",1,"w-3","h-3","mt-0.5","flex-none","text-blue-500/60"],["class","px-5 py-4 hover:bg-slate-50/50 transition-colors group/field",3,"id",4,"ngIf"],[1,"px-5","py-4","hover:bg-slate-50/50","transition-colors","group/field",3,"id"],[3,"fieldEdited","fieldCleared","askAgent","citationClick","commentClicked","field","readOnly"],[1,"text-[11px]","font-bold","text-slate-700"],[1,"w-8"],[1,"flex-none","flex","items-center","p-1.5","bg-slate-50","border-b","border-slate-200"],[1,"flex-1","flex","items-center","justify-center","gap-2","py-1.5","px-3","rounded-md","text-xs","font-semibold","transition-colors",3,"click"],["name","book-open",1,"w-3.5","h-3.5"],["name","alert-circle",1,"w-3.5","h-3.5"],["class","ml-1 px-1.5 py-0.5 rounded-full bg-rose-50 text-rose-700 border border-rose-200 text-[10px] font-bold",4,"ngIf"],[1,"ml-1","px-1.5","py-0.5","rounded-full","bg-rose-50","text-rose-700","border","border-rose-200","text-[10px]","font-bold"],[1,"flex-1","flex","flex-col","min-h-0",3,"agentSelected","validateRequested","applySuggestion","signOffGroups","activeAgentId","agentChats","sectionFieldGroups","inputData"],[1,"flex-1","flex","flex-col","min-h-0","bg-slate-50/30","relative"],["class","flex-1 flex flex-col min-h-0",4,"ngIf"],["class","absolute inset-0 flex flex-col items-center justify-center p-6 text-center",4,"ngIf"],[1,"flex-1","flex","flex-col","min-h-0"],[1,"px-4","py-3","bg-blue-50/80","border-b","border-blue-100/50","flex","items-start","gap-3","flex-none"],[1,"p-1.5","bg-blue-100","text-blue-600","rounded","mt-0.5","border","border-blue-200","shadow-sm","flex-none"],["name","book-open",1,"w-4","h-4"],[1,"text-xs","font-bold","text-slate-800","mb-0.5","leading-tight"],[1,"text-[9px]","font-mono","text-slate-400","bg-white","border","border-slate-200","px-1.5","py-0.5","rounded","uppercase","tracking-wide"],[1,"flex-1","overflow-y-auto","p-4","space-y-4"],[1,"px-3","py-2","bg-white","rounded-lg","border","border-slate-200","shadow-sm"],[1,"text-[10px]","uppercase","font-bold","text-slate-400","tracking-wider","mb-2","flex","items-center","gap-1.5"],["name","align-left",1,"w-3","h-3"],[1,"text-[11px]","leading-relaxed","text-slate-700","italic","border-l-2","border-amber-300","pl-3","py-0.5","my-1"],["class","p-3 bg-white rounded-lg border border-slate-200 flex items-center justify-between",4,"ngIf"],[1,"p-3","bg-white","rounded-lg","border","border-slate-200","flex","items-center","justify-between"],[1,"text-[11px]","font-medium","text-slate-600"],["target","_blank","rel","noopener noreferrer",1,"flex","items-center","gap-1.5","px-2.5","py-1.5","bg-slate-100","hover:bg-blue-50","text-blue-600","text-[10px]","font-bold","rounded","transition-colors","group",3,"href"],["name","external-link",1,"w-3","h-3","group-hover:text-blue-700"],[1,"absolute","inset-0","flex","flex-col","items-center","justify-center","p-6","text-center"],[1,"w-12","h-12","bg-white","border","border-slate-200","rounded-xl","flex","items-center","justify-center","mb-3","shadow-sm"],["name","library",1,"w-6","h-6","text-slate-300"],[1,"text-[11px]","font-bold","text-slate-700","mb-1"],[1,"text-[10px]","text-slate-400","leading-relaxed","max-w-[200px]"],[1,"flex-1","flex","flex-col","min-h-0","bg-white"],[1,"px-4","py-3","border-b","border-slate-200","bg-slate-50/50"],[1,"text-xs","font-bold","text-slate-800"],[1,"mt-1","text-[11px]","text-slate-500"],[1,"flex-1","overflow-y-auto","p-4","space-y-3","npa-scrollbar"],[1,"grid","grid-cols-2","gap-2"],[1,"p-3","rounded-lg","border","border-slate-200","bg-white"],[1,"text-[10px]","uppercase","tracking-wider","font-bold","text-slate-400"],[1,"text-xl","font-bold","text-rose-600","mt-1"],[1,"text-xl","font-bold","text-slate-800","mt-1"],["class","p-3 rounded-lg border border-emerald-200 bg-emerald-50 text-emerald-700 text-[11px] font-semibold",4,"ngIf"],["class","p-3 rounded-lg border border-rose-200 bg-rose-50",4,"ngFor","ngForOf"],[1,"p-3","rounded-lg","border","border-emerald-200","bg-emerald-50","text-emerald-700","text-[11px]","font-semibold"],[1,"p-3","rounded-lg","border","border-rose-200","bg-rose-50"],[1,"flex","items-center","justify-between","gap-2"],[1,"text-[11px]","font-bold","text-rose-800","truncate"],[1,"text-[10px]","text-rose-700","font-mono"],[1,"px-3","py-1.5","rounded-lg","bg-white","border","border-rose-200","text-rose-700","text-[11px]","font-bold","hover:bg-rose-100","transition-colors",3,"click"],[1,"fixed","inset-0","z-[220]"],[1,"absolute","inset-0","bg-slate-900/40",3,"click"],[1,"absolute","right-0","top-0","h-full","w-full","max-w-xl","bg-white","border-l","border-slate-200","shadow-2xl","flex","flex-col"],[1,"px-5","py-4","border-b","border-slate-100","flex","items-start","justify-between","gap-3"],[1,"text-[10px]","text-slate-500","font-semibold","uppercase","tracking-wider"],[1,"text-sm","font-bold","text-slate-900","truncate"],["class","mt-1 text-[10px] text-slate-400 font-mono truncate",4,"ngIf"],[1,"p-2","rounded-lg","hover:bg-slate-100","text-slate-600","flex-none",3,"click"],["name","x",1,"w-5","h-5"],[1,"flex-1","min-h-0","overflow-y-auto","p-5","space-y-3","npa-scrollbar"],["class","px-3 py-2 text-[11px] text-slate-500 bg-slate-50 border border-slate-200 rounded-lg",4,"ngIf"],["class","px-3 py-2 text-[11px] text-rose-700 bg-rose-50 border border-rose-200 rounded-lg",4,"ngIf"],["class","bg-white border border-slate-200 rounded-lg p-4 shadow-sm",4,"ngFor","ngForOf","ngForTrackBy"],[1,"px-4","py-3","bg-slate-50","border","border-dashed","border-slate-200","rounded-lg","text-[11px]","text-slate-500"],[1,"px-5","py-4","border-t","border-slate-100","bg-white"],[1,"block","text-xs","font-semibold","text-slate-600","mb-2"],["rows","2","placeholder","Write a comment\u2026",1,"w-full","px-3","py-2","text-sm","rounded-lg","border","border-slate-200","bg-white","outline-none","focus:border-blue-300","focus:ring-2","focus:ring-blue-500/20","resize-none",3,"ngModelChange","ngModel"],[1,"mt-3","flex","items-center","justify-end","gap-2"],[1,"px-3.5","py-2","text-xs","font-semibold","text-white","bg-blue-600","hover:bg-blue-700","rounded-lg","shadow-sm","transition-colors","flex","items-center","gap-1.5",3,"click","disabled"],["name","send",1,"w-3.5","h-3.5"],[1,"mt-1","text-[10px]","text-slate-400","font-mono","truncate"],[1,"px-3","py-2","text-[11px]","text-slate-500","bg-slate-50","border","border-slate-200","rounded-lg"],[1,"px-3","py-2","text-[11px]","text-rose-700","bg-rose-50","border","border-rose-200","rounded-lg"],[1,"bg-white","border","border-slate-200","rounded-lg","p-4","shadow-sm"],[1,"flex","items-center","justify-between","gap-3"],[1,"text-xs","font-semibold","text-slate-800","truncate"],[1,"mt-2","text-[12px]","text-slate-700","leading-relaxed","whitespace-pre-wrap"],["class","mt-3 space-y-2",4,"ngIf"],[1,"px-2.5","py-1.5","text-[11px]","font-semibold","text-slate-600","hover:bg-slate-50","rounded-lg","border","border-slate-200","transition-colors",3,"click"],["class","mt-3",4,"ngIf"],[1,"mt-3","space-y-2"],["class","pl-3 border-l border-slate-200",4,"ngFor","ngForOf","ngForTrackBy"],[1,"pl-3","border-l","border-slate-200"],[1,"text-[11px]","font-semibold","text-slate-700","truncate"],[1,"mt-1","text-[12px]","text-slate-700","leading-relaxed","whitespace-pre-wrap"],[1,"mt-3"],["rows","2","placeholder","Write a reply\u2026",1,"w-full","px-3","py-2","text-sm","rounded-lg","border","border-slate-200","bg-white","outline-none","focus:border-blue-300","focus:ring-2","focus:ring-blue-500/20","resize-none",3,"ngModelChange","ngModel"],[1,"mt-2","flex","items-center","justify-end","gap-2"],[1,"px-3","py-1.5","text-xs","font-semibold","text-slate-600","hover:bg-slate-50","rounded-lg","border","border-slate-200","transition-colors",3,"click"],[1,"px-3","py-1.5","text-xs","font-semibold","text-white","bg-blue-600","hover:bg-blue-700","rounded-lg","shadow-sm","transition-colors",3,"click","disabled"]],template:function(e,i){e&1&&(r(0,"div",1)(1,"div",2)(2,"div",3)(3,"button",4),y("click",function(){return i.close.emit()}),m(4,"lucide-icon",5),a(),r(5,"div",6)(6,"div",7)(7,"h1",8),l(8,"NPA Draft Builder"),a(),r(9,"span",9),l(10),a()(),r(11,"p",10),l(12),a()()(),r(13,"div",11)(14,"div",12)(15,"div",13),m(16,"div",14),a(),r(17,"span",15),l(18),a(),r(19,"span",16),l(20),a()(),r(21,"div",7)(22,"div",17),m(23,"div",18),a(),r(24,"span",15),l(25),a(),r(26,"span",16),l(27),a()(),r(28,"button",19),y("click",function(){return i.openCommentsForDraft()}),m(29,"lucide-icon",20),l(30," Comments "),f(31,Bn,2,1,"span",21),a(),f(32,Gn,4,1,"div",22),r(33,"button",23),y("click",function(){return i.saveDraft()}),l(34),a()()(),r(35,"div",24)(36,"div",25)(37,"app-npa-section-stepper",26),y("sectionSelected",function(d){return i.selectSection(d)}),a()(),r(38,"div",27),f(39,qn,28,18,"div",28),r(40,"div",29)(41,"div",30),f(42,Kn,7,0,"div",31)(43,Hn,12,7,"div",32),r(44,"div",33)(45,"button",34),y("click",function(){return i.navigatePrev()}),m(46,"lucide-icon",35),l(47," Previous Section "),a(),r(48,"button",36),y("click",function(){return i.navigateNext()}),l(49," Next Section "),m(50,"lucide-icon",37),a()()()()(),r(51,"div",38)(52,"div",39)(53,"button",40),y("click",function(){return i.rightPanelCollapsed=!i.rightPanelCollapsed}),m(54,"lucide-icon",41),a(),f(55,zn,2,0,"div",42)(56,Jn,1,0,"div",43),a(),f(57,Xn,11,39,"div",44)(58,Zn,2,5,"app-npa-agent-chat",45)(59,nr,3,2,"div",46)(60,or,20,4,"div",47),a()(),f(61,gr,26,9,"div",48),a()),e&2&&(s(9),O(i.isReadOnly?"bg-slate-50 text-slate-600 border-slate-200":"bg-blue-50 text-blue-700 border-blue-200"),s(),x(" ",i.isReadOnly?"Read Only":"Edit Mode \xB7 Maker/Checker"," "),s(2),Y(" ",i.inputData!=null&&i.inputData.npaId||i.inputData!=null&&i.inputData.projectId?((i.inputData==null?null:i.inputData.npaId)||(i.inputData==null?null:i.inputData.projectId))+" \xB7 ":"","",(i.inputData==null?null:i.inputData.title)||"New Product Approval"," "),s(4),H("width",i.requiredProgressPercent(),"%"),s(2),x("",i.requiredProgressPercent(),"%"),s(2),Y("req ",i.requiredFilled,"/",i.requiredTotal),s(3),O(i.overallProgress>=80?"bg-emerald-500":i.overallProgress>=40?"bg-amber-500":"bg-blue-500"),H("width",i.overallProgress,"%"),s(2),x("",i.overallProgress,"%"),s(2),Y("",i.filledFields,"/",i.totalFields),s(4),c("ngIf",i.draftCommentCount()>0),s(),c("ngIf",i.draftSaveError),s(),c("disabled",i.isReadOnly||i.isSavingDraft),s(),x(" ",i.isSavingDraft?"Saving\u2026":"Save Draft"," "),s(3),c("sections",i.stepperSections)("activeSectionId",i.activeSectionId)("filledFields",i.filledFields)("totalFields",i.totalFields)("overallProgress",i.overallProgress)("requiredMissingBySection",i.requiredMissingBySection),s(2),c("ngIf",i.getActiveSection()),s(3),c("ngIf",i.getActiveSectionGroups().length===0),s(),c("ngForOf",i.getActiveSectionGroups())("ngForTrackBy",i.trackByGroupTopic),s(2),c("disabled",(i.stepperSections[0]==null?null:i.stepperSections[0].id)===i.activeSectionId),s(3),c("disabled",(i.stepperSections[i.stepperSections.length-1]==null?null:i.stepperSections[i.stepperSections.length-1].id)===i.activeSectionId),s(3),M("w-96",!i.rightPanelCollapsed)("w-12",i.rightPanelCollapsed),s(2),c("title",i.rightPanelCollapsed?"Expand panel":"Collapse panel"),s(2),c("ngIf",!i.rightPanelCollapsed),s(),c("ngIf",!i.rightPanelCollapsed),s(),c("ngIf",!i.rightPanelCollapsed),s(),c("ngIf",!i.rightPanelCollapsed&&i.agentPanelTab==="CHAT"),s(),c("ngIf",!i.rightPanelCollapsed&&i.agentPanelTab==="KNOWLEDGE"),s(),c("ngIf",!i.rightPanelCollapsed&&i.agentPanelTab==="ISSUES"),s(),c("ngIf",i.commentsDrawerOpen))},dependencies:[N,V,F,de,oe,se,le,ae,L,it,rt,at],styles:[".npa-scrollbar[_ngcontent-%COMP%]{scrollbar-width:thin;scrollbar-color:#cbd5e1 transparent}.npa-scrollbar[_ngcontent-%COMP%]::-webkit-scrollbar{width:4px}.npa-scrollbar[_ngcontent-%COMP%]::-webkit-scrollbar-track{background:transparent}.npa-scrollbar[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background-color:#cbd5e1;border-radius:4px}.npa-scrollbar[_ngcontent-%COMP%]::-webkit-scrollbar-thumb:hover{background-color:#94a3b8}.table-grid[_ngcontent-%COMP%]   td[_ngcontent-%COMP%], .table-grid[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{padding:6px 8px;font-size:11px;border:1px solid #e2e8f0}.table-grid[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{background:#f8fafc;font-weight:600;text-transform:uppercase;letter-spacing:.05em;font-size:9px;color:#64748b}"]})};function fr(n,t){if(n&1&&(r(0,"p",28),l(1),ie(2,"date"),a()),n&2){let e=p().$implicit;s(),v(Ie(2,1,e.date,"MMM d"))}}function _r(n,t){n&1&&(r(0,"p",29),l(1,"Active"),a())}function br(n,t){if(n&1&&(r(0,"div",21)(1,"div",22),m(2,"lucide-icon",23),a(),r(3,"div",24)(4,"p",25),l(5),a(),f(6,fr,3,4,"p",26)(7,_r,2,0,"p",27),a()()),n&2){let e=t.$implicit,i=p();s(),c("ngClass",i.getStageStyles(e.status)),s(),c("name",i.getStageIcon(e.id)),s(),c("ngClass",e.status==="PENDING"?"opacity-50 grayscale":"opacity-100"),s(2),v(e.label),s(),c("ngIf",e.date),s(),c("ngIf",e.status==="IN_PROGRESS")}}function yr(n,t){n&1&&(r(0,"span",30),m(1,"span",31)(2,"span",32),a())}function xr(n,t){if(n&1&&(me(0),l(1),ie(2,"date"),ue()),n&2){let e=p();s(),x("Target Completion: ",Ie(2,1,e.targetCompletion,"mediumDate")," \u2022 ")}}function hr(n,t){if(n&1&&(r(0,"span",33),l(1),a()),n&2){let e=p();s(),Y("",e.blockerCount," Blocker",e.blockerCount>1?"s":"")}}function vr(n,t){n&1&&(r(0,"span",34),l(1,"No Blockers"),a())}function Cr(n,t){n&1&&(r(0,"div",45),m(1,"lucide-icon",46),a())}function Ir(n,t){n&1&&(r(0,"div",47),m(1,"lucide-icon",48),a())}function Sr(n,t){n&1&&(r(0,"div",49),m(1,"lucide-icon",50),a())}function kr(n,t){if(n&1&&(r(0,"p",51),m(1,"lucide-icon",52),l(2),a()),n&2){let e=p().$implicit;s(2),x(" ",e.assignee," ")}}function wr(n,t){n&1&&(r(0,"button",53),l(1," View Details "),a())}function Ar(n,t){if(n&1&&(r(0,"div",35)(1,"div",36),f(2,Cr,2,0,"div",37)(3,Ir,2,0,"div",38)(4,Sr,2,0,"div",39),a(),r(5,"div",40)(6,"p",41),l(7),a(),f(8,kr,3,1,"p",42),a(),r(9,"div",43),f(10,wr,2,0,"button",44),a()()),n&2){let e=t.$implicit;s(2),c("ngIf",e.status==="COMPLETED"),s(),c("ngIf",e.status==="IN_PROGRESS"),s(),c("ngIf",e.status==="PENDING"),s(2),M("line-through",e.status==="COMPLETED")("text-slate-400",e.status==="COMPLETED"),s(),v(e.label),s(),c("ngIf",e.assignee),s(2),c("ngIf",e.status!=="COMPLETED")}}function Tr(n,t){if(n&1&&(r(0,"div",54),l(1),a()),n&2){let e=p();s(),Y(" ",e.projectId?"NPA: "+e.projectId:"Workflow"," \u2022 ",e.stages.length," Stages ")}}var st=class n{stages=[];targetCompletion=null;projectId="";get currentStage(){return this.stages.find(t=>t.status==="IN_PROGRESS")||this.stages.filter(t=>t.status==="COMPLETED").pop()}get progressPercentage(){if(!this.stages.length)return 0;let t=this.stages.findIndex(e=>e.status==="IN_PROGRESS");return t===-1?this.stages.every(i=>i.status==="COMPLETED")?100:0:t/(this.stages.length-1)*100}get blockerCount(){return this.stages.filter(t=>t.status==="BLOCKED").length}get velocityPercent(){if(!this.stages.length)return 0;let t=this.stages.filter(e=>e.status==="COMPLETED").length;return Math.round(t/this.stages.length*100)}constructor(){}ngOnInit(){}getStageStyles(t){switch(t){case"COMPLETED":return"bg-green-600 text-white border-green-600";case"IN_PROGRESS":return"bg-white text-blue-600 border-blue-600 shadow-blue-200 shadow-lg scale-110";case"PENDING":return"bg-white text-slate-300 border-slate-200";case"BLOCKED":return"bg-white text-red-500 border-red-500";default:return""}}getStageIcon(t){switch(t){case"INITIATION":return"play";case"REVIEW":return"users";case"SIGN_OFF":return"pen-tool";case"LAUNCH":return"rocket";case"MONITORING":return"activity";case"ARCHIVE":return"archive";default:return"circle"}}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=E({type:n,selectors:[["app-npa-workflow-visualizer"]],inputs:{stages:"stages",targetCompletion:"targetCompletion",projectId:"projectId"},decls:25,vars:13,consts:[[1,"w-full"],[1,"relative","flex","items-center","justify-between","mb-12","px-4"],[1,"absolute","left-6","right-6","top-1/2","-translate-y-1/2","h-1","bg-slate-100","-z-10","rounded-full"],[1,"absolute","left-6","right-6","top-1/2","-translate-y-1/2","h-1","bg-blue-600","transition-all","duration-1000","ease-out","-z-10","rounded-full"],["class","relative flex flex-col items-center group cursor-default",4,"ngFor","ngForOf"],[1,"bg-white","rounded-xl","border","border-slate-200","shadow-sm","overflow-hidden","animate-in","fade-in","slide-in-from-bottom-4","duration-500"],[1,"px-6","py-4","bg-slate-50/50","border-b","border-slate-100","flex","items-center","justify-between"],[1,"text-lg","font-bold","text-slate-900","flex","items-center","gap-2"],["class","relative flex h-2.5 w-2.5 ml-1",4,"ngIf"],[1,"text-sm","text-slate-500","mt-1"],[4,"ngIf"],["class","text-amber-600 font-semibold",4,"ngIf"],["class","text-green-600 font-semibold",4,"ngIf"],[1,"flex","items-center","gap-2"],[1,"text-xs","font-semibold","text-slate-500","uppercase"],[1,"h-2","w-24","bg-slate-100","rounded-full","overflow-hidden"],[1,"h-full","bg-green-500","rounded-full","transition-all","duration-500"],[1,"text-[10px]","font-mono","text-slate-400"],[1,"divide-y","divide-slate-100"],["class","p-4 hover:bg-slate-50 transition-colors flex items-center gap-4 group",4,"ngFor","ngForOf"],["class","px-6 py-3 bg-slate-50 border-t border-slate-200 text-xs text-center text-slate-500",4,"ngIf"],[1,"relative","flex","flex-col","items-center","group","cursor-default"],[1,"w-12","h-12","rounded-full","flex","items-center","justify-center","border-4","transition-all","duration-500","shadow-sm","z-10",3,"ngClass"],[1,"w-5","h-5",3,"name"],[1,"absolute","top-14","w-32","text-center","transition-all","duration-300",3,"ngClass"],[1,"text-sm","font-bold","text-slate-900"],["class","text-[10px] text-slate-500 mt-0.5 font-mono",4,"ngIf"],["class","text-[10px] text-blue-600 font-bold uppercase tracking-wider animate-pulse mt-0.5",4,"ngIf"],[1,"text-[10px]","text-slate-500","mt-0.5","font-mono"],[1,"text-[10px]","text-blue-600","font-bold","uppercase","tracking-wider","animate-pulse","mt-0.5"],[1,"relative","flex","h-2.5","w-2.5","ml-1"],[1,"animate-ping","absolute","inline-flex","h-full","w-full","rounded-full","bg-blue-400","opacity-75"],[1,"relative","inline-flex","rounded-full","h-2.5","w-2.5","bg-blue-500"],[1,"text-amber-600","font-semibold"],[1,"text-green-600","font-semibold"],[1,"p-4","hover:bg-slate-50","transition-colors","flex","items-center","gap-4","group"],[1,"flex-none","pt-1"],["class","w-6 h-6 rounded-full bg-green-100 text-green-600 flex items-center justify-center",4,"ngIf"],["class","w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center animate-pulse",4,"ngIf"],["class","w-6 h-6 rounded-full bg-slate-100 text-slate-400 flex items-center justify-center",4,"ngIf"],[1,"flex-1"],[1,"text-sm","font-medium","text-slate-900"],["class","text-xs text-slate-500 mt-0.5 flex items-center gap-1",4,"ngIf"],[1,"opacity-0","group-hover:opacity-100","transition-opacity"],["class","px-3 py-1.5 text-xs font-bold text-blue-600 bg-blue-50 hover:bg-blue-100 rounded border border-blue-200",4,"ngIf"],[1,"w-6","h-6","rounded-full","bg-green-100","text-green-600","flex","items-center","justify-center"],["name","check",1,"w-3.5","h-3.5"],[1,"w-6","h-6","rounded-full","bg-blue-100","text-blue-600","flex","items-center","justify-center","animate-pulse"],["name","loader-2",1,"w-3.5","h-3.5","animate-spin"],[1,"w-6","h-6","rounded-full","bg-slate-100","text-slate-400","flex","items-center","justify-center"],["name","circle",1,"w-3.5","h-3.5"],[1,"text-xs","text-slate-500","mt-0.5","flex","items-center","gap-1"],["name","user",1,"w-3","h-3"],[1,"px-3","py-1.5","text-xs","font-bold","text-blue-600","bg-blue-50","hover:bg-blue-100","rounded","border","border-blue-200"],[1,"px-6","py-3","bg-slate-50","border-t","border-slate-200","text-xs","text-center","text-slate-500"]],template:function(e,i){e&1&&(r(0,"div",0)(1,"div",1),m(2,"div",2)(3,"div",3),f(4,br,8,6,"div",4),a(),r(5,"div",5)(6,"div",6)(7,"div")(8,"h3",7),l(9),f(10,yr,3,0,"span",8),a(),r(11,"p",9),f(12,xr,3,4,"ng-container",10)(13,hr,2,2,"span",11)(14,vr,2,0,"span",12),a()(),r(15,"div",13)(16,"span",14),l(17,"Progress"),a(),r(18,"div",15),m(19,"div",16),a(),r(20,"span",17),l(21),a()()(),r(22,"div",18),f(23,Ar,11,10,"div",19),a(),f(24,Tr,2,2,"div",20),a()()),e&2&&(s(3),H("width",i.progressPercentage+"%"),s(),c("ngForOf",i.stages),s(5),x(" Current Phase: ",i.currentStage==null?null:i.currentStage.label," "),s(),c("ngIf",(i.currentStage==null?null:i.currentStage.status)==="IN_PROGRESS"),s(2),c("ngIf",i.targetCompletion),s(),c("ngIf",i.blockerCount>0),s(),c("ngIf",i.blockerCount===0),s(5),H("width",i.velocityPercent+"%"),s(2),x("",i.velocityPercent,"%"),s(2),c("ngForOf",i.currentStage==null?null:i.currentStage.subTasks),s(),c("ngIf",i.stages.length>0))},dependencies:[N,G,V,F,U,L,De],encapsulation:2})};function Pr(n,t){if(n&1){let e=I();r(0,"button",13),y("click",function(){let o=_(e).$implicit,d=p();return b(d.activeCategory=o)}),l(1),a()}if(n&2){let e=t.$implicit,i=p();O(i.activeCategory===e?"bg-white text-blue-700 shadow-sm ring-1 ring-slate-200":"text-slate-500 hover:bg-slate-100"),s(),x(" ",e," ")}}function Er(n,t){n&1&&(r(0,"span",29),l(1," CRITICAL "),a())}function Rr(n,t){if(n&1&&(r(0,"span",30),m(1,"lucide-icon",31),l(2),a()),n&2){let e=p().$implicit;s(2),x(" ",e.autoFillPercentage,"% Auto-fill ")}}function Nr(n,t){if(n&1&&(r(0,"div",14)(1,"div",15)(2,"div",16),m(3,"lucide-icon",17),a(),r(4,"div")(5,"h4",18),l(6),f(7,Er,2,0,"span",19),a(),r(8,"div",20)(9,"span",21),m(10,"lucide-icon",22),l(11),a(),r(12,"span",21),m(13,"lucide-icon",23),l(14),a(),f(15,Rr,3,1,"span",24),a()()(),r(16,"div",25)(17,"span",26),l(18),a(),r(19,"button",27),m(20,"lucide-icon",28),a()()()),n&2){let e=t.$implicit,i=p();s(2),c("ngClass",i.getStatusColor(e.status)),s(),c("name",i.getStatusIcon(e.status)),s(3),x(" ",e.name," "),s(),c("ngIf",e.isCriticalPath),s(4),x(" ",e.owner||"Unassigned"," "),s(3),x(" ",e.source," "),s(),c("ngIf",e.autoFillPercentage),s(2),c("ngClass",i.getStatusBadge(e.status)),s(),x(" ",e.status.replace("_"," ")," ")}}var lt=class n{npaContext=null;npaType="NPA Full (New-to-Group)";categories=["ALL","CORE","RISK","LEGAL","TECH"];activeCategory="ALL";allDocs=[{id:"D1",name:"NPA Submission Form",category:"CORE",source:"BUSINESS",status:"COMPLETE",isCriticalPath:!0,autoFillPercentage:78,owner:"Vikram A."},{id:"D2",name:"Product Specification",category:"CORE",source:"BUSINESS",status:"IN_PROGRESS",isCriticalPath:!0,autoFillPercentage:35,owner:"Vikram A."},{id:"D3",name:"Risk Assessment Matrix",category:"RISK",source:"RISK",status:"AT_RISK",isCriticalPath:!0,autoFillPercentage:55,owner:"Sarah J.",notes:"Waiting on Market Risk sign-off"},{id:"D4",name:"Legal Documentation Summary",category:"LEGAL",source:"LEGAL",status:"NOT_STARTED",isCriticalPath:!1,autoFillPercentage:45},{id:"D5",name:"Regulatory Checklist",category:"LEGAL",source:"COMPLIANCE",status:"IN_PROGRESS",isCriticalPath:!0,owner:"Compliance Team"},{id:"D6",name:"System Impact Assessment",category:"TECH",source:"TECH",status:"COMPLETE",isCriticalPath:!1,autoFillPercentage:70,owner:"IT Dept"},{id:"D7",name:"Ops Readiness Checklist",category:"CORE",source:"OPS",status:"NOT_STARTED",isCriticalPath:!0,autoFillPercentage:75,owner:"Ops Lead"}];constructor(){}ngOnInit(){this.updateMatrix()}ngOnChanges(t){t.npaContext&&this.updateMatrix()}get filteredDocs(){return this.activeCategory==="ALL"?this.allDocs:this.activeCategory==="RISK"?this.allDocs.filter(t=>t.category==="RISK"||t.source==="RISK"):this.activeCategory==="LEGAL"?this.allDocs.filter(t=>t.category==="LEGAL"||t.source==="LEGAL"||t.source==="COMPLIANCE"):this.activeCategory==="TECH"?this.allDocs.filter(t=>t.category==="TECH"||t.source==="TECH"||t.source==="OPS"):this.allDocs.filter(t=>t.category===this.activeCategory)}get completionPercentage(){let t=this.allDocs.length,e=this.allDocs.filter(i=>i.status==="COMPLETE").length;return Math.round(e/t*100)}get criticalMissingCount(){return this.allDocs.filter(t=>t.isCriticalPath&&t.status!=="COMPLETE").length}updateMatrix(){}getStatusColor(t){switch(t){case"COMPLETE":return"bg-green-100 text-green-600";case"IN_PROGRESS":return"bg-blue-100 text-blue-600";case"AT_RISK":return"bg-amber-100 text-amber-600";case"NOT_STARTED":return"bg-slate-100 text-slate-400";case"MISSING":return"bg-red-100 text-red-600";default:return"bg-slate-100"}}getStatusIcon(t){switch(t){case"COMPLETE":return"check";case"IN_PROGRESS":return"loader-2";case"AT_RISK":return"alert-triangle";case"NOT_STARTED":return"circle-dashed";case"MISSING":return"x-circle";default:return"circle"}}getStatusBadge(t){switch(t){case"COMPLETE":return"bg-green-100 text-green-700";case"IN_PROGRESS":return"bg-blue-100 text-blue-700";case"AT_RISK":return"bg-amber-100 text-amber-800 animate-pulse";case"NOT_STARTED":return"bg-slate-100 text-slate-600";case"MISSING":return"bg-red-100 text-red-700 font-bold";default:return"bg-slate-100"}}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=E({type:n,selectors:[["app-document-dependency-matrix"]],inputs:{npaContext:"npaContext"},features:[It],decls:21,vars:5,consts:[[1,"bg-white","rounded-xl","shadow-sm","border","border-slate-200","overflow-hidden"],[1,"px-6","py-5","border-b","border-slate-200","bg-slate-50/50","flex","flex-col","md:flex-row","md:items-center","justify-between","gap-4"],[1,"text-lg","font-bold","text-slate-900","flex","items-center","gap-2"],[1,"px-2","py-0.5","rounded","text-xs","font-bold","uppercase","bg-blue-100","text-blue-700","border","border-blue-200"],[1,"text-sm","text-slate-500","mt-1"],[1,"text-red-600","font-semibold"],[1,"flex","items-center","gap-2"],["class","px-3 py-1.5 rounded-lg text-xs font-medium transition-all",3,"class","click",4,"ngFor","ngForOf"],[1,"divide-y","divide-slate-100"],["class","group hover:bg-slate-50 transition-colors p-4 flex items-center justify-between",4,"ngFor","ngForOf"],[1,"bg-slate-50","px-6","py-3","border-t","border-slate-200","flex","items-center","justify-between","text-xs","text-slate-500"],[1,"font-semibold","text-blue-600","hover:text-blue-800","flex","items-center","gap-1"],["name","arrow-right",1,"w-3","h-3"],[1,"px-3","py-1.5","rounded-lg","text-xs","font-medium","transition-all",3,"click"],[1,"group","hover:bg-slate-50","transition-colors","p-4","flex","items-center","justify-between"],[1,"flex","items-center","gap-4","flex-1"],[1,"w-10","h-10","rounded-full","flex","items-center","justify-center","flex-none",3,"ngClass"],[1,"w-5","h-5",3,"name"],[1,"text-sm","font-bold","text-slate-900","flex","items-center","gap-2"],["class","px-1.5 py-0.5 rounded text-[10px] font-bold bg-red-100 text-red-700 border border-red-200",4,"ngIf"],[1,"flex","items-center","gap-3","text-xs","text-slate-500","mt-1"],[1,"flex","items-center","gap-1"],["name","user",1,"w-3","h-3"],["name","building-2",1,"w-3","h-3"],["class","flex items-center gap-1 text-green-600",4,"ngIf"],[1,"flex","items-center","gap-3"],[1,"text-xs","font-semibold","px-2","py-1","rounded",3,"ngClass"],[1,"p-2","text-slate-400","hover:text-blue-600","transition-colors"],["name","more-vertical",1,"w-4","h-4"],[1,"px-1.5","py-0.5","rounded","text-[10px]","font-bold","bg-red-100","text-red-700","border","border-red-200"],[1,"flex","items-center","gap-1","text-green-600"],["name","sparkles",1,"w-3","h-3"]],template:function(e,i){e&1&&(r(0,"div",0)(1,"div",1)(2,"div")(3,"h3",2),l(4," Document Dependency Matrix "),r(5,"span",3),l(6),a()(),r(7,"p",4),l(8),r(9,"span",5),l(10),a()()(),r(11,"div",6),f(12,Pr,2,3,"button",7),a()(),r(13,"div",8),f(14,Nr,21,9,"div",9),a(),r(15,"div",10)(16,"span"),l(17,"Source: NPA_Documents_Required.md (v1.0)"),a(),r(18,"button",11),l(19," Generate Missing Docs "),m(20,"lucide-icon",12),a()()()),e&2&&(s(6),x(" ",i.npaType||"NPA Full"," "),s(2),x(" ",i.completionPercentage,"% Complete \u2022 "),s(2),x("",i.criticalMissingCount," Critical Missing"),s(2),c("ngForOf",i.categories),s(2),c("ngForOf",i.filteredDocs))},dependencies:[N,G,V,F,U,L],encapsulation:2})};function Dr(n,t){if(n&1&&(r(0,"div")(1,"div",24)(2,"div",25)(3,"span",26),l(4),a(),r(5,"span",27),l(6),a()(),r(7,"span",28),l(8),a()(),r(9,"div",29),m(10,"div",30),a()()),n&2){let e=t.$implicit,i=p(2);s(4),v(e.name),s(2),v(e.value),s(2),x(" ",(e.importance*100).toFixed(0),"% "),s(2),H("width",e.importance*100,"%"),c("ngClass",i.getFeatureBarColor(e.importance))}}function Mr(n,t){if(n&1&&(r(0,"li",34),m(1,"lucide-icon",35),l(2),a()),n&2){let e=t.$implicit;s(2),x(" ",e," ")}}function Lr(n,t){if(n&1&&(r(0,"div",2)(1,"h4",5),m(2,"lucide-icon",31),l(3," Comparison Insights "),a(),r(4,"ul",32),f(5,Mr,3,1,"li",33),a()()),n&2){let e=p(2);s(5),c("ngForOf",e.result.comparisonInsights)}}function Or(n,t){if(n&1&&(r(0,"div",1)(1,"div",2)(2,"div",3)(3,"div",4)(4,"h4",5),l(5," Approval Likelihood "),a(),r(6,"div",6),vt(),r(7,"svg",7),m(8,"circle",8)(9,"circle",9),a(),Ct(),r(10,"div",10)(11,"span",11),l(12),a()()()(),r(13,"div",12)(14,"h4",5),l(15," Estimated Timeline "),a(),r(16,"div",13),m(17,"lucide-icon",14),r(18,"span",15),l(19),a(),r(20,"span",16),l(21,"days"),a()()(),r(22,"div",12)(23,"h4",5),l(24," Bottleneck Dept. "),a(),r(25,"span",17),m(26,"lucide-icon",18),l(27),a()()()(),r(28,"div",2)(29,"h4",19),m(30,"lucide-icon",20),l(31," Feature Importance (Top 5) "),a(),r(32,"div",21),f(33,Dr,11,6,"div",22),a()(),f(34,Lr,6,1,"div",23),a()),n&2){let e=p();s(9),St("stroke",e.getGaugeColor(e.result.approvalLikelihood))("stroke-dasharray",e.getStrokeDasharray(e.result.approvalLikelihood)),s(2),c("ngClass",e.getGaugeTextClass(e.result.approvalLikelihood)),s(),x(" ",e.result.approvalLikelihood,"% "),s(7),v(e.result.timelineDays),s(6),c("ngClass",e.getBottleneckClass()),s(2),x(" ",e.result.bottleneckDept," "),s(6),c("ngForOf",e.topFeatures),s(),c("ngIf",e.result.comparisonInsights.length>0)}}var dt=class n{result;get topFeatures(){return this.result?.features?[...this.result.features].sort((t,e)=>e.importance-t.importance).slice(0,5):[]}getGaugeColor(t){return t>=70?"#22c55e":t>=40?"#f59e0b":"#ef4444"}getGaugeTextClass(t){return t>=70?"text-green-600":t>=40?"text-amber-600":"text-red-600"}getStrokeDasharray(t){let e=2*Math.PI*42;return`${t/100*e} ${e}`}getBottleneckClass(){return"bg-orange-100 text-orange-800 border border-orange-200"}getFeatureBarColor(t){return t>=.7?"bg-indigo-500":t>=.4?"bg-blue-400":"bg-slate-400"}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=E({type:n,selectors:[["app-ml-prediction-result"]],inputs:{result:"result"},decls:1,vars:1,consts:[["class","space-y-5",4,"ngIf"],[1,"space-y-5"],[1,"bg-white","rounded-xl","border","border-slate-200","shadow-sm","p-5"],[1,"grid","grid-cols-3","gap-6"],[1,"flex","flex-col","items-center"],[1,"text-xs","font-semibold","text-slate-400","uppercase","tracking-wider","mb-3"],[1,"relative","w-28","h-28"],["viewBox","0 0 100 100",1,"w-28","h-28","-rotate-90"],["cx","50","cy","50","r","42","fill","none","stroke","#e2e8f0","stroke-width","8"],["cx","50","cy","50","r","42","fill","none","stroke-width","8","stroke-linecap","round",1,"transition-all","duration-1000"],[1,"absolute","inset-0","flex","flex-col","items-center","justify-center"],[1,"text-2xl","font-bold",3,"ngClass"],[1,"flex","flex-col","items-center","justify-center"],[1,"flex","items-center","gap-2","bg-slate-50","rounded-lg","px-4","py-3","border","border-slate-100"],["name","clock",1,"w-5","h-5","text-blue-500"],[1,"text-xl","font-bold","text-slate-800"],[1,"text-sm","text-slate-500"],[1,"px-4","py-2","rounded-lg","text-sm","font-bold",3,"ngClass"],["name","alert-triangle",1,"w-4","h-4","inline-block","mr-1","-mt-0.5"],[1,"text-xs","font-semibold","text-slate-400","uppercase","tracking-wider","mb-4"],["name","bar-chart-3",1,"w-3.5","h-3.5","inline-block","mr-1","-mt-0.5"],[1,"space-y-3"],[4,"ngFor","ngForOf"],["class","bg-white rounded-xl border border-slate-200 shadow-sm p-5",4,"ngIf"],[1,"flex","items-center","justify-between","mb-1"],[1,"flex","items-center","gap-2"],[1,"text-sm","font-medium","text-slate-700"],[1,"text-xs","text-slate-400","font-mono"],[1,"text-xs","font-bold","text-slate-600"],[1,"w-full","bg-slate-100","rounded-full","h-2","overflow-hidden"],[1,"h-full","rounded-full","transition-all","duration-500",3,"ngClass"],["name","lightbulb",1,"w-3.5","h-3.5","inline-block","mr-1","-mt-0.5"],[1,"space-y-2"],["class","flex items-start gap-2 text-sm text-slate-600",4,"ngFor","ngForOf"],[1,"flex","items-start","gap-2","text-sm","text-slate-600"],["name","arrow-right",1,"w-4","h-4","text-blue-400","mt-0.5","flex-shrink-0"]],template:function(e,i){e&1&&f(0,Or,35,9,"div",0),e&2&&c("ngIf",i.result)},dependencies:[N,G,V,F,ae,L],encapsulation:2})};var Fr=["scrollContainer"],Vr=n=>({"flex-row-reverse":n});function Br(n,t){if(n&1){let e=I();r(0,"div",15)(1,"div",16),m(2,"lucide-icon",17),a(),r(3,"div")(4,"h4",18),l(5,"Proposal Ready"),a(),r(6,"p",19),l(7,"Draft generated successfully."),a()(),r(8,"button",20),y("click",function(){_(e);let o=p();return b(o.onComplete.emit(o.routingPayload))}),l(9," View "),a()()}}function Gr(n,t){n&1&&(r(0,"span"),l(1,"V"),a())}function Ur(n,t){n&1&&m(0,"lucide-icon",33)}function jr(n,t){if(n&1&&m(0,"app-classification-result",34),n&2){let e=p().$implicit;c("result",e.cardData)}}function qr(n,t){if(n&1&&(r(0,"div",35)(1,"div",36)(2,"div",37),m(3,"lucide-icon",38),a(),r(4,"div")(5,"h4",39),l(6,"PROHIBITED \u2014 Hard Stop"),a(),r(7,"p",40),l(8),a()()(),r(9,"div",41),l(10," Matched prohibited item: "),r(11,"strong"),l(12),a(),l(13,". NPA creation blocked. "),a()()),n&2){let e=p().$implicit;s(8),v((e.cardData.prohibitedMatch==null?null:e.cardData.prohibitedMatch.layer)||"REGULATORY"),s(4),v((e.cardData.prohibitedMatch==null?null:e.cardData.prohibitedMatch.item)||"Unknown")}}function Kr(n,t){if(n&1&&(r(0,"div",42)(1,"div",36)(2,"div",43),m(3,"lucide-icon",44),a(),r(4,"h4",45),l(5,"ML Prediction"),a()(),r(6,"div",46)(7,"div")(8,"div",47),l(9),a(),r(10,"div",48),l(11,"Approval"),a()(),r(12,"div")(13,"div",47),l(14),a(),r(15,"div",48),l(16,"Timeline"),a()(),r(17,"div")(18,"div",45),l(19),a(),r(20,"div",48),l(21,"Bottleneck"),a()()()()),n&2){let e=p().$implicit;s(9),x("",e.cardData.approvalLikelihood||0,"%"),s(5),x("",e.cardData.timelineDays||0,"d"),s(5),v(e.cardData.bottleneckDept||"-")}}function $r(n,t){if(n&1&&m(0,"app-risk-assessment-result",34),n&2){let e=p().$implicit;c("result",e.cardData)}}function Wr(n,t){if(n&1&&m(0,"app-governance-status",34),n&2){let e=p().$implicit;c("result",e.cardData)}}function Yr(n,t){if(n&1&&m(0,"app-doc-completeness",34),n&2){let e=p().$implicit;c("result",e.cardData)}}function Hr(n,t){if(n&1&&(r(0,"div",49)(1,"div",50)(2,"div",51),m(3,"lucide-icon",52),a(),r(4,"h4",53),l(5),a()(),r(6,"p",54),l(7),a()()),n&2){let e=p().$implicit;s(5),v(e.cardData.title),s(2),v(e.cardData.description)}}function zr(n,t){if(n&1&&m(0,"app-monitoring-alerts",34),n&2){let e=p().$implicit;c("result",e.cardData)}}function Jr(n,t){if(n&1&&(r(0,"div",21)(1,"div",22),f(2,Gr,2,0,"span",23)(3,Ur,1,0,"lucide-icon",24),a(),r(4,"div",25)(5,"div",26),m(6,"markdown",27),r(7,"span",28),l(8),ie(9,"date"),a()(),f(10,jr,1,1,"app-classification-result",29)(11,qr,14,2,"div",30)(12,Kr,22,3,"div",31)(13,$r,1,1,"app-risk-assessment-result",29)(14,Wr,1,1,"app-governance-status",29)(15,Yr,1,1,"app-doc-completeness",29)(16,Hr,8,2,"div",32)(17,zr,1,1,"app-monitoring-alerts",29),a()()),n&2){let e=t.$implicit;c("ngClass",wt(18,Vr,e.role==="user")),s(),c("ngClass",e.role==="user"?"bg-indigo-600 text-white chat-avatar-user":"bg-white border border-slate-200 text-indigo-600 chat-avatar-agent"),s(),c("ngIf",e.role==="user"),s(),c("ngIf",e.role!=="user"),s(2),c("ngClass",e.role==="user"?"bg-indigo-50 border border-indigo-100 text-slate-900 rounded-tr-sm":"bg-white border border-slate-200 text-slate-800 rounded-tl-sm"),s(),c("data",e.content),s(2),v(Ie(9,15,e.timestamp,"shortTime")),s(2),c("ngIf",e.cardType==="CLASSIFICATION"&&e.cardData),s(),c("ngIf",e.cardType==="HARD_STOP"&&e.cardData),s(),c("ngIf",e.cardType==="PREDICTION"&&e.cardData),s(),c("ngIf",e.cardType==="RISK"&&e.cardData),s(),c("ngIf",e.cardType==="GOVERNANCE"&&e.cardData),s(),c("ngIf",e.cardType==="DOC_STATUS"&&e.cardData),s(),c("ngIf",e.cardType==="INFO"&&e.cardData),s(),c("ngIf",e.cardType==="MONITORING"&&e.cardData)}}function Qr(n,t){if(n&1&&(r(0,"div",55)(1,"div",56),m(2,"lucide-icon",57),a(),r(3,"div",58)(4,"div",59)(5,"span",60),l(6),a(),r(7,"span",61),l(8),a()(),r(9,"div",62)(10,"div",63),m(11,"span",64)(12,"span",65)(13,"span",66),a(),r(14,"span",67),l(15),a()()()()),n&2){let e=p();s(6),v(e.thinkingMessage),s(2),v(e.thinkingElapsed),s(7),v(e.thinkingSubMessage)}}function Xr(n,t){if(n&1){let e=I();r(0,"div",68)(1,"button",69),y("click",function(){_(e);let o=p();return b(o.generateWorkItem())}),m(2,"lucide-icon",70),l(3," Generate Work Item "),a()()}}function Zr(n,t){n&1&&m(0,"lucide-icon",78)}function ea(n,t){n&1&&m(0,"lucide-icon",79)}function ta(n,t){if(n&1&&(r(0,"div",74),m(1,"lucide-icon",75),l(2),f(3,Zr,1,0,"lucide-icon",76)(4,ea,1,0,"lucide-icon",77),a()),n&2){let e=t.$implicit;c("ngClass",e.status==="running"?"bg-blue-50 text-blue-700 border-blue-200 animate-pulse":e.status==="done"?"bg-green-50 text-green-700 border-green-200":"bg-red-50 text-red-700 border-red-200"),s(),c("name",e.icon),s(),x(" ",e.name," "),s(),c("ngIf",e.status==="running"),s(),c("ngIf",e.status==="done")}}function ia(n,t){if(n&1&&(r(0,"div",71)(1,"span",72),l(2,"Agents:"),a(),f(3,ta,5,5,"div",73),a()),n&2){let e=p();s(3),c("ngForOf",e.getActiveAgentsList())}}function na(n,t){if(n&1){let e=I();r(0,"div",80)(1,"div",62)(2,"div",81),m(3,"lucide-icon",82),a(),r(4,"span",83),l(5,"Draft Proposal Ready"),a()(),r(6,"button",84),y("click",function(){_(e);let o=p();return b(o.onComplete.emit(o.routingPayload))}),l(7," Review Now "),m(8,"lucide-icon",85),a()()}}function ra(n,t){n&1&&(r(0,"div",86)(1,"div",62),m(2,"span",87),r(3,"span",88),l(4,"AI Agent Active"),a()()())}function aa(n,t){if(n&1){let e=I();r(0,"button",89),y("click",function(){_(e);let o=p();return b(o.sendMessage())}),m(1,"lucide-icon",90),a()}if(n&2){let e=p();c("disabled",!e.userInput.trim())}}function oa(n,t){if(n&1){let e=I();r(0,"button",91),y("click",function(){_(e);let o=p();return b(o.stopRequest())}),m(1,"lucide-icon",92),a()}}var ct=class n{onComplete=new R;scrollContainer;initialConversationId;initialSessionId;defaultAgent;contextLabel;difyService=T(ce);chatSessionService=T(Be);activitySub;agentChangeSub;currentSubscription;userInput="";isThinking=!1;thinkingMessage="Processing request...";thinkingSubMessage="";thinkingElapsed="0s";thinkingStartTime=0;thinkingTimerInterval=null;thinkingSubMessageInterval=null;thinkingSubMessageIndex=0;isDraftReady=!1;showToast=!1;messages=[];nextAgent=null;showGenerateButton=!1;routingPayload=null;sessionDirty=!1;sessionId=null;AGENTS={};activeAgents=new Map;currentAgent;constructor(){for(let t of Q)this.AGENTS[t.id]={id:t.id,name:t.name,role:t.description,color:t.color,icon:t.icon},this.activeAgents.set(t.id,"idle");this.currentAgent=this.AGENTS.MASTER_COO}ngOnInit(){this.initialSessionId?this.resumeSession():this.startConversation(),this.activitySub=this.difyService.getAgentActivity().subscribe(t=>{this.activeAgents.set(t.agentId,t.status)}),this.agentChangeSub=this.difyService.getAgentChanges().subscribe(t=>{let e=this.AGENTS[t.toAgent];e&&(this.currentAgent=e)})}async resumeSession(){let t=await this.chatSessionService.fetchSessionWithMessages(this.initialSessionId);if(!t){this.startConversation();return}if(this.sessionId=t.id,this.messages=t.messages.map(e=>({role:e.role,content:e.content,timestamp:new Date(e.timestamp||e.created_at),agentIdentity:e.agentIdentityId?this.AGENTS[e.agentIdentityId]:void 0,cardType:e.cardType||void 0,cardData:e.cardData||void 0,agentAction:e.agentAction||void 0})),this.difyService.reset(),t.conversationState)this.difyService.restoreConversationState(t.conversationState);else if(this.initialConversationId){let e=this.defaultAgent||t.activeAgentId||"NPA_ORCHESTRATOR";this.difyService.setActiveAgent(e),this.difyService.restoreConversation(e,this.initialConversationId)}else t.activeAgentId?this.difyService.setActiveAgent(t.activeAgentId):this.defaultAgent&&this.difyService.setActiveAgent(this.defaultAgent);this.currentAgent=this.AGENTS[this.difyService.activeAgentId]||this.AGENTS.MASTER_COO,this.chatSessionService.setActiveSession(t.id),this.messages.push({role:"agent",content:`Continuing your conversation on **${this.contextLabel||"this NPA"}**. I can help you amend the draft, run governance checks, review documents, or answer questions about the proposal.`,timestamp:new Date,agentIdentity:this.AGENTS[this.defaultAgent||"NPA_ORCHESTRATOR"]||this.AGENTS.MASTER_COO})}ngAfterViewChecked(){this.scrollToBottom()}ngOnDestroy(){this.activitySub?.unsubscribe(),this.agentChangeSub?.unsubscribe(),this.currentSubscription?.unsubscribe(),this.stopThinkingTimer()}startConversation(){this.difyService.reset();let t=this.defaultAgent||"MASTER_COO";this.difyService.setActiveAgent(t),this.currentAgent=this.AGENTS[t]||this.AGENTS.MASTER_COO,this.isThinking=!0,this.difyService.sendMessage("",{},t).subscribe(e=>{this.messages.push({role:"agent",content:e.answer,timestamp:new Date,agentIdentity:this.AGENTS[t]||this.AGENTS.MASTER_COO}),this.isThinking=!1,this.stopThinkingTimer(),this.sessionDirty=!0,this.autoSaveSession()})}sendMessage(){this.userInput.trim()&&this.processUserMessage(this.userInput)}stopRequest(){this.currentSubscription?.unsubscribe(),this.currentSubscription=void 0,this.isThinking=!1,this.stopThinkingTimer(),this.messages.push({role:"agent",content:"*Request cancelled by user.*",timestamp:new Date,agentIdentity:this.AGENTS.MASTER_COO}),this.sessionDirty=!0,this.autoSaveSession()}handleKeyDown(t){t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),this.isThinking&&this.stopRequest(),this.userInput.trim()&&this.sendMessage())}triggerInput(t){this.processUserMessage(t)}AGENT_THINKING_MESSAGES={IDEATION:["Gathering product information...","Searching for similar historical NPAs...","Checking prohibited products list...","Analyzing product structure...","Evaluating regulatory requirements...","Building NPA draft..."],CLASSIFIER:["Running classification model...","Comparing against product taxonomy...","Scoring product complexity..."],RISK:["Evaluating risk factors...","Running risk scoring model...","Analyzing market exposure..."],DEFAULT:["Processing your request...","Analyzing data...","Preparing response..."]};startThinkingTimer(t){this.thinkingStartTime=Date.now(),this.thinkingElapsed="0s",this.thinkingSubMessageIndex=0;let e=this.AGENT_THINKING_MESSAGES[t]||this.AGENT_THINKING_MESSAGES.DEFAULT;this.thinkingSubMessage=e[0],this.thinkingTimerInterval=setInterval(()=>{let i=Math.floor((Date.now()-this.thinkingStartTime)/1e3);if(i<60)this.thinkingElapsed=`${i}s`;else{let o=Math.floor(i/60),d=i%60;this.thinkingElapsed=`${o}m ${d}s`}},1e3),this.thinkingSubMessageInterval=setInterval(()=>{this.thinkingSubMessageIndex=(this.thinkingSubMessageIndex+1)%e.length,this.thinkingSubMessage=e[this.thinkingSubMessageIndex]},4e3)}stopThinkingTimer(){this.thinkingTimerInterval&&(clearInterval(this.thinkingTimerInterval),this.thinkingTimerInterval=null),this.thinkingSubMessageInterval&&(clearInterval(this.thinkingSubMessageInterval),this.thinkingSubMessageInterval=null)}processUserMessage(t){this.messages.push({role:"user",content:t,timestamp:new Date}),this.userInput="",this.isThinking=!0,this.sessionDirty=!0,this.autoSaveSession();let e=this.difyService.activeAgentId||this.defaultAgent||"IDEATION";this.thinkingMessage=`${this.currentAgent?.name||"Agent"} is working`,this.startThinkingTimer(e),this.currentSubscription?.unsubscribe(),this.currentSubscription=this.difyService.sendMessage(t).subscribe({next:i=>{this.handleDifyResponse(i)},error:()=>{let i=this.difyService.activeAgentId;this.messages.push({role:"agent",content:"Sorry, I encountered an error processing your request.",timestamp:new Date,agentIdentity:this.AGENTS[i]||this.AGENTS.MASTER_COO}),this.isThinking=!1,this.stopThinkingTimer(),this.sessionDirty=!0,this.autoSaveSession()}})}handleDifyResponse(t){let e=this.difyService.activeAgentId||t.metadata?.agent_id||"MASTER_COO",i=this.AGENTS[e]||this.AGENTS.MASTER_COO,o=t.metadata?.agent_action,d=null;t.metadata&&(d=this.difyService.processAgentRouting(t.metadata));let u,g;if(o==="SHOW_CLASSIFICATION"&&t.metadata?.payload?(u="CLASSIFICATION",g=t.metadata.payload):o==="HARD_STOP"||o==="STOP_PROCESS"?(u="HARD_STOP",g=t.metadata?.payload):o==="SHOW_PREDICTION"&&t.metadata?.payload?(u="PREDICTION",g=t.metadata.payload):o==="SHOW_RISK"&&t.metadata?.payload?(u="RISK",g=t.metadata.payload):o==="SHOW_GOVERNANCE"&&t.metadata?.payload?(u="GOVERNANCE",g=t.metadata.payload):o==="SHOW_DOC_STATUS"&&t.metadata?.payload?(u="DOC_STATUS",g=t.metadata.payload):o==="SHOW_MONITORING"&&t.metadata?.payload?(u="MONITORING",g=t.metadata.payload):o==="DELEGATE_AGENT"&&t.metadata?.payload?(u="DELEGATION",g=t.metadata.payload):o==="FINALIZE_DRAFT"&&this.finishDraft(t.metadata?.payload),this.messages.push({role:"agent",content:t.answer,timestamp:new Date,agentIdentity:i,cardType:u,cardData:g,agentAction:o}),d?.shouldSwitch&&d.targetAgent){let C=d.targetAgent,h=this.AGENTS[C],S=t.metadata?.payload?.intent||t.metadata?.payload?.data?.intent||"";if(h&&(this.currentAgent=h),(o==="DELEGATE_AGENT"||o==="ROUTE_DOMAIN")&&C){let P=this.AGENTS[C]||this.AGENTS.MASTER_COO,k=h?.name||C,w="Agent Handoff",D=`${k} is taking over with full context.`;o==="ROUTE_DOMAIN"&&S&&(w="Domain Orchestrator",D=`Routing to ${k} to handle **${S}**. Forwarding your request...`),this.messages.push({role:"agent",content:`**${k}** is now connected. Forwarding context...`,timestamp:new Date,agentIdentity:P,cardType:"INFO",cardData:{title:w,description:D}}),this.isThinking=!0,this.startThinkingTimer(`${k} is loading context...`);let A=this._buildDelegationContext(t.answer);this.currentSubscription?.unsubscribe(),this.currentSubscription=this.difyService.sendMessage(A,{orchestrator_message:t.answer.substring(0,4e3)},C).subscribe({next:z=>{this.handleDifyResponse(z)},error:()=>{this.isThinking=!1,this.stopThinkingTimer(),this.sessionDirty=!0,this.autoSaveSession()}})}else{let P=this.AGENTS[C]||this.AGENTS.MASTER_COO,k=h?.name||C,w=S?`

I understand you'd like to **${S}**. `:`

`,D=`\u{1F44B} **${k}** is ready.${w}Go ahead and describe your product idea or requirement \u2014 I'll guide you through the process step by step.`;this.messages.push({role:"agent",content:D,timestamp:new Date,agentIdentity:P}),this.isThinking=!1,this.stopThinkingTimer()}}else this.isThinking=!1,this.stopThinkingTimer();this.sessionDirty=!0,this.autoSaveSession()}_buildDelegationContext(t){let e=t.substring(0,3e3);return`[CONTEXT FROM ORCHESTRATOR]
The following product details were gathered during the routing phase. Please use this context to begin the structured interview \u2014 do not re-ask questions already answered.

User's original request:
${this.messages.filter(o=>o.role==="user").map(o=>o.content).join(" | ").substring(0,2e3)}

Orchestrator summary:
${e}`}finishDraft(t){this.isDraftReady=!0,this.showToast=!0,this.routingPayload=t||{title:"NPA Draft",npaType:"Variation",riskLevel:"MEDIUM",isCrossBorder:!1,description:"Auto-generated NPA draft from agent analysis.",notional:0,jurisdictions:["Singapore"],requiredSignOffs:t?.mandatorySignOffs||["Finance","Credit","Ops"],submittedBy:"Current User",submittedDate:new Date},t?.target_agent&&this.difyService.returnToPreviousAgent("finalize_draft"),this.showGenerateButton=!0,setTimeout(()=>{this.showToast=!1},5e3);let e={product_name:t?.product_name||t?.title||"Untitled Product",product_description:t?.product_description||t?.description||"",product_type:t?.product_type||"",asset_class:t?.asset_class||"",target_market:t?.target_market||"",distribution_channel:t?.distribution_channel||"",risk_features:t?.risk_features||"",jurisdictions:(t?.jurisdictions||[]).join(", "),notional_size:t?.notional_size||t?.notional||"",regulatory_framework:t?.regulatory_framework||""};this.difyService.runWorkflow("CLASSIFIER",e).subscribe({next:i=>{if(i.data.status==="succeeded"){let o=this.parseClassifierResponse(i.data.outputs);o.prohibitedMatch?.matched?(this.isDraftReady=!1,this.showGenerateButton=!1,this.messages.push({role:"agent",content:"**HARD STOP** \u2014 This product has been classified as **Prohibited**. NPA creation is blocked.",timestamp:new Date,agentIdentity:this.AGENTS.CLASSIFIER,cardType:"HARD_STOP",cardData:o})):this.messages.push({role:"agent",content:"Classification analysis complete.",timestamp:new Date,agentIdentity:this.AGENTS.CLASSIFIER,cardType:"CLASSIFICATION",cardData:o}),this.sessionDirty=!0,this.autoSaveSession()}},error:i=>{console.error("[CLASSIFIER] Workflow failed:",i)}})}parseClassifierResponse(t){let e=t?.result||"",i=e.match(/```json\s*([\s\S]*?)\s*```/);i&&(e=i[1]);let o;try{o=JSON.parse(e)}catch{let w=e.match(/\{[\s\S]*\}/);if(w)try{o=JSON.parse(w[0])}catch{}if(!o)return console.warn("[parseClassifierResponse] JSON parse failed, using safe defaults. Raw (200):",(e||"").substring(0,200)),{type:"Variation",track:"NPA Lite",scores:[],overallConfidence:0,mandatorySignOffs:[],_parseError:"Classifier returned narrative text instead of JSON"}}let d={FULL_NPA:"Full NPA",NPA_LITE:"NPA Lite",EVERGREEN:"Evergreen",PROHIBITED:"Prohibited",VARIATION:"NPA Lite"},u={FULL_NPA:"NTG",NPA_LITE:"Variation",EVERGREEN:"Existing",PROHIBITED:"NTG",VARIATION:"Variation"},g=o.scorecard||{},C=g.ntg_total_score||0,h=g.ntg_max_score||30,S=[],P=[{key:"product_innovation",name:"Product Innovation",max:15},{key:"market_customer",name:"Market & Customer",max:8},{key:"risk_regulatory",name:"Risk & Regulatory",max:7},{key:"financial_operational",name:"Financial & Operational",max:0}];for(let w of P){let D=g[w.key];D&&S.push({criterion:w.name,score:D.subtotal||0,maxScore:D.max_subtotal||w.max,reasoning:Object.entries(D).filter(([A])=>!["subtotal","max_subtotal"].includes(A)).map(([A,z])=>`${A}: ${z.score}/${z.max}`).join(", ")})}let k=h>0?Math.round((1-Math.abs(C-h/2)/(h/2))*100):80;return{type:u[o.classification_type]||"NTG",track:d[o.classification_type]||"Full NPA",scores:S,overallConfidence:Math.max(k,60),prohibitedMatch:o.prohibited_check?{matched:o.prohibited_check.is_prohibited||!1,item:(o.prohibited_check.matched_items||[])[0]||void 0,layer:o.prohibited_check.is_prohibited?"REGULATORY":void 0}:void 0,mandatorySignOffs:o.mandatory_signoffs||[]}}generateWorkItem(){this.onComplete.emit(this.routingPayload)}resetChat(){this.messages=[],this.currentAgent=this.AGENTS.MASTER_COO,this.isDraftReady=!1,this.showGenerateButton=!1,this.activeAgents.forEach((t,e)=>this.activeAgents.set(e,"idle")),this.sessionId=null,this.startConversation()}autoSaveSession(){if(this.messages.length===0||!this.sessionDirty)return;let t=!this.sessionId;this.sessionId=this.chatSessionService.saveSessionFor(this.sessionId,this.messages,this.difyService.activeAgentId||this.currentAgent?.id,this.currentAgent,{makeActive:t,conversationState:this.difyService.exportConversationState()})}getActiveAgentsList(){return Array.from(this.activeAgents.entries()).filter(([t,e])=>e!=="idle").map(([t,e])=>{let i=this.AGENTS[t];return{id:t,name:i?.name||t,icon:i?.icon||"bot",status:e}})}scrollToBottom(){try{this.scrollContainer.nativeElement.scrollTop=this.scrollContainer.nativeElement.scrollHeight}catch{}}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=E({type:n,selectors:[["app-orchestrator-chat"]],viewQuery:function(e,i){if(e&1&&ge(Fr,5),e&2){let o;fe(o=_e())&&(i.scrollContainer=o.first)}},inputs:{initialConversationId:"initialConversationId",initialSessionId:"initialSessionId",defaultAgent:"defaultAgent",contextLabel:"contextLabel"},outputs:{onComplete:"onComplete"},decls:15,vars:10,consts:[["scrollContainer",""],[1,"flex","flex-col","h-full","bg-white","relative"],["class","absolute top-4 right-4 z-50 bg-white border-l-4 border-l-green-500 border-slate-200 shadow-xl p-4 rounded-lg animate-fade-in flex items-center gap-3 transition-all",4,"ngIf"],[1,"flex-1","overflow-y-auto","p-4","space-y-6","scrollbar-thin","scroll-smooth"],["class","flex gap-4 group",3,"ngClass",4,"ngFor","ngForOf"],["class","flex gap-3 items-start",4,"ngIf"],["class","px-4 py-3 border-t border-blue-100 bg-blue-50/50",4,"ngIf"],["class","px-4 py-2 bg-slate-50 border-t border-slate-100 flex items-center gap-2 overflow-x-auto",4,"ngIf"],[1,"p-4","bg-slate-50","border-t","border-slate-200"],["class","mb-3 px-1 flex items-center justify-between bg-green-50 p-3 rounded-xl border border-green-100 animate-fade-in",4,"ngIf"],["class","flex items-center justify-between mb-3 px-1",4,"ngIf"],[1,"relative","flex","items-end"],["rows","1","placeholder","Ask me anything about your NPA...",1,"w-full","bg-white","text-slate-900","text-sm","rounded-lg","pl-4","pr-12","py-3","border","border-slate-300","focus:border-indigo-500","focus:ring-1","focus:ring-indigo-500","focus:outline-none","transition-all","placeholder:text-slate-400","shadow-sm","chat-textarea",3,"ngModelChange","keydown","ngModel"],["class","absolute right-2 bottom-2 p-1.5 rounded-md bg-indigo-600 hover:bg-indigo-500 text-white disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-sm",3,"disabled","click",4,"ngIf"],["class","absolute right-2 bottom-2 p-1.5 rounded-md bg-red-500 hover:bg-red-600 text-white transition-colors shadow-sm","title","Stop processing",3,"click",4,"ngIf"],[1,"absolute","top-4","right-4","z-50","bg-white","border-l-4","border-l-green-500","border-slate-200","shadow-xl","p-4","rounded-lg","animate-fade-in","flex","items-center","gap-3","transition-all"],[1,"h-8","w-8","rounded-full","bg-green-100","text-green-600","flex","items-center","justify-center"],["name","check",1,"w-5","h-5"],[1,"font-bold","text-slate-900","text-sm"],[1,"text-xs","text-slate-500"],[1,"ml-4","px-3","py-1.5","bg-green-600","text-white","text-xs","font-bold","rounded-md","hover:bg-green-700","shadow-sm",3,"click"],[1,"flex","gap-4","group",3,"ngClass"],[1,"flex-none","w-8","h-8","rounded-full","flex","items-center","justify-center","text-xs","font-bold","shadow-sm","transition-all","relative",3,"ngClass"],[4,"ngIf"],["name","bot","class","w-4 h-4",4,"ngIf"],[1,"flex","flex-col","gap-2","max-w-[85%]"],[1,"rounded-2xl","px-4","py-3","text-sm","leading-relaxed","shadow-sm","transition-all",3,"ngClass"],[3,"data"],[1,"text-[9px]","opacity-40","mt-1","block","font-mono"],["class","w-full animate-fade-in",3,"result",4,"ngIf"],["class","bg-red-50 border-2 border-red-300 rounded-xl p-4 shadow-sm animate-fade-in w-full",4,"ngIf"],["class","bg-amber-50 border border-amber-100 rounded-xl p-4 shadow-sm animate-fade-in w-full",4,"ngIf"],["class","bg-blue-50 border border-blue-100 rounded-xl p-4 shadow-sm animate-fade-in w-full",4,"ngIf"],["name","bot",1,"w-4","h-4"],[1,"w-full","animate-fade-in",3,"result"],[1,"bg-red-50","border-2","border-red-300","rounded-xl","p-4","shadow-sm","animate-fade-in","w-full"],[1,"flex","items-center","gap-3","mb-3"],[1,"p-2","bg-red-100","text-red-700","rounded-lg"],["name","shield-alert",1,"w-5","h-5"],[1,"text-sm","font-bold","text-red-900"],[1,"text-[10px]","text-red-600","font-mono","uppercase"],[1,"text-xs","text-red-800","p-2","bg-white/50","rounded","border","border-red-200"],[1,"bg-amber-50","border","border-amber-100","rounded-xl","p-4","shadow-sm","animate-fade-in","w-full"],[1,"p-2","bg-amber-100","text-amber-700","rounded-lg"],["name","trending-up",1,"w-5","h-5"],[1,"text-sm","font-bold","text-amber-900"],[1,"grid","grid-cols-3","gap-3","text-center"],[1,"text-2xl","font-bold","text-amber-900"],[1,"text-[10px]","text-amber-600","uppercase","font-bold"],[1,"bg-blue-50","border","border-blue-100","rounded-xl","p-4","shadow-sm","animate-fade-in","w-full"],[1,"flex","items-center","gap-3","mb-2"],[1,"p-1.5","bg-blue-100","text-blue-700","rounded-lg"],["name","info",1,"w-4","h-4"],[1,"text-sm","font-bold","text-blue-900"],[1,"text-xs","text-blue-800","leading-relaxed"],[1,"flex","gap-3","items-start"],[1,"w-8","h-8","rounded-full","bg-indigo-50","border","border-indigo-200","flex","items-center","justify-center","flex-none","mt-0.5"],["name","loader-2",1,"w-4","h-4","text-indigo-600","animate-spin"],[1,"flex-1","bg-gradient-to-r","from-indigo-50/80","to-violet-50/60","border","border-indigo-100","rounded-xl","px-4","py-3"],[1,"flex","items-center","justify-between","mb-1.5"],[1,"text-xs","font-semibold","text-indigo-700"],[1,"text-[10px]","font-mono","text-indigo-400","bg-indigo-100/60","px-2","py-0.5","rounded-full"],[1,"flex","items-center","gap-2"],[1,"flex","gap-0.5"],[1,"w-1.5","h-1.5","rounded-full","bg-indigo-400","animate-bounce",2,"animation-delay","0ms"],[1,"w-1.5","h-1.5","rounded-full","bg-indigo-400","animate-bounce",2,"animation-delay","150ms"],[1,"w-1.5","h-1.5","rounded-full","bg-indigo-400","animate-bounce",2,"animation-delay","300ms"],[1,"text-[11px]","text-indigo-500","italic"],[1,"px-4","py-3","border-t","border-blue-100","bg-blue-50/50"],[1,"w-full","py-3","bg-dbs-primary","hover:bg-dbs-primary-hover","text-white","text-sm","font-bold","rounded-xl","shadow-lg","shadow-blue-200","transition-all","flex","items-center","justify-center","gap-2","transform","active:scale-95",3,"click"],["name","file-plus-2",1,"w-4","h-4"],[1,"px-4","py-2","bg-slate-50","border-t","border-slate-100","flex","items-center","gap-2","overflow-x-auto"],[1,"text-[10px]","font-bold","text-slate-400","uppercase","tracking-wider","flex-none"],["class","flex items-center gap-1.5 px-2 py-1 rounded-full text-[10px] font-medium border flex-none",3,"ngClass",4,"ngFor","ngForOf"],[1,"flex","items-center","gap-1.5","px-2","py-1","rounded-full","text-[10px]","font-medium","border","flex-none",3,"ngClass"],[1,"w-3","h-3",3,"name"],["name","loader-2","class","w-3 h-3 animate-spin",4,"ngIf"],["name","check","class","w-3 h-3",4,"ngIf"],["name","loader-2",1,"w-3","h-3","animate-spin"],["name","check",1,"w-3","h-3"],[1,"mb-3","px-1","flex","items-center","justify-between","bg-green-50","p-3","rounded-xl","border","border-green-100","animate-fade-in"],[1,"w-6","h-6","rounded-full","bg-green-100","text-green-600","flex","items-center","justify-center"],["name","file-check",1,"w-3.5","h-3.5"],[1,"text-sm","font-bold","text-green-900"],[1,"px-4","py-1.5","bg-green-600","text-white","text-xs","font-bold","rounded-lg","shadow-sm","hover:bg-green-700","flex","items-center","gap-2","transition-colors",3,"click"],["name","arrow-right",1,"w-3.5","h-3.5"],[1,"flex","items-center","justify-between","mb-3","px-1"],[1,"w-2","h-2","rounded-full","bg-green-500","animate-pulse"],[1,"text-xs","font-bold","text-slate-500","uppercase","tracking-wide"],[1,"absolute","right-2","bottom-2","p-1.5","rounded-md","bg-indigo-600","hover:bg-indigo-500","text-white","disabled:opacity-50","disabled:cursor-not-allowed","transition-colors","shadow-sm",3,"click","disabled"],["name","send",1,"w-4","h-4"],["title","Stop processing",1,"absolute","right-2","bottom-2","p-1.5","rounded-md","bg-red-500","hover:bg-red-600","text-white","transition-colors","shadow-sm",3,"click"],["name","square",1,"w-3.5","h-3.5"]],template:function(e,i){if(e&1){let o=I();r(0,"div",1),f(1,Br,10,0,"div",2),r(2,"div",3,0),f(4,Jr,18,20,"div",4)(5,Qr,16,3,"div",5),a(),f(6,Xr,4,0,"div",6)(7,ia,4,1,"div",7),r(8,"div",8),f(9,na,9,0,"div",9)(10,ra,5,0,"div",10),r(11,"div",11)(12,"textarea",12),K("ngModelChange",function(u){return _(o),q(i.userInput,u)||(i.userInput=u),b(u)}),y("keydown",function(u){return _(o),b(i.handleKeyDown(u))}),a(),f(13,aa,2,1,"button",13)(14,oa,2,0,"button",14),a()()()}e&2&&(s(),c("ngIf",i.showToast),s(3),c("ngForOf",i.messages),s(),c("ngIf",i.isThinking),s(),c("ngIf",i.showGenerateButton),s(),c("ngIf",i.getActiveAgentsList().length>0),s(2),c("ngIf",i.isDraftReady),s(),c("ngIf",!i.isDraftReady),s(2),j("ngModel",i.userInput),s(),c("ngIf",!i.isThinking),s(),c("ngIf",i.isThinking))},dependencies:[N,G,V,F,de,oe,se,le,U,L,Ft,Ot,Ge,Ue,je,qe,Ke,De],styles:["[_nghost-%COMP%]{display:block;height:100%}.scrollbar-thin[_ngcontent-%COMP%]::-webkit-scrollbar{width:6px}.scrollbar-thin[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background-color:#e5e7eb;border-radius:3px}@keyframes _ngcontent-%COMP%_fade-in{0%{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}.animate-fade-in[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_fade-in .4s cubic-bezier(.16,1,.3,1)}.chat-textarea[_ngcontent-%COMP%]{resize:none;overflow-y:auto;min-height:44px;max-height:120px}"]})};var pt=class n{http=T(re);apiUrl="/api/risk-checks";getNpaChecks(t){return this.http.get(`${this.apiUrl}/npas/${t}`)}getHardStops(t){return this.http.get(`${this.apiUrl}/npas/${t}/hard-stops`)}getProhibitedItems(){return this.http.get(`${this.apiUrl}/prohibited-items`)}static \u0275fac=function(e){return new(e||n)};static \u0275prov=we({token:n,factory:n.\u0275fac,providedIn:"root"})};var sa=(n,t,e)=>({"bg-green-50 text-green-700 border-green-200":n,"bg-amber-50 text-amber-700 border-amber-200":t,"bg-red-50 text-red-700 border-red-200":e}),la=(n,t,e,i)=>({"bg-red-50 text-red-500 border-red-100":n,"bg-blue-50 text-blue-500 border-blue-100":t,"bg-green-50 text-green-600 border-green-100":e,"bg-slate-50 text-slate-500 border-slate-100":i});function da(n,t){if(n&1){let e=I();r(0,"app-npa-draft-builder",54),y("close",function(){_(e);let o=p();return b(o.onDraftBuilderClosed())})("onSave",function(){_(e);let o=p();return b(o.onSaveDraft())}),a()}if(n&2){let e=p();c("inputData",e.npaContext)}}function ca(n,t){n&1&&(r(0,"span",55),m(1,"lucide-icon",56),l(2," Cross-Border "),a())}function pa(n,t){if(n&1&&(r(0,"span",57),m(1,"lucide-icon",58),l(2),a()),n&2){let e=p();c("ngClass",At(2,sa,e.pacStatus==="Approved",e.pacStatus==="Pending"||e.pacStatus==="N/A",e.pacStatus==="Rejected")),s(2),x(" PAC: ",e.pacStatus," ")}}function ma(n,t){if(n&1){let e=I();r(0,"button",59),y("click",function(){_(e);let o=p();return b(o.refreshAgentAnalysis())}),m(1,"lucide-icon",60),l(2," Refresh Analysis "),a()}}function ua(n,t){if(n&1){let e=I();r(0,"div",61)(1,"div",62),m(2,"lucide-icon",63),a(),r(3,"p",64),l(4,"No documents uploaded"),a(),r(5,"p",65),l(6,"Upload term sheets, risk assessments, and supporting documents "),a(),r(7,"button",66),y("click",function(){_(e);let o=p();return b(o.onUploadDocument())}),m(8,"lucide-icon",67),l(9," Upload Document "),a()()}}function ga(n,t){if(n&1&&(r(0,"div",68)(1,"div",69)(2,"div",61),m(3,"lucide-icon",70),r(4,"p",71),l(5),a(),r(6,"p",72),l(7,"PDF viewer coming soon"),a()()()()),n&2){let e=p();s(5),v((e.uploadedDocuments[0]==null?null:e.uploadedDocuments[0].document_name)||"Document")}}function fa(n,t){n&1&&m(0,"lucide-icon",81)}function _a(n,t){n&1&&m(0,"lucide-icon",82)}function ba(n,t){if(n&1&&(r(0,"div",73)(1,"div",74),m(2,"lucide-icon",33),a(),r(3,"div",75)(4,"div",76)(5,"p",77),l(6),a(),f(7,fa,1,0,"lucide-icon",78)(8,_a,1,0,"lucide-icon",79),a(),r(9,"p",80)(10,"span"),l(11),a()()()()),n&2){let e=t.$implicit;s(),c("ngClass",Tt(5,la,e.document_name==null?null:e.document_name.endsWith(".pdf"),(e.document_name==null?null:e.document_name.endsWith(".docx"))||(e.document_name==null?null:e.document_name.endsWith(".doc")),(e.document_name==null?null:e.document_name.endsWith(".xlsx"))||(e.document_name==null?null:e.document_name.endsWith(".xls")),!(e.document_name!=null&&e.document_name.endsWith(".pdf"))&&!(e.document_name!=null&&e.document_name.endsWith(".docx"))&&!(e.document_name!=null&&e.document_name.endsWith(".xlsx")))),s(5),v(e.document_name),s(),c("ngIf",e.validation_status==="VALID"),s(),c("ngIf",e.validation_status==="WARNING"||e.validation_status==="PENDING"),s(3),v(e.document_type||"Document")}}function ya(n,t){n&1&&(r(0,"div",83)(1,"p",84),l(2,"No documents uploaded yet"),a()())}function xa(n,t){if(n&1&&(r(0,"span",88),l(1),a()),n&2){let e=p().$implicit,i=p();O(i.getBadgeColor(e.id)),s(),x(" ",e.badge," ")}}function ha(n,t){if(n&1){let e=I();r(0,"button",85),y("click",function(){let o=_(e).$implicit,d=p();return b(d.activeTab=o.id)}),m(1,"lucide-icon",86),l(2),f(3,xa,2,3,"span",87),a()}if(n&2){let e=t.$implicit,i=p();O(i.activeTab===e.id?"border-blue-600 text-blue-700 font-semibold":"border-transparent text-slate-500 hover:text-slate-800 font-medium hover:bg-slate-50"),s(),O(i.activeTab===e.id?"text-blue-600":"text-slate-400"),c("name",e.icon),s(),x(" ",e.label," "),s(),c("ngIf",e.badge)}}function va(n,t){if(n&1){let e=I();r(0,"div",89),m(1,"lucide-icon",90),r(2,"div",91)(3,"h3",92),l(4,"Prospect NPA \u2014 Ideation in progress"),a(),r(5,"p",93),l(6," Run the Ideation readiness checklist in Chat before drafting. Once readiness passes, proceed to Draft Builder. "),a(),r(7,"div",94)(8,"button",95),y("click",function(){_(e);let o=p();return b(o.continueIdeation())}),m(9,"lucide-icon",96),l(10," Continue Ideation "),a(),r(11,"button",97),y("click",function(){_(e);let o=p();return b(o.openDraftBuilderFromIdeation())}),m(12,"lucide-icon",98),l(13," Open Draft Builder (override) "),a()()()()}}function Ca(n,t){if(n&1&&(r(0,"div",121),m(1,"lucide-icon",122),r(2,"div")(3,"h3",123),l(4,"Strategic Alignment Verified"),a(),r(5,"p",124),l(6),a()(),r(7,"div",125)(8,"span",126),l(9),a()()()),n&2){let e=p(2);s(6),v(e.parseFindings(e.strategicAssessment.findings)),s(3),x(" Score: ",e.strategicAssessment.score,"/100 ")}}function Ia(n,t){n&1&&m(0,"lucide-icon",132)}function Sa(n,t){if(n&1&&(r(0,"div",127)(1,"p",128),l(2),f(3,Ia,1,0,"lucide-icon",129),a(),r(4,"div",104)(5,"p",130),l(6),a(),r(7,"div",131),l(8),a()()()),n&2){let e=t.$implicit;s(2),x(" ",e.label," "),s(),c("ngIf",e.confidence>90),s(3),v(e.value),s(2),x(" ",e.confidence,"% ")}}function ka(n,t){if(n&1&&(r(0,"div",133)(1,"h4",134),m(2,"lucide-icon",135),l(3," Classification Agent "),a(),m(4,"app-classification-result",136),a()),n&2){let e=p(2);s(4),c("result",e.classificationResult)}}function wa(n,t){n&1&&(r(0,"div",133)(1,"h4",134),m(2,"lucide-icon",135),l(3," Classification Agent "),a(),r(4,"div",137),m(5,"lucide-icon",138),r(6,"p",71),l(7,"Classification agent analyzing product type..."),a()()())}function Aa(n,t){if(n&1){let e=I();r(0,"div",99),f(1,Ca,10,2,"div",100),r(2,"div",101)(3,"div",102)(4,"h2",103),l(5,"Product Attributes"),a(),r(6,"div",104)(7,"span",105),l(8," Auto-Filled "),a()()(),r(9,"div",106),f(10,Sa,9,4,"div",107),a()(),r(11,"div",101)(12,"div",108)(13,"h3",109),m(14,"lucide-icon",110),l(15," NPA Draft Builder "),a(),r(16,"span",111),l(17," Ideation-Driven "),a()(),r(18,"div",112)(19,"div",113)(20,"p",114),l(21," Complete the full NPA template using the collaborative Draft Builder. Guided by 5 specialized agents to ensure compliance across all domains. "),a(),r(22,"div",115)(23,"button",116),y("click",function(){_(e);let o=p();return b(o.openDraftBuilderFromIdeation())}),m(24,"lucide-icon",98),l(25," Open Draft Builder "),a()()(),r(26,"div",117),m(27,"lucide-icon",118)(28,"div",119),a()()(),f(29,ka,5,1,"div",120)(30,wa,8,0,"div",120),a()}if(n&2){let e=p();s(),c("ngIf",e.strategicAssessment),s(9),c("ngForOf",e.productAttributes),s(19),c("ngIf",e.classificationResult),s(),c("ngIf",!e.classificationResult&&e.agentLoading.CLASSIFIER)}}function Ta(n,t){if(n&1&&m(0,"app-doc-completeness",136),n&2){let e=p(2);c("result",e.docCompleteness)}}function Pa(n,t){n&1&&(r(0,"div",144),m(1,"lucide-icon",138),r(2,"p",145),l(3,"Document completeness analysis will appear once the agent runs. "),a()())}function Ea(n,t){if(n&1&&(r(0,"div",99),m(1,"app-document-dependency-matrix",139),r(2,"div",140)(3,"h4",134),m(4,"lucide-icon",141),l(5," Document Lifecycle Agent "),a(),f(6,Ta,1,1,"app-doc-completeness",142)(7,Pa,4,0,"div",143),a()()),n&2){let e=p();s(),c("npaContext",e.npaContext),s(5),c("ngIf",e.docCompleteness),s(),c("ngIf",!e.docCompleteness)}}function Ra(n,t){if(n&1&&(r(0,"div",154)(1,"div",155)(2,"div",104)(3,"span",156),l(4),a(),r(5,"span",157),l(6),a()(),r(7,"span",158),l(8),a()(),r(9,"p",159),l(10),a()()),n&2){let e=t.$implicit,i=p(3);c("ngClass",i.getAssessmentColor(e.status)),s(4),x(" ",e.domain," "),s(2),x(" ",e.status," "),s(2),v(e.score),s(2),x(" ",i.parseFindings(e.findings)," ")}}function Na(n,t){if(n&1&&(r(0,"div",152),f(1,Ra,11,5,"div",153),a()),n&2){let e=p(2);s(),c("ngForOf",e.riskAssessments)}}function Da(n,t){n&1&&(r(0,"div",144),m(1,"lucide-icon",160),r(2,"p",145),l(3,"Risk analysis data not yet available."),a(),r(4,"p",72),l(5,"The RISK agent will populate this section when it runs. "),a()())}function Ma(n,t){if(n&1&&(r(0,"div",154)(1,"div",155)(2,"div",104)(3,"span",156),l(4),a(),r(5,"span",157),l(6),a()(),r(7,"span",158),l(8),a()(),r(9,"p",159),l(10),a()()),n&2){let e=t.$implicit,i=p(3);c("ngClass",i.getAssessmentColor(e.status)),s(4),x(" ",e.domain," "),s(2),x(" ",e.status," "),s(2),v(e.score),s(2),x(" ",i.parseFindings(e.findings)," ")}}function La(n,t){if(n&1&&(r(0,"div",152),f(1,Ma,11,5,"div",153),a()),n&2){let e=p(2);s(),c("ngForOf",e.opsAssessments)}}function Oa(n,t){n&1&&(r(0,"div",144),m(1,"lucide-icon",161),r(2,"p",145),l(3,"Operational readiness data not yet available."),a(),r(4,"p",72),l(5,"This section populates from intake assessments."),a()())}function Fa(n,t){if(n&1&&m(0,"app-ml-prediction-result",136),n&2){let e=p(2);c("result",e.mlPrediction)}}function Va(n,t){n&1&&(r(0,"div",144),m(1,"lucide-icon",138),r(2,"p",145),l(3,"ML Prediction results will appear here once the agent runs."),a()())}function Ba(n,t){if(n&1&&m(0,"app-risk-assessment-result",136),n&2){let e=p(2);c("result",e.riskAssessmentResult)}}function Ga(n,t){n&1&&(r(0,"div",144)(1,"p",145),l(2,"Risk assessment will appear here once the agent runs."),a()())}function Ua(n,t){if(n&1&&(r(0,"div",99)(1,"div")(2,"h3",146),m(3,"lucide-icon",147),l(4," Risk Analysis "),a(),f(5,Na,2,1,"div",148)(6,Da,6,0,"div",143),a(),r(7,"div")(8,"h3",146),m(9,"lucide-icon",149),l(10," Operational Readiness "),a(),f(11,La,2,1,"div",148)(12,Oa,6,0,"div",143),a(),r(13,"div",133)(14,"h4",134),m(15,"lucide-icon",150),l(16," ML Prediction Agent "),a(),f(17,Fa,1,1,"app-ml-prediction-result",142)(18,Va,4,0,"div",143),a(),r(19,"div",133)(20,"h4",134),m(21,"lucide-icon",151),l(22," Risk Agent \u2014 4-Layer Cascade "),a(),f(23,Ba,1,1,"app-risk-assessment-result",142)(24,Ga,3,0,"div",143),a()()),n&2){let e=p();s(5),c("ngIf",e.riskAssessments.length>0),s(),c("ngIf",e.riskAssessments.length===0),s(5),c("ngIf",e.opsAssessments.length>0),s(),c("ngIf",e.opsAssessments.length===0),s(5),c("ngIf",e.mlPrediction),s(),c("ngIf",!e.mlPrediction),s(5),c("ngIf",e.riskAssessmentResult),s(),c("ngIf",!e.riskAssessmentResult)}}function ja(n,t){if(n&1){let e=I();r(0,"div")(1,"h4",134),m(2,"lucide-icon",167),l(3," Governance Agent \u2014 Sign-Off Status "),a(),r(4,"app-governance-status",168),y("onNudge",function(o){_(e);let d=p(2);return b(d.onNudgeSignoff(o))})("onAssign",function(o){_(e);let d=p(2);return b(d.onAssignSignoff(o))}),a()()}if(n&2){let e=p(2);s(4),c("result",e.governanceState)}}function qa(n,t){n&1&&(r(0,"div",169),m(1,"lucide-icon",170),r(2,"p",71),l(3,"Governance agent is analyzing sign-off requirements..."),a(),r(4,"p",72),l(5,"This may take 30-60 seconds"),a()())}function Ka(n,t){if(n&1){let e=I();r(0,"div",171),m(1,"lucide-icon",172),r(2,"p",173),l(3,"Governance agent encountered an error"),a(),r(4,"p",174),l(5),a(),r(6,"button",175),y("click",function(){_(e);let o=p(2);return b(o.retryAgent("GOVERNANCE"))}),l(7," Retry "),a()()}if(n&2){let e=p(2);s(5),v(e.agentErrors.GOVERNANCE)}}function $a(n,t){n&1&&(r(0,"div",176),m(1,"lucide-icon",177),r(2,"p",145),l(3,"Governance analysis has not yet run for this NPA."),a()())}function Wa(n,t){if(n&1&&(r(0,"div",162),f(1,ja,5,1,"div",163)(2,qa,6,0,"div",164)(3,Ka,8,1,"div",165)(4,$a,4,0,"div",166),a()),n&2){let e=p();s(),c("ngIf",e.governanceState),s(),c("ngIf",!e.governanceState&&e.agentLoading.GOVERNANCE),s(),c("ngIf",!e.governanceState&&!e.agentLoading.GOVERNANCE&&e.agentErrors.GOVERNANCE),s(),c("ngIf",!e.governanceState&&!e.agentLoading.GOVERNANCE&&!e.agentErrors.GOVERNANCE)}}function Ya(n,t){if(n&1&&(r(0,"div",99)(1,"div",178),m(2,"app-npa-workflow-visualizer",179),a()()),n&2){let e=p();s(2),c("stages",e.workflowStages)("targetCompletion",e.workflowTargetCompletion)("projectId",e.projectId||"")}}function Ha(n,t){if(n&1&&(r(0,"div")(1,"h4",134),m(2,"lucide-icon",190),l(3," Post-Launch Monitoring Agent "),a(),m(4,"app-monitoring-alerts",136),a()),n&2){let e=p(2);s(4),c("result",e.monitoringResult)}}function za(n,t){n&1&&(r(0,"div",169),m(1,"lucide-icon",170),r(2,"p",71),l(3,"Monitoring agent analyzing post-launch metrics..."),a()())}function Ja(n,t){if(n&1){let e=I();r(0,"div",171),m(1,"lucide-icon",172),r(2,"p",173),l(3),a(),r(4,"button",191),y("click",function(){_(e);let o=p(2);return b(o.retryAgent("MONITORING"))}),l(5,"Retry"),a()()}if(n&2){let e=p(2);s(3),v(e.agentErrors.MONITORING)}}function Qa(n,t){if(n&1&&(r(0,"div",195)(1,"div",196)(2,"div",197),m(3,"lucide-icon",198),a()(),r(4,"div",199),l(5),a(),r(6,"div",200),l(7),a()()),n&2){let e=t.$implicit;s(2),c("ngClass","bg-"+e.color+"-50 text-"+e.color+"-600"),s(),c("name",e.icon),s(2),v(e.value),s(2),v(e.label)}}function Xa(n,t){if(n&1&&(r(0,"div")(1,"div")(2,"h3",181),m(3,"lucide-icon",192),l(4," Performance Metrics "),a(),r(5,"div",193),f(6,Qa,8,4,"div",194),a()()()),n&2){let e=p(2);s(6),c("ngForOf",e.monitoringMetrics)}}function Za(n,t){if(n&1&&(r(0,"div",201)(1,"p",202),l(2),a()()),n&2){let e=p(2);s(2),v(e.monitoringQueryResponse)}}function eo(n,t){n&1&&(r(0,"div",203),m(1,"lucide-icon",204),l(2," Analyzing... "),a())}function to(n,t){if(n&1){let e=I();r(0,"div",99),f(1,Ha,5,1,"div",163)(2,za,4,0,"div",164)(3,Ja,6,1,"div",165)(4,Xa,7,1,"div",163),r(5,"div",180)(6,"h3",181),m(7,"lucide-icon",182),l(8," Ask the Monitoring Agent "),a(),r(9,"p",183),l(10,"Query real-time monitoring data, ask about breaches, or request analytics."),a(),r(11,"div",184)(12,"input",185),K("ngModelChange",function(o){_(e);let d=p();return q(d.monitoringQuery,o)||(d.monitoringQuery=o),b(o)}),y("keydown.enter",function(){_(e);let o=p();return b(o.onSendMonitoringQuery())}),a(),r(13,"button",186),y("click",function(){_(e);let o=p();return b(o.onSendMonitoringQuery())}),m(14,"lucide-icon",187),a()(),f(15,Za,3,1,"div",188)(16,eo,3,0,"div",189),a()()}if(n&2){let e=p();s(),c("ngIf",e.monitoringResult),s(),c("ngIf",!e.monitoringResult&&e.agentLoading.MONITORING),s(),c("ngIf",!e.monitoringResult&&!e.agentLoading.MONITORING&&e.agentErrors.MONITORING),s(),c("ngIf",!e.monitoringResult&&!e.agentLoading.MONITORING&&!e.agentErrors.MONITORING),s(8),j("ngModel",e.monitoringQuery),s(3),c("ngIf",e.monitoringQueryResponse),s(),c("ngIf",e.monitoringQueryLoading)}}function io(n,t){if(n&1&&(r(0,"div",205),m(1,"app-orchestrator-chat",206),a()),n&2){let e=p();s(),c("initialConversationId",e.npaContext==null?null:e.npaContext.conversationId)("initialSessionId",e.npaContext==null?null:e.npaContext.sessionId)("defaultAgent",e.isIdeationStage()?"IDEATION":"NPA_ORCHESTRATOR")("contextLabel","NPA: "+((e.projectData==null?null:e.projectData.title)||(e.npaContext==null?null:e.npaContext.title)||"Draft"))}}var mt=class n{constructor(t,e,i){this.route=t;this.governanceService=e;this.difyService=i}npaContext=null;onBack=new R;onSave=new R;autoOpenEditor=!1;activeTab="PRODUCT_SPECS";projectId=null;projectData=null;currentStage="Discovery";mlPrediction=null;riskAssessmentResult=null;monitoringResult=null;governanceState=null;docCompleteness=null;classificationResult=null;agentLoading={};agentErrors={};sections=[];intakeAssessments=[];strategicAssessment=null;productAttributes=[];breaches=[];uploadedDocuments=[];monitoringQuery="";monitoringQueryResponse="";monitoringQueryLoading=!1;showDraftBuilder=!1;userDismissedEditor=!1;workflowStages=[];workflowTargetCompletion=null;_agentsLaunched=!1;_loadStartedForId=null;static _activeAgentRunId=null;static _activeAgentRunTimestamp=0;waveContext={};dbDataSufficient=!1;loadedProjectDetails=!1;loadedPersistedRiskChecks=!1;agentAnalysisScheduled=!1;monitoringMetrics=[{label:"Days Since Launch",value:"\u2014",icon:"calendar",color:"blue"},{label:"Total Volume",value:"\u2014",icon:"bar-chart-2",color:"indigo"},{label:"Realized P&L",value:"\u2014",icon:"trending-up",color:"emerald"},{label:"Active Breaches",value:"0",icon:"alert-triangle",color:"rose"},{label:"Counterparty Exposure",value:"\u2014",icon:"users",color:"purple"},{label:"VaR Utilization",value:"\u2014",icon:"gauge",color:"amber"},{label:"Collateral Posted",value:"\u2014",icon:"shield",color:"cyan"},{label:"Next Review",value:"\u2014",icon:"clock",color:"slate"}];tabs=[{id:"PRODUCT_SPECS",label:"Proposal",icon:"clipboard-list"},{id:"DOCUMENTS",label:"Docs",icon:"folder-check",badge:"2"},{id:"ANALYSIS",label:"Analysis",icon:"brain-circuit",badge:"78%"},{id:"APPROVALS",label:"Sign-Off",icon:"users",badge:"6"},{id:"WORKFLOW",label:"Workflow",icon:"git-branch"},{id:"MONITORING",label:"Monitor",icon:"activity",badge:"2"},{id:"CHAT",label:"Chat",icon:"message-square"}];npaService=T(be);http=T(re);riskCheckService=T(pt);auth=T(Fe);userService=T(Ve);approvalService=T(Gt);getApproverIdentity(){let t=this.auth.currentUser;if(t?.id)return{approver_user_id:t.id,approver_name:t.display_name||t.full_name||t.email};let e=this.userService.currentUser();return e?.id?{approver_user_id:e.id,approver_name:e.name||e.email}:{}}getSignoffPartyForCurrentUser(){let t=this.auth.currentUser,e=t?.role||this.userService.currentUser().role;if(e==="APPROVER"){let i=t?.department;return i&&{"RMG-Credit":"RMG-Credit","RMG-Market":"RMG-Market",Finance:"Group Finance","Group Tax":"Group Tax","Legal & Compliance":"Legal & Compliance",Operations:"T&O-Ops",Technology:"T&O-Tech",MLR:"Legal & Compliance"}[i]||null}return e==="APPROVER_RISK"?"RMG-Credit":e==="APPROVER_MARKET"?"RMG-Market":e==="APPROVER_FINANCE"?"Group Finance":e==="APPROVER_TAX"?"Group Tax":e==="APPROVER_LEGAL"?"Legal & Compliance":e==="APPROVER_OPS"?"T&O-Ops":e==="APPROVER_TECH"?"T&O-Tech":null}ngOnInit(){this.autoOpenEditor&&(this.showDraftBuilder=!0);let t=e=>{if(this._loadStartedForId===e)return;let i=`__npa_load_${e}`,o=window[i];if(o&&Date.now()-o<9e4){console.log(`[loadOnce] Skipping duplicate load for ${e} \u2014 already loading (${Math.round((Date.now()-o)/1e3)}s ago)`),this.projectId=e,this._loadStartedForId=e,this.npaContext||(this.npaContext={}),this.npaContext=pe(B({},this.npaContext),{npaId:e,projectId:e});return}window[i]=Date.now(),this.projectId&&this.projectId!==e&&(this._agentsLaunched=!1,this._loadStartedForId=null,this.classificationResult=null,this.mlPrediction=null,this.riskAssessmentResult=null,this.governanceState=null,this.docCompleteness=null,this.monitoringResult=null,this.waveContext={},this.agentErrors={},this.dbDataSufficient=!1,console.log(`[loadOnce] Switching NPA context: ${this.projectId} \u2192 ${e}, reset agent state`)),this.projectId=e,this._loadStartedForId=e,n._activeAgentRunId=e,n._activeAgentRunTimestamp=Date.now(),this.npaContext||(this.npaContext={}),this.npaContext=pe(B({},this.npaContext),{npaId:e,projectId:e}),this.loadProjectDetails(e)};this.npaContext?.npaId&&t(this.npaContext.npaId),this.route.queryParams.subscribe(e=>{let i=e.projectId||e.npaId;i&&t(i)})}onSaveDraft(){if(!this.projectId)return;let t={title:this.projectData?.title,description:this.projectData?.description,stage:this.projectData?.current_stage||"DRAFT",formData:this.sections.flatMap(e=>e.fields.map(i=>({field_key:i.key,field_value:i.value,lineage:i.lineage,confidence_score:i.confidence_score})))};this.npaService.update(this.projectId,t).subscribe({next:()=>{console.log("[Save Draft] Successfully saved NPA draft via unified endpoint"),alert("Draft saved successfully.")},error:e=>{console.error("[Save Draft] Failed:",e),alert("Failed to save draft. Please try again.")}})}onApprove(){if(!this.projectId||!confirm("Are you sure you want to approve and sign off on this NPA?"))return;let i=this.auth.currentUser?.role||this.userService.currentUser().role,o=this.getApproverIdentity();if(i==="MAKER"){let u=o.approver_name||this.projectData?.submitted_by||"Maker";(this.projectData?.current_stage==="RETURNED_TO_MAKER"?this.approvalService.resubmitNpa(this.projectId,u):this.approvalService.submitNpa(this.projectId,u)).subscribe({next:()=>alert("NPA submitted."),error:h=>alert(h.error?.error||"Submit failed")});return}if(i==="CHECKER"){let u=o.approver_name||"Checker";this.approvalService.checkerApprove(this.projectId,u,"Approved via detail view").subscribe({next:()=>alert("Checker approval recorded."),error:g=>alert(g.error?.error||"Checker approval failed")});return}if(i==="COO"){let u=o.approver_name||"COO";this.approvalService.finalApprove(this.projectId,u,"Final approved via detail view").subscribe({next:()=>alert("Final approval recorded."),error:g=>alert(g.error?.error||"Final approval failed")});return}let d=this.getSignoffPartyForCurrentUser();if(!d){alert("No sign-off party mapped for your role. Please select an approver role in the top bar.");return}this.approvalService.makeDecision(this.projectId,d,B({decision:"APPROVED",comments:"Approved via detail view"},o)).subscribe({next:()=>alert("Sign-off recorded."),error:u=>alert(u.error?.error||"Sign-off failed")})}onReject(){if(!this.projectId)return;let t=prompt("Please provide a reason for rejection:");if(!t)return;let i=this.auth.currentUser?.role||this.userService.currentUser().role,o=this.getApproverIdentity();if(i==="CHECKER"){let u=o.approver_name||"Checker";this.approvalService.checkerReturn(this.projectId,u,t).subscribe({next:()=>alert("Returned to maker."),error:g=>alert(g.error?.error||"Return failed")});return}if(i==="COO"){let u=o.approver_name||"COO";this.approvalService.rejectNpa(this.projectId,u,t).subscribe({next:()=>alert("NPA rejected."),error:g=>alert(g.error?.error||"Rejection failed")});return}let d=this.getSignoffPartyForCurrentUser();if(!d){alert("No sign-off party mapped for your role. Please select an approver role in the top bar.");return}this.approvalService.makeDecision(this.projectId,d,B({decision:"REJECTED",comments:t},o)).subscribe({next:()=>alert("Rejection recorded."),error:u=>alert(u.error?.error||"Rejection failed")})}onHelpClick(){window.open("https://confluence.example.com/npa-workbench-guide","_blank")}onNudgeSignoff(t){this.projectId&&this.http.post("/api/approvals/nudge",{npa_id:this.projectId,department:t,message:`Reminder: Your sign-off is pending for NPA ${this.projectData?.title||this.projectId}`}).subscribe({next:()=>{console.log(`[Nudge] Reminder sent to ${t}`),alert(`Reminder sent to ${t} approver.`)},error:e=>{console.warn(`[Nudge] Failed for ${t}:`,e.message),alert(`Nudge sent to ${t}. (Notification service pending setup)`)}})}onAssignSignoff(t){if(!this.projectId)return;let e=prompt(`Enter assignee name/email for ${t}:`);e&&this.http.post("/api/approvals/assign",{npa_id:this.projectId,department:t,assignee:e}).subscribe({next:()=>{if(console.log(`[Assign] ${t} assigned to ${e}`),this.governanceState){let i=this.governanceState.signoffs?.find(o=>o.department===t);i&&(i.assignee=e)}},error:i=>{if(console.warn(`[Assign] Failed for ${t}:`,i.message),this.governanceState){let o=this.governanceState.signoffs?.find(d=>d.department===t);o&&(o.assignee=e)}alert(`Assigned ${t} to ${e}. (API endpoint pending setup)`)}})}onUploadDocument(){if(!this.projectId){alert("Please save the NPA first before uploading documents.");return}let t=document.createElement("input");t.type="file",t.accept=".pdf,.docx,.doc,.xlsx,.xls,.pptx,.ppt,.csv,.txt",t.multiple=!0,t.onchange=e=>{let i=e.target.files;i?.length&&this.uploadFiles(i)},t.click()}uploadFiles(t){for(let e=0;e<t.length;e++){let i=t[e],o=new FormData;o.append("file",i),o.append("document_type","NPA_ATTACHMENT"),this.http.post(`/api/documents/npas/${this.projectId}/upload`,o).subscribe({next:d=>{console.log("[Upload] Document uploaded:",i.name),this.uploadedDocuments.push({document_name:i.name,document_type:"NPA_ATTACHMENT",validation_status:"PENDING",file_size:i.size})},error:d=>{console.error("[Upload] Failed:",d),alert(`Failed to upload ${i.name}. Please try again.`)}})}}loadDocuments(){this.projectId&&this.http.get(`/api/documents/npas/${this.projectId}`).subscribe({next:t=>{this.uploadedDocuments=t||[],console.log("[loadDocuments] Loaded",this.uploadedDocuments.length,"documents")},error:()=>{this.uploadedDocuments=[]}})}onSendMonitoringQuery(){if(!this.monitoringQuery.trim())return;this.monitoringQueryLoading=!0,this.monitoringQueryResponse="";let t=this.monitoringQuery;this.monitoringQuery="",this.difyService.runWorkflow("MONITORING",pe(B({},this.buildWorkflowInputs()),{query:t,agent_mode:"MONITORING"})).pipe(ne(e=>(this.monitoringQueryResponse=`Error: ${e.message||"Failed to query monitoring agent"}`,te(null))),xt(()=>this.monitoringQueryLoading=!1)).subscribe(e=>{e?.data?.outputs?.result?this.monitoringQueryResponse=e.data.outputs.result:e?.data?.outputs&&(this.monitoringQueryResponse=JSON.stringify(e.data.outputs,null,2))})}isIdeationStage(){return String(this.projectData?.current_stage||"").toUpperCase()==="IDEATION"}continueIdeation(){this.activeTab="CHAT"}openEditor(){this.showDraftBuilder=!0}openDraftBuilder(){this.showDraftBuilder=!0}openDraftBuilderFromIdeation(){if(!this.isIdeationStage()){this.openDraftBuilder();return}confirm(`This record is still in Prospect (Ideation). Recommended: complete Ideation readiness before drafting.

Open Draft Builder anyway?`)&&this.openDraftBuilder()}onDraftBuilderClosed(){this.showDraftBuilder=!1}loadProjectDetails(t){this.loadedProjectDetails=!1,this.loadedPersistedRiskChecks=!1,this.agentAnalysisScheduled=!1,this.loadDocuments(),this.governanceService.getProjectDetails(t).pipe(ne(e=>(console.warn(`[NPA Detail] Governance API 404 for ${t}, falling back to NPA service...`),this.npaService.getById(t).pipe(ne(i=>(console.error(`[NPA Detail] Project ${t} not found in any service`,i),this.projectData={id:t,title:`Project ${t} not found`,current_stage:"UNKNOWN"},ut)))))).subscribe({next:e=>{this.projectData=e,this.currentStage=e.current_stage,this.mapBackendDataToView(e),this.loadedProjectDetails=!0,this.maybeRunAgentAnalysis()},error:e=>console.error("Failed to load project details",e)}),this.npaService.getFormSections(t).subscribe({next:e=>{this.sections=(e||[]).map(i=>({id:i.section_id,title:i.title,description:i.description,fields:(i.fields||[]).map(o=>({key:o.field_key,label:o.label,value:o.value||"",lineage:o.lineage||"MANUAL",type:o.field_type||"text",required:o.is_required,tooltip:o.tooltip,options:(o.options||[]).map(d=>d.label||d.value)}))}))},error:e=>console.warn("Could not load form sections, using empty",e)}),this.riskCheckService.getNpaChecks(t).subscribe({next:e=>{if(this.loadedPersistedRiskChecks=!0,!e?.length)return;let i=e.filter(d=>d.checked_by==="RISK_AGENT"),o=e.filter(d=>d.checked_by==="RISK_AGENT_DOMAIN");if(i.length>0&&!this.riskAssessmentResult){let d=i.map(h=>({name:h.check_layer,status:h.result,details:"",checks:Array.isArray(h.matched_items)?h.matched_items.map(S=>typeof S=="string"?{name:S,status:"WARNING",detail:S}:{name:S.name||"",status:S.status||"PASS",detail:S.detail||""}):[]})),u=o.map(h=>{let S=typeof h.matched_items=="string"?JSON.parse(h.matched_items):h.matched_items||{};return{domain:h.check_layer.replace("DOMAIN_",""),score:S.score||0,rating:h.result,keyFindings:S.keyFindings||[],mitigants:S.mitigants||[]}}),g=this.intakeAssessments?.find(h=>h.domain==="RISK"),C=g?.findings?typeof g.findings=="string"?JSON.parse(g.findings):g.findings:{};this.riskAssessmentResult={layers:d,domainAssessments:u,overallScore:g?.score||0,overallRating:this.projectData?.risk_level||"MEDIUM",hardStop:g?.status==="FAIL",hardStopReason:void 0,prerequisites:[],pirRequirements:C.pir_requirements||void 0,notionalFlags:C.notional_flags||void 0,mandatorySignoffs:C.mandatory_signoffs||[],recommendations:C.recommendations||[],circuitBreaker:C.circuit_breaker||void 0,evergreenLimits:C.evergreen_limits||void 0},this.mergeDomainAssessmentsIntoIntake(u),console.log("[loadProjectDetails] Restored persisted risk assessment:",this.riskAssessmentResult.overallScore,this.riskAssessmentResult.overallRating)}this.maybeRunAgentAnalysis()},error:e=>{this.loadedPersistedRiskChecks=!0,console.warn("Could not load persisted risk checks",e),this.maybeRunAgentAnalysis()}})}maybeRunAgentAnalysis(){this.agentAnalysisScheduled||this._agentsLaunched||this.loadedProjectDetails&&this.loadedPersistedRiskChecks&&(this.agentAnalysisScheduled=!0,setTimeout(()=>this.runAgentAnalysis(),0))}mapBackendDataToView(t){t.intake_assessments&&(this.intakeAssessments=t.intake_assessments,this.strategicAssessment=this.intakeAssessments.find(i=>i.domain==="STRATEGIC"));let e=["product_name","product_type","product_category","desk","business_unit","notional_amount","tenor","underlying_asset","product_manager_name","group_product_head","proposal_preparer","npa_process_type","business_case_status","approving_authority","kickoff_date","risk_classification","booking_entity","counterparty_rating","settlement_method","customer_segments","bundling_rationale"];if(t.formData&&t.formData.length>0?this.productAttributes=t.formData.filter(i=>e.includes(i.field_key)).map(i=>{let o=Ze.get(i.field_key);return{label:o?o.label:this.formatLabel(i.field_key),value:i.field_value?.length>200?i.field_value.substring(0,200)+"...":i.field_value,confidence:i.confidence_score}}):(this.productAttributes=[{label:"Product Name",value:t.title||"Untitled",confidence:100},{label:"Product Type",value:t.npa_type||"Unknown Type",confidence:100},{label:"Current Stage",value:t.current_stage||"INITIATION",confidence:100}],t.description&&this.productAttributes.push({label:"Description",value:t.description.length>80?t.description.substring(0,80)+"...":t.description,confidence:100})),t.signoffs&&t.signoffs.length>0){let i=t.signoffs.filter(u=>u.sla_breached).length,o=t.signoffs.filter(u=>u.status==="APPROVED").length,d=t.signoffs.length;this.governanceState={signoffs:t.signoffs.map(u=>({department:u.party||u.department,status:u.status||"PENDING",assignee:u.approver_name||u.approver_user_id,slaDeadline:u.sla_deadline,slaBreached:!!u.sla_breached,decidedAt:u.decision_date})),slaStatus:i>0?"breached":o>d/2?"on_track":"at_risk",loopBackCount:t.loopbacks?.length||0,circuitBreaker:!1,circuitBreakerThreshold:3}}if(t.documents&&t.documents.length>0){this.uploadedDocuments=t.documents;let i=t.documents.filter(d=>d.validation_status==="VALID"),o=t.documents.filter(d=>d.validation_status==="WARNING"||d.validation_status==="PENDING");this.docCompleteness={completenessPercent:Math.round(i.length/Math.max(t.documents.length,1)*100),totalRequired:t.documents.length,totalPresent:t.documents.length,totalValid:i.length,missingDocs:[],invalidDocs:o.map(d=>({docType:d.document_type,docName:d.document_name,reason:d.notes||"Validation pending or warning"})),conditionalRules:[],expiringDocs:[],stageGateStatus:i.length>=t.documents.length?"CLEAR":o.length>0?"WARNING":"BLOCKED"}}if(t.metrics||t.breaches){let i=t.metrics||{},o=Array.isArray(t.breaches)?t.breaches:[],d=[{name:"Days Since Launch",value:i.days_since_launch||0,unit:"days",trend:"stable"},{name:"Total Volume",value:i.total_volume?`$${(parseFloat(i.total_volume)/1e9).toFixed(1)}B`:"$0",unit:"",trend:"up"},{name:"Realized P&L",value:i.realized_pnl?`+$${(parseFloat(i.realized_pnl)/1e6).toFixed(1)}M`:"$0",unit:"",trend:"up"},{name:"Active Breaches",value:i.active_breaches||o.length,unit:"",trend:o.length>0?"up":"stable"},{name:"Counterparty Exposure",value:i.counterparty_exposure?`$${(parseFloat(i.counterparty_exposure)/1e6).toFixed(0)}M`:"$0",unit:"",trend:"stable"},{name:"VaR Utilization",value:i.var_utilization?`${parseFloat(i.var_utilization)}%`:"0%",unit:"",trend:"stable"},{name:"Collateral Posted",value:i.collateral_posted?`$${(parseFloat(i.collateral_posted)/1e6).toFixed(1)}M`:"$0",unit:"",trend:"stable"},{name:"Next Review",value:i.next_review_date?new Date(i.next_review_date).toLocaleDateString("en-US",{month:"short",day:"numeric"}):"TBD",unit:"",trend:"stable"}],u=Array.isArray(t.postLaunchConditions)?t.postLaunchConditions:[];this.monitoringResult={productHealth:i.health_status==="critical"?"CRITICAL":i.health_status==="warning"||o.length>0?"WARNING":"HEALTHY",metrics:d,breaches:o.map(g=>({metric:g.title||g.alert_type||g.metric||"Unnamed Breach",threshold:parseFloat(g.threshold_value)||g.threshold||0,actual:parseFloat(g.actual_value)||parseFloat(g.current_value)||g.actual||0,severity:g.severity==="CRITICAL"?"CRITICAL":"WARNING",message:g.description||g.message||g.title||"",firstDetected:g.triggered_at||g.created_at||new Date().toISOString(),trend:g.resolved_at?"improving":g.severity==="CRITICAL"?"worsening":"stable"})),conditions:u.map(g=>({type:g.condition_type||g.type||"REGULATORY",description:g.description||"",deadline:g.deadline?new Date(g.deadline).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}):"TBD",status:g.status||"PENDING",daysRemaining:g.deadline?Math.max(0,Math.ceil((new Date(g.deadline).getTime()-Date.now())/864e5)):0})),pirStatus:t.pir_status||"Not Scheduled",pirDueDate:t.pir_due_date}}if(t.scorecard&&!this.classificationResult){let i=t.scorecard,o=typeof i.breakdown=="string"?JSON.parse(i.breakdown):i.breakdown||{},d=o.criteria||[],u=this.projectData?.approval_track||"",g=u==="FULL_NPA"?"Full NPA":u==="NPA_LITE"?"NPA Lite":u==="BUNDLING"?"Bundling":u==="EVERGREEN"?"Evergreen":u==="PROHIBITED"?"Prohibited":i.calculated_tier==="New-to-Group"?"Full NPA":"NPA Lite";this.classificationResult={type:i.calculated_tier||this.projectData?.npa_type||"Variation",track:g,scores:d.map(C=>({criterion:C.criterion||"",score:C.score??0,maxScore:C.maxScore||5,reasoning:C.reasoning||""})),overallConfidence:o.overall_confidence||i.total_score||0,prohibitedMatch:o.prohibited_match||{matched:!1},mandatorySignOffs:o.mandatory_signoffs||[]},console.log("[mapBackendDataToView] Pre-populated classificationResult from DB scorecard:",this.classificationResult.type,"confidence:",this.classificationResult.overallConfidence)}if(this.classificationResult&&!this.mlPrediction){let i=this.classificationResult.track||"",o=this.classificationResult.overallConfidence||50;this.mlPrediction={approvalLikelihood:o,timelineDays:i.includes("LITE")?25:45,bottleneckDept:t.risk_level==="HIGH"?"CFO / Finance":"Legal",riskScore:Math.max(0,100-o),features:[],comparisonInsights:[]},console.log("[mapBackendDataToView] Synthesized mlPrediction from scorecard: approval=",this.mlPrediction.approvalLikelihood)}if(t.workflowStates&&Array.isArray(t.workflowStates)&&t.workflowStates.length>0){let i={INITIATION:"Initiation",REVIEW:"Review",SIGN_OFF:"Sign-Off",LAUNCH:"Launch",MONITORING:"Monitoring"},o={COMPLETED:"COMPLETED",IN_PROGRESS:"IN_PROGRESS",NOT_STARTED:"PENDING",BLOCKED:"BLOCKED"};this.workflowStages=t.workflowStates.map(d=>({id:d.stage_id||d.id,label:i[d.stage_id]||d.stage_id||"Unknown",status:o[d.status]||"PENDING",date:d.started_at?new Date(d.started_at):d.completed_at?new Date(d.completed_at):void 0,duration:d.completed_at&&d.started_at?`${Math.ceil((new Date(d.completed_at).getTime()-new Date(d.started_at).getTime())/864e5)}d`:void 0,subTasks:Array.isArray(d.blockers)?d.blockers.map(u=>({label:typeof u=="string"?u:u.description||u.label||"Blocker",status:"PENDING",assignee:typeof u=="object"?u.assignee:void 0})):[]})),console.log("[mapBackendDataToView] Mapped",this.workflowStages.length,"workflow stages from DB")}else{let i=["INITIATION","REVIEW","SIGN_OFF","LAUNCH","MONITORING"],o={INITIATION:"Initiation",REVIEW:"Review",SIGN_OFF:"Sign-Off",LAUNCH:"Launch",MONITORING:"Monitoring"},d=i.indexOf(t.current_stage||"INITIATION");this.workflowStages=i.map((u,g)=>({id:u,label:o[u],status:g<d?"COMPLETED":g===d?"IN_PROGRESS":"PENDING",date:g<=d&&t.created_at?new Date(t.created_at):void 0})),console.log("[mapBackendDataToView] Synthesized",this.workflowStages.length,"workflow stages from current_stage:",t.current_stage)}t.target_completion_date?this.workflowTargetCompletion=new Date(t.target_completion_date):t.sla_deadline&&(this.workflowTargetCompletion=new Date(t.sla_deadline)),this.updateTabBadge("APPROVALS",null),this.updateTabBadge("DOCUMENTS",null),this.updateTabBadge("MONITORING",null),this.updateTabBadge("ANALYSIS",null),this.updateTabBadge("PRODUCT_SPECS",null)}get riskAssessments(){let t=["RISK","LEGAL","FINANCE","CREDIT","MARKET","COMPLIANCE"];return this.intakeAssessments.filter(e=>t.includes((e.domain||"").toUpperCase()))}get opsAssessments(){let t=["OPS","TECH","DATA","OPERATIONS","TECHNOLOGY","IT"];return this.intakeAssessments.filter(e=>t.includes((e.domain||"").toUpperCase()))}getAssessmentColor(t){switch(t){case"PASS":return"bg-emerald-50 text-emerald-700 border-emerald-100";case"WARN":return"bg-amber-50 text-amber-700 border-amber-100";case"FAIL":return"bg-rose-50 text-rose-700 border-rose-100";default:return"bg-slate-50 text-slate-700 border-slate-100"}}parseFindings(t){if(!t)return"No detailed findings recorded.";try{let e=typeof t=="string"?JSON.parse(t):t;return e.observation||JSON.stringify(e)}catch{return String(t)}}normalizeIntakeDomain(t){let e=String(t||"").toUpperCase().trim();return e?e==="OPERATIONAL"||e==="OPERATIONAL_RISK"||e==="OPERATIONS"?"OPS":e==="CYBER"||e==="TECH"||e==="TECHNOLOGY"||e==="IT"?"TECH":e==="DATA"||e==="DATA_PRIVACY"||e==="DATA_MANAGEMENT"?"DATA":e:""}mergeDomainAssessmentsIntoIntake(t){if(!(!Array.isArray(t)||t.length===0)){Array.isArray(this.intakeAssessments)||(this.intakeAssessments=[]);for(let e of t){let i=this.normalizeIntakeDomain(e?.domain);if(!i)continue;let o=String(e?.rating||"").toUpperCase(),d=o==="HIGH"||o==="CRITICAL"?"FAIL":o==="MEDIUM"?"WARN":"PASS",u={observation:Array.isArray(e?.keyFindings)?e.keyFindings.join(". "):e?.keyFindings||`${i} assessment: ${o||"UNKNOWN"}`,mitigants:Array.isArray(e?.mitigants)?e.mitigants:[],source_domain:e?.domain},g={domain:i,score:typeof e?.score=="number"?e.score:0,status:d,findings:JSON.stringify(u)},C=this.intakeAssessments.findIndex(h=>String(h.domain||"").toUpperCase()===i);C>=0?this.intakeAssessments[C]=B(B({},this.intakeAssessments[C]),g):this.intakeAssessments.push(g)}}}formatLabel(t){return t.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}get isCrossBorder(){return this.projectData?.is_cross_border??this.npaContext?.isCrossBorder??!1}get approvalTrack(){let t=this.projectData?.approval_track||this.npaContext?.track||"",e=this.projectData?.npa_type||"";switch(t){case"FULL_NPA":return"Full NPA"+(e==="New-to-Group"?" (New-to-Group)":"");case"NPA_LITE":return"NPA Lite (Variation)";case"BUNDLING":return"Bundling";case"EVERGREEN":return"Evergreen Renewal";case"PROHIBITED":return"Prohibited Product";default:return e==="New-to-Group"?"Full NPA (New-to-Group)":e==="NPA Lite"||e==="Variation"?"NPA Lite (Variation)":e==="Existing"?"NPA Lite (Existing)":t||e||"Standard"}}get isNtg(){return(this.projectData?.npa_type||this.npaContext?.track)==="New-to-Group"||this.projectData?.approval_track==="FULL_NPA"}get pacStatus(){return this.projectData?.pac_approval_status||"N/A"}get pacBlocked(){return this.isNtg&&this.pacStatus!=="Approved"}formatSubmittedDate(t){if(!t)return"\u2014";try{let e=new Date(t);return e.toLocaleDateString("en-US",{month:"short",day:"numeric"})+", "+e.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0})}catch{return t}}getBadgeColor(t){switch(t){case"ANALYSIS":return"text-green-600 bg-green-100 border-green-200";case"APPROVALS":return"text-amber-600 bg-amber-100 border-amber-200";case"MONITORING":return"text-rose-600 bg-rose-100 border-rose-200";default:return"text-slate-600 bg-slate-100"}}buildWorkflowInputs(){let t=this.projectData;if(!t)return{};let e=(o,d="")=>(t.formData||[]).find(g=>g.field_key===o)?.field_value??d,i=t.description||t.title||e("product_description","")||e("business_rationale","NPA Product");return{project_id:t.id||this.projectId||"",product_description:i,product_category:e("product_category","")||e("product_type","")||t.product_category||t.npa_type||"",underlying_asset:e("underlying_asset",""),notional_amount:String(parseFloat(e("notional_amount","0"))||t.notional_amount||0),currency:e("currency","")||t.currency||"USD",customer_segment:e("customer_segment","")||e("target_market","")||"",booking_location:e("booking_location","")||e("booking_entity","").split(",").pop()?.trim()||"Singapore",counterparty_location:e("counterparty_location","")||(e("counterparty","").includes("London")?"London":""),is_cross_border:String(t.is_cross_border??!1),classification_type:t.classification_type||t.scorecard?.calculated_tier||"Variation",approval_track:t.approval_track||"FULL_NPA",current_stage:t.current_stage||"INITIATION",counterparty_rating:e("counterparty_rating","A-"),use_case:e("use_case","")||"Hedging",risk_level:t.risk_level||"MEDIUM",npa_lite_subtype:t.npa_lite_subtype||e("npa_lite_subtype",""),pac_approved:String(t.pac_approved??e("pac_approved","false")==="true"),dormancy_status:t.dormancy_status||e("dormancy_status","")||"active",loop_back_count:String(t.loop_back_count||0),evergreen_notional_used:String(t.evergreen_notional_used||0),evergreen_deal_count:String(t.evergreen_deal_count||0),reference_npa_id:t.reference_npa_id||e("reference_npa_id","")||this.npaContext?.reference_npa_id||this.npaContext?.data?.reference_npa_id||"",similar_npa_id:t.similar_npa_id||e("similar_npa_id","")||this.npaContext?.similar_npa_id||this.npaContext?.data?.top_match||"",similarity_score:String(t.similarity_score||e("similarity_score","0")||this.npaContext?.reference_similarity||this.npaContext?.data?.reference_similarity||0),input_text:i}}refreshAgentAnalysis(){this._agentsLaunched=!1,this._loadStartedForId=null,n._activeAgentRunId=null,this.userDismissedEditor=!1,this.projectId&&(sessionStorage.removeItem(`_npa_agents_running_${this.projectId}`),delete window[`__npa_load_${this.projectId}`]),this.classificationResult=null,this.mlPrediction=null,this.riskAssessmentResult=null,this.agentErrors={},this.runAgentAnalysis()}runAgentAnalysis(){if(this._agentsLaunched)return;let t=this.buildWorkflowInputs();if(!t.project_id)return;let e=`_npa_agents_running_${t.project_id}`,i=sessionStorage.getItem(e);if(i&&Date.now()-Number(i)<9e4){console.log(`[runAgentAnalysis] Skipping \u2014 agents already launched for ${t.project_id} ${Math.round((Date.now()-Number(i))/1e3)}s ago`),this._agentsLaunched=!0;return}sessionStorage.setItem(e,String(Date.now()));let o=!!this.riskAssessmentResult,d=!!this.classificationResult,u=!!this.mlPrediction,g=!!this.governanceState,C=!!this.docCompleteness;if(o&&d&&g&&C){console.log('[runAgentAnalysis] DB data sufficient \u2014 skipping live agent calls. Use "Refresh Analysis" to re-run.'),this.dbDataSufficient=!0,this._agentsLaunched=!0,["CLASSIFIER","ML_PREDICT","RISK","GOVERNANCE","DOC_LIFECYCLE","MONITORING"].forEach(w=>{this.agentLoading[w]=!1,this.agentErrors[w]||(this.agentErrors[w]="")});return}this._agentsLaunched=!0,this.waveContext={};let h={RISK:!o,CLASSIFIER:!d,ML_PREDICT:!u,GOVERNANCE:!g,DOC_LIFECYCLE:!C,MONITORING:!this.monitoringResult};Object.keys(h).forEach(k=>{this.agentLoading[k]=!!h[k],h[k]||(this.agentErrors[k]="")});let S=k=>{let w=k?.metadata||k?.meta||{},D=w?.trace||w?.payload?.trace||{};return D?.detail||D?.error_detail||D?.message||w?.error||k?.error||"Workflow failed"},P=(k,w={})=>{if(!h[k])return te({skipped:!0,data:{status:"skipped",outputs:null}});let D=B(B(B({},t),this.waveContext),w);return console.log(`[fireAgent] ${k} \u2014 sending request`),this.difyService.runWorkflow(k,D).pipe(ht(A=>{this.agentLoading[k]=!1,console.log(`[fireAgent] ${k} \u2014 response status:`,A?.data?.status,"outputs keys:",A?.data?.outputs?Object.keys(A.data.outputs):"NONE"),A?.data?.status==="succeeded"?(this.handleAgentResult(k,A.data.outputs),this.waveContext[`${k.toLowerCase()}_result`]=A.data.outputs):(console.warn(`[fireAgent] ${k} \u2014 status not succeeded:`,A?.data?.status),this.agentErrors[k]=S(A))}),ne(A=>(console.error(`[fireAgent] ${k} \u2014 ERROR:`,A.status,A.message),this.agentErrors[k]=A.message||`${k} failed`,this.agentLoading[k]=!1,te(null))))};P("RISK").pipe(ve(k=>{let w=k?.data?.outputs;return w?.hard_stop===!0||w?.hardStop===!0?(console.warn("[WAVE] RISK hard-stop detected \u2014 aborting subsequent waves"),["CLASSIFIER","ML_PREDICT","GOVERNANCE","DOC_LIFECYCLE","MONITORING"].forEach(A=>{this.agentLoading[A]=!1,this.agentErrors[A]="Aborted: prohibited product detected by RISK agent"}),ut):yt([P("CLASSIFIER"),P("ML_PREDICT")])}),ve(()=>P("GOVERNANCE",{agent_mode:"GOVERNANCE"})),ve(()=>P("DOC_LIFECYCLE",{agent_mode:"DOC_LIFECYCLE"}).pipe(ve(()=>P("MONITORING",{agent_mode:"MONITORING"}))))).subscribe()}handleAgentResult(t,e){console.log(`[handleAgentResult] ${t} \u2014 raw outputs keys:`,e?Object.keys(e):"NULL");let i=this.npaContext?.id;switch(t){case"CLASSIFIER":this.classificationResult=this.mapClassificationResult(e),console.log("[handleAgentResult] CLASSIFIER mapped:",this.classificationResult?.type,"scores:",this.classificationResult?.scores?.length),this.updateTabBadge("ANALYSIS",null),i&&this.classificationResult&&this.persistAgentResult(i,"classifier",{total_score:this.classificationResult.overallConfidence,calculated_tier:this.classificationResult.type,breakdown:this.classificationResult.scores,approval_track:this.classificationResult.track});break;case"ML_PREDICT":this.mlPrediction=this.mapMlPrediction(e),console.log(`[handleAgentResult] ML_PREDICT mapped: approval=${this.mlPrediction?.approvalLikelihood}, risk=${this.mlPrediction?.riskScore}`),this.updateTabBadge("ANALYSIS",null),i&&this.mlPrediction&&this.persistAgentResult(i,"ml-predict",{approval_likelihood:this.mlPrediction.approvalLikelihood,timeline_days:this.mlPrediction.timelineDays,bottleneck:this.mlPrediction.bottleneckDept,risk_score:this.mlPrediction.riskScore});break;case"RISK":this.riskAssessmentResult=this.mapRiskAssessment(e),console.log("[handleAgentResult] RISK mapped:",this.riskAssessmentResult?`score=${this.riskAssessmentResult.overallScore}, rating=${this.riskAssessmentResult.overallRating}, layers=${this.riskAssessmentResult.layers?.length}, domains=${this.riskAssessmentResult.domainAssessments?.length}`:"NULL"),this.riskAssessmentResult?.domainAssessments?.length&&(this.mergeDomainAssessmentsIntoIntake(this.riskAssessmentResult.domainAssessments),console.log("[handleAgentResult] RISK: Merged domain assessments into intake assessments")),this.riskAssessmentResult&&!this.intakeAssessments.find(o=>o.domain==="RISK")&&this.intakeAssessments.push({domain:"RISK",score:this.riskAssessmentResult.overallScore,status:this.riskAssessmentResult.overallRating==="HIGH"?"FAIL":this.riskAssessmentResult.overallRating==="MEDIUM"?"WARN":"PASS",findings:JSON.stringify({observation:`Overall risk: ${this.riskAssessmentResult.overallRating} (score: ${this.riskAssessmentResult.overallScore}/100)`,recommendations:this.riskAssessmentResult.recommendations||[]})}),i&&this.riskAssessmentResult&&this.persistAgentResult(i,"risk",{layers:this.riskAssessmentResult.layers?.map(o=>({check_layer:o.name,result:o.status,findings:o.checks})),domain_assessments:this.riskAssessmentResult.domainAssessments,overall_score:this.riskAssessmentResult.overallScore,overall_rating:this.riskAssessmentResult.overallRating,hard_stop:this.riskAssessmentResult.hardStop,pir_requirements:this.riskAssessmentResult.pirRequirements,notional_flags:this.riskAssessmentResult.notionalFlags,mandatory_signoffs:this.riskAssessmentResult.mandatorySignoffs,recommendations:this.riskAssessmentResult.recommendations,circuit_breaker:this.riskAssessmentResult.circuitBreaker,evergreen_limits:this.riskAssessmentResult.evergreenLimits});break;case"GOVERNANCE":{let o=this.mapGovernanceState(e);o&&o.signoffs&&o.signoffs.length>0&&(this.governanceState=o),this.updateTabBadge("APPROVALS",null),i&&o?.signoffs?.length&&this.persistAgentResult(i,"governance",{signoffs:o.signoffs.map(d=>({party:d.party,department:d.department}))});break}case"DOC_LIFECYCLE":{let o=this.mapDocCompleteness(e);o&&o.totalPresent>0&&(this.docCompleteness=o),this.updateTabBadge("DOCUMENTS",null),i&&o&&this.persistAgentResult(i,"doc-lifecycle",{documents:o.missingDocs.map(d=>({document_name:d.docType,document_type:"REQUIRED",status:"PENDING",notes:d.reason}))});break}case"MONITORING":{let o=this.mapMonitoringResult(e);o&&(o.metrics?.length>0||o.breaches?.length>0)&&(this.monitoringResult=o),this.updateTabBadge("MONITORING",null),i&&o&&this.persistAgentResult(i,"monitoring",{thresholds:o.metrics?.map(d=>({metric_name:d.name,warning_value:(d.threshold||0)*.8,critical_value:d.threshold||0}))});break}}}persistAgentResult(t,e,i){let o=`/api/agents/npas/${t}/persist/${e}`;fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).then(d=>{if(!d.ok)throw new Error(`HTTP ${d.status}`);return d.json()}).then(d=>{console.log(`[persist] ${e} result saved:`,d.fields_saved??d.status??"ok")}).catch(d=>{console.warn(`[persist] ${e} save failed:`,d.message)})}parseJsonOutput(t){if(t?.result&&typeof t.result=="string"){let e=t.result.trim();e=e.replace(/^```(?:json)?\s*\n?/i,"").replace(/\n?```\s*$/i,"").trim();try{return JSON.parse(e)}catch{}let i=e.match(/\{[\s\S]*\}/);if(i)try{return JSON.parse(i[0])}catch{}try{let d=e.replace(/'/g,'"').replace(/True/g,"true").replace(/False/g,"false").replace(/None/g,"null").match(/\{[\s\S]*\}/);if(d){let u=JSON.parse(d[0]);return console.log("[parseJsonOutput] Recovered JSON via Python\u2192JSON syntax fix"),u}}catch{}return console.warn("[parseJsonOutput] All parse attempts failed. raw (first 300):",e.substring(0,300)),this.extractFallbackFromText(e)}return t}extractFallbackFromText(t){return console.warn("[extractFallbackFromText] JSON parse failed, using safe defaults. Raw (200):",t.substring(0,200)),{_fromFallback:!0,_parseError:"Agent returned narrative text instead of JSON. Classification defaulted to Variation.",classification:{type:"Variation",track:"NPA_LITE"},scorecard:{overall_confidence:0,scores:[]},risk_assessment:{overall_score:50,overall_rating:"MEDIUM",hard_stop:!1},prohibited_check:{matched:!1},mandatory_signoffs:[],_rawSummary:t.substring(0,500)}}mapClassificationResult(t){let e=this.parseJsonOutput(t);if(!e)return null;if(Array.isArray(e.result))return this.mapClassificationFromTrace(e.result);let i=e.classification||e.classification_result||e,o=e.scorecard||i.scorecard||{},d=o.scores||i.scores||[];return{type:i.type||i.classification_type||"Variation",track:i.track||i.approval_track||"NPA Lite",scores:d.map(u=>({criterion:u.criterion_name||u.criterion||u.name||u.criterion_code||"",score:u.score??0,maxScore:u.max_score||u.maxScore||10,reasoning:u.reasoning||u.description||""})),overallConfidence:o.overall_confidence||i.overallConfidence||i.overall_confidence||i.confidence||0,prohibitedMatch:e.prohibited_check||i.prohibitedMatch||i.prohibited_match||{matched:!1},mandatorySignOffs:e.mandatory_signoffs||i.mandatorySignOffs||i.mandatory_signoffs||[]}}mapClassificationFromTrace(t){let e=[],i=[];for(let k of t){let w=k?.data||{},D=typeof w.observation=="string"?w.observation:"",A=typeof w.thought=="string"?w.thought:"",z=w.tool_name||w.action_name||w.action;D&&D.toLowerCase().includes("tool invoke error")&&e.push(`${z||"tool"}: ${D.split(`
`)[0]}`),A&&i.push(A.trim())}let o=i.length?i[i.length-1]:JSON.stringify(t,null,2),d=/classification:\s*(new-to-group|ntg)/i.test(o)?"NTG":/classification:\s*existing/i.test(o)?"Existing":(/classification:\s*variation/i.test(o),"Variation"),u=/track:\s*full[_\s-]*npa/i.test(o)||/track:\s*full npa/i.test(o)?"Full NPA":/track:\s*npa[_\s-]*lite/i.test(o)?"NPA Lite":/track:\s*bundling/i.test(o)?"Bundling":/track:\s*evergreen/i.test(o)?"Evergreen":/track:\s*prohibited/i.test(o)?"Prohibited":"NPA Lite",g=o.match(/confidence:\s*(\d+)\s*%/i),C=g?Number(g[1]):0,h=[],S=[{key:"PRODUCT_INNOVATION",label:"Product Innovation",max:8},{key:"MARKET_CUSTOMER",label:"Market & Customer",max:10},{key:"RISK_REGULATORY",label:"Risk & Regulatory",max:8},{key:"FINANCIAL_OPERATIONAL",label:"Financial & Operational",max:7}];for(let k of S){let w=o.match(new RegExp(`${k.key}[\\s\\S]*?Subtotal:\\s*(\\d+)\\s*/\\s*(\\d+)`,"i"));w&&h.push({criterion:k.label,score:Number(w[1]),maxScore:Number(w[2])||k.max,reasoning:`${k.key} subtotal from narrative output`})}let P=[];return e.length&&(P.push(`Tool errors detected (${e.length}). Workflow likely returned trace/narrative output instead of JSON.`),P.push(...e.slice(0,5)),e.length>5&&P.push(`...and ${e.length-5} more tool errors`)),{type:d,track:u,scores:h,overallConfidence:C,mandatorySignOffs:[],analysisSummary:P.length?P:void 0,rawOutput:o,rawJson:{trace:t}}}mapMlPrediction(t){let e=this.parseJsonOutput(t);if(!e)return null;let i=e.ml_prediction||e.prediction||{},o=e.scorecard||{},d=e.classification||{},u=e.notional_flags||{},g=i.approvalLikelihood||i.approval_likelihood||o.overall_confidence||0,h=(d.track||"").includes("LITE")?25:45,S=i.timelineDays||i.timeline_days||h,P=e.mandatory_signoffs||[],k=i.bottleneckDept||i.bottleneck_dept||(u.cfo_approval_required?"CFO / Finance":P[P.length-1]||"Unknown"),w=i.riskScore||i.risk_score||Math.max(0,100-g),D=i.features||[];return D.length===0&&(u.roae_analysis_needed&&D.push({name:"ROAE Analysis Required",importance:.8,value:"Yes"}),u.mlr_review_required&&D.push({name:"MLR Review Required",importance:.7,value:"Yes"}),u.finance_vp_required&&D.push({name:"Finance VP Required",importance:.6,value:"Yes"}),d.is_cross_border&&D.push({name:"Cross-Border",importance:.9,value:"Yes"}),D.push({name:"Classification",importance:.5,value:d.type||"N/A"})),{approvalLikelihood:g,timelineDays:S,bottleneckDept:k,riskScore:w,features:D,comparisonInsights:i.comparisonInsights||i.comparison_insights||(e.similar_npa_hint?[e.similar_npa_hint]:[])}}mapRiskAssessment(t){let e=this.parseJsonOutput(t);if(!e)return null;let i=e.risk_assessment||e,o=(e.layer_results||i.layers||[]).map(A=>({name:A.layer||A.name||"",status:A.status||"PASS",details:Array.isArray(A.findings)?A.findings.join("; "):A.details||"",checks:(A.checks||A.flags||[]).map(z=>typeof z=="string"?{name:z,status:"WARNING",detail:z}:{name:z.name,status:z.status||"PASS",detail:z.detail||z.description||""})})),d=(e.domain_assessments||i.domain_assessments||[]).map(A=>({domain:A.domain||"",score:A.score||0,rating:A.rating||"LOW",keyFindings:A.key_findings||A.keyFindings||[],mitigants:A.mitigants||A.mitigation||[]})),u=(e.prerequisite_validation?.pending_items||i.prerequisites||[]).map(A=>typeof A=="string"?{name:A,status:"FAIL",category:"Pending"}:{name:A.name,status:A.status||"PASS",category:A.category||""}),g=e.pir_requirements||i.pir_requirements,C=g?{required:g.required??g.pir_required??!1,type:g.type||g.pir_type,deadline_months:g.deadline_months||g.deadline,conditions:g.conditions||[]}:void 0,h=e.circuit_breaker||i.circuit_breaker,S=h?{triggered:h.triggered??!1,loop_back_count:h.loop_back_count??h.count??0,threshold:h.threshold??3,escalation_target:h.escalation_target}:void 0,P=e.evergreen_limits||i.evergreen_limits,k=P?{eligible:P.eligible??!1,notional_remaining:P.notional_remaining,deal_count_remaining:P.deal_count_remaining,flags:P.flags||[]}:void 0,w=e.notional_flags||i.notional_flags,D=w?{finance_vp_required:w.finance_vp_required??!1,cfo_required:w.cfo_required??!1,roae_required:w.roae_required??w.roae_analysis_needed??!1,threshold_breached:w.threshold_breached}:void 0;return{layers:o,domainAssessments:d,overallScore:i.overall_score||i.overallScore||0,overallRating:i.overall_risk_rating||i.overallRating||(i.overall_score>=70?"HIGH":i.overall_score>=40?"MEDIUM":"LOW"),hardStop:i.hardStop||i.hard_stop||!1,hardStopReason:i.hardStopReason||i.hard_stop_reason||void 0,prerequisites:u,pirRequirements:C,circuitBreaker:S,evergreenLimits:k,notionalFlags:D,mandatorySignoffs:e.mandatory_signoffs||i.mandatory_signoffs||[],recommendations:e.recommendations||i.recommendations||[]}}mapGovernanceState(t){let e=this.parseJsonOutput(t);if(console.log("[mapGovernanceState] parsed keys:",e?Object.keys(e):"NULL"),!e)return null;let i=e.signoff_status||e,o=e.loopback_status||{},d=(e.signoffs||i.signoffs||[]).map(g=>({department:g.department,status:g.status||"PENDING",assignee:g.assignee||g.approver,slaDeadline:g.sla_deadline||g.slaDeadline,slaBreached:g.sla_breached||g.slaBreached||!1,decidedAt:g.decided_at||g.decidedAt}));return{signoffs:d.length>0?d:(i.blocking_parties||[]).map(g=>({department:g,status:"PENDING"})),slaStatus:i.sla_breached>0?"breached":i.completion_pct>50?"on_track":"at_risk",loopBackCount:o.total||0,circuitBreaker:o.circuit_breaker_triggered||!1,circuitBreakerThreshold:3}}mapDocCompleteness(t){let e=this.parseJsonOutput(t);if(!e)return null;let i=e.completeness||e;return{completenessPercent:i.completion_pct||i.completenessPercent||0,totalRequired:i.total_required||i.totalRequired||0,totalPresent:i.present||i.totalPresent||0,totalValid:i.totalValid||i.present||0,missingDocs:(e.missing_documents||i.missingDocs||[]).map(o=>({docType:o.doc_name||o.docType||"",reason:o.reason||`Required by ${o.required_by||"sign-off"}`,priority:o.criticality==="CRITICAL"?"BLOCKING":"WARNING"})),invalidDocs:i.invalidDocs||[],conditionalRules:i.conditionalRules||[],expiringDocs:i.expiringDocs||[],stageGateStatus:i.is_complete?"CLEAR":i.critical_missing>0?"BLOCKED":"WARNING"}}mapMonitoringResult(t){let e=this.parseJsonOutput(t);return e?{productHealth:e.health_status||e.productHealth||"HEALTHY",metrics:(e.metrics||[]).map(i=>({name:i.name||i.metric||"",value:i.value||i.actual||0,unit:i.unit||"",threshold:i.threshold||i.warning,trend:i.trend||"stable"})),breaches:(e.breaches||[]).map(i=>({metric:i.metric||"",threshold:i.threshold||i.warning||i.critical||0,actual:i.actual||0,severity:i.severity||"WARNING",message:i.message||`${i.metric} exceeds threshold`,firstDetected:i.firstDetected||i.first_detected||new Date().toISOString(),trend:i.trend||"stable"})),conditions:(e.conditions?.items||e.post_launch_conditions||[]).map(i=>({type:i.type||"",description:i.description||"",deadline:i.deadline||"",status:i.status||"PENDING",daysRemaining:i.daysRemaining||i.days_remaining||0})),pirStatus:e.pir_status||e.pirStatus||"Not Scheduled",pirDueDate:e.pir_due_date||e.pirDueDate}:null}retryAgent(t){delete this.agentErrors[t],this.agentLoading[t]=!0;let e=this.buildWorkflowInputs(),i={GOVERNANCE:"GOVERNANCE",DOC_LIFECYCLE:"DOC_LIFECYCLE",MONITORING:"MONITORING"},o=i[t]?pe(B({},e),{agent_mode:i[t]}):e;this.difyService.runWorkflow(t,o).pipe(ne(d=>(this.agentErrors[t]=d.message||`${t} failed`,te(null)))).subscribe(d=>{if(this.agentLoading[t]=!1,d?.data?.status==="succeeded")switch(t){case"CLASSIFIER":this.classificationResult=this.mapClassificationResult(d.data.outputs);break;case"ML_PREDICT":this.mlPrediction=this.mapMlPrediction(d.data.outputs);break;case"RISK":this.riskAssessmentResult=this.mapRiskAssessment(d.data.outputs);break;case"GOVERNANCE":this.governanceState=this.mapGovernanceState(d.data.outputs);break;case"DOC_LIFECYCLE":this.docCompleteness=this.mapDocCompleteness(d.data.outputs);break;case"MONITORING":this.monitoringResult=this.mapMonitoringResult(d.data.outputs);break}})}updateTabBadge(t,e){let i=this.tabs.find(o=>o.id===t);if(i)switch(t){case"PRODUCT_SPECS":break;case"DOCUMENTS":if(this.docCompleteness){let o=this.docCompleteness.missingDocs?.length||0;i.badge=o>0?`${o} Missing`:"Complete"}break;case"ANALYSIS":this.mlPrediction&&(i.badge=`${this.mlPrediction.approvalLikelihood}%`);break;case"APPROVALS":if(this.governanceState){let o=this.governanceState.signoffs?.filter(d=>d.status==="PENDING").length||0;i.badge=`${o}`}break;case"MONITORING":this.monitoringResult&&(i.badge=this.monitoringResult.breaches?.length>0?`${this.monitoringResult.breaches.length}`:"0");break}}static \u0275fac=function(e){return new(e||n)(ye(Me),ye($e),ye(ce))};static \u0275cmp=E({type:n,selectors:[["app-npa-detail"]],inputs:{npaContext:"npaContext",autoOpenEditor:"autoOpenEditor"},outputs:{onBack:"onBack",onSave:"onSave"},decls:75,vars:23,consts:[[3,"inputData","close","onSave",4,"ngIf"],[1,"fixed","inset-0","z-[100]","flex","flex-col","h-screen","w-screen","bg-slate-50","overscroll-none","font-sans"],[1,"flex-none","bg-white","border-b","border-slate-200","px-6","py-3","flex","items-center","justify-between","shadow-sm","z-20"],[1,"flex","items-center","gap-4"],[1,"group","flex","items-center","justify-center","p-2","rounded-full","hover:bg-slate-100","text-slate-500","hover:text-slate-900","transition-all","focus:outline-none","focus:ring-2","focus:ring-offset-2","focus:ring-blue-500",3,"click"],["name","arrow-left",1,"w-6","h-6","stroke-[1.5]","group-hover:-translate-x-0.5","transition-transform"],[1,"flex","items-center","gap-3","text-xs","text-slate-500","mb-2"],[1,"font-medium","text-slate-400"],["name","chevron-right",1,"w-3","h-3","text-slate-300"],[1,"font-mono","text-slate-600","bg-slate-100","px-2","py-0.5","rounded"],[1,"flex","items-center","gap-1.5","ml-2"],["name","user",1,"w-3","h-3"],[1,"font-medium","text-slate-700"],[1,"text-slate-300"],[1,"text-slate-400"],[1,"flex","items-center","gap-3"],[1,"text-lg","font-bold","text-slate-900","tracking-tight"],[1,"inline-flex","items-center","px-2","py-0.5","rounded","text-xs","font-semibold","bg-blue-100","text-blue-700","border","border-blue-200"],["class","inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-50 text-purple-700 border border-purple-200",4,"ngIf"],["class","inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold border",3,"ngClass",4,"ngIf"],["class","px-3 py-2 text-sm font-medium text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors border border-indigo-200 hover:border-indigo-300 flex items-center gap-2","title","Re-run all AI agents with live Dify analysis",3,"click",4,"ngIf"],[1,"px-3","py-2","text-sm","font-medium","text-slate-600","hover:bg-slate-50","rounded-lg","transition-colors","border","border-slate-200","hover:border-slate-300","flex","items-center","gap-2",3,"click"],["name","help-circle",1,"w-4","h-4"],["name","save",1,"w-4","h-4"],[1,"h-6","w-px","bg-slate-300","mx-1"],[1,"px-4","py-2","text-sm","font-medium","text-red-600","hover:bg-red-50","rounded-lg","transition-colors","border","border-transparent","hover:border-red-100/50",3,"click"],[1,"px-4","py-2","text-sm","font-semibold","text-white","bg-dbs-primary","hover:bg-dbs-primary-hover","rounded-lg","shadow-sm","transition-colors","focus:ring-2","focus:ring-offset-2","focus:ring-blue-400","shadow-blue-200",3,"click"],[1,"flex-1","overflow-hidden"],[1,"grid","grid-cols-1","lg:grid-cols-12","h-full"],[1,"lg:col-span-4","flex","flex-col","h-full","border-r","border-slate-200","bg-white","p-0","overflow-hidden"],[1,"flex-none","p-4","border-b","border-slate-100","flex","items-center","justify-between","bg-slate-50/50"],[1,"font-semibold","text-sm","flex","items-center","gap-2","text-slate-900"],[1,"p-1.5","bg-white","border","border-slate-200","rounded-md","shadow-sm","text-red-500"],["name","file-text",1,"w-4","h-4"],["title","Upload document",1,"p-1.5","hover:bg-blue-50","text-blue-600","rounded","transition-colors",3,"click"],["name","upload-cloud",1,"w-4","h-4"],[1,"flex-1","bg-slate-50","relative","flex","flex-col","items-center","justify-center","p-8"],["class","text-center",4,"ngIf"],["class","w-full h-full flex flex-col",4,"ngIf"],[1,"flex-none","bg-white","border-t","border-slate-200","h-1/3","flex","flex-col"],[1,"px-4","py-3","border-b","border-slate-100","bg-slate-50/50","flex","items-center","justify-between"],[1,"text-xs","font-bold","text-slate-500","uppercase","tracking-wider"],[1,"p-1","hover:bg-blue-50","text-blue-600","rounded",3,"click"],[1,"overflow-y-auto","p-2","space-y-1"],["class","flex items-center p-2 rounded-lg hover:bg-slate-50 cursor-pointer group transition-colors border border-transparent hover:border-slate-200",4,"ngFor","ngForOf"],["class","py-6 text-center text-slate-400",4,"ngIf"],[1,"lg:col-span-8","flex","flex-col","h-full","bg-slate-50/50","overflow-hidden","relative"],[1,"flex-none","flex","items-center","px-3","border-b","border-slate-200","bg-white","w-full","shadow-[0_1px_2px_rgba(0,0,0,0.02)]"],["class","flex-1 justify-center flex items-center gap-1.5 py-3 border-b-2 text-xs transition-all whitespace-nowrap px-2 rounded-t",3,"class","click",4,"ngFor","ngForOf"],[1,"flex-1","overflow-y-auto","p-8","scroll-smooth"],["class","mb-6 max-w-4xl mx-auto bg-amber-50 border border-amber-100 rounded-lg p-4 flex items-start gap-3",4,"ngIf"],["class","space-y-8 animate-in fade-in slide-in-from-bottom-2 duration-300 max-w-4xl mx-auto",4,"ngIf"],["class","space-y-6 animate-in fade-in slide-in-from-bottom-2 duration-300 max-w-4xl mx-auto",4,"ngIf"],["class","h-[calc(100vh-280px)] flex flex-col overflow-hidden animate-in fade-in slide-in-from-bottom-2 duration-300",4,"ngIf"],[3,"close","onSave","inputData"],[1,"inline-flex","items-center","px-2","py-0.5","rounded","text-xs","font-medium","bg-purple-50","text-purple-700","border","border-purple-200"],["name","globe",1,"w-3","h-3","mr-1"],[1,"inline-flex","items-center","px-2","py-0.5","rounded","text-xs","font-semibold","border",3,"ngClass"],["name","shield-check",1,"w-3","h-3","mr-1"],["title","Re-run all AI agents with live Dify analysis",1,"px-3","py-2","text-sm","font-medium","text-indigo-600","hover:bg-indigo-50","rounded-lg","transition-colors","border","border-indigo-200","hover:border-indigo-300","flex","items-center","gap-2",3,"click"],["name","refresh-cw",1,"w-4","h-4"],[1,"text-center"],[1,"w-16","h-16","rounded-full","bg-slate-100","flex","items-center","justify-center","mx-auto","mb-4"],["name","file-x",1,"w-8","h-8","text-slate-300"],[1,"text-sm","font-medium","text-slate-500","mb-1"],[1,"text-xs","text-slate-400","mb-4"],[1,"px-4","py-2","text-sm","font-medium","text-blue-600","bg-blue-50","hover:bg-blue-100","rounded-lg","transition-colors","border","border-blue-200",3,"click"],["name","upload-cloud",1,"w-4","h-4","inline","mr-1.5"],[1,"w-full","h-full","flex","flex-col"],[1,"flex-1","flex","items-center","justify-center"],["name","file-text",1,"w-12","h-12","text-slate-300","mx-auto","mb-2"],[1,"text-sm","font-medium","text-slate-500"],[1,"text-xs","text-slate-400","mt-1"],[1,"flex","items-center","p-2","rounded-lg","hover:bg-slate-50","cursor-pointer","group","transition-colors","border","border-transparent","hover:border-slate-200"],[1,"w-8","h-8","rounded","flex","items-center","justify-center","mr-3","border",3,"ngClass"],[1,"flex-1","min-w-0"],[1,"flex","items-center","justify-between"],[1,"text-sm","font-medium","text-slate-900","truncate"],["name","check-circle-2","class","w-3.5 h-3.5 text-green-500",4,"ngIf"],["name","alert-triangle","class","w-3.5 h-3.5 text-amber-500",4,"ngIf"],[1,"text-xs","text-slate-500","flex","items-center","gap-2"],["name","check-circle-2",1,"w-3.5","h-3.5","text-green-500"],["name","alert-triangle",1,"w-3.5","h-3.5","text-amber-500"],[1,"py-6","text-center","text-slate-400"],[1,"text-xs"],[1,"flex-1","justify-center","flex","items-center","gap-1.5","py-3","border-b-2","text-xs","transition-all","whitespace-nowrap","px-2","rounded-t",3,"click"],[1,"w-3.5","h-3.5",3,"name"],["class","ml-0.5 px-1.5 py-0.5 rounded-full text-[9px] bg-slate-100 text-slate-600 font-bold border border-slate-200/50",3,"class",4,"ngIf"],[1,"ml-0.5","px-1.5","py-0.5","rounded-full","text-[9px]","bg-slate-100","text-slate-600","font-bold","border","border-slate-200/50"],[1,"mb-6","max-w-4xl","mx-auto","bg-amber-50","border","border-amber-100","rounded-lg","p-4","flex","items-start","gap-3"],["name","lightbulb",1,"w-5","h-5","text-amber-700","mt-0.5"],[1,"min-w-0"],[1,"text-sm","font-bold","text-amber-900"],[1,"text-sm","text-amber-800","mt-1"],[1,"mt-3","flex","flex-wrap","gap-2"],[1,"px-3","py-2","text-xs","font-bold","text-white","bg-amber-700","hover:bg-amber-800","rounded-lg","shadow-sm","transition-colors","flex","items-center","gap-2",3,"click"],["name","message-square",1,"w-4","h-4"],[1,"px-3","py-2","text-xs","font-semibold","text-amber-800","bg-white","hover:bg-amber-100","rounded-lg","transition-colors","border","border-amber-200","flex","items-center","gap-2",3,"click"],["name","layout-list",1,"w-4","h-4"],[1,"space-y-8","animate-in","fade-in","slide-in-from-bottom-2","duration-300","max-w-4xl","mx-auto"],["class","bg-blue-50 border border-blue-100 rounded-lg p-4 flex items-start gap-3",4,"ngIf"],[1,"bg-white","rounded-xl","shadow-sm","border","border-slate-200","p-6"],[1,"flex","items-center","justify-between","mb-6"],[1,"text-lg","font-bold","text-slate-900"],[1,"flex","items-center","gap-2"],[1,"text-xs","font-medium","text-green-700","bg-green-50","px-2.5","py-1","rounded-full","border","border-green-100"],[1,"grid","grid-cols-2","md:grid-cols-3","gap-y-6","gap-x-8"],["class","group",4,"ngFor","ngForOf"],[1,"flex","items-center","justify-between","mb-4"],[1,"text-sm","font-bold","text-slate-900","flex","items-center","gap-2"],["name","file-edit",1,"w-4","h-4","text-blue-500"],[1,"text-[10px]","font-bold","text-slate-400","uppercase","tracking-widest","bg-slate-50","px-2","py-1","rounded","border","border-slate-100"],[1,"flex","items-start","gap-6"],[1,"flex-1"],[1,"text-xs","text-slate-600","leading-relaxed","mb-6"],[1,"flex","gap-3"],[1,"px-5","py-2.5","bg-blue-600","text-white","rounded-lg","shadow-sm","hover:shadow-md","hover:bg-blue-700","transition-all","text-xs","font-bold","flex","items-center","gap-2",3,"click"],[1,"w-32","h-32","flex-none","bg-slate-50","rounded-xl","border","border-slate-100","flex","items-center","justify-center","relative","overflow-hidden","group"],["name","sparkles",1,"w-12","h-12","text-blue-200","group-hover:scale-110","transition-transform"],[1,"absolute","inset-0","bg-blue-600/5","opacity-0","group-hover:opacity-100","transition-opacity"],["class","mt-8 pt-8 border-t border-slate-200",4,"ngIf"],[1,"bg-blue-50","border","border-blue-100","rounded-lg","p-4","flex","items-start","gap-3"],["name","info",1,"w-5","h-5","text-blue-600","mt-0.5"],[1,"text-sm","font-bold","text-blue-900"],[1,"text-sm","text-blue-800","mt-1"],[1,"ml-auto"],[1,"inline-flex","items-center","px-2.5","py-0.5","rounded-full","text-xs","font-medium","bg-blue-100","text-blue-800"],[1,"group"],[1,"text-xs","font-semibold","text-slate-400","uppercase","tracking-wider","mb-1","flex","items-center","gap-1"],["name","sparkles","class","w-3 h-3 text-amber-400 opacity-60",4,"ngIf"],[1,"text-base","font-semibold","text-slate-900"],[1,"opacity-0","group-hover:opacity-100","transition-opacity","bg-blue-600","text-white","text-[10px]","px-1.5","py-0.5","rounded","font-mono"],["name","sparkles",1,"w-3","h-3","text-amber-400","opacity-60"],[1,"mt-8","pt-8","border-t","border-slate-200"],[1,"text-sm","font-bold","text-slate-400","uppercase","tracking-widest","mb-4","flex","items-center","gap-2"],["name","git-branch",1,"w-4","h-4","text-purple-500"],[3,"result"],[1,"bg-slate-50","rounded-xl","border","border-slate-200","p-8","text-center"],["name","loader-2",1,"w-6","h-6","mx-auto","mb-2","text-slate-400","animate-spin"],[3,"npaContext"],[1,"mt-8","pt-6","border-t","border-slate-200"],["name","scan-search",1,"w-4","h-4","text-teal-500"],[3,"result",4,"ngIf"],["class","bg-slate-50 rounded-xl border border-slate-200 p-8 text-center text-slate-500",4,"ngIf"],[1,"bg-slate-50","rounded-xl","border","border-slate-200","p-8","text-center","text-slate-500"],[1,"text-sm","font-medium"],[1,"text-lg","font-bold","text-slate-900","mb-4","flex","items-center","gap-2"],["name","shield-alert",1,"w-5","h-5","text-slate-500"],["class","grid grid-cols-1 md:grid-cols-2 gap-4",4,"ngIf"],["name","settings",1,"w-5","h-5","text-slate-500"],["name","trending-up",1,"w-4","h-4","text-amber-500"],["name","shield-alert",1,"w-4","h-4","text-red-500"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-4"],["class","rounded-xl border p-4 transition-all",3,"ngClass",4,"ngFor","ngForOf"],[1,"rounded-xl","border","p-4","transition-all",3,"ngClass"],[1,"flex","items-center","justify-between","mb-2"],[1,"text-xs","font-bold","px-2","py-0.5","rounded","bg-white/50","border","border-black/5"],[1,"text-[10px]","font-bold","uppercase","tracking-wide","opacity-80"],[1,"text-xl","font-bold","opacity-40"],[1,"text-sm","font-medium","leading-relaxed"],["name","shield-alert",1,"w-8","h-8","mx-auto","mb-3","text-slate-300"],["name","settings",1,"w-8","h-8","mx-auto","mb-3","text-slate-300"],[1,"space-y-6","animate-in","fade-in","slide-in-from-bottom-2","duration-300","max-w-4xl","mx-auto"],[4,"ngIf"],["class","bg-slate-50 rounded-xl border border-slate-200 p-12 text-center",4,"ngIf"],["class","bg-red-50 rounded-xl border border-red-200 p-8 text-center",4,"ngIf"],["class","bg-slate-50 rounded-xl border border-slate-200 p-12 text-center text-slate-500",4,"ngIf"],["name","workflow",1,"w-4","h-4","text-slate-500"],[3,"onNudge","onAssign","result"],[1,"bg-slate-50","rounded-xl","border","border-slate-200","p-12","text-center"],["name","loader-2",1,"w-8","h-8","mx-auto","mb-3","text-slate-400","animate-spin"],[1,"bg-red-50","rounded-xl","border","border-red-200","p-8","text-center"],["name","alert-circle",1,"w-8","h-8","mx-auto","mb-3","text-red-400"],[1,"text-sm","font-medium","text-red-600"],[1,"text-xs","text-red-500","mt-1"],[1,"mt-3","px-4","py-2","text-sm","font-medium","text-red-700","bg-red-100","rounded-lg","hover:bg-red-200","transition-colors",3,"click"],[1,"bg-slate-50","rounded-xl","border","border-slate-200","p-12","text-center","text-slate-500"],["name","workflow",1,"w-8","h-8","mx-auto","mb-3","text-slate-300"],[1,"my-6"],[3,"stages","targetCompletion","projectId"],[1,"bg-white","rounded-xl","border","border-slate-200","shadow-sm","p-6"],[1,"text-sm","font-bold","text-slate-900","mb-4","flex","items-center","gap-2"],["name","message-square",1,"w-4","h-4","text-indigo-500"],[1,"text-sm","text-slate-500","mb-4"],[1,"relative"],["type","text","placeholder","e.g. What caused the volume breach on Jan 15?",1,"w-full","pl-4","pr-12","py-3","rounded-xl","border","border-slate-200","focus:ring-2","focus:ring-indigo-500/20","focus:border-indigo-500","outline-none","text-sm","bg-slate-50",3,"ngModelChange","keydown.enter","ngModel"],[1,"absolute","right-2","top-2","p-1.5","text-indigo-600","hover:bg-indigo-50","rounded-lg",3,"click"],["name","send",1,"w-4","h-4"],["class","mt-4 p-4 bg-indigo-50 rounded-xl border border-indigo-100",4,"ngIf"],["class","mt-4 flex items-center gap-2 text-sm text-slate-500",4,"ngIf"],["name","activity",1,"w-4","h-4","text-emerald-500"],[1,"mt-3","px-4","py-2","text-sm","font-medium","text-red-700","bg-red-100","rounded-lg","hover:bg-red-200",3,"click"],["name","bar-chart-2",1,"w-4","h-4","text-blue-500"],[1,"grid","grid-cols-2","md:grid-cols-4","gap-4"],["class","bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-all",4,"ngFor","ngForOf"],[1,"bg-white","p-4","rounded-xl","border","border-slate-200","shadow-sm","hover:shadow-md","transition-all"],[1,"flex","items-center","justify-between","mb-3"],[1,"p-1.5","rounded-lg",3,"ngClass"],[1,"w-4","h-4",3,"name"],[1,"text-2xl","font-bold","text-slate-900","mb-1"],[1,"text-[10px]","font-bold","text-slate-400","uppercase","tracking-wider"],[1,"mt-4","p-4","bg-indigo-50","rounded-xl","border","border-indigo-100"],[1,"text-sm","text-slate-700","whitespace-pre-wrap"],[1,"mt-4","flex","items-center","gap-2","text-sm","text-slate-500"],["name","loader-2",1,"w-4","h-4","animate-spin"],[1,"h-[calc(100vh-280px)]","flex","flex-col","overflow-hidden","animate-in","fade-in","slide-in-from-bottom-2","duration-300"],[1,"flex-1",3,"initialConversationId","initialSessionId","defaultAgent","contextLabel"]],template:function(e,i){e&1&&(f(0,da,1,1,"app-npa-draft-builder",0),r(1,"div",1)(2,"div",2)(3,"div",3)(4,"button",4),y("click",function(){return i.onBack.emit()}),m(5,"lucide-icon",5),a(),r(6,"div")(7,"div",6)(8,"span",7),l(9,"NPA Pipeline"),a(),m(10,"lucide-icon",8),r(11,"span",9),l(12),a(),r(13,"span",10),m(14,"lucide-icon",11),r(15,"span",12),l(16),a()(),r(17,"span",13),l(18,"|"),a(),r(19,"span",14),l(20),a()(),r(21,"div",15)(22,"h1",16),l(23),a(),r(24,"span",17),l(25),a(),f(26,ca,3,0,"span",18)(27,pa,3,6,"span",19),a()()(),r(28,"div",15),f(29,ma,3,0,"button",20),r(30,"button",21),y("click",function(){return i.onHelpClick()}),m(31,"lucide-icon",22),l(32," Help "),a(),r(33,"button",21),y("click",function(){return i.onSaveDraft()}),m(34,"lucide-icon",23),l(35," Save Draft "),a(),m(36,"div",24),r(37,"button",25),y("click",function(){return i.onReject()}),l(38," Reject "),a(),r(39,"button",26),y("click",function(){return i.onApprove()}),l(40," Approve & Sign-Off "),a()()(),r(41,"div",27)(42,"div",28)(43,"div",29)(44,"div",30)(45,"h3",31)(46,"div",32),m(47,"lucide-icon",33),a(),l(48," Document Preview "),a(),r(49,"button",34),y("click",function(){return i.onUploadDocument()}),m(50,"lucide-icon",35),a()(),r(51,"div",36),f(52,ua,10,0,"div",37)(53,ga,8,1,"div",38),a(),r(54,"div",39)(55,"div",40)(56,"h4",41),l(57),a(),r(58,"button",42),y("click",function(){return i.onUploadDocument()}),m(59,"lucide-icon",35),a()(),r(60,"div",43),f(61,ba,12,10,"div",44)(62,ya,3,0,"div",45),a()()(),r(63,"div",46)(64,"div",47),f(65,ha,4,7,"button",48),a(),r(66,"div",49),f(67,va,14,0,"div",50)(68,Aa,31,4,"div",51)(69,Ea,8,3,"div",51)(70,Ua,25,8,"div",51)(71,Wa,5,4,"div",52)(72,Ya,3,3,"div",51)(73,to,17,7,"div",51)(74,io,2,4,"div",53),a()()()()()),e&2&&(c("ngIf",i.showDraftBuilder),s(12),v((i.projectData==null?null:i.projectData.id)||i.projectId),s(4),v((i.projectData==null?null:i.projectData.submitted_by)||(i.projectData==null?null:i.projectData.product_manager)||"Unknown"),s(4),x("Sub: ",i.formatSubmittedDate(i.projectData==null?null:i.projectData.created_at)),s(3),x(" ",(i.projectData==null?null:i.projectData.title)||"Loading Project..."," "),s(2),x(" ",i.approvalTrack," "),s(),c("ngIf",i.isCrossBorder),s(),c("ngIf",i.isNtg),s(2),c("ngIf",i.dbDataSufficient),s(23),c("ngIf",!i.uploadedDocuments.length),s(),c("ngIf",i.uploadedDocuments.length),s(4),x(" Attachments (",i.uploadedDocuments.length,") "),s(4),c("ngForOf",i.uploadedDocuments),s(),c("ngIf",!i.uploadedDocuments.length),s(3),c("ngForOf",i.tabs),s(2),c("ngIf",i.isIdeationStage()),s(),c("ngIf",i.activeTab==="PRODUCT_SPECS"),s(),c("ngIf",i.activeTab==="DOCUMENTS"),s(),c("ngIf",i.activeTab==="ANALYSIS"),s(),c("ngIf",i.activeTab==="APPROVALS"),s(),c("ngIf",i.activeTab==="WORKFLOW"),s(),c("ngIf",i.activeTab==="MONITORING"),s(),c("ngIf",i.activeTab==="CHAT"))},dependencies:[N,G,V,F,de,oe,se,le,U,L,ot,st,lt,Ue,dt,Ke,qe,ct,je,Ge],styles:[".no-scrollbar[_ngcontent-%COMP%]::-webkit-scrollbar{display:none}.no-scrollbar[_ngcontent-%COMP%]{-ms-overflow-style:none;scrollbar-width:none}"]})};function no(n,t){if(n&1){let e=I();r(0,"div",3)(1,"app-npa-dashboard",4),y("navigateToCreate",function(){_(e);let o=p();return b(o.goToCreate())})("navigateToDraft",function(){_(e);let o=p();return b(o.goToDraft())})("navigateToDetail",function(o){_(e);let d=p();return b(d.goToDetail(o))}),a()()}}function ro(n,t){if(n&1){let e=I();r(0,"div",5)(1,"app-chat-interface",6),y("onBack",function(){_(e);let o=p();return b(o.goToDashboard())})("onComplete",function(o){_(e);let d=p();return b(d.goToDraftWithData(o))}),a()()}}function ao(n,t){if(n&1){let e=I();r(0,"div",7)(1,"app-npa-detail",8),y("onBack",function(){_(e);let o=p();return b(o.goToDashboard())}),a()()}if(n&2){let e=p();s(),c("npaContext",e.npaContext)("autoOpenEditor",e.autoOpenEditor)}}var jt=class n{layoutService=T(Rt);route=T(Me);router=T(Le);governanceService=T($e);npaService=T(be);difyService=T(ce);viewMode="DASHBOARD";autoOpenEditor=!1;npaContext=null;constructor(){console.log("NPAAgentComponent Initialized. viewMode:",this.viewMode)}ngOnInit(){this.route.queryParams.subscribe(t=>{t.mode==="create"?this.goToCreate():t.mode==="detail"&&(this.npaContext={npaId:t.npaId||t.projectId||null},this.viewMode="WORK_ITEM",this.autoOpenEditor=!1,this.layoutService.setSidebarVisible(!1))})}goToDashboard(){this.viewMode="DASHBOARD",this.autoOpenEditor=!1,this.npaContext=null,this.layoutService.setSidebarVisible(!0)}goToCreate(){this.viewMode="IDEATION",this.layoutService.setSidebarVisible(!1)}goToDraft(){this.viewMode="WORK_ITEM",this.autoOpenEditor=!0,this.layoutService.setSidebarVisible(!1)}goToDraftWithData(t){if(console.log("[NPAAgent] Transitioning to Draft with payload:",t),t?.npaId)this.npaContext=t,this.viewMode="WORK_ITEM",this.autoOpenEditor=!1,this.layoutService.setSidebarVisible(!1);else{let e={title:t.product_name||t.title||"Untitled NPA",description:t.product_description||t.description||"Draft created from ideation.",npa_type:t.npa_type||"STANDARD"};this.npaService.create(e).subscribe({next:i=>{let o=i.id;console.log(`[NPAAgent] Created new NPA: ${o}`);let d=["data","target_agent","uiRoute","projectId","intent","project_id","npaId","id","title","description","npa_type"],u=[],g=B(B({},t.data||{}),t);for(let[h,S]of Object.entries(g))d.includes(h)||S===null||S===void 0||S===""||(typeof S=="string"||typeof S=="number"||typeof S=="boolean"?u.push({field_key:h,field_value:String(S),lineage:"AUTO"}):Array.isArray(S)&&u.push({field_key:h,field_value:S.join(", "),lineage:"AUTO"}));u.find(h=>h.field_key==="risk_level")||u.push({field_key:"risk_level",field_value:t.risk_level||"MEDIUM",lineage:"AUTO"}),u.find(h=>h.field_key==="is_cross_border")||u.push({field_key:"is_cross_border",field_value:t.is_cross_border?"true":"false",lineage:"AUTO"});let C={formData:u};this.npaService.update(o,C).subscribe({next:()=>{console.log(`[NPAAgent] Initial data persisted for ${o}`);let h={agent_id:"CLASSIFIER",product_description:t.product_description||t.description||"",product_category:t.product_category||t.product_type||t.npa_type||"",underlying_asset:t.underlying_asset||t.underlying||"",notional_amount:t.notional_amount||t.notional||"",currency:t.currency||"USD",customer_segment:t.customer_segment||t.target_market||"",booking_location:t.booking_location||t.location||"Singapore",counterparty_location:t.counterparty_location||"",is_cross_border:t.is_cross_border||!1,project_id:o};this.difyService.runWorkflow("CLASSIFIER",h).subscribe({next:()=>console.log(`[NPAAgent] Classification workflow executed for ${o}`),error:S=>console.warn("[NPAAgent] Classification workflow failed:",S)}),this.npaContext=B({id:o,npaId:o},t),this.viewMode="WORK_ITEM",this.autoOpenEditor=!0,this.layoutService.setSidebarVisible(!1)},error:h=>{console.warn("[NPAAgent] Failed to persist initial data:",h),this.npaContext=B({id:o,npaId:o},t),this.viewMode="WORK_ITEM",this.autoOpenEditor=!0,this.layoutService.setSidebarVisible(!1)}})},error:i=>{console.error("[NPAAgent] Failed to create NPA:",i),alert("Failed to create NPA record. Please try again.")}})}}goToDetail(t){this.npaContext={npaId:t},this.viewMode="WORK_ITEM",this.autoOpenEditor=!1,this.layoutService.setSidebarVisible(!1)}ngOnDestroy(){this.layoutService.setSidebarVisible(!0),this.layoutService.setSidebarState(!1)}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=E({type:n,selectors:[["app-npa-agent"]],decls:3,vars:3,consts:[["class","h-full w-full overflow-y-auto scrollbar-hide",4,"ngIf"],["class","h-[calc(100vh-64px)] w-full border-t border-slate-200 bg-white",4,"ngIf"],["class","h-full w-full",4,"ngIf"],[1,"h-full","w-full","overflow-y-auto","scrollbar-hide"],[3,"navigateToCreate","navigateToDraft","navigateToDetail"],[1,"h-[calc(100vh-64px)]","w-full","border-t","border-slate-200","bg-white"],[3,"onBack","onComplete"],[1,"h-full","w-full"],[3,"onBack","npaContext","autoOpenEditor"]],template:function(e,i){e&1&&f(0,no,2,0,"div",0)(1,ro,2,0,"div",1)(2,ao,2,2,"div",2),e&2&&(c("ngIf",i.viewMode==="DASHBOARD"),s(),c("ngIf",i.viewMode==="IDEATION"),s(),c("ngIf",i.viewMode==="WORK_ITEM"))},dependencies:[N,F,U,We,Qe,mt],encapsulation:2})};export{jt as NPAAgentComponent};
