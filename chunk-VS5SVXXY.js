import{a as Re}from"./chunk-FJNWIHH7.js";import{a as $,b as T}from"./chunk-OD4VSVIC.js";import{a as Ee}from"./chunk-QD3K37AI.js";import{a as Oe}from"./chunk-W2JNMVTT.js";import{c as _e}from"./chunk-WR7XAGZW.js";import{Ab as pe,C as Q,Cb as me,D as S,Db as fe,E as ee,Hc as I,J as te,Ja as W,Jc as L,Kb as Ae,L as ne,Mb as ve,N as ie,Na as de,Nb as ye,O as re,Sa as D,T as P,Ta as B,U as se,W as N,X as A,Xa as M,Za as le,ab as K,bb as he,c as H,f as E,fc as Se,j as y,k as Z,o as k,oa as oe,q as J,ra as ae,tb as ue,ub as ge,v as x,va as ce,w as X,y as Y}from"./chunk-IVDQKAZB.js";import{a as f}from"./chunk-7RJXRMKA.js";var Te=["*"],we="Copy",xe="Copied",Pe=(()=>{let n=class n{constructor(){this._buttonClick$=new E,this.copied=Ee(this._buttonClick$.pipe(ie(()=>X(y(!0),x(3e3).pipe(Q(!1)))),ee(),ne(1))),this.copiedText=Se(()=>this.copied()?xe:we)}onCopyToClipboardClick(){this._buttonClick$.next()}};n.\u0275fac=function(t){return new(t||n)},n.\u0275cmp=K({type:n,selectors:[["markdown-clipboard"]],decls:2,vars:3,consts:[[1,"markdown-clipboard-button",3,"click"]],template:function(t,i){t&1&&(ue(0,"button",0),pe("click",function(){return i.onCopyToClipboardClick()}),ve(1),ge()),t&2&&(Ae("copied",i.copied()),de(),ye(i.copiedText()))},encapsulation:2,changeDetection:0});let c=n;return c})(),De=new N("CLIPBOARD_OPTIONS");var U=(function(c){return c.CommandLine="command-line",c.LineHighlight="line-highlight",c.LineNumbers="line-numbers",c})(U||{}),Me=new N("MARKED_EXTENSIONS"),Le=new N("MARKED_OPTIONS"),$e=new N("MERMAID_OPTIONS"),Ie=new N("SANITIZE");function je(c){return typeof c=="function"}var Fe="[ngx-markdown] When using the `emoji` attribute you *have to* include Emoji-Toolkit files to `angular.json` or use imports. See README for more information",He="[ngx-markdown] When using the `katex` attribute you *have to* include KaTeX files to `angular.json` or use imports. See README for more information",We="[ngx-markdown] When using the `mermaid` attribute you *have to* include Mermaid files to `angular.json` or use imports. See README for more information",Be="[ngx-markdown] When using the `clipboard` attribute you *have to* include Clipboard files to `angular.json` or use imports. See README for more information",Ke="[ngx-markdown] When using the `clipboard` attribute you *have to* provide the `viewContainerRef` parameter to `MarkdownService.render()` function",Ue="[ngx-markdown] When using the `src` attribute you *have to* pass the `HttpClient` as a parameter of the `forRoot` method. See README for more information";var be=(()=>{let n=class n{get options(){return this._options}set options(e){this._options=f(f({},this.DEFAULT_MARKED_OPTIONS),e)}get renderer(){return this.options.renderer}set renderer(e){this.options.renderer=e}constructor(e,t,i,r,o,a,d,h){this.clipboardOptions=e,this.extensions=t,this.mermaidOptions=r,this.platform=o,this.sanitize=a,this.http=d,this.sanitizer=h,this.DEFAULT_MARKED_OPTIONS={renderer:new $},this.DEFAULT_KATEX_OPTIONS={delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\begin{equation}",right:"\\end{equation}",display:!0},{left:"\\begin{align}",right:"\\end{align}",display:!0},{left:"\\begin{alignat}",right:"\\end{alignat}",display:!0},{left:"\\begin{gather}",right:"\\end{gather}",display:!0},{left:"\\begin{CD}",right:"\\end{CD}",display:!0},{left:"\\[",right:"\\]",display:!0}]},this.DEFAULT_MERMAID_OPTIONS={startOnLoad:!1},this.DEFAULT_CLIPBOARD_OPTIONS={buttonComponent:void 0},this.DEFAULT_PARSE_OPTIONS={decodeHtml:!1,inline:!1,emoji:!1,mermaid:!1,markedOptions:void 0,disableSanitizer:!1},this.DEFAULT_RENDER_OPTIONS={clipboard:!1,clipboardOptions:void 0,katex:!1,katexOptions:void 0,mermaid:!1,mermaidOptions:void 0},this._reload$=new E,this.reload$=this._reload$.asObservable(),this.options=i}parse(e,t=this.DEFAULT_PARSE_OPTIONS){let{decodeHtml:i,inline:r,emoji:o,mermaid:a,disableSanitizer:d}=t,h=f(f({},this.options),t.markedOptions),l=h.renderer||this.renderer||new $;this.extensions&&(this.renderer=this.extendsRendererForExtensions(l)),a&&(this.renderer=this.extendsRendererForMermaid(l));let g=this.trimIndentation(e),p=i?this.decodeHtml(g):g,m=o?this.parseEmoji(p):p,u=this.parseMarked(m,h,r);return d?u:this.sanitizeHtml(u)}render(e,t=this.DEFAULT_RENDER_OPTIONS,i){let{clipboard:r,clipboardOptions:o,katex:a,katexOptions:d,mermaid:h,mermaidOptions:l}=t;a&&this.renderKatex(e,f(f({},this.DEFAULT_KATEX_OPTIONS),d)),h&&this.renderMermaid(e,f(f(f({},this.DEFAULT_MERMAID_OPTIONS),this.mermaidOptions),l)),r&&this.renderClipboard(e,i,f(f(f({},this.DEFAULT_CLIPBOARD_OPTIONS),this.clipboardOptions),o)),this.highlight(e)}reload(){this._reload$.next()}getSource(e){if(!this.http)throw new Error(Ue);return this.http.get(e,{responseType:"text"}).pipe(k(t=>this.handleExtension(e,t)))}highlight(e){if(!I(this.platform)||typeof Prism>"u"||typeof Prism.highlightAllUnder>"u")return;e||(e=document);let t=e.querySelectorAll('pre code:not([class*="language-"])');Array.prototype.forEach.call(t,i=>i.classList.add("language-none")),Prism.highlightAllUnder(e)}decodeHtml(e){if(!I(this.platform))return e;let t=document.createElement("textarea");return t.innerHTML=e,t.value}extendsRendererForExtensions(e){let t=e;return t.\u0275NgxMarkdownRendererExtendedForExtensions===!0||(this.extensions?.length>0&&T.use(...this.extensions),t.\u0275NgxMarkdownRendererExtendedForExtensions=!0),e}extendsRendererForMermaid(e){let t=e;if(t.\u0275NgxMarkdownRendererExtendedForMermaid===!0)return e;let i=e.code;return e.code=r=>r.lang==="mermaid"?`<div class="mermaid">${r.text}</div>`:i(r),t.\u0275NgxMarkdownRendererExtendedForMermaid=!0,e}handleExtension(e,t){let i=e.lastIndexOf("://"),r=i>-1?e.substring(i+4):e,o=r.lastIndexOf("/"),a=o>-1?r.substring(o+1).split("?")[0]:"",d=a.lastIndexOf("."),h=d>-1?a.substring(d+1):"";return h&&h!=="md"?"```"+h+`
`+t+"\n```":t}parseMarked(e,t,i=!1){if(t.renderer){let r=f({},t.renderer);delete r.\u0275NgxMarkdownRendererExtendedForExtensions,delete r.\u0275NgxMarkdownRendererExtendedForMermaid,delete t.renderer,T.use({renderer:r})}return i?T.parseInline(e,t):T.parse(e,t)}parseEmoji(e){if(!I(this.platform))return e;if(typeof joypixels>"u"||typeof joypixels.shortnameToUnicode>"u")throw new Error(Fe);return joypixels.shortnameToUnicode(e)}renderKatex(e,t){if(I(this.platform)){if(typeof katex>"u"||typeof renderMathInElement>"u")throw new Error(He);renderMathInElement(e,t)}}renderClipboard(e,t,i){if(!I(this.platform))return;if(typeof ClipboardJS>"u")throw new Error(Be);if(!t)throw new Error(Ke);let{buttonComponent:r,buttonTemplate:o}=i,a=e.querySelectorAll("pre");for(let d=0;d<a.length;d++){let h=a.item(d),l=document.createElement("div");l.style.position="relative",h.parentNode.insertBefore(l,h),l.appendChild(h);let g=document.createElement("div");g.classList.add("markdown-clipboard-toolbar"),g.style.position="absolute",g.style.top=".5em",g.style.right=".5em",g.style.zIndex="1",l.insertAdjacentElement("beforeend",g),l.onmouseenter=()=>g.classList.add("hover"),l.onmouseleave=()=>g.classList.remove("hover");let p;if(r){let u=t.createComponent(r);p=u.hostView,u.changeDetectorRef.markForCheck()}else if(o)p=t.createEmbeddedView(o);else{let u=t.createComponent(Pe);p=u.hostView,u.changeDetectorRef.markForCheck()}let m;p.rootNodes.forEach(u=>{g.appendChild(u),m=new ClipboardJS(u,{text:()=>h.innerText})}),p.onDestroy(()=>m.destroy())}}renderMermaid(e,t=this.DEFAULT_MERMAID_OPTIONS){if(!I(this.platform))return;if(typeof mermaid>"u"||typeof mermaid.initialize>"u")throw new Error(We);let i=e.querySelectorAll(".mermaid");i.length!==0&&(mermaid.initialize(t),mermaid.run({nodes:i}))}trimIndentation(e){if(!e)return"";let t;return e.split(`
`).map(i=>{let r=t;return i.length>0&&(r=isNaN(r)?i.search(/\S|$/):Math.min(i.search(/\S|$/),r)),isNaN(t)&&(t=r),r?i.substring(r):i}).join(`
`)}async sanitizeHtml(e){return je(this.sanitize)?this.sanitize(await e):this.sanitize!==W.NONE?this.sanitizer.sanitize(this.sanitize,e)??"":e}};n.\u0275fac=function(t){return new(t||n)(A(De,8),A(Me,8),A(Le,8),A($e,8),A(ce),A(Ie),A(L,8),A(_e))},n.\u0275prov=P({token:n,factory:n.\u0275fac});let c=n;return c})(),ut=(()=>{let n=class n{get disableSanitizer(){return this._disableSanitizer}set disableSanitizer(e){this._disableSanitizer=this.coerceBooleanProperty(e)}get inline(){return this._inline}set inline(e){this._inline=this.coerceBooleanProperty(e)}get clipboard(){return this._clipboard}set clipboard(e){this._clipboard=this.coerceBooleanProperty(e)}get emoji(){return this._emoji}set emoji(e){this._emoji=this.coerceBooleanProperty(e)}get katex(){return this._katex}set katex(e){this._katex=this.coerceBooleanProperty(e)}get mermaid(){return this._mermaid}set mermaid(e){this._mermaid=this.coerceBooleanProperty(e)}get lineHighlight(){return this._lineHighlight}set lineHighlight(e){this._lineHighlight=this.coerceBooleanProperty(e)}get lineNumbers(){return this._lineNumbers}set lineNumbers(e){this._lineNumbers=this.coerceBooleanProperty(e)}get commandLine(){return this._commandLine}set commandLine(e){this._commandLine=this.coerceBooleanProperty(e)}constructor(e,t,i){this.element=e,this.markdownService=t,this.viewContainerRef=i,this.error=new D,this.load=new D,this.ready=new D,this._clipboard=!1,this._commandLine=!1,this._disableSanitizer=!1,this._emoji=!1,this._inline=!1,this._katex=!1,this._lineHighlight=!1,this._lineNumbers=!1,this._mermaid=!1,this.destroyed$=new E}ngOnChanges(){this.loadContent()}loadContent(){if(this.data!=null){this.handleData();return}if(this.src!=null){this.handleSrc();return}}ngAfterViewInit(){!this.data&&!this.src&&this.handleTransclusion(),this.markdownService.reload$.pipe(re(this.destroyed$)).subscribe(()=>this.loadContent())}ngOnDestroy(){this.destroyed$.next(),this.destroyed$.complete()}async render(e,t=!1){let i={decodeHtml:t,inline:this.inline,emoji:this.emoji,mermaid:this.mermaid,disableSanitizer:this.disableSanitizer},r={clipboard:this.clipboard,clipboardOptions:this.getClipboardOptions(),katex:this.katex,katexOptions:this.katexOptions,mermaid:this.mermaid,mermaidOptions:this.mermaidOptions},o=await this.markdownService.parse(e,i);this.element.nativeElement.innerHTML=o,this.handlePlugins(),this.markdownService.render(this.element.nativeElement,r,this.viewContainerRef),this.ready.emit()}coerceBooleanProperty(e){return e!=null&&`${String(e)}`!="false"}getClipboardOptions(){if(this.clipboardButtonComponent||this.clipboardButtonTemplate)return{buttonComponent:this.clipboardButtonComponent,buttonTemplate:this.clipboardButtonTemplate}}handleData(){this.render(this.data)}handleSrc(){this.markdownService.getSource(this.src).subscribe({next:e=>{this.render(e).then(()=>{this.load.emit(e)})},error:e=>this.error.emit(e)})}handleTransclusion(){this.render(this.element.nativeElement.innerHTML,!0)}handlePlugins(){this.commandLine&&(this.setPluginClass(this.element.nativeElement,U.CommandLine),this.setPluginOptions(this.element.nativeElement,{dataFilterOutput:this.filterOutput,dataHost:this.host,dataPrompt:this.prompt,dataOutput:this.output,dataUser:this.user})),this.lineHighlight&&this.setPluginOptions(this.element.nativeElement,{dataLine:this.line,dataLineOffset:this.lineOffset}),this.lineNumbers&&(this.setPluginClass(this.element.nativeElement,U.LineNumbers),this.setPluginOptions(this.element.nativeElement,{dataStart:this.start}))}setPluginClass(e,t){let i=e.querySelectorAll("pre");for(let r=0;r<i.length;r++){let o=t instanceof Array?t:[t];i.item(r).classList.add(...o)}}setPluginOptions(e,t){let i=e.querySelectorAll("pre");for(let r=0;r<i.length;r++)Object.keys(t).forEach(o=>{let a=t[o];if(a){let d=this.toLispCase(o);i.item(r).setAttribute(d,a.toString())}})}toLispCase(e){let t=e.match(/([A-Z])/g);if(!t)return e;let i=e.toString();for(let r=0,o=t.length;r<o;r++)i=i.replace(new RegExp(t[r]),"-"+t[r].toLowerCase());return i.slice(0,1)==="-"&&(i=i.slice(1)),i}};n.\u0275fac=function(t){return new(t||n)(M(ae),M(be),M(le))},n.\u0275cmp=K({type:n,selectors:[["markdown"],["","markdown",""]],inputs:{data:"data",src:"src",disableSanitizer:"disableSanitizer",inline:"inline",clipboard:"clipboard",clipboardButtonComponent:"clipboardButtonComponent",clipboardButtonTemplate:"clipboardButtonTemplate",emoji:"emoji",katex:"katex",katexOptions:"katexOptions",mermaid:"mermaid",mermaidOptions:"mermaidOptions",lineHighlight:"lineHighlight",line:"line",lineOffset:"lineOffset",lineNumbers:"lineNumbers",start:"start",commandLine:"commandLine",filterOutput:"filterOutput",host:"host",prompt:"prompt",output:"output",user:"user"},outputs:{error:"error",load:"load",ready:"ready"},features:[oe],ngContentSelectors:Te,decls:1,vars:0,template:function(t,i){t&1&&(me(),fe(0))},encapsulation:2});let c=n;return c})();function ze(c){return[be,c?.loader??[],c?.clipboardOptions??[],c?.markedOptions??[],c?.mermaidOptions??[],c?.markedExtensions??[],Ve(c?.sanitize)??[]]}function Ge(c){return c!=null&&c.provide!=null}function Ve(c){return Ge(c)?c:{provide:Ie,useValue:c??W.HTML}}var gt=(()=>{let n=class n{static forRoot(e){return{ngModule:n,providers:[ze(e)]}}static forChild(){return{ngModule:n}}};n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=he({type:n}),n.\u0275inj=se({});let c=n;return c})();var ke=class c{constructor(n,s,e){this.http=n;this.ngZone=s;this.auth=e}useMockDify=!1;conversationStep=0;conversations=new Map;_activeAgentId="MASTER_COO";delegationStack=[];agentActivity$=new E;streaming$=new E;activeAgentChanged$=new E;static difyAppAliasToAgentId=(()=>{let n={},s={},e=(t,i,r)=>{if(!t)return;let o=s[t];(o===void 0||r<o)&&(n[t]=i,s[t]=r)};for(let t of Re){if(!t?.id)continue;let i=String(t.id),r=typeof t.tier=="number"?t.tier:99;if(t.difyApp&&e(String(t.difyApp),i,r),Array.isArray(t.aliases))for(let o of t.aliases)o&&e(String(o),i,r)}return n})();get difyUser(){return this.auth.currentUser?.id||"anonymous"}get authHeader(){return this.auth.token?`Bearer ${this.auth.token}`:null}get activeAgentId(){return this._activeAgentId}getConversationId(n){let s=n||this._activeAgentId;return this.conversations.get(s)?.conversationId||null}getAgentActivity(){return this.agentActivity$.asObservable()}getStreamingText(){return this.streaming$.asObservable()}getAgentChanges(){return this.activeAgentChanged$.asObservable()}hasConversation(n){return this.conversations.has(n)&&!!this.conversations.get(n)?.conversationId}restoreConversation(n,s){this.setConversationId(n,s)}exportConversationState(){let n={};for(let[s,e]of this.conversations.entries())e?.conversationId&&(n[s]=e.conversationId);return{activeAgentId:this._activeAgentId,delegationStack:[...this.delegationStack],conversations:n}}restoreConversationState(n){if(!n||typeof n!="object")return;let s=n.conversations&&typeof n.conversations=="object"?n.conversations:{};for(let[e,t]of Object.entries(s))typeof t=="string"&&t&&this.restoreConversation(String(e),t);Array.isArray(n.delegationStack)&&(this.delegationStack=n.delegationStack.map(String)),typeof n.activeAgentId=="string"&&n.activeAgentId&&this.setActiveAgent(n.activeAgentId)}switchAgent(n,s="manual"){let e=this._activeAgentId;e!==n&&(this.delegationStack.push(e),this._activeAgentId=n,console.log(`[DifyService] Agent switch: ${e} \u2192 ${n} (${s})`),this.activeAgentChanged$.next({fromAgent:e,toAgent:n,reason:s}))}returnToPreviousAgent(n="handoff_complete"){let s=this.delegationStack.pop()||"MASTER_COO",e=this._activeAgentId;return this._activeAgentId=s,console.log(`[DifyService] Agent return: ${e} \u2192 ${s} (${n})`),this.activeAgentChanged$.next({fromAgent:e,toAgent:s,reason:n}),s}setActiveAgent(n){let s=this._activeAgentId;s!==n&&(this._activeAgentId=n,this.activeAgentChanged$.next({fromAgent:s,toAgent:n,reason:"set_active"}))}processAgentRouting(n){let s=n?.agent_action,e=n?.payload,t=i=>c.difyAppAliasToAgentId[i]||i;if(s==="DELEGATE_AGENT"&&e?.target_agent){let i=t(e.target_agent);return this.switchAgent(i,`delegate:${s}`),{shouldSwitch:!0,targetAgent:i,action:s}}if(s==="ROUTE_DOMAIN"&&e){let i=e.domainId||e.data?.domainId,r={NPA:"NPA_ORCHESTRATOR",IDEATION:"IDEATION",RISK:"RISK",KB:"KB_SEARCH",OPS:"GOVERNANCE",DESK:"DILIGENCE"},o;return e.target_agent&&e.target_agent!=="MASTER_COO"?o=t(e.target_agent):o=r[i]||"NPA_ORCHESTRATOR",console.log(`[DifyService] ROUTE_DOMAIN: domainId=${i}, target_agent=${e.target_agent}, resolved=${o}`),this.switchAgent(o,`route_domain:${i}`),{shouldSwitch:!0,targetAgent:o,action:s}}return s==="FINALIZE_DRAFT"&&e?.target_agent?{shouldSwitch:!1,targetAgent:e.target_agent,action:s}:{shouldSwitch:!1,action:s||"SHOW_RAW_RESPONSE"}}sendMessage(n,s={},e){let t=e||this._activeAgentId;if(this.useMockDify)return this.mockDifyLogic(n);let i=this.getConversationId(t);return this.http.post("/api/dify/chat",{agent_id:t,query:n,inputs:s,conversation_id:i,user:this.difyUser,response_mode:"blocking"}).pipe(k(r=>(this.setConversationId(t,r.conversation_id),{answer:r.answer,conversationId:r.conversation_id,messageId:r.message_id,metadata:r.metadata})))}sendMessageStreaming(n,s={},e){let t=e||this._activeAgentId;if(this.useMockDify){let o="I am analyzing your request and routing to the appropriate specialist agent...".split(" "),a=0,d=setInterval(()=>{a<o.length?(this.streaming$.next(o[a]+" "),a++):(clearInterval(d),this.streaming$.next("[DONE]"))},100);return}let i=this.getConversationId(t),r=JSON.stringify({agent_id:t,query:n,inputs:s,conversation_id:i,user:this.difyUser,response_mode:"streaming"});fetch("/api/dify/chat",{method:"POST",headers:f({"Content-Type":"application/json"},this.authHeader?{Authorization:this.authHeader}:{}),body:r}).then(o=>{let a=o.body?.getReader(),d=new TextDecoder,h=()=>{a?.read().then(({done:l,value:g})=>{if(l){this.streaming$.next("[DONE]");return}let m=d.decode(g,{stream:!0}).split(`
`).filter(u=>u.startsWith("data:"));for(let u of m)try{let O=JSON.parse(u.slice(5).trim());O.answer&&this.streaming$.next(O.answer),O.conversation_id&&this.setConversationId(t,O.conversation_id)}catch{}h()})};h()})}sendMessageStreamed(n,s={},e){let t=e||this._activeAgentId;if(this.useMockDify)return this._mockStreamedResponse(n);let i=this.getConversationId(t);return new H(r=>{let o="",a,d,h=new AbortController,l=3,g=p=>{fetch("/api/dify/chat",{method:"POST",headers:f({"Content-Type":"application/json"},this.authHeader?{Authorization:this.authHeader}:{}),body:JSON.stringify({agent_id:t,query:n,inputs:s,conversation_id:i,user:this.difyUser,response_mode:"streaming"}),signal:h.signal}).then(m=>{if(!m.ok){if((m.status===502||m.status===503||m.status===504)&&p<l){let _=(p+1)*3e3;console.warn(`[DifyService] Chat stream retry ${p+1}/${l} in ${_}ms (HTTP ${m.status})`),r.next({type:"thought",thought:`Service temporarily unavailable, retrying (${p+1}/${l})...`}),setTimeout(()=>g(p+1),_);return}r.error(new Error(`HTTP ${m.status}`));return}let u=m.body?.getReader();if(!u){r.error(new Error("No stream"));return}let O=new TextDecoder,j="",R=[],F=!1,z=()=>{if(F)return;F=!0,(_=>{typeof requestAnimationFrame=="function"?requestAnimationFrame(_):setTimeout(_,16)})(()=>{if(F=!1,R.length===0)return;let _=R.splice(0,R.length);this.ngZone.run(()=>{for(let w of _)r.next(w)}),R.length>0&&z()})},G=()=>{u.read().then(({done:C,value:_})=>{if(C){this.ngZone.run(()=>this._finishStream(r,o,a,d,t));return}j+=O.decode(_,{stream:!0});let w=j.split(`
`);j=w.pop()||"";for(let V of w){if(!V.startsWith("data:"))continue;let q=V.slice(5).trim();if(q)try{let v=JSON.parse(q);if(v.event==="agent_message"||v.event==="message"){let b=v.answer||"";o+=b,b&&R.push({type:"chunk",text:b})}else if(v.event==="agent_thought"){let b=v.thought||"";b&&R.push({type:"thought",thought:b})}else v.event==="message_end"&&(a=v.conversation_id||a,d=v.message_id||d);v.conversation_id&&(a=v.conversation_id),v.message_id&&(d=v.message_id)}catch{}}R.length>0&&z(),G()}).catch(C=>{C.name!=="AbortError"&&this.ngZone.run(()=>this._finishStream(r,o,a,d,t))})};G()}).catch(m=>{if(m.name!=="AbortError"){if(p<l){let u=(p+1)*3e3;console.warn(`[DifyService] Chat stream retry ${p+1}/${l} in ${u}ms (network error: ${m.message})`),r.next({type:"thought",thought:`Connection error, retrying (${p+1}/${l})...`}),setTimeout(()=>g(p+1),u);return}r.error(m)}})};return g(0),()=>h.abort()})}_finishStream(n,s,e,t,i){e&&this.setConversationId(i,e);let r=this._parseMarkersClientSide(s),o=r._cleanAnswer;delete r._cleanAnswer,n.next({type:"done",response:{answer:o,conversationId:e,messageId:t,metadata:r}}),n.complete()}_parseMarkersClientSide(n){if(!n)return{agent_action:"SHOW_RAW_RESPONSE",agent_id:"UNKNOWN",payload:{},trace:{},_cleanAnswer:""};let s=n.match(/@@NPA_META@@(\{[\s\S]*\})$/);if(s)try{let a=JSON.parse(s[1]),d=n.slice(0,s.index).trimEnd();return{agent_action:a.agent_action||"SHOW_RAW_RESPONSE",agent_id:a.agent_id||"UNKNOWN",payload:a.payload||{},trace:a.trace||{},_cleanAnswer:d}}catch(a){console.warn("@@NPA_META@@ JSON parse failed:",a)}let e=n.split(`
`),t={},i=-1;for(let a=0;a<e.length;a++){let d=e[a].trim();if(d.startsWith("[NPA_")){i===-1&&(i=a);let h=d.indexOf("]");if(h>0){let l=d.substring(1,h),g=d.substring(h+1).trim();t[l]=g}}}if(i===-1||!t.NPA_ACTION){let d=["MASTER_COO","NPA_ORCHESTRATOR",void 0,null,""].includes(this._activeAgentId),h=[{pattern:/(?:rout(?:e|ing)\b.{0,60}(?:cf_npa_ideation|ideation\s+(?:agent|specialist|workflow|module)))|rout(?:e|ing)\b.{0,60}ideation\b.{0,30}(?:interview|session|process)|initiating\s+ideation\s+(?:session|workflow)|starting\s+(?:the\s+)?ideation\s+interview|delegate.*ideation|conduct\s+(?:the\s+)?structured\s+(?:intake|interview).*ideation|structured\s+multi.?turn\s+interview/i,agentId:"IDEATION",intent:"create_npa"},{pattern:/(?:rout(?:e|ing)\b.{0,40}(?:the\s+)?classifier)|starting\s+classification|initiating\s+classification/i,agentId:"CLASSIFIER",intent:"classify_product"},{pattern:/(?:rout(?:e|ing)\b.{0,40}(?:the\s+)?risk\s+assess(?:ment\s+agent))|starting\s+risk\s+assessment|initiating\s+risk\s+assess/i,agentId:"RISK",intent:"assess_risk"},{pattern:/(?:rout(?:e|ing)\b.{0,40}(?:the\s+)?governance)|starting\s+governance\s+check/i,agentId:"GOVERNANCE",intent:"governance_check"},{pattern:/(?:rout(?:e|ing)\b.{0,40}(?:the\s+)?sign.?off)|starting\s+sign.?off\s+orchestration/i,agentId:"SIGNOFF",intent:"signoff_routing"},{pattern:/(?:rout(?:e|ing)\b.{0,40}cf_npa_query_assistant)|(?:rout(?:e|ing)\b.{0,40}(?:the\s+)?diligence)/i,agentId:"DILIGENCE",intent:"query_kb"}];if(d){for(let l of h)if(l.pattern.test(n))return console.log(`[DifyService] Text-based delegation detected \u2192 ${l.agentId} (intent: ${l.intent}) [from ${this._activeAgentId}]`),{agent_action:"DELEGATE_AGENT",agent_id:this._activeAgentId||"NPA_ORCHESTRATOR",payload:{target_agent:l.agentId,intent:l.intent,reason:"Text-based delegation detected from agent response"},trace:{},_cleanAnswer:n}}else console.log(`[DifyService] Skipping delegation detection \u2014 active agent is ${this._activeAgentId} (not an orchestrator)`);return{agent_action:"SHOW_RAW_RESPONSE",agent_id:"UNKNOWN",payload:{raw_answer:n},trace:{},_cleanAnswer:n}}let r=e.slice(0,i).join(`
`).trimEnd(),o={};if(t.NPA_DATA)try{o=JSON.parse(t.NPA_DATA)}catch{o={raw:t.NPA_DATA}}return{agent_action:t.NPA_ACTION||"SHOW_RAW_RESPONSE",agent_id:t.NPA_AGENT||"UNKNOWN",payload:{projectId:t.NPA_PROJECT||"",intent:t.NPA_INTENT||"",target_agent:t.NPA_TARGET||"",uiRoute:"/agents/npa",data:o},trace:{session_id:t.NPA_SESSION||""},_cleanAnswer:r}}_mockStreamedResponse(n){return new H(s=>{let e="I am analyzing your request and routing to the appropriate specialist agent...".split(" "),t=0,i=setInterval(()=>{t<e.length?(s.next({type:"chunk",text:e[t]+" "}),t++):(clearInterval(i),s.next({type:"done",response:{answer:e.join(" "),metadata:{agent_action:"SHOW_RAW_RESPONSE",agent_id:"MASTER_COO",payload:{},trace:{}}}}),s.complete())},80);return()=>clearInterval(i)})}runWorkflow(n,s={}){return this.useMockDify?this.mockWorkflow(n,s):(this.agentActivity$.next({agentId:n,status:"running"}),this.http.post("/api/dify/workflow",{agent_id:n,inputs:s,user:this.difyUser,response_mode:"blocking"}).pipe(te(e=>{let t=0,i=3;return e.pipe(J(r=>{if(t++,(r.status===0||r.status===502||r.status===503||r.status===504)&&t<=i){let a=t*3e3;return console.warn(`[DifyService] ${n} retry ${t}/${i} in ${a}ms (status=${r.status})`),x(a)}return Z(()=>r)}))}),k(e=>(this.agentActivity$.next({agentId:n,status:e.data.status==="succeeded"?"done":"error"}),e)),Y(e=>{throw console.error(`[DifyService] Workflow ${n} failed after retries:`,e),console.error(`[DifyService] ${n} error details \u2014 status: ${e.status}, statusText: ${e.statusText}, url: ${e.url}, message: ${e.message}`),this.agentActivity$.next({agentId:n,status:"error"}),e})))}reset(){this.conversationStep=0,this.conversations.clear(),this.delegationStack=[],this._activeAgentId="MASTER_COO"}resetAgent(n){this.conversations.delete(n)}setConversationId(n,s){let e=this.conversations.get(n);e?(e.conversationId=s,e.messageCount++):this.conversations.set(n,{conversationId:s,messageCount:1,startedAt:new Date})}mockDifyLogic(n){let s=n.toLowerCase();if(this.conversationStep===0){this.conversationStep++;let e=this.detectDomain(s);return e==="NPA"?(this.emitMockActivity(["MASTER_COO","NPA_ORCHESTRATOR"]),y({answer:`I've identified this as a **New Product Approval** request. Routing you to the **NPA Domain Orchestrator**.

Please describe the product structure, underlying asset, and payout logic so I can begin the analysis.`,metadata:{agent_action:"ROUTE_DOMAIN",agent_id:"MASTER_COO",payload:{domainId:"NPA",name:"NPA Domain Orchestrator",description:"Create, classify, and manage New Product Approvals",icon:"target",color:"bg-orange-50 text-orange-600",route:"/agents/npa"},trace:{}}}).pipe(S(1200))):e==="RISK"?(this.emitMockActivity(["MASTER_COO","RISK"]),y({answer:`I've identified this as a **Risk & Compliance** query. The Risk domain is currently in development.

For now, I can help you with NPA-related risk assessments through the NPA Agent. Would you like me to route you there?`,metadata:{agent_action:"ROUTE_DOMAIN",agent_id:"MASTER_COO",payload:{domainId:"RISK",name:"Risk Control Agent",description:"4-layer risk cascade: Internal, Regulatory, Sanctions, Dynamic",icon:"shield-alert",color:"bg-red-50 text-red-600",route:"/functions/orm"},trace:{}}}).pipe(S(1200))):e==="KB"?(this.emitMockActivity(["MASTER_COO","KB_SEARCH"]),y({answer:`I've routed your request to the **Knowledge Base Search Agent**. Let me search our SOPs, policies, and regulatory guidance for you.

Searching...

**Results (3 matches):**
1. **MAS Notice 656** \u2014 Guidelines on Risk Management (92% match)
2. **NPA SOP v4.2** \u2014 Standard Operating Procedure for Product Approvals (87% match)
3. **T&M Policy Framework** \u2014 Trading & Markets Governance Policies (81% match)

Would you like me to drill into any of these documents?`,metadata:{agent_action:"ROUTE_DOMAIN",agent_id:"KB_SEARCH",payload:{domainId:"KB",name:"KB Search Agent",description:"Semantic search over SOPs, policies, and regulatory guidance",icon:"search",color:"bg-fuchsia-50 text-fuchsia-600",route:"/knowledge/base"},trace:{}}}).pipe(S(1500))):(this.emitMockActivity(["MASTER_COO"]),y({answer:`I'm the **Master COO Orchestrator**. I manage 7 COO domains:

* **New Product Approval (NPA)** \u2014 Active
* **Desk Support** \u2014 Coming Soon
* **DCE Client Services** \u2014 Coming Soon
* **Operational Risk** \u2014 Coming Soon
* **Strategic PM** \u2014 Coming Soon
* **Business Leads** \u2014 Coming Soon
* **Business Analysis** \u2014 Coming Soon

Currently, the **NPA domain** is fully active. Try asking me to create a new product, run a risk check, or search the knowledge base.`,metadata:{agent_action:"SHOW_RAW_RESPONSE",agent_id:"MASTER_COO",payload:{raw_answer:"Domain overview"},trace:{}}}).pipe(S(1e3)))}if(this.conversationStep===1)return this.conversationStep++,s.includes("crypto")||s.includes("bitcoin")?(this.emitMockActivity(["CLASSIFIER","RISK"]),y({answer:`**HARD STOP** \u2014 Prohibited item detected.

My analysis classifies this as a **New-to-Group (NTG)** product involving Crypto assets, which is on the **Prohibited List** (Layer: REGULATORY).

You cannot proceed with an NPA. Contact the Product Approval Committee for exemption review.`,metadata:{agent_action:"STOP_PROCESS",agent_id:"RISK",payload:{type:"NTG",track:"Prohibited",hardStop:!0,prohibitedMatch:{matched:!0,item:"Cryptocurrency",layer:"REGULATORY"}},trace:{}}}).pipe(S(2e3))):(this.emitMockActivity(["CLASSIFIER","KB_SEARCH","ML_PREDICT"]),y({answer:`I've analyzed your description and activated specialist agents:

**Classification Agent**: Variation / Existing product
**KB Search**: Found similar NPA 'TSG1917' (94% match)
**ML Prediction**: 82% approval likelihood, est. 35 days

One critical check: **Will this product involve booking across multiple locations (Cross-Border)?**`,metadata:{agent_action:"SHOW_CLASSIFICATION",agent_id:"CLASSIFIER",payload:{type:"Variation",track:"NPA Lite",scores:[{criterion:"Novelty",score:3,maxScore:10,reasoning:"Similar to existing FX products"},{criterion:"Complexity",score:5,maxScore:10,reasoning:"Standard structured product"},{criterion:"Risk Impact",score:4,maxScore:10,reasoning:"Within approved risk appetite"},{criterion:"Regulatory",score:2,maxScore:10,reasoning:"Covered under existing MAS framework"},{criterion:"Technology",score:3,maxScore:10,reasoning:"Minor booking system changes"},{criterion:"Market",score:4,maxScore:10,reasoning:"Established market segment"},{criterion:"Cross-Border",score:2,maxScore:10,reasoning:"Single jurisdiction expected"}],overallConfidence:88,prohibitedMatch:{matched:!1}},trace:{}}}).pipe(S(2e3)));if(this.conversationStep===2){this.conversationStep++;let e=s.includes("yes")||s.includes("hk")||s.includes("london")||s.includes("hong kong");this.emitMockActivity(["GOVERNANCE","DOC_LIFECYCLE"]);let t=`All specialist agents have completed their analysis:

### Summary
`;return t+=`* **Track**: NPA Lite (Variation)
`,t+=`* **Cross-Border**: ${e?"YES":"NO"}
`,e?t+=`* **Mandatory Sign-Offs**: Finance, Credit, MLR, Tech, Ops
`:t+=`* **Mandatory Sign-Offs**: Finance, Credit, Ops
`,t+=`
The NPA draft has been created. Access it from the notification below.`,y({answer:t,metadata:{agent_action:"FINALIZE_DRAFT",agent_id:"NPA_ORCHESTRATOR",payload:{track:"NPA_LITE",isCrossBorder:e,mandatorySignOffs:e?["FINANCE","CREDIT","MLR","TECH","OPS"]:["FINANCE","CREDIT","OPS"],autoFillCoverage:0,mlPrediction:{approvalLikelihood:82,timelineDays:35,bottleneckDept:"Legal"}},trace:{}}}).pipe(S(2500))}return y({answer:"I've completed this analysis. You can reset the conversation to start a new query, or use the button above to open the full NPA workspace.",metadata:{agent_action:"SHOW_RAW_RESPONSE",agent_id:"MASTER_COO",payload:{raw_answer:"Analysis complete."},trace:{}}}).pipe(S(500))}detectDomain(n){let s=["npa","new product","product approval","create a product","structured note","structured product","derivative","etf","fx accumulator","fx option","bond","swap","approval","classify","classification","ideation","concept paper","prohibited"],e=["risk assessment","risk check","compliance check","regulatory","sanctions","prohibited list","risk cascade","operational risk","credit risk","market risk"],t=["search","knowledge","sop","policy","guideline","mas notice","regulation","documentation","procedure","framework"],i=["settlement","booking","murex","operations","workflow","process flow"],r=["desk support","trade error","booking error","system access","entitlement"];return s.some(o=>n.includes(o))?"NPA":e.some(o=>n.includes(o))?"RISK":t.some(o=>n.includes(o))?"KB":i.some(o=>n.includes(o))?"OPS":r.some(o=>n.includes(o))?"DESK":"GENERAL"}mockWorkflow(n,s){this.agentActivity$.next({agentId:n,status:"running"});let t={CLASSIFIER:{type:"Variation",track:"NPA Lite",scores:[{criterion:"Novelty",score:3,maxScore:10}],overallConfidence:88},RISK:{layers:[{name:"Internal Policy",status:"PASS",details:"Compliant"},{name:"Regulatory",status:"PASS",details:"MAS 656 compliant"},{name:"Sanctions",status:"PASS",details:"No matches"},{name:"Dynamic",status:"WARNING",details:"Elevated market volatility"}],overallScore:72,hardStop:!1},ML_PREDICT:{approvalLikelihood:82,timelineDays:35,bottleneckDept:"Legal",riskScore:28},KB_SEARCH:{results:[{docId:"TSG1917",title:"FX Structured Note",snippet:"Similar FX derivative...",similarity:.94,source:"Historical NPAs"},{docId:"TSG1845",title:"Interest Rate Swap",snippet:"IR product with...",similarity:.87,source:"Historical NPAs"}]},GOVERNANCE:{signoffs:[{department:"Finance",status:"PENDING"},{department:"Credit",status:"PENDING"},{department:"Operations",status:"PENDING"}],slaStatus:"on_track",loopBackCount:0,circuitBreaker:!1}}[n]||{};return y({workflow_run_id:`wf-${Date.now()}`,task_id:`task-${Date.now()}`,data:{outputs:t,status:"succeeded"},metadata:{agent_action:"SHOW_RAW_RESPONSE",agent_id:n,payload:t,trace:{}}}).pipe(S(1500),k(i=>(this.agentActivity$.next({agentId:n,status:"done"}),i)))}emitMockActivity(n){n.forEach((s,e)=>{setTimeout(()=>{this.agentActivity$.next({agentId:s,status:"running"})},e*300),setTimeout(()=>{this.agentActivity$.next({agentId:s,status:"done"})},1e3+e*500)})}static \u0275fac=function(s){return new(s||c)(A(L),A(B),A(Oe))};static \u0275prov=P({token:c,factory:c.\u0275fac,providedIn:"root"})};export{ut as a,ze as b,gt as c,ke as d};
